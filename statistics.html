<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–µ–º–µ–ª—å–Ω–∏—Ö –¥—ñ–ª—è–Ω–æ–∫</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --mono-bg: #000000;
            --mono-surface: #1C1C1E;
            --mono-surface-2: #2C2C2E;
            --mono-surface-3: #3A3A3C;
            --mono-border: rgba(255, 255, 255, 0.08);
            --mono-text: #FFFFFF;
            --mono-text-secondary: #8E8E93;
            --mono-text-muted: #636366;
            --mono-green: #10B981;
            --mono-green-bg: rgba(16, 185, 129, 0.15);
            --mono-red: #EF4444;
            --mono-red-bg: rgba(239, 68, 68, 0.15);
            --mono-yellow: #F59E0B;
            --mono-yellow-bg: rgba(245, 158, 11, 0.15);
            --mono-blue: #3B82F6;
            --mono-blue-bg: rgba(59, 130, 246, 0.15);
            --mono-orange: #F97316;
            --mono-orange-bg: rgba(249, 115, 22, 0.15);
            --mono-radius: 12px;
            --mono-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }
        
        * {
            box-sizing: border-box;
        }
        
        body {
            background: var(--mono-bg);
            color: var(--mono-text);
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
            min-height: 100vh;
        }
        
        /* Navbar */
        .navbar {
            background: var(--mono-surface) !important;
            border-bottom: 1px solid var(--mono-border);
            padding: 12px 0;
        }
        
        .navbar-brand {
            color: var(--mono-text) !important;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-pdf {
            background: var(--mono-surface-2);
            border: 1px solid var(--mono-border);
            color: var(--mono-text);
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .btn-pdf:hover {
            background: var(--mono-surface-3);
            color: var(--mono-text);
        }
        
        /* Page title */
        .page-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 24px;
            color: var(--mono-text);
        }
        
        .page-title span {
            color: var(--mono-green);
        }
        
        /* Stats Cards */
        .stats-card {
            background: var(--mono-surface);
            border-radius: var(--mono-radius);
            padding: 20px;
            border: 1px solid var(--mono-border);
            height: 100%;
        }
        
        .stats-card-title {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--mono-text-secondary);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .stats-value {
            font-size: 32px;
            font-weight: 700;
            line-height: 1.2;
            margin-top: 8px;
        }
        
        .stats-value-unit {
            font-size: 16px;
            font-weight: 400;
            color: var(--mono-text-secondary);
            margin-left: 4px;
        }
        
        .stats-subtitle {
            font-size: 13px;
            color: var(--mono-text-secondary);
            margin-top: 4px;
        }
        
        /* Section */
        .section {
            background: var(--mono-surface);
            border-radius: var(--mono-radius);
            border: 1px solid var(--mono-border);
            margin-bottom: 24px;
            overflow: hidden;
        }
        
        .section-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--mono-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 12px;
        }
        
        .section-title {
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .section-title i {
            color: var(--mono-green);
        }
        
        .section-body {
            padding: 20px;
        }
        
        /* Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table th {
            background: var(--mono-surface-2);
            color: var(--mono-text-secondary);
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--mono-border);
        }
        
        .data-table th.text-end {
            text-align: right;
        }
        
        .data-table td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--mono-border);
            font-size: 14px;
            color: var(--mono-text);
        }
        
        .data-table td.text-end {
            text-align: right;
        }
        
        .data-table tbody tr:hover {
            background: var(--mono-surface-2);
        }
        
        .data-table tbody tr:last-child td {
            border-bottom: none;
        }
        
        .data-table .total-row {
            background: var(--mono-surface-2);
            font-weight: 600;
        }
        
        .data-table .total-row td {
            border-top: 2px solid var(--mono-border);
        }
        
        /* Year colors */
        .year-expired { color: var(--mono-red); }
        .year-current { color: var(--mono-yellow); }
        .year-future { color: var(--mono-green); }
        
        /* Progress bar */
        .progress-bar-container {
            position: relative;
            height: 24px;
            background: var(--mono-surface-2);
            border-radius: 6px;
            overflow: hidden;
        }
        
        .progress-bar-fill {
            height: 100%;
            display: flex;
        }
        
        .progress-bar-segment {
            height: 100%;
            transition: width 0.3s;
        }
        
        .progress-bar-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 12px;
            font-weight: 600;
            color: var(--mono-text);
        }
        
        /* Tenant color indicator */
        .tenant-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 3px;
            margin-right: 8px;
            vertical-align: middle;
        }
        
        /* Potential card */
        .potential-card {
            background: linear-gradient(135deg, var(--mono-surface) 0%, var(--mono-surface-2) 100%);
            border: 1px solid var(--mono-green);
            border-radius: var(--mono-radius);
            padding: 24px;
            margin-bottom: 24px;
        }
        
        .potential-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .potential-icon {
            width: 48px;
            height: 48px;
            background: var(--mono-green-bg);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: var(--mono-green);
        }
        
        .potential-title {
            font-size: 18px;
            font-weight: 600;
        }
        
        .potential-subtitle {
            font-size: 13px;
            color: var(--mono-text-secondary);
        }
        
        .potential-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
        }
        
        .potential-item {
            background: var(--mono-surface);
            border-radius: 8px;
            padding: 16px;
            border: 1px solid var(--mono-border);
            text-align: center;
        }
        
        .potential-item-label {
            font-size: 12px;
            color: var(--mono-text-secondary);
            margin-bottom: 4px;
        }
        
        .potential-item-value {
            font-size: 24px;
            font-weight: 700;
        }
        
        .potential-item-detail {
            font-size: 13px;
            color: var(--mono-text-secondary);
        }
        
        /* Risk indicator */
        .risk-indicator {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: var(--mono-surface-2);
            border-radius: 8px;
            margin-bottom: 8px;
        }
        
        .risk-bar {
            flex: 1;
            height: 8px;
            background: var(--mono-surface-3);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .risk-bar-fill {
            height: 100%;
            border-radius: 4px;
        }
        
        .risk-percent {
            font-size: 14px;
            font-weight: 600;
            min-width: 50px;
            text-align: right;
        }
        
        /* Matrix table */
        .matrix-table th.sticky-col,
        .matrix-table td.sticky-col {
            position: sticky;
            left: 0;
            background-color: var(--mono-surface);
            z-index: 10;
            border-right: 2px solid var(--mono-border);
            min-width: 180px;
        }
        
        .matrix-table thead th.sticky-col {
            background-color: var(--mono-surface-2);
        }
        
        .matrix-cell-highlight {
            background: var(--mono-yellow-bg) !important;
        }
        
        /* Filter input */
        .filter-input {
            background: var(--mono-surface-2);
            border: 1px solid var(--mono-border);
            color: var(--mono-text);
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 14px;
            width: 80px;
        }
        
        .filter-input:focus {
            outline: none;
            border-color: var(--mono-green);
        }
        
        .filter-btn {
            background: var(--mono-green);
            border: none;
            color: var(--mono-bg);
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 14px;
            cursor: pointer;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--mono-surface);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--mono-surface-3);
            border-radius: 4px;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .stats-value {
                font-size: 24px;
            }
            
            .potential-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .section-body {
                padding: 12px;
            }
            
            .data-table td, .data-table th {
                padding: 10px 12px;
                font-size: 13px;
            }
            
            .page-title {
                font-size: 22px;
            }
        }
        
        /* Chart container */
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        
        /* Alerts/Notifications */
        .alert-card {
            background: var(--mono-surface);
            border-radius: var(--mono-radius);
            border: 1px solid var(--mono-border);
            margin-bottom: 24px;
            overflow: hidden;
        }
        
        .alert-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--mono-border);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .alert-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        
        .alert-icon.warning {
            background: var(--mono-orange-bg);
            color: var(--mono-orange);
        }
        
        .alert-icon.danger {
            background: var(--mono-red-bg);
            color: var(--mono-red);
        }
        
        .alert-icon.info {
            background: var(--mono-blue-bg);
            color: var(--mono-blue);
        }
        
        .alert-title {
            font-size: 16px;
            font-weight: 600;
        }
        
        .alert-subtitle {
            font-size: 13px;
            color: var(--mono-text-secondary);
        }
        
        .alert-body {
            padding: 16px 20px;
        }
        
        .alert-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 14px;
            background: var(--mono-surface-2);
            border-radius: 8px;
            margin-bottom: 8px;
        }
        
        .alert-item:last-child {
            margin-bottom: 0;
        }
        
        .alert-item-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .alert-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .alert-badge.red {
            background: var(--mono-red-bg);
            color: var(--mono-red);
        }
        
        .alert-badge.orange {
            background: var(--mono-orange-bg);
            color: var(--mono-orange);
        }
        
        .alert-badge.yellow {
            background: var(--mono-yellow-bg);
            color: var(--mono-yellow);
        }
        
        /* Export buttons */
        .export-buttons {
            display: flex;
            gap: 8px;
        }
        
        .btn-export {
            background: var(--mono-surface-2);
            border: 1px solid var(--mono-border);
            color: var(--mono-text);
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 14px;
            transition: all 0.2s;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .btn-export:hover {
            background: var(--mono-surface-3);
        }
        
        .btn-export.excel {
            border-color: #10B981;
        }
        
        .btn-export.excel:hover {
            background: rgba(16, 185, 129, 0.15);
        }
        
        @media print {
            @page {
                size: A4 landscape;
                margin: 0.5cm;
            }
            
            body {
                background: white !important;
                color: black !important;
            }
            
            .btn-pdf, .btn-export, .navbar, .export-buttons {
                display: none !important;
            }
            
            .stats-card, .section, .potential-card, .alert-card {
                background: white !important;
                border: 1px solid #ddd !important;
                color: black !important;
            }
            
            .chart-container {
                height: 250px !important;
            }
            
            .page-break {
                page-break-before: always;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <a class="navbar-brand" href="#" onclick="goBack(); return false;">
                <i class="bi bi-arrow-left"></i>
                –ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –Ω–∞ –∫–∞—Ä—Ç—É
            </a>
            <div class="export-buttons">
                <button class="btn-export excel" onclick="exportToExcel()">
                    <i class="bi bi-file-earmark-excel"></i>
                    <span class="d-none d-sm-inline">Excel</span>
                </button>
                <button class="btn-export" onclick="generatePDF()">
                    <i class="bi bi-file-pdf"></i>
                    <span class="d-none d-sm-inline">PDF</span>
                </button>
            </div>
        </div>
    </nav>

    <div class="container py-4">
        <h1 class="page-title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: <span id="councilName">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</span></h1>

        <!-- –°–ø–æ–≤—ñ—â–µ–Ω–Ω—è –ø—Ä–æ –¥–æ–≥–æ–≤–æ—Ä–∏ -->
        <div class="alert-card" id="alertsCard" style="display: none;">
            <div class="alert-header">
                <div class="alert-icon warning">
                    <i class="bi bi-bell"></i>
                </div>
                <div>
                    <div class="alert-title">–£–≤–∞–≥–∞! –ü–æ—Ç—Ä—ñ–±–Ω–∞ –¥—ñ—è</div>
                    <div class="alert-subtitle">–î–æ–≥–æ–≤–æ—Ä–∏, —è–∫—ñ –ø–æ—Ç—Ä–µ–±—É—é—Ç—å —É–≤–∞–≥–∏ –Ω–∞–π–±–ª–∏–∂—á–∏–º —á–∞—Å–æ–º</div>
                </div>
            </div>
            <div class="alert-body" id="alertsBody">
                <!-- –ó–∞–ø–æ–≤–Ω—é—î—Ç—å—Å—è –¥–∏–Ω–∞–º—ñ—á–Ω–æ -->
            </div>
        </div>

        <!-- –ü–æ—Ç–µ–Ω—Ü—ñ–∞–ª –¥–ª—è –Ω–æ–≤–∏—Ö –¥–æ–≥–æ–≤–æ—Ä—ñ–≤ -->
        <div class="potential-card" id="potentialCard">
            <div class="potential-header">
                <div class="potential-icon">
                    <i class="bi bi-graph-up-arrow"></i>
                </div>
                <div>
                    <div class="potential-title">–ü–æ—Ç–µ–Ω—Ü—ñ–∞–ª –¥–ª—è –Ω–æ–≤–∏—Ö –¥–æ–≥–æ–≤–æ—Ä—ñ–≤</div>
                    <div class="potential-subtitle">–î—ñ–ª—è–Ω–∫–∏, —è–∫—ñ –º–æ–∂–Ω–∞ –≤–∑—è—Ç–∏ –≤ –æ—Ä–µ–Ω–¥—É –∑–∞—Ä–∞–∑ –∞–±–æ –Ω–∞–π–±–ª–∏–∂—á–∏–º —á–∞—Å–æ–º</div>
                </div>
            </div>
            <div class="potential-grid" id="potentialGrid">
                <!-- –ó–∞–ø–æ–≤–Ω—é—î—Ç—å—Å—è –¥–∏–Ω–∞–º—ñ—á–Ω–æ -->
            </div>
        </div>

        <!-- –ì—Ä–∞—Ñ—ñ–∫–∏ -->
        <div class="row mb-4 g-3">
            <div class="col-lg-6">
                <div class="section">
                    <div class="section-header">
                        <div class="section-title">
                            <i class="bi bi-bar-chart"></i>
                            –î–∏–Ω–∞–º—ñ–∫–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –¥–æ–≥–æ–≤–æ—Ä—ñ–≤
                        </div>
                    </div>
                    <div class="section-body">
                        <div class="chart-container">
                            <canvas id="registrationChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="section">
                    <div class="section-header">
                        <div class="section-title">
                            <i class="bi bi-pie-chart"></i>
                            –†–æ–∑–ø–æ–¥—ñ–ª –ø–ª–æ—â—ñ –ø–æ –æ—Ä–µ–Ω–¥–∞—Ä—è—Ö
                        </div>
                    </div>
                    <div class="section-body">
                        <div class="chart-container">
                            <canvas id="tenantsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ó–∞–≥–∞–ª—å–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="row mb-4 g-3">
            <div class="col-md-3 col-6">
                <div class="stats-card">
                    <div class="stats-card-title">
                        <i class="bi bi-geo-alt"></i> –ó–∞–≥–∞–ª—å–Ω–∞ –ø–ª–æ—â–∞
                    </div>
                    <div class="stats-value" id="totalArea">0<span class="stats-value-unit">–≥–∞</span></div>
                    <div class="stats-subtitle"><span id="totalParcels">0</span> –¥—ñ–ª—è–Ω–æ–∫</div>
                </div>
            </div>
            <div class="col-md-3 col-6">
                <div class="stats-card">
                    <div class="stats-card-title">
                        <i class="bi bi-unlock"></i> –í—ñ–ª—å–Ω—ñ –≤—ñ–¥ –æ—Ä–µ–Ω–¥–∏
                    </div>
                    <div class="stats-value" style="color: var(--mono-yellow);" id="freeArea">0<span class="stats-value-unit">–≥–∞</span></div>
                    <div class="stats-subtitle"><span id="freeParcels">0</span> –¥—ñ–ª—è–Ω–æ–∫</div>
                </div>
            </div>
            <div class="col-md-3 col-6">
                <div class="stats-card">
                    <div class="stats-card-title">
                        <i class="bi bi-people"></i> –û—Ä–µ–Ω–¥–∞—Ä—ñ
                    </div>
                    <div class="stats-value" style="color: var(--mono-blue);" id="tenantsCount">0</div>
                    <div class="stats-subtitle">–∞–∫—Ç–∏–≤–Ω–∏—Ö –∫–æ–º–ø–∞–Ω—ñ–π</div>
                </div>
            </div>
            <div class="col-md-3 col-6">
                <div class="stats-card">
                    <div class="stats-card-title">
                        <i class="bi bi-cash-stack"></i> –ù–ì–û
                    </div>
                    <div class="stats-value" style="color: var(--mono-green);" id="totalNGO">0<span class="stats-value-unit">–≥—Ä–Ω</span></div>
                    <div class="stats-subtitle">–Ω–æ—Ä–º–∞—Ç–∏–≤–Ω–∞ –æ—Ü—ñ–Ω–∫–∞</div>
                </div>
            </div>
        </div>

        <!-- –ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü—ñ—è –æ—Ä–µ–Ω–¥–∞—Ä—ñ–≤ -->
        <div class="section mb-4">
            <div class="section-header">
                <div class="section-title">
                    <i class="bi bi-pie-chart"></i>
                    –ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü—ñ—è –æ—Ä–µ–Ω–¥–∞—Ä—ñ–≤ (—Ç–æ–ø-5)
                </div>
            </div>
            <div class="section-body" id="concentrationBody">
            </div>
        </div>

        <!-- –ü—Ä–æ–≥–Ω–æ–∑ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –¥–æ–≥–æ–≤–æ—Ä—ñ–≤ -->
        <div class="section mb-4">
            <div class="section-header">
                <div class="section-title">
                    <i class="bi bi-calendar-event"></i>
                    –ü—Ä–æ–≥–Ω–æ–∑ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –¥–æ–≥–æ–≤–æ—Ä—ñ–≤ (5 —Ä–æ–∫—ñ–≤)
                </div>
            </div>
            <div class="section-body">
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>–†—ñ–∫</th>
                                <th class="text-end">–î–æ–≥–æ–≤–æ—Ä—ñ–≤</th>
                                <th class="text-end">–ü–ª–æ—â–∞ (–≥–∞)</th>
                                <th class="text-end">% –≤—ñ–¥ –æ—Ä–µ–Ω–¥–æ–≤–∞–Ω–æ—ó</th>
                                <th style="width: 30%;">–†–æ–∑–ø–æ–¥—ñ–ª</th>
                            </tr>
                        </thead>
                        <tbody id="forecastTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó -->
        <div class="section mb-4 page-break">
            <div class="section-header">
                <div class="section-title">
                    <i class="bi bi-graph-up"></i>
                    –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –¥–æ–≥–æ–≤–æ—Ä—ñ–≤
                </div>
            </div>
            <div class="section-body">
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>–†—ñ–∫</th>
                                <th class="text-end">–í—Å—å–æ–≥–æ</th>
                                <th class="text-end">–ü–ª–æ—â–∞ (–≥–∞)</th>
                                <th class="text-end">–ê–∫—Ç–∏–≤–Ω—ñ / –ü–ª–æ—â–∞</th>
                                <th class="text-end">–ù–µ–∞–∫—Ç–∏–≤–Ω—ñ / –ü–ª–æ—â–∞</th>
                                <th style="width: 25%;">–†–æ–∑–ø–æ–¥—ñ–ª</th>
                            </tr>
                        </thead>
                        <tbody id="registrationTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- –¢–∞–±–ª–∏—Ü—è –æ—Ä–µ–Ω–¥–∞—Ä—ñ–≤ -->
        <div class="section mb-4">
            <div class="section-header">
                <div class="section-title">
                    <i class="bi bi-building"></i>
                    –û—Ä–µ–Ω–¥–∞—Ä—ñ
                </div>
            </div>
            <div class="section-body">
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>–û—Ä–µ–Ω–¥–∞—Ä</th>
                                <th class="text-end">–î—ñ–ª—è–Ω–æ–∫</th>
                                <th class="text-end">–ü–ª–æ—â–∞ (–≥–∞)</th>
                                <th class="text-end">% –ø–ª–æ—â—ñ</th>
                                <th class="text-end">–°–µ—Ä. –ø–ª–æ—â–∞</th>
                                <th class="text-end">–ù–ì–û (–≥—Ä–Ω)</th>
                            </tr>
                        </thead>
                        <tbody id="tenantsTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- –¢–∞–±–ª–∏—Ü—è –≤–ª–∞—Å–Ω–∏–∫—ñ–≤ -->
        <div class="section mb-4 page-break">
            <div class="section-header">
                <div class="section-title">
                    <i class="bi bi-person"></i>
                    –í–ª–∞—Å–Ω–∏–∫–∏
                </div>
                <div class="d-flex align-items-center gap-2">
                    <span style="font-size: 13px; color: var(--mono-text-secondary);">–ú—ñ–Ω. –¥—ñ–ª—è–Ω–æ–∫:</span>
                    <input type="number" class="filter-input" id="minParcelsFilter" value="3" min="1">
                    <button class="filter-btn" onclick="updateOwnersTable()">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
            </div>
            <div class="section-body">
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>–í–ª–∞—Å–Ω–∏–∫</th>
                                <th class="text-end">–î—ñ–ª—è–Ω–æ–∫</th>
                                <th class="text-end">–ü–ª–æ—â–∞ (–≥–∞)</th>
                                <th class="text-end">–°–µ—Ä. –ø–ª–æ—â–∞</th>
                            </tr>
                        </thead>
                        <tbody id="ownersTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- –ú–∞—Ç—Ä–∏—á–Ω–∞ —Ç–∞–±–ª–∏—Ü—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è -->
        <div class="section page-break">
            <div class="section-header">
                <div class="section-title">
                    <i class="bi bi-table"></i>
                    –ú–∞—Ç—Ä–∏—Ü—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –¥–æ–≥–æ–≤–æ—Ä—ñ–≤
                </div>
            </div>
            <div class="section-body">
                <div class="table-responsive">
                    <table class="data-table matrix-table">
                        <thead>
                            <tr id="matrixHeader">
                                <th class="sticky-col">–û—Ä–µ–Ω–¥–∞—Ä</th>
                            </tr>
                        </thead>
                        <tbody id="matrixTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Tenant colors
        const tenantColors = {};
        const colorPalette = [
            '#1B9688', '#E91E63', '#9C27B0', '#673AB7', '#3F51B5',
            '#2196F3', '#00BCD4', '#009688', '#4CAF50', '#8BC34A',
            '#CDDC39', '#FFC107', '#FF9800', '#FF5722', '#795548'
        ];
        let colorIndex = 0;
        
        function getColor(tenant) {
            if (!tenant) return '#3A3A3C';
            if (!tenantColors[tenant]) {
                tenantColors[tenant] = colorPalette[colorIndex % colorPalette.length];
                colorIndex++;
            }
            return tenantColors[tenant];
        }

        function getClientId() {
            const urlParams = new URLSearchParams(window.location.search);
            let id = urlParams.get('id');
            if (!id) {
                const storedId = localStorage.getItem('client_id');
                if (storedId) {
                    id = storedId;
                    const currentUrl = new URL(window.location);
                    currentUrl.searchParams.set('id', id);
                    window.history.replaceState({}, '', currentUrl);
                }
            }
            return id;
        }

        const urlParams = new URLSearchParams(window.location.search);
        const selectedFile = urlParams.get('file');
        const id = getClientId();
        const councilName = selectedFile ? selectedFile.replace('.geojson', '') : '–ù–µ –≤–∏–±—Ä–∞–Ω–æ';
        const dataPath = id ? `data/${id}/` : 'data/';

        let globalStats = null;
        const currentYear = new Date().getFullYear();

        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toFixed(0);
        }

        function generatePDF() {
            const opt = {
                margin: 0.5,
                filename: `–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞_${councilName}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'cm', format: 'a4', orientation: 'landscape' },
                pagebreak: { mode: ['avoid-all', 'css', 'legacy'], before: '.page-break' }
            };
            html2pdf().set(opt).from(document.body).save();
        }

        async function loadAndProcessData() {
            if (!selectedFile) {
                document.getElementById('councilName').textContent = '–§–∞–π–ª –Ω–µ –≤–∏–±—Ä–∞–Ω–æ';
                return;
            }

            try {
                document.getElementById('councilName').textContent = '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...';
                const response = await fetch(`${dataPath}${selectedFile}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const data = await response.json();
                document.getElementById('councilName').textContent = councilName;
                
                data.features = data.features.filter(f => f.properties.type === 'original');
                processData(data);
            } catch (error) {
                console.error('–ü–æ–º–∏–ª–∫–∞:', error);
                document.getElementById('councilName').textContent = '–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è';
            }
        }

        function processData(data) {
            const features = data.features;
            const uniqueOwners = new Set();
            
            const stats = features.reduce((acc, feature) => {
                const props = feature.properties;
                const area = parseFloat(props['–ü–ª–æ—â–∞ —Ä–æ–∑—Ä–∞—Ö–æ–≤–∞–Ω–∞'] || props['–ü–ª–æ—â–∞ –î–ó–ö'] || 0);
                const tenant = props['–û—Ä–µ–Ω–¥–∞—Ä'];
                const owner = props['–í–ª–∞—Å–Ω–∏–∫'];
                const expiryYear = props['–†—ñ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è'];
                const registrationDate = props['–î–∞—Ç–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó'];
                const ngo = parseFloat(String(props['–ù–ì–û'] || '0').replace(/\s/g, '')) || 0;

                acc.totalArea += area;
                acc.totalParcels++;
                acc.totalNGO += ngo;
                
                if (!tenant) {
                    acc.freeParcels++;
                    acc.freeArea += area;
                    acc.freeNGO += ngo;
                } else {
                    acc.rentedArea += area;
                }

                if (owner && owner.trim() !== '') {
                    uniqueOwners.add(owner);
                }

                // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó
                if (registrationDate) {
                    let year = extractYear(registrationDate);
                    if (year && year > 1990 && year <= currentYear) {
                        if (!acc.registrationYears[year]) {
                            acc.registrationYears[year] = { total: 0, totalArea: 0, active: 0, activeArea: 0, inactive: 0, inactiveArea: 0 };
                        }
                        acc.registrationYears[year].total++;
                        acc.registrationYears[year].totalArea += area;
                        if (tenant) {
                            acc.registrationYears[year].active++;
                            acc.registrationYears[year].activeArea += area;
                        } else {
                            acc.registrationYears[year].inactive++;
                            acc.registrationYears[year].inactiveArea += area;
                        }
                    }
                }

                // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –æ—Ä–µ–Ω–¥–∞—Ä—è—Ö
                if (tenant) {
                    if (!acc.tenants[tenant]) {
                        acc.tenants[tenant] = { count: 0, area: 0, ngo: 0 };
                    }
                    acc.tenants[tenant].count++;
                    acc.tenants[tenant].area += area;
                    acc.tenants[tenant].ngo += ngo;
                }

                // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≤–ª–∞—Å–Ω–∏–∫–∞—Ö
                if (owner) {
                    if (!acc.owners[owner]) {
                        acc.owners[owner] = { count: 0, area: 0 };
                    }
                    acc.owners[owner].count++;
                    acc.owners[owner].area += area;
                }

                // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ä–æ–∫–∞—Ö –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è
                if (tenant && expiryYear) {
                    const year = parseInt(expiryYear);
                    if (!isNaN(year)) {
                        if (!acc.expiryYears[year]) {
                            acc.expiryYears[year] = { count: 0, area: 0, tenants: {} };
                        }
                        if (!acc.expiryYears[year].tenants[tenant]) {
                            acc.expiryYears[year].tenants[tenant] = { count: 0, area: 0 };
                        }
                        acc.expiryYears[year].count++;
                        acc.expiryYears[year].area += area;
                        acc.expiryYears[year].tenants[tenant].count++;
                        acc.expiryYears[year].tenants[tenant].area += area;
                    }
                }

                return acc;
            }, {
                totalArea: 0, totalParcels: 0, freeParcels: 0, freeArea: 0, freeNGO: 0,
                rentedArea: 0, totalNGO: 0, tenants: {}, owners: {}, expiryYears: {}, registrationYears: {}
            });

            stats.uniqueOwnersCount = uniqueOwners.size;
            globalStats = stats;
            updateUI(stats);
        }

        function extractYear(dateStr) {
            if (!dateStr) return null;
            if (dateStr.includes('.')) return parseInt(dateStr.split('.')[2]);
            if (dateStr.includes('/')) return parseInt(dateStr.split('/')[2]);
            if (dateStr.length === 4) return parseInt(dateStr);
            const match = dateStr.match(/\d{4}/);
            return match ? parseInt(match[0]) : null;
        }

        function updateUI(stats) {
            document.getElementById('totalArea').innerHTML = `${stats.totalArea.toFixed(0)}<span class="stats-value-unit">–≥–∞</span>`;
            document.getElementById('totalParcels').textContent = stats.totalParcels;
            document.getElementById('freeArea').innerHTML = `${stats.freeArea.toFixed(0)}<span class="stats-value-unit">–≥–∞</span>`;
            document.getElementById('freeParcels').textContent = stats.freeParcels;
            document.getElementById('tenantsCount').textContent = Object.keys(stats.tenants).length;
            document.getElementById('totalNGO').innerHTML = `${formatNumber(stats.totalNGO)}<span class="stats-value-unit">–≥—Ä–Ω</span>`;

            updateAlerts(stats, null);
            updatePotentialCard(stats);
            updateConcentration(stats);
            updateForecastTable(stats);
            updateRegistrationTable(stats.registrationYears);
            updateTenantsTable(stats);
            updateOwnersTable();
            updateMatrixTable(stats.expiryYears, stats.tenants);
            updateRegistrationChart(stats.registrationYears);
            updateTenantsChart(stats.tenants, stats.totalArea);
        }

        function updatePotentialCard(stats) {
            const grid = document.getElementById('potentialGrid');
            let html = '';
            
            html += `
                <div class="potential-item">
                    <div class="potential-item-label">üü¢ –í—ñ–ª—å–Ω—ñ –∑–∞—Ä–∞–∑</div>
                    <div class="potential-item-value" style="color: var(--mono-green);">${stats.freeParcels}</div>
                    <div class="potential-item-detail">${stats.freeArea.toFixed(1)} –≥–∞</div>
                </div>`;
            
            let cumulativeCount = stats.freeParcels;
            let cumulativeArea = stats.freeArea;
            
            // –ü—Ä–æ—Å—Ç—Ä–æ—á–µ–Ω—ñ
            let expiredCount = 0, expiredArea = 0;
            Object.entries(stats.expiryYears).forEach(([year, data]) => {
                if (parseInt(year) < currentYear) {
                    expiredCount += data.count;
                    expiredArea += data.area;
                }
            });
            
            if (expiredCount > 0) {
                cumulativeCount += expiredCount;
                cumulativeArea += expiredArea;
                html += `
                    <div class="potential-item">
                        <div class="potential-item-label">üî¥ –ü—Ä–æ—Å—Ç—Ä–æ—á–µ–Ω—ñ</div>
                        <div class="potential-item-value" style="color: var(--mono-red);">${expiredCount}</div>
                        <div class="potential-item-detail">${expiredArea.toFixed(1)} –≥–∞</div>
                    </div>`;
            }
            
            for (let year = currentYear; year <= currentYear + 2; year++) {
                const yearData = stats.expiryYears[year] || { count: 0, area: 0 };
                cumulativeCount += yearData.count;
                cumulativeArea += yearData.area;
                
                const isCurrent = year === currentYear;
                const color = isCurrent ? 'var(--mono-yellow)' : 'var(--mono-text)';
                const icon = isCurrent ? 'üü°' : 'üìÖ';
                
                html += `
                    <div class="potential-item">
                        <div class="potential-item-label">${icon} ${isCurrent ? '–¶—å–æ–≥–æ —Ä–æ–∫—É' : year}</div>
                        <div class="potential-item-value" style="color: ${color};">${yearData.count}</div>
                        <div class="potential-item-detail">${yearData.area.toFixed(1)} –≥–∞</div>
                    </div>`;
            }
            
            html += `
                <div class="potential-item" style="border-color: var(--mono-green);">
                    <div class="potential-item-label">üéØ –í—Å—å–æ–≥–æ –ø–æ—Ç–µ–Ω—Ü—ñ–∞–ª</div>
                    <div class="potential-item-value" style="color: var(--mono-green);">${cumulativeCount}</div>
                    <div class="potential-item-detail">${cumulativeArea.toFixed(1)} –≥–∞</div>
                </div>`;
            
            grid.innerHTML = html;
        }

        function updateConcentration(stats) {
            const container = document.getElementById('concentrationBody');
            const sorted = Object.entries(stats.tenants).sort((a, b) => b[1].area - a[1].area).slice(0, 5);
            
            let html = '';
            sorted.forEach(([tenant, data]) => {
                const percent = stats.rentedArea > 0 ? (data.area / stats.rentedArea * 100).toFixed(1) : 0;
                const color = getColor(tenant);
                
                html += `
                    <div class="risk-indicator">
                        <span class="tenant-indicator" style="background-color: ${color};"></span>
                        <span style="flex: 1; font-size: 14px; color: ${color};">${tenant}</span>
                        <div class="risk-bar">
                            <div class="risk-bar-fill" style="width: ${percent}%; background-color: ${color};"></div>
                        </div>
                        <span class="risk-percent">${percent}%</span>
                    </div>`;
            });
            
            container.innerHTML = html || '<p style="color: var(--mono-text-secondary);">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö</p>';
        }

        function updateForecastTable(stats) {
            const tbody = document.getElementById('forecastTableBody');
            let html = '';
            let totalCount = 0, totalArea = 0;
            
            // –ü—Ä–æ—Å—Ç—Ä–æ—á–µ–Ω—ñ
            let expiredCount = 0, expiredArea = 0;
            Object.entries(stats.expiryYears).forEach(([year, data]) => {
                if (parseInt(year) < currentYear) {
                    expiredCount += data.count;
                    expiredArea += data.area;
                }
            });
            
            if (expiredCount > 0) {
                const percent = stats.rentedArea > 0 ? (expiredArea / stats.rentedArea * 100).toFixed(1) : 0;
                html += `
                    <tr>
                        <td class="year-expired">‚ö†Ô∏è –ü—Ä–æ—Å—Ç—Ä–æ—á–µ–Ω—ñ</td>
                        <td class="text-end">${expiredCount}</td>
                        <td class="text-end">${expiredArea.toFixed(1)}</td>
                        <td class="text-end">${percent}%</td>
                        <td>
                            <div class="progress-bar-container">
                                <div class="progress-bar-fill">
                                    <div class="progress-bar-segment" style="width: ${percent}%; background: var(--mono-red);"></div>
                                </div>
                            </div>
                        </td>
                    </tr>`;
                totalCount += expiredCount;
                totalArea += expiredArea;
            }
            
            for (let year = currentYear; year <= currentYear + 5; year++) {
                const yearData = stats.expiryYears[year] || { count: 0, area: 0 };
                const percent = stats.rentedArea > 0 ? (yearData.area / stats.rentedArea * 100).toFixed(1) : 0;
                
                totalCount += yearData.count;
                totalArea += yearData.area;
                
                const yearClass = year === currentYear ? 'year-current' : 'year-future';
                const barColor = year === currentYear ? 'var(--mono-yellow)' : 'var(--mono-green)';
                
                html += `
                    <tr>
                        <td class="${yearClass}">${year}</td>
                        <td class="text-end">${yearData.count}</td>
                        <td class="text-end">${yearData.area.toFixed(1)}</td>
                        <td class="text-end">${percent}%</td>
                        <td>
                            <div class="progress-bar-container">
                                <div class="progress-bar-fill">
                                    <div class="progress-bar-segment" style="width: ${percent}%; background: ${barColor};"></div>
                                </div>
                            </div>
                        </td>
                    </tr>`;
            }
            
            const totalPercent = stats.rentedArea > 0 ? (totalArea / stats.rentedArea * 100).toFixed(1) : 0;
            html += `
                <tr class="total-row">
                    <td>–í—Å—å–æ–≥–æ</td>
                    <td class="text-end">${totalCount}</td>
                    <td class="text-end">${totalArea.toFixed(1)}</td>
                    <td class="text-end">${totalPercent}%</td>
                    <td></td>
                </tr>`;
            
            tbody.innerHTML = html;
        }

        function updateRegistrationTable(registrationYears) {
            const tbody = document.getElementById('registrationTableBody');
            const years = Object.keys(registrationYears).sort((a, b) => a - b);
            
            let html = '';
            let totals = { total: 0, totalArea: 0, active: 0, activeArea: 0, inactive: 0, inactiveArea: 0 };
            
            years.forEach(year => {
                const d = registrationYears[year];
                Object.keys(totals).forEach(k => totals[k] += d[k] || 0);
                
                const activePercent = d.total > 0 ? (d.active / d.total * 100).toFixed(0) : 0;
                const inactivePercent = d.total > 0 ? (d.inactive / d.total * 100).toFixed(0) : 0;
                
                html += `
                    <tr>
                        <td>${year}</td>
                        <td class="text-end">${d.total}</td>
                        <td class="text-end">${d.totalArea.toFixed(1)}</td>
                        <td class="text-end">${d.active} / ${d.activeArea.toFixed(1)}</td>
                        <td class="text-end">${d.inactive} / ${d.inactiveArea.toFixed(1)}</td>
                        <td>
                            <div class="progress-bar-container">
                                <div class="progress-bar-fill">
                                    <div class="progress-bar-segment" style="width: ${activePercent}%; background: var(--mono-green);"></div>
                                    <div class="progress-bar-segment" style="width: ${inactivePercent}%; background: var(--mono-red);"></div>
                                </div>
                                <span class="progress-bar-text">${activePercent}% / ${inactivePercent}%</span>
                            </div>
                        </td>
                    </tr>`;
            });
            
            const activePercent = totals.total > 0 ? (totals.active / totals.total * 100).toFixed(0) : 0;
            const inactivePercent = totals.total > 0 ? (totals.inactive / totals.total * 100).toFixed(0) : 0;
            
            html += `
                <tr class="total-row">
                    <td>–í—Å—å–æ–≥–æ</td>
                    <td class="text-end">${totals.total}</td>
                    <td class="text-end">${totals.totalArea.toFixed(1)}</td>
                    <td class="text-end">${totals.active} / ${totals.activeArea.toFixed(1)}</td>
                    <td class="text-end">${totals.inactive} / ${totals.inactiveArea.toFixed(1)}</td>
                    <td>
                        <div class="progress-bar-container">
                            <div class="progress-bar-fill">
                                <div class="progress-bar-segment" style="width: ${activePercent}%; background: var(--mono-green);"></div>
                                <div class="progress-bar-segment" style="width: ${inactivePercent}%; background: var(--mono-red);"></div>
                            </div>
                            <span class="progress-bar-text">${activePercent}% / ${inactivePercent}%</span>
                        </div>
                    </td>
                </tr>`;
            
            tbody.innerHTML = html;
        }

        function updateTenantsTable(stats) {
            const tbody = document.getElementById('tenantsTableBody');
            const sorted = Object.entries(stats.tenants).sort((a, b) => b[1].area - a[1].area);
            
            let html = '';
            sorted.forEach(([tenant, data]) => {
                const percent = (data.area / stats.totalArea * 100).toFixed(1);
                const avgArea = (data.area / data.count).toFixed(2);
                const color = getColor(tenant);
                
                html += `
                    <tr>
                        <td>
                            <span class="tenant-indicator" style="background-color: ${color};"></span>
                            <span style="color: ${color}; font-weight: 500;">${tenant}</span>
                        </td>
                        <td class="text-end">${data.count}</td>
                        <td class="text-end">${data.area.toFixed(2)}</td>
                        <td class="text-end">${percent}%</td>
                        <td class="text-end">${avgArea}</td>
                        <td class="text-end">${formatNumber(data.ngo)}</td>
                    </tr>`;
            });
            
            tbody.innerHTML = html || '<tr><td colspan="6" style="text-align: center; color: var(--mono-text-secondary);">–ù–µ–º–∞—î –æ—Ä–µ–Ω–¥–∞—Ä—ñ–≤</td></tr>';
        }

        function updateOwnersTable() {
            if (!globalStats) return;
            
            const minParcels = parseInt(document.getElementById('minParcelsFilter').value) || 3;
            const tbody = document.getElementById('ownersTableBody');
            const sorted = Object.entries(globalStats.owners)
                .filter(([_, data]) => data.count >= minParcels)
                .sort((a, b) => b[1].area - a[1].area);
            
            let html = '';
            sorted.forEach(([name, data]) => {
                const avgArea = (data.area / data.count).toFixed(2);
                html += `
                    <tr>
                        <td>${name}</td>
                        <td class="text-end">${data.count}</td>
                        <td class="text-end">${data.area.toFixed(2)}</td>
                        <td class="text-end">${avgArea}</td>
                    </tr>`;
            });
            
            tbody.innerHTML = html || '<tr><td colspan="4" style="text-align: center; color: var(--mono-text-secondary);">–ù–µ–º–∞—î –≤–ª–∞—Å–Ω–∏–∫—ñ–≤ –∑ —Ç–∞–∫–æ—é –∫—ñ–ª—å–∫—ñ—Å—Ç—é –¥—ñ–ª—è–Ω–æ–∫</td></tr>';
        }

        function updateMatrixTable(expiryYears, tenants) {
            const years = Object.keys(expiryYears).sort((a, b) => a - b).filter(y => parseInt(y) >= currentYear - 2);
            const header = document.getElementById('matrixHeader');
            const tbody = document.getElementById('matrixTableBody');
            
            let headerHtml = '<th class="sticky-col">–û—Ä–µ–Ω–¥–∞—Ä</th>';
            years.forEach(year => {
                const yearClass = parseInt(year) < currentYear ? 'year-expired' : (parseInt(year) === currentYear ? 'year-current' : 'year-future');
                headerHtml += `<th class="text-end ${yearClass}">${year}</th>`;
            });
            headerHtml += '<th class="text-end">–í—Å—å–æ–≥–æ</th>';
            header.innerHTML = headerHtml;
            
            let html = '';
            const yearTotals = {};
            years.forEach(y => yearTotals[y] = 0);
            
            Object.entries(tenants)
                .sort((a, b) => b[1].area - a[1].area)
                .forEach(([tenant, data]) => {
                    const color = getColor(tenant);
                    let rowTotal = 0;
                    
                    html += `<tr><td class="sticky-col"><span class="tenant-indicator" style="background-color: ${color};"></span><span style="color: ${color};">${tenant}</span></td>`;
                    
                    years.forEach(year => {
                        const areaForYear = expiryYears[year]?.tenants?.[tenant]?.area || 0;
                        yearTotals[year] += areaForYear;
                        rowTotal += areaForYear;
                        
                        const highlight = areaForYear > 0 ? 'matrix-cell-highlight' : '';
                        html += `<td class="text-end ${highlight}">${areaForYear > 0 ? areaForYear.toFixed(1) : '-'}</td>`;
                    });
                    
                    html += `<td class="text-end" style="font-weight: 600;">${rowTotal > 0 ? rowTotal.toFixed(1) : '-'}</td></tr>`;
                });
            
            let grandTotal = 0;
            html += '<tr class="total-row"><td class="sticky-col">–í—Å—å–æ–≥–æ</td>';
            years.forEach(year => {
                grandTotal += yearTotals[year];
                html += `<td class="text-end">${yearTotals[year] > 0 ? yearTotals[year].toFixed(1) : '-'}</td>`;
            });
            html += `<td class="text-end">${grandTotal.toFixed(1)}</td></tr>`;
            
            tbody.innerHTML = html;
        }

        // ========== –ù–û–í–Ü –§–£–ù–ö–¶–Ü–á ==========
        
        // –ì—Ä–∞—Ñ—ñ–∫ –¥–∏–Ω–∞–º—ñ–∫–∏ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó
        let registrationChartInstance = null;
        let tenantsChartInstance = null;
        
        function updateRegistrationChart(registrationYears) {
            const ctx = document.getElementById('registrationChart');
            if (!ctx) return;
            
            const years = Object.keys(registrationYears).sort((a, b) => a - b);
            const activeData = years.map(y => registrationYears[y].active || 0);
            const inactiveData = years.map(y => registrationYears[y].inactive || 0);
            
            if (registrationChartInstance) {
                registrationChartInstance.destroy();
            }
            
            registrationChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: years,
                    datasets: [
                        {
                            label: '–ê–∫—Ç–∏–≤–Ω—ñ',
                            data: activeData,
                            backgroundColor: 'rgba(16, 185, 129, 0.7)',
                            borderColor: '#10B981',
                            borderWidth: 1
                        },
                        {
                            label: '–ù–µ–∞–∫—Ç–∏–≤–Ω—ñ',
                            data: inactiveData,
                            backgroundColor: 'rgba(239, 68, 68, 0.7)',
                            borderColor: '#EF4444',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: { color: '#8E8E93', font: { size: 12 } }
                        }
                    },
                    scales: {
                        x: {
                            stacked: true,
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { color: '#8E8E93' }
                        },
                        y: {
                            stacked: true,
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { color: '#8E8E93' }
                        }
                    }
                }
            });
        }
        
        function updateTenantsChart(tenants, totalArea) {
            const ctx = document.getElementById('tenantsChart');
            if (!ctx) return;
            
            const sorted = Object.entries(tenants).sort((a, b) => b[1].area - a[1].area);
            const top5 = sorted.slice(0, 5);
            const othersArea = sorted.slice(5).reduce((sum, [_, d]) => sum + d.area, 0);
            
            const labels = top5.map(([name, _]) => name.length > 20 ? name.substring(0, 20) + '...' : name);
            const data = top5.map(([_, d]) => d.area);
            const colors = top5.map(([name, _]) => getColor(name));
            
            if (othersArea > 0) {
                labels.push('–Ü–Ω—à—ñ');
                data.push(othersArea);
                colors.push('#636366');
            }
            
            if (tenantsChartInstance) {
                tenantsChartInstance.destroy();
            }
            
            tenantsChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderColor: '#1C1C1E',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: '#8E8E93',
                                font: { size: 11 },
                                boxWidth: 12,
                                padding: 8
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const percent = (value / totalArea * 100).toFixed(1);
                                    return `${context.label}: ${value.toFixed(1)} –≥–∞ (${percent}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // –°–ø–æ–≤—ñ—â–µ–Ω–Ω—è –ø—Ä–æ –¥–æ–≥–æ–≤–æ—Ä–∏
        function updateAlerts(stats, features) {
            const alertsCard = document.getElementById('alertsCard');
            const alertsBody = document.getElementById('alertsBody');
            
            const today = new Date();
            const alerts = [];
            
            // –ü—Ä–æ—Å—Ç—Ä–æ—á–µ–Ω—ñ –¥–æ–≥–æ–≤–æ—Ä–∏
            let expiredCount = 0;
            let expiredArea = 0;
            Object.entries(stats.expiryYears).forEach(([year, data]) => {
                if (parseInt(year) < currentYear) {
                    expiredCount += data.count;
                    expiredArea += data.area;
                }
            });
            
            if (expiredCount > 0) {
                alerts.push({
                    type: 'red',
                    icon: 'exclamation-triangle',
                    title: '–ü—Ä–æ—Å—Ç—Ä–æ—á–µ–Ω—ñ –¥–æ–≥–æ–≤–æ—Ä–∏',
                    count: expiredCount,
                    area: expiredArea.toFixed(1),
                    description: '–¢–µ—Ä–º—ñ–Ω –æ—Ä–µ–Ω–¥–∏ –≤–∂–µ –∑–∞–∫—ñ–Ω—á–∏–≤—Å—è'
                });
            }
            
            // –î–æ–≥–æ–≤–æ—Ä–∏ —Ü—å–æ–≥–æ —Ä–æ–∫—É
            const thisYearData = stats.expiryYears[currentYear] || { count: 0, area: 0 };
            if (thisYearData.count > 0) {
                alerts.push({
                    type: 'orange',
                    icon: 'clock-history',
                    title: `–ó–∞–∫—ñ–Ω—á—É—é—Ç—å—Å—è —É ${currentYear}`,
                    count: thisYearData.count,
                    area: thisYearData.area.toFixed(1),
                    description: '–ü–æ—Ç—Ä—ñ–±–Ω–æ –ø—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ –∞–±–æ –ø–µ—Ä–µ—É–∫–ª–∞—Å—Ç–∏'
                });
            }
            
            // –î–æ–≥–æ–≤–æ—Ä–∏ –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ —Ä–æ–∫—É
            const nextYearData = stats.expiryYears[currentYear + 1] || { count: 0, area: 0 };
            if (nextYearData.count > 0) {
                alerts.push({
                    type: 'yellow',
                    icon: 'calendar-event',
                    title: `–ó–∞–∫—ñ–Ω—á—É—é—Ç—å—Å—è —É ${currentYear + 1}`,
                    count: nextYearData.count,
                    area: nextYearData.area.toFixed(1),
                    description: '–ü—ñ–¥–≥–æ—Ç—É–π—Ç–µ—Å—è –∑–∞–∑–¥–∞–ª–µ–≥—ñ–¥—å'
                });
            }
            
            // –í—ñ–ª—å–Ω—ñ –¥—ñ–ª—è–Ω–∫–∏
            if (stats.freeParcels > 0) {
                alerts.push({
                    type: 'yellow',
                    icon: 'unlock',
                    title: '–í—ñ–ª—å–Ω—ñ –≤—ñ–¥ –æ—Ä–µ–Ω–¥–∏',
                    count: stats.freeParcels,
                    area: stats.freeArea.toFixed(1),
                    description: '–ú–æ–∂–Ω–∞ —É–∫–ª–∞—Å—Ç–∏ –Ω–æ–≤—ñ –¥–æ–≥–æ–≤–æ—Ä–∏'
                });
            }
            
            if (alerts.length === 0) {
                alertsCard.style.display = 'none';
                return;
            }
            
            alertsCard.style.display = 'block';
            
            let html = '';
            alerts.forEach(alert => {
                html += `
                    <div class="alert-item">
                        <div class="alert-item-left">
                            <i class="bi bi-${alert.icon}" style="font-size: 18px; color: var(--mono-${alert.type === 'red' ? 'red' : (alert.type === 'orange' ? 'orange' : 'yellow')});"></i>
                            <div>
                                <div style="font-weight: 500;">${alert.title}</div>
                                <div style="font-size: 12px; color: var(--mono-text-secondary);">${alert.description}</div>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <span class="alert-badge ${alert.type}">${alert.count} –¥—ñ–ª—è–Ω–æ–∫</span>
                            <div style="font-size: 12px; color: var(--mono-text-secondary); margin-top: 2px;">${alert.area} –≥–∞</div>
                        </div>
                    </div>`;
            });
            
            alertsBody.innerHTML = html;
        }
        
        // –ï–∫—Å–ø–æ—Ä—Ç –≤ Excel
        function exportToExcel() {
            if (!globalStats) {
                alert('–î–∞–Ω—ñ —â–µ –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ');
                return;
            }
            
            const wb = XLSX.utils.book_new();
            
            // –õ–∏—Å—Ç 1: –ó–∞–≥–∞–ª—å–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            const summaryData = [
                ['–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ä–∞–¥—ñ:', councilName],
                ['–î–∞—Ç–∞ –∑–≤—ñ—Ç—É:', new Date().toLocaleDateString('uk-UA')],
                [''],
                ['–ü–æ–∫–∞–∑–Ω–∏–∫', '–ó–Ω–∞—á–µ–Ω–Ω—è'],
                ['–ó–∞–≥–∞–ª—å–Ω–∞ –ø–ª–æ—â–∞ (–≥–∞)', globalStats.totalArea.toFixed(2)],
                ['–ö—ñ–ª—å–∫—ñ—Å—Ç—å –¥—ñ–ª—è–Ω–æ–∫', globalStats.totalParcels],
                ['–í—ñ–ª—å–Ω—ñ –≤—ñ–¥ –æ—Ä–µ–Ω–¥–∏ (–≥–∞)', globalStats.freeArea.toFixed(2)],
                ['–ö—ñ–ª—å–∫—ñ—Å—Ç—å –≤—ñ–ª—å–Ω–∏—Ö –¥—ñ–ª—è–Ω–æ–∫', globalStats.freeParcels],
                ['–ö—ñ–ª—å–∫—ñ—Å—Ç—å –æ—Ä–µ–Ω–¥–∞—Ä—ñ–≤', Object.keys(globalStats.tenants).length],
                ['–ù–ì–û (–≥—Ä–Ω)', globalStats.totalNGO.toFixed(0)]
            ];
            const ws1 = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, ws1, '–ó–∞–≥–∞–ª—å–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞');
            
            // –õ–∏—Å—Ç 2: –û—Ä–µ–Ω–¥–∞—Ä—ñ
            const tenantsData = [['–û—Ä–µ–Ω–¥–∞—Ä', '–ö—ñ–ª—å–∫—ñ—Å—Ç—å –¥—ñ–ª—è–Ω–æ–∫', '–ü–ª–æ—â–∞ (–≥–∞)', '% –ø–ª–æ—â—ñ', '–°–µ—Ä–µ–¥–Ω—è –ø–ª–æ—â–∞', '–ù–ì–û (–≥—Ä–Ω)']];
            Object.entries(globalStats.tenants)
                .sort((a, b) => b[1].area - a[1].area)
                .forEach(([name, data]) => {
                    tenantsData.push([
                        name,
                        data.count,
                        data.area.toFixed(2),
                        (data.area / globalStats.totalArea * 100).toFixed(1) + '%',
                        (data.area / data.count).toFixed(2),
                        data.ngo.toFixed(0)
                    ]);
                });
            const ws2 = XLSX.utils.aoa_to_sheet(tenantsData);
            XLSX.utils.book_append_sheet(wb, ws2, '–û—Ä–µ–Ω–¥–∞—Ä—ñ');
            
            // –õ–∏—Å—Ç 3: –ü—Ä–æ–≥–Ω–æ–∑ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è
            const forecastData = [['–†—ñ–∫', '–ö—ñ–ª—å–∫—ñ—Å—Ç—å –¥–æ–≥–æ–≤–æ—Ä—ñ–≤', '–ü–ª–æ—â–∞ (–≥–∞)', '% –≤—ñ–¥ –æ—Ä–µ–Ω–¥–æ–≤–∞–Ω–æ—ó']];
            
            // –ü—Ä–æ—Å—Ç—Ä–æ—á–µ–Ω—ñ
            let expiredCount = 0, expiredArea = 0;
            Object.entries(globalStats.expiryYears).forEach(([year, data]) => {
                if (parseInt(year) < currentYear) {
                    expiredCount += data.count;
                    expiredArea += data.area;
                }
            });
            if (expiredCount > 0) {
                forecastData.push(['–ü—Ä–æ—Å—Ç—Ä–æ—á–µ–Ω—ñ', expiredCount, expiredArea.toFixed(2), 
                    (expiredArea / globalStats.rentedArea * 100).toFixed(1) + '%']);
            }
            
            for (let year = currentYear; year <= currentYear + 5; year++) {
                const yearData = globalStats.expiryYears[year] || { count: 0, area: 0 };
                forecastData.push([
                    year,
                    yearData.count,
                    yearData.area.toFixed(2),
                    globalStats.rentedArea > 0 ? (yearData.area / globalStats.rentedArea * 100).toFixed(1) + '%' : '0%'
                ]);
            }
            const ws3 = XLSX.utils.aoa_to_sheet(forecastData);
            XLSX.utils.book_append_sheet(wb, ws3, '–ü—Ä–æ–≥–Ω–æ–∑ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è');
            
            // –õ–∏—Å—Ç 4: –ú–∞—Ç—Ä–∏—Ü—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è
            const years = Object.keys(globalStats.expiryYears).sort((a, b) => a - b).filter(y => parseInt(y) >= currentYear - 2);
            const matrixData = [['–û—Ä–µ–Ω–¥–∞—Ä', ...years, '–í—Å—å–æ–≥–æ']];
            
            Object.entries(globalStats.tenants)
                .sort((a, b) => b[1].area - a[1].area)
                .forEach(([tenant, data]) => {
                    const row = [tenant];
                    let rowTotal = 0;
                    years.forEach(year => {
                        const areaForYear = globalStats.expiryYears[year]?.tenants?.[tenant]?.area || 0;
                        row.push(areaForYear > 0 ? areaForYear.toFixed(1) : '-');
                        rowTotal += areaForYear;
                    });
                    row.push(rowTotal > 0 ? rowTotal.toFixed(1) : '-');
                    matrixData.push(row);
                });
            const ws4 = XLSX.utils.aoa_to_sheet(matrixData);
            XLSX.utils.book_append_sheet(wb, ws4, '–ú–∞—Ç—Ä–∏—Ü—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è');
            
            // –õ–∏—Å—Ç 5: –í–ª–∞—Å–Ω–∏–∫–∏
            const ownersData = [['–í–ª–∞—Å–Ω–∏–∫', '–ö—ñ–ª—å–∫—ñ—Å—Ç—å –¥—ñ–ª—è–Ω–æ–∫', '–ü–ª–æ—â–∞ (–≥–∞)', '–°–µ—Ä–µ–¥–Ω—è –ø–ª–æ—â–∞']];
            Object.entries(globalStats.owners)
                .sort((a, b) => b[1].area - a[1].area)
                .forEach(([name, data]) => {
                    ownersData.push([
                        name,
                        data.count,
                        data.area.toFixed(2),
                        (data.area / data.count).toFixed(2)
                    ]);
                });
            const ws5 = XLSX.utils.aoa_to_sheet(ownersData);
            XLSX.utils.book_append_sheet(wb, ws5, '–í–ª–∞—Å–Ω–∏–∫–∏');
            
            // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Ñ–∞–π–ª
            XLSX.writeFile(wb, `–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞_${councilName}.xlsx`);
        }

        function goBack() {
            let returnUrl = 'index.html';
            if (id) returnUrl += `?id=${id}`;
            if (selectedFile) {
                returnUrl += id ? '&' : '?';
                returnUrl += `return_file=${encodeURIComponent(selectedFile)}`;
            }
            window.location.href = returnUrl;
        }

        document.addEventListener('DOMContentLoaded', loadAndProcessData);
    </script>
</body>
</html>
