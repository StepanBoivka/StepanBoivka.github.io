<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–µ–º–µ–ª—å–Ω–∏—Ö –¥—ñ–ª—è–Ω–æ–∫</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --mono-bg: #000000;
            --mono-surface: #1C1C1E;
            --mono-surface-2: #2C2C2E;
            --mono-surface-3: #3A3A3C;
            --mono-border: rgba(255, 255, 255, 0.08);
            --mono-text: #FFFFFF;
            --mono-text-secondary: #8E8E93;
            --mono-text-muted: #636366;
            --mono-green: #10B981;
            --mono-green-bg: rgba(16, 185, 129, 0.15);
            --mono-red: #EF4444;
            --mono-red-bg: rgba(239, 68, 68, 0.15);
            --mono-yellow: #F59E0B;
            --mono-yellow-bg: rgba(245, 158, 11, 0.15);
            --mono-blue: #3B82F6;
            --mono-blue-bg: rgba(59, 130, 246, 0.15);
            --mono-orange: #F97316;
            --mono-orange-bg: rgba(249, 115, 22, 0.15);
            --mono-radius: 12px;
            --mono-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }
        
        * {
            box-sizing: border-box;
        }
        
        body {
            background: var(--mono-bg);
            color: var(--mono-text);
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
            min-height: 100vh;
        }
        
        /* Navbar */
        .navbar {
            background: var(--mono-surface) !important;
            border-bottom: 1px solid var(--mono-border);
            padding: 12px 0;
        }
        
        .navbar-brand {
            color: var(--mono-text) !important;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-pdf {
            background: var(--mono-surface-2);
            border: 1px solid var(--mono-border);
            color: var(--mono-text);
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .btn-pdf:hover {
            background: var(--mono-surface-3);
            color: var(--mono-text);
        }
        
        /* Page title */
        .page-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 24px;
            color: var(--mono-text);
        }
        
        .page-title span {
            color: var(--mono-green);
        }
        
        /* Stats Cards */
        .stats-card {
            background: var(--mono-surface);
            border-radius: var(--mono-radius);
            padding: 20px;
            border: 1px solid var(--mono-border);
            height: 100%;
        }
        
        .stats-card-title {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--mono-text-secondary);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .stats-value {
            font-size: 32px;
            font-weight: 700;
            line-height: 1.2;
            margin-top: 8px;
        }
        
        .stats-value-unit {
            font-size: 16px;
            font-weight: 400;
            color: var(--mono-text-secondary);
            margin-left: 4px;
        }
        
        .stats-subtitle {
            font-size: 13px;
            color: var(--mono-text-secondary);
            margin-top: 4px;
        }
        
        /* Section */
        .section {
            background: var(--mono-surface);
            border-radius: var(--mono-radius);
            border: 1px solid var(--mono-border);
            margin-bottom: 24px;
            overflow: hidden;
        }
        
        .section-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--mono-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 12px;
        }
        
        .section-title {
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .section-title i {
            color: var(--mono-green);
        }
        
        .section-body {
            padding: 20px;
        }
        
        /* Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table th {
            background: var(--mono-surface-2);
            color: var(--mono-text-secondary);
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--mono-border);
        }
        
        .data-table th.text-end {
            text-align: right;
        }
        
        .data-table td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--mono-border);
            font-size: 14px;
            color: var(--mono-text);
        }
        
        .data-table td.text-end {
            text-align: right;
        }
        
        .data-table tbody tr:hover {
            background: var(--mono-surface-2);
        }
        
        .data-table tbody tr:last-child td {
            border-bottom: none;
        }
        
        .data-table .total-row {
            background: var(--mono-surface-2);
            font-weight: 600;
        }
        
        .data-table .total-row td {
            border-top: 2px solid var(--mono-border);
        }
        
        /* Year colors */
        .year-expired { color: var(--mono-red); }
        .year-current { color: var(--mono-yellow); }
        .year-future { color: var(--mono-green); }
        
        /* Progress bar */
        .progress-bar-container {
            position: relative;
            height: 24px;
            background: var(--mono-surface-2);
            border-radius: 6px;
            overflow: hidden;
        }
        
        .progress-bar-fill {
            height: 100%;
            display: flex;
        }
        
        .progress-bar-segment {
            height: 100%;
            transition: width 0.3s;
        }
        
        .progress-bar-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 12px;
            font-weight: 600;
            color: var(--mono-text);
        }
        
        /* Tenant color indicator */
        .tenant-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 3px;
            margin-right: 8px;
            vertical-align: middle;
        }
        
        /* Potential card */
        .potential-card {
            background: linear-gradient(135deg, var(--mono-surface) 0%, var(--mono-surface-2) 100%);
            border: 1px solid var(--mono-green);
            border-radius: var(--mono-radius);
            padding: 24px;
            margin-bottom: 24px;
        }
        
        .potential-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .potential-icon {
            width: 48px;
            height: 48px;
            background: var(--mono-green-bg);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: var(--mono-green);
        }
        
        .potential-title {
            font-size: 18px;
            font-weight: 600;
        }
        
        .potential-subtitle {
            font-size: 13px;
            color: var(--mono-text-secondary);
        }
        
        .potential-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
        }
        
        .potential-item {
            background: var(--mono-surface);
            border-radius: 8px;
            padding: 16px;
            border: 1px solid var(--mono-border);
            text-align: center;
        }
        
        .potential-item-label {
            font-size: 12px;
            color: var(--mono-text-secondary);
            margin-bottom: 4px;
        }
        
        .potential-item-value {
            font-size: 24px;
            font-weight: 700;
        }
        
        .potential-item-detail {
            font-size: 13px;
            color: var(--mono-text-secondary);
        }
        
        /* Risk indicator */
        .risk-indicator {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: var(--mono-surface-2);
            border-radius: 8px;
            margin-bottom: 8px;
        }
        
        .risk-bar {
            flex: 1;
            height: 8px;
            background: var(--mono-surface-3);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .risk-bar-fill {
            height: 100%;
            border-radius: 4px;
        }
        
        .risk-percent {
            font-size: 14px;
            font-weight: 600;
            min-width: 50px;
            text-align: right;
        }
        
        /* Matrix table */
        .matrix-table th.sticky-col,
        .matrix-table td.sticky-col {
            position: sticky;
            left: 0;
            background-color: var(--mono-surface);
            z-index: 10;
            border-right: 2px solid var(--mono-border);
            min-width: 180px;
        }
        
        .matrix-table thead th.sticky-col {
            background-color: var(--mono-surface-2);
        }
        
        .matrix-cell-highlight {
            background: var(--mono-yellow-bg) !important;
        }
        
        /* Filter input */
        .filter-input {
            background: var(--mono-surface-2);
            border: 1px solid var(--mono-border);
            color: var(--mono-text);
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 14px;
            width: 80px;
        }
        
        .filter-input:focus {
            outline: none;
            border-color: var(--mono-green);
        }
        
        .filter-btn {
            background: var(--mono-green);
            border: none;
            color: var(--mono-bg);
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 14px;
            cursor: pointer;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--mono-surface);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--mono-surface-3);
            border-radius: 4px;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .stats-value {
                font-size: 24px;
            }
            
            .potential-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .section-body {
                padding: 12px;
            }
            
            .data-table td, .data-table th {
                padding: 10px 12px;
                font-size: 13px;
            }
            
            .page-title {
                font-size: 22px;
            }
        }
        
        /* Chart container */
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        
        /* Alerts/Notifications */
        .alert-card {
            background: var(--mono-surface);
            border-radius: var(--mono-radius);
            border: 1px solid var(--mono-border);
            margin-bottom: 24px;
            overflow: hidden;
        }
        
        .alert-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--mono-border);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .alert-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        
        .alert-icon.warning {
            background: var(--mono-orange-bg);
            color: var(--mono-orange);
        }
        
        .alert-icon.danger {
            background: var(--mono-red-bg);
            color: var(--mono-red);
        }
        
        .alert-icon.info {
            background: var(--mono-blue-bg);
            color: var(--mono-blue);
        }
        
        .alert-title {
            font-size: 16px;
            font-weight: 600;
        }
        
        .alert-subtitle {
            font-size: 13px;
            color: var(--mono-text-secondary);
        }
        
        .alert-body {
            padding: 16px 20px;
        }
        
        .alert-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 14px;
            background: var(--mono-surface-2);
            border-radius: 8px;
            margin-bottom: 8px;
        }
        
        .alert-item:last-child {
            margin-bottom: 0;
        }
        
        .alert-item-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .alert-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .alert-badge.red {
            background: var(--mono-red-bg);
            color: var(--mono-red);
        }
        
        .alert-badge.orange {
            background: var(--mono-orange-bg);
            color: var(--mono-orange);
        }
        
        .alert-badge.yellow {
            background: var(--mono-yellow-bg);
            color: var(--mono-yellow);
        }
        
        /* Compact table style */
        .data-table.compact th,
        .data-table.compact td {
            padding: 8px 10px;
            font-size: 13px;
        }
        
        .data-table.compact th {
            font-size: 10px;
        }
        
        /* Details/Summary for collapsible sections */
        .section-details {
            background: var(--mono-surface);
            border-radius: var(--mono-radius);
            border: 1px solid var(--mono-border);
            overflow: hidden;
        }
        
        .section-details[open] .expand-icon {
            transform: rotate(180deg);
        }
        
        .section-summary {
            list-style: none;
            cursor: pointer;
        }
        
        .section-summary::-webkit-details-marker {
            display: none;
        }
        
        .section-summary .section-header {
            margin: 0;
            border: none;
            transition: background 0.2s;
        }
        
        .section-summary:hover .section-header {
            background: var(--mono-surface-2);
        }
        
        .expand-icon {
            transition: transform 0.3s ease;
            color: var(--mono-text-secondary);
        }
        
        /* Timeline Cards */
        .timeline-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .timeline-card.active {
            box-shadow: 0 0 0 2px var(--mono-blue);
        }
        
        /* Responsive adjustments */
        @media (max-width: 1400px) {
            .potential-grid {
                grid-template-columns: repeat(3, 1fr) !important;
            }
        }
        
        @media (max-width: 992px) {
            .potential-grid {
                grid-template-columns: repeat(2, 1fr) !important;
            }
            
            /* Timeline cards - —Å–∫—Ä–æ–ª –Ω–∞ –ø–ª–∞–Ω—à–µ—Ç–∞—Ö */
            #expiryTimeline {
                flex-wrap: nowrap !important;
            }
        }
        
        @media (max-width: 576px) {
            .potential-grid {
                grid-template-columns: 1fr !important;
            }
            
            .stats-value {
                font-size: 22px;
            }
            
            .data-table.compact th,
            .data-table.compact td {
                padding: 6px 8px;
                font-size: 11px;
            }
            
            /* Timeline cards –Ω–∞ –º–æ–±—ñ–ª—å–Ω–∏—Ö - –º–µ–Ω—à–∏–π —Ä–æ–∑–º—ñ—Ä */
            .timeline-card {
                min-width: 90px !important;
                padding: 12px !important;
            }
            
            .timeline-card > div:nth-child(2) {
                font-size: 22px !important;
            }
            
            /* –ú–∞—Ç—Ä–∏—Ü—è –Ω–∞ –º–æ–±—ñ–ª—å–Ω–∏—Ö */
            .matrix-table th,
            .matrix-table td {
                padding: 4px 6px !important;
                font-size: 10px !important;
            }
            
            .matrix-table .sticky-col {
                max-width: 100px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
            
            /* –ü–æ—Ç–µ–Ω—Ü—ñ–∞–ª –∫–∞—Ä—Ç–∫–∏ */
            #potentialCards > div {
                min-width: 80px !important;
                padding: 8px 10px !important;
            }
            
            #potentialCards > div span:first-of-type {
                font-size: 12px !important;
            }
            
            #potentialSummary {
                flex-wrap: wrap;
            }
        }

        /* Export buttons */
        .export-buttons {
            display: flex;
            gap: 8px;
        }
        
        .btn-export {
            background: var(--mono-surface-2);
            border: 1px solid var(--mono-border);
            color: var(--mono-text);
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 14px;
            transition: all 0.2s;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .btn-export:hover {
            background: var(--mono-surface-3);
        }
        
        .btn-export.excel {
            border-color: #10B981;
        }
        
        .btn-export.excel:hover {
            background: rgba(16, 185, 129, 0.15);
        }
        
        @media print {
            @page {
                size: A4 landscape;
                margin: 0.5cm;
            }
            
            body {
                background: white !important;
                color: black !important;
            }
            
            .btn-pdf, .btn-export, .navbar, .export-buttons {
                display: none !important;
            }
            
            .stats-card, .section, .potential-card, .alert-card {
                background: white !important;
                border: 1px solid #ddd !important;
                color: black !important;
            }
            
            .chart-container {
                height: 250px !important;
            }
            
            .page-break {
                page-break-before: always;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <a class="navbar-brand" href="#" onclick="goBack(); return false;">
                <i class="bi bi-arrow-left"></i>
                –ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –Ω–∞ –∫–∞—Ä—Ç—É
            </a>
            <div class="export-buttons">
                <button class="btn-export excel" onclick="exportToExcel()">
                    <i class="bi bi-file-earmark-excel"></i>
                    <span class="d-none d-sm-inline">Excel</span>
                </button>
                <button class="btn-export" onclick="generatePDF()">
                    <i class="bi bi-file-pdf"></i>
                    <span class="d-none d-sm-inline">PDF</span>
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid px-3 px-lg-5 py-4">
        <h1 class="page-title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: <span id="councilName">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</span></h1>

        <!-- –ó–∞–≥–∞–ª—å–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ - –ü–ï–†–®–ê –°–ï–ö–¶–Ü–Ø -->
        <div class="row mb-4 g-3">
            <div class="col-xl-3 col-md-6 col-6">
                <div class="stats-card">
                    <div class="stats-card-title">
                        <i class="bi bi-geo-alt"></i> –ó–∞–≥–∞–ª—å–Ω–∞ –ø–ª–æ—â–∞
                    </div>
                    <div class="stats-value" id="totalArea">0<span class="stats-value-unit">–≥–∞</span></div>
                    <div class="stats-subtitle"><span id="totalParcels">0</span> –¥—ñ–ª—è–Ω–æ–∫</div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6 col-6">
                <div class="stats-card">
                    <div class="stats-card-title">
                        <i class="bi bi-unlock"></i> –í—ñ–ª—å–Ω—ñ –≤—ñ–¥ –æ—Ä–µ–Ω–¥–∏
                    </div>
                    <div class="stats-value" style="color: var(--mono-yellow);" id="freeArea">0<span class="stats-value-unit">–≥–∞</span></div>
                    <div class="stats-subtitle"><span id="freeParcels">0</span> –¥—ñ–ª—è–Ω–æ–∫</div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6 col-6">
                <div class="stats-card">
                    <div class="stats-card-title">
                        <i class="bi bi-people"></i> –û—Ä–µ–Ω–¥–∞—Ä—ñ
                    </div>
                    <div class="stats-value" style="color: var(--mono-blue);" id="tenantsCount">0</div>
                    <div class="stats-subtitle">–∞–∫—Ç–∏–≤–Ω–∏—Ö –∫–æ–º–ø–∞–Ω—ñ–π</div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6 col-6">
                <div class="stats-card">
                    <div class="stats-card-title">
                        <i class="bi bi-cash-stack"></i> –ù–ì–û
                    </div>
                    <div class="stats-value" style="color: var(--mono-green);" id="totalNGO">0<span class="stats-value-unit">–≥—Ä–Ω</span></div>
                    <div class="stats-subtitle">–Ω–æ—Ä–º–∞—Ç–∏–≤–Ω–∞ –æ—Ü—ñ–Ω–∫–∞</div>
                </div>
            </div>
        </div>

        <!-- –ü–æ—Ç–µ–Ω—Ü—ñ–∞–ª –¥–ª—è –Ω–æ–≤–∏—Ö –¥–æ–≥–æ–≤–æ—Ä—ñ–≤ (–æ–±'—î–¥–Ω–∞–Ω–∏–π –±–ª–æ–∫) -->
        <div class="section mb-4" id="potentialSection">
            <div class="section-header" style="padding: 16px 20px;">
                <div class="section-title" style="font-size: 18px;">
                    <i class="bi bi-bullseye" style="color: var(--mono-green);"></i>
                    üéØ –ü–æ—Ç–µ–Ω—Ü—ñ–∞–ª –¥–ª—è –Ω–æ–≤–∏—Ö –¥–æ–≥–æ–≤–æ—Ä—ñ–≤
                </div>
                <div id="potentialSummary" style="display: flex; align-items: center; gap: 16px;">
                    <!-- –ó–∞–ø–æ–≤–Ω—é—î—Ç—å—Å—è –¥–∏–Ω–∞–º—ñ—á–Ω–æ -->
                </div>
            </div>
            <div class="section-body" style="padding: 16px 20px;">
                <!-- –ö–∞—Ä—Ç–∫–∏ –ø–æ—Ç–µ–Ω—Ü—ñ–∞–ª—É -->
                <div id="potentialCards" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px;">
                    <!-- –ó–∞–ø–æ–≤–Ω—é—î—Ç—å—Å—è –¥–∏–Ω–∞–º—ñ—á–Ω–æ -->
                </div>
                <!-- –ü—Ä–æ–≥—Ä–µ—Å-–±–∞—Ä -->
                <div id="potentialProgressContainer" style="background: var(--mono-surface-2); border-radius: 8px; overflow: hidden; height: 32px; position: relative;">
                    <div id="potentialProgressBar" style="display: flex; height: 100%;">
                        <!-- –ó–∞–ø–æ–≤–Ω—é—î—Ç—å—Å—è –¥–∏–Ω–∞–º—ñ—á–Ω–æ -->
                    </div>
                    <div id="potentialProgressText" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 12px; font-weight: 600; color: var(--mono-text); text-shadow: 0 1px 2px rgba(0,0,0,0.5);">
                        <!-- –ó–∞–ø–æ–≤–Ω—é—î—Ç—å—Å—è –¥–∏–Ω–∞–º—ñ—á–Ω–æ -->
                    </div>
                </div>
                <!-- –°–ø–∏—Å–æ–∫ –Ω–æ–≤–∏—Ö –≤–ª–∞—Å–Ω–∏–∫—ñ–≤ (–∑–≥–æ—Ä–Ω—É—Ç–æ) -->
                <details id="newOwnersDetails" style="margin-top: 16px; display: none;">
                    <summary style="cursor: pointer; color: var(--mono-orange); font-size: 13px; padding: 8px 0; font-weight: 500;">
                        <i class="bi bi-fire"></i> –ü–æ–∫–∞–∑–∞—Ç–∏ –Ω–æ–≤–∏—Ö –≤–ª–∞—Å–Ω–∏–∫—ñ–≤ –±–µ–∑ –æ—Ä–µ–Ω–¥–∏
                    </summary>
                    <div id="newOwnersList" style="margin-top: 8px;">
                        <!-- –°–ø–∏—Å–æ–∫ –≤–ª–∞—Å–Ω–∏–∫—ñ–≤ -->
                    </div>
                </details>
            </div>
        </div>

        <!-- –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—è –¥–æ–≥–æ–≤–æ—Ä—ñ–≤ (Timeline Cards) -->
        <div class="section mb-4" id="expiryTimelineSection">
            <div class="section-header" style="padding: 16px 20px;">
                <div class="section-title" style="font-size: 18px;">
                    <i class="bi bi-calendar-event" style="color: var(--mono-yellow);"></i>
                    üìÖ –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—è –¥–æ–≥–æ–≤–æ—Ä—ñ–≤
                </div>
                <div id="expirySummary" style="display: flex; align-items: center; gap: 12px;">
                    <!-- –ó–∞–ø–æ–≤–Ω—é—î—Ç—å—Å—è –¥–∏–Ω–∞–º—ñ—á–Ω–æ -->
                </div>
            </div>
            <div class="section-body" style="padding: 16px 20px;">
                <!-- Timeline Cards -->
                <div id="expiryTimeline" style="display: flex; gap: 12px; overflow-x: auto; padding-bottom: 8px;">
                    <!-- –ó–∞–ø–æ–≤–Ω—é—î—Ç—å—Å—è –¥–∏–Ω–∞–º—ñ—á–Ω–æ -->
                </div>
                
                <!-- Progress bar -->
                <div style="margin-top: 16px; background: var(--mono-surface-2); border-radius: 6px; height: 8px; overflow: hidden;">
                    <div id="expiryProgressBar" style="display: flex; height: 100%;">
                        <!-- –ó–∞–ø–æ–≤–Ω—é—î—Ç—å—Å—è –¥–∏–Ω–∞–º—ñ—á–Ω–æ -->
                    </div>
                </div>
                
                <!-- –î–µ—Ç–∞–ª—ñ –ø–æ —Ä–æ–∫–∞—Ö (–∞–∫–æ—Ä–¥–µ–æ–Ω) -->
                <div id="expiryDetails" style="margin-top: 16px;">
                    <!-- –ó–∞–ø–æ–≤–Ω—é—î—Ç—å—Å—è –¥–∏–Ω–∞–º—ñ—á–Ω–æ -->
                </div>
                
                <!-- –ú–∞—Ç—Ä–∏—Ü—è –ø–æ –æ—Ä–µ–Ω–¥–∞—Ä—è—Ö (–∑–∞–≤–∂–¥–∏ –≤–∏–¥–∏–º–∞) -->
                <div style="margin-top: 20px;">
                    <div style="font-size: 14px; font-weight: 600; color: var(--mono-text); margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                        <i class="bi bi-table"></i>
                        –ú–∞—Ç—Ä–∏—Ü—è –ø–æ –æ—Ä–µ–Ω–¥–∞—Ä—è—Ö
                    </div>
                    <div style="max-height: 400px; overflow: auto; position: relative; border: 1px solid var(--mono-border); border-radius: 8px;">
                        <table class="data-table matrix-table compact" style="border-collapse: separate; border-spacing: 0; margin: 0;">
                            <thead style="position: sticky; top: 0; z-index: 10;">
                                <tr id="matrixHeader">
                                    <th class="sticky-col" style="position: sticky; left: 0; top: 0; z-index: 11; background-color: #1C1C1E;">–û—Ä–µ–Ω–¥–∞—Ä</th>
                                </tr>
                            </thead>
                            <tbody id="matrixTableBody"></tbody>
                            <tfoot id="matrixFooter" style="position: sticky; bottom: 0; z-index: 10;">
                                <!-- –†—è–¥–æ–∫ –í—Å—å–æ–≥–æ - sticky –∑–Ω–∏–∑—É -->
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ì—Ä–∞—Ñ—ñ–∫: –î–∏–Ω–∞–º—ñ–∫–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó (–≤–ª–∞—Å–Ω—ñ—Å—Ç—å + –æ—Ä–µ–Ω–¥–∞) -->
        <div class="row mb-4 g-3">
            <div class="col-12">
                <div class="section">
                    <div class="section-header">
                        <div class="section-title">
                            <i class="bi bi-bar-chart"></i>
                            –î–∏–Ω–∞–º—ñ–∫–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –ø–æ —Ä–æ–∫–∞—Ö
                        </div>
                        <div style="display: flex; gap: 16px; font-size: 12px;">
                            <span><span style="display: inline-block; width: 12px; height: 12px; background: #10B981; border-radius: 2px; margin-right: 4px;"></span>–í–ª–∞—Å–Ω—ñ—Å—Ç—å</span>
                            <span><span style="display: inline-block; width: 12px; height: 12px; background: #3B82F6; border-radius: 2px; margin-right: 4px;"></span>–û—Ä–µ–Ω–¥–∞</span>
                        </div>
                    </div>
                    <div class="section-body">
                        <div class="chart-container" style="height: 280px;">
                            <canvas id="registrationChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ó–≥–æ—Ä—Ç–∞—î–º—ñ —Å–µ–∫—Ü—ñ—ó –∑ –¥–µ—Ç–∞–ª—è–º–∏ -->
        <div class="row mb-4 g-3">
            <!-- –û—Ä–µ–Ω–¥–∞—Ä—ñ (–∑–≥–æ—Ä–Ω—É—Ç–æ) -->
            <div class="col-xl-6">
                <details class="section-details">
                    <summary class="section-summary">
                        <div class="section-header" style="border-radius: var(--mono-radius); margin: 0;">
                            <div class="section-title">
                                <i class="bi bi-building"></i>
                                –í—Å—ñ –æ—Ä–µ–Ω–¥–∞—Ä—ñ
                            </div>
                            <i class="bi bi-chevron-down expand-icon"></i>
                        </div>
                    </summary>
                    <div class="section-body" style="border: 1px solid var(--mono-border); border-top: none; border-radius: 0 0 var(--mono-radius) var(--mono-radius); padding: 12px;">
                        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                            <table class="data-table compact">
                                <thead>
                                    <tr>
                                        <th>–û—Ä–µ–Ω–¥–∞—Ä</th>
                                        <th class="text-end">–î—ñ–ª.</th>
                                        <th class="text-end">–ü–ª–æ—â–∞</th>
                                        <th class="text-end">%</th>
                                        <th class="text-end">–ù–ì–û</th>
                                    </tr>
                                </thead>
                                <tbody id="tenantsTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </details>
            </div>
            
            <!-- –í–ª–∞—Å–Ω–∏–∫–∏ (–∑–≥–æ—Ä–Ω—É—Ç–æ) -->
            <div class="col-xl-6">
                <details class="section-details">
                    <summary class="section-summary">
                        <div class="section-header" style="border-radius: var(--mono-radius); margin: 0;">
                            <div class="section-title">
                                <i class="bi bi-person"></i>
                                –í–ª–∞—Å–Ω–∏–∫–∏
                            </div>
                            <div class="d-flex align-items-center gap-2">
                                <span style="font-size: 12px; color: var(--mono-text-secondary);">–ú—ñ–Ω:</span>
                                <input type="number" class="filter-input" id="minParcelsFilter" value="3" min="1" style="width: 50px;" onclick="event.stopPropagation();">
                                <button class="filter-btn" onclick="event.stopPropagation(); updateOwnersTable();">
                                    <i class="bi bi-arrow-clockwise"></i>
                                </button>
                                <i class="bi bi-chevron-down expand-icon"></i>
                            </div>
                        </div>
                    </summary>
                    <div class="section-body" style="border: 1px solid var(--mono-border); border-top: none; border-radius: 0 0 var(--mono-radius) var(--mono-radius); padding: 12px;">
                        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                            <table class="data-table compact">
                                <thead>
                                    <tr>
                                        <th>–í–ª–∞—Å–Ω–∏–∫</th>
                                        <th class="text-end">–î—ñ–ª.</th>
                                        <th class="text-end">–ü–ª–æ—â–∞</th>
                                        <th class="text-end">–°–µ—Ä.</th>
                                    </tr>
                                </thead>
                                <tbody id="ownersTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </details>
            </div>
        </div>
    </div>

    <script>
        // Tenant colors
        const tenantColors = {};
        const colorPalette = [
            '#1B9688', '#E91E63', '#9C27B0', '#673AB7', '#3F51B5',
            '#2196F3', '#00BCD4', '#009688', '#4CAF50', '#8BC34A',
            '#CDDC39', '#FFC107', '#FF9800', '#FF5722', '#795548'
        ];
        let colorIndex = 0;
        
        // === –°–∏—Å—Ç–µ–º–∞ —É–Ω—ñ–∫–∞–ª—å–Ω–æ—Å—Ç—ñ –æ—Ä–µ–Ω–¥–∞—Ä—ñ–≤ –ø–æ –Ñ–î–†–ü–û–£ ===
        // –ú–∞–ø: –Ñ–î–†–ü–û–£ -> –∫–∞–Ω–æ–Ω—ñ—á–Ω–∞ –Ω–∞–∑–≤–∞ (–Ω–∞–π–∫–æ—Ä–æ—Ç—à–∞)
        let tenantEdrpouNames = {};
        // –ú–∞–ø: –Ω–∞–∑–≤–∞ –æ—Ä–µ–Ω–¥–∞—Ä—è -> –Ñ–î–†–ü–û–£
        let tenantNameToEdrpou = {};
        
        /**
         * –†–µ—î—Å—Ç—Ä—É—î –∑–≤'—è–∑–æ–∫ –Ñ–î–†–ü–û–£ –∑ –Ω–∞–∑–≤–æ—é –æ—Ä–µ–Ω–¥–∞—Ä—è.
         * –ó–±–µ—Ä—ñ–≥–∞—î –Ω–∞–π–∫–æ—Ä–æ—Ç—à—É –Ω–∞–∑–≤—É —è–∫ –∫–∞–Ω–æ–Ω—ñ—á–Ω—É.
         */
        function registerTenantEdrpou(edrpou, tenantName) {
            if (!edrpou || !tenantName) return;
            tenantNameToEdrpou[tenantName] = edrpou;
            if (!tenantEdrpouNames[edrpou]) {
                tenantEdrpouNames[edrpou] = tenantName;
            } else if (tenantName.length < tenantEdrpouNames[edrpou].length) {
                tenantEdrpouNames[edrpou] = tenantName;
            }
        }
        
        /**
         * –û—Ç—Ä–∏–º—É—î —É–Ω—ñ–∫–∞–ª—å–Ω–∏–π –∫–ª—é—á –æ—Ä–µ–Ω–¥–∞—Ä—è (–Ñ–î–†–ü–û–£ –∞–±–æ –Ω–∞–∑–≤—É)
         */
        function getTenantKey(tenant, edrpou) {
            return edrpou || tenant;
        }
        
        /**
         * –û—Ç—Ä–∏–º—É—î –Ω–∞–∑–≤—É –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ø–æ –∫–ª—é—á—É
         */
        function getTenantDisplayName(key) {
            if (tenantEdrpouNames[key]) {
                return tenantEdrpouNames[key];
            }
            return key;
        }
        
        function getColor(key) {
            if (!key) return '#3A3A3C';
            if (!tenantColors[key]) {
                tenantColors[key] = colorPalette[colorIndex % colorPalette.length];
                colorIndex++;
            }
            return tenantColors[key];
        }

        function getClientId() {
            const urlParams = new URLSearchParams(window.location.search);
            let id = urlParams.get('id');
            if (!id) {
                const storedId = localStorage.getItem('client_id');
                if (storedId) {
                    id = storedId;
                    const currentUrl = new URL(window.location);
                    currentUrl.searchParams.set('id', id);
                    window.history.replaceState({}, '', currentUrl);
                }
            }
            return id;
        }

        const urlParams = new URLSearchParams(window.location.search);
        const selectedFile = urlParams.get('file');
        const id = getClientId();
        const councilName = selectedFile ? selectedFile.replace('.geojson', '') : '–ù–µ –≤–∏–±—Ä–∞–Ω–æ';
        const dataPath = id ? `data/${id}/` : 'data/';

        let globalStats = null;
        const currentYear = new Date().getFullYear();

        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toFixed(0);
        }

        function generatePDF() {
            const opt = {
                margin: 0.5,
                filename: `–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞_${councilName}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'cm', format: 'a4', orientation: 'landscape' },
                pagebreak: { mode: ['avoid-all', 'css', 'legacy'], before: '.page-break' }
            };
            html2pdf().set(opt).from(document.body).save();
        }

        async function loadAndProcessData() {
            if (!selectedFile) {
                document.getElementById('councilName').textContent = '–§–∞–π–ª –Ω–µ –≤–∏–±—Ä–∞–Ω–æ';
                return;
            }

            try {
                document.getElementById('councilName').textContent = '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...';
                const response = await fetch(`${dataPath}${selectedFile}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const data = await response.json();
                document.getElementById('councilName').textContent = councilName;
                
                data.features = data.features.filter(f => f.properties.type === 'original');
                processData(data);
            } catch (error) {
                console.error('–ü–æ–º–∏–ª–∫–∞:', error);
                document.getElementById('councilName').textContent = '–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è';
            }
        }

        function processData(data) {
            const features = data.features;
            const uniqueOwners = new Set();
            
            // –û—á–∏—â–∞—î–º–æ –º–∞–ø–ø—ñ–Ω–≥–∏ –Ñ–î–†–ü–û–£ –ø—Ä–∏ –Ω–æ–≤–æ–º—É –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ
            tenantEdrpouNames = {};
            tenantNameToEdrpou = {};
            colorIndex = 0;
            Object.keys(tenantColors).forEach(k => delete tenantColors[k]);
            
            const stats = features.reduce((acc, feature) => {
                const props = feature.properties;
                const area = parseFloat(props['–ü–ª–æ—â–∞ —Ä–æ–∑—Ä–∞—Ö–æ–≤–∞–Ω–∞'] || props['–ü–ª–æ—â–∞ –î–ó–ö'] || 0);
                const tenantName = props['–û—Ä–µ–Ω–¥–∞—Ä'];
                const edrpou = props['–Ñ–î–†–ü–û–£ –æ—Ä–µ–Ω–¥–∞—Ä—è –¥—ñ–ª—è–Ω–∫–∏'];
                const owner = props['–í–ª–∞—Å–Ω–∏–∫'];
                const expiryYear = props['–†—ñ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è'];
                const registrationDate = props['–î–∞—Ç–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó'];
                const ngo = parseFloat(String(props['–ù–ì–û'] || '0').replace(/\s/g, '')) || 0;
                
                // –†–µ—î—Å—Ç—Ä—É—î–º–æ –∑–≤'—è–∑–æ–∫ –Ñ–î–†–ü–û–£ -> –Ω–∞–∑–≤–∞
                if (tenantName && edrpou) {
                    registerTenantEdrpou(edrpou, tenantName);
                }
                
                // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –Ñ–î–†–ü–û–£ —è–∫ –∫–ª—é—á –¥–ª—è —É–Ω—ñ–∫–∞–ª—å–Ω–æ—Å—Ç—ñ
                const tenant = tenantName ? getTenantKey(tenantName, edrpou) : null;

                acc.totalArea += area;
                acc.totalParcels++;
                acc.totalNGO += ngo;
                
                if (!tenant) {
                    acc.freeParcels++;
                    acc.freeArea += area;
                    acc.freeNGO += ngo;
                } else {
                    acc.rentedArea += area;
                }

                if (owner && owner.trim() !== '') {
                    uniqueOwners.add(owner);
                }

                // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó
                if (registrationDate) {
                    let year = extractYear(registrationDate);
                    if (year && year > 1990 && year <= currentYear) {
                        if (!acc.registrationYears[year]) {
                            acc.registrationYears[year] = { total: 0, totalArea: 0, active: 0, activeArea: 0, inactive: 0, inactiveArea: 0 };
                        }
                        acc.registrationYears[year].total++;
                        acc.registrationYears[year].totalArea += area;
                        if (tenant) {
                            acc.registrationYears[year].active++;
                            acc.registrationYears[year].activeArea += area;
                        } else {
                            acc.registrationYears[year].inactive++;
                            acc.registrationYears[year].inactiveArea += area;
                            
                            // –ó–±–∏—Ä–∞—î–º–æ "–≥–∞—Ä—è—á–∏–π –ø–æ—Ç–µ–Ω—Ü—ñ–∞–ª" - –Ω–æ–≤—ñ –≤–ª–∞—Å–Ω–∏–∫–∏ –±–µ–∑ –æ—Ä–µ–Ω–¥–∏ (–æ—Å—Ç–∞–Ω–Ω—ñ 3 —Ä–æ–∫–∏)
                            if (year >= currentYear - 2 && owner) {
                                if (!acc.newOwnersFree[year]) {
                                    acc.newOwnersFree[year] = { count: 0, area: 0, owners: [] };
                                }
                                acc.newOwnersFree[year].count++;
                                acc.newOwnersFree[year].area += area;
                                acc.newOwnersFree[year].owners.push({
                                    name: owner,
                                    area: area,
                                    cadastre: props['–ö–∞–¥–∞—Å—Ç—Ä–æ–≤–∏–π –Ω–æ–º–µ—Ä'] || '',
                                    ngo: ngo
                                });
                            }
                        }
                    }
                }

                // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –æ—Ä–µ–Ω–¥–∞—Ä—è—Ö
                if (tenant) {
                    if (!acc.tenants[tenant]) {
                        acc.tenants[tenant] = { count: 0, area: 0, ngo: 0 };
                    }
                    acc.tenants[tenant].count++;
                    acc.tenants[tenant].area += area;
                    acc.tenants[tenant].ngo += ngo;
                }

                // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≤–ª–∞—Å–Ω–∏–∫–∞—Ö
                if (owner) {
                    if (!acc.owners[owner]) {
                        acc.owners[owner] = { count: 0, area: 0 };
                    }
                    acc.owners[owner].count++;
                    acc.owners[owner].area += area;
                }

                // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ä–æ–∫–∞—Ö –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è
                if (tenant && expiryYear) {
                    const year = parseInt(expiryYear);
                    if (!isNaN(year)) {
                        if (!acc.expiryYears[year]) {
                            acc.expiryYears[year] = { count: 0, area: 0, tenants: {} };
                        }
                        if (!acc.expiryYears[year].tenants[tenant]) {
                            acc.expiryYears[year].tenants[tenant] = { count: 0, area: 0 };
                        }
                        acc.expiryYears[year].count++;
                        acc.expiryYears[year].area += area;
                        acc.expiryYears[year].tenants[tenant].count++;
                        acc.expiryYears[year].tenants[tenant].area += area;
                    }
                }

                return acc;
            }, {
                totalArea: 0, totalParcels: 0, freeParcels: 0, freeArea: 0, freeNGO: 0,
                rentedArea: 0, totalNGO: 0, tenants: {}, owners: {}, expiryYears: {}, registrationYears: {},
                // –ù–æ–≤—ñ –≤–ª–∞—Å–Ω–∏–∫–∏ –±–µ–∑ –æ—Ä–µ–Ω–¥–∏ (–∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω—ñ –∑–∞ –æ—Å—Ç–∞–Ω–Ω—ñ 3 —Ä–æ–∫–∏)
                newOwnersFree: {}
            });

            stats.uniqueOwnersCount = uniqueOwners.size;
            globalStats = stats;
            updateUI(stats);
        }

        function extractYear(dateStr) {
            if (!dateStr) return null;
            if (dateStr.includes('.')) return parseInt(dateStr.split('.')[2]);
            if (dateStr.includes('/')) return parseInt(dateStr.split('/')[2]);
            if (dateStr.length === 4) return parseInt(dateStr);
            const match = dateStr.match(/\d{4}/);
            return match ? parseInt(match[0]) : null;
        }

        function updateUI(stats) {
            document.getElementById('totalArea').innerHTML = `${stats.totalArea.toFixed(0)}<span class="stats-value-unit">–≥–∞</span>`;
            document.getElementById('totalParcels').textContent = stats.totalParcels;
            document.getElementById('freeArea').innerHTML = `${stats.freeArea.toFixed(0)}<span class="stats-value-unit">–≥–∞</span>`;
            document.getElementById('freeParcels').textContent = stats.freeParcels;
            document.getElementById('tenantsCount').textContent = Object.keys(stats.tenants).length;
            document.getElementById('totalNGO').innerHTML = `${formatNumber(stats.totalNGO)}<span class="stats-value-unit">–≥—Ä–Ω</span>`;

            updatePotentialSection(stats);
            updateForecastTable(stats);
            updateTenantsTable(stats);
            updateOwnersTable();
            updateMatrixTable(stats.expiryYears, stats.tenants);
            updateRegistrationChart(stats.registrationYears);
        }
        
        // –û–±'—î–¥–Ω–∞–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è –¥–ª—è –ø–æ—Ç–µ–Ω—Ü—ñ–∞–ª—É
        function updatePotentialSection(stats) {
            const cardsContainer = document.getElementById('potentialCards');
            const progressBar = document.getElementById('potentialProgressBar');
            const progressText = document.getElementById('potentialProgressText');
            const summary = document.getElementById('potentialSummary');
            const newOwnersDetails = document.getElementById('newOwnersDetails');
            const newOwnersList = document.getElementById('newOwnersList');
            
            // –ó–±–∏—Ä–∞—î–º–æ –≤—Å—ñ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó –ø–æ—Ç–µ–Ω—Ü—ñ–∞–ª—É
            const categories = [];
            
            // 1. –í—ñ–ª—å–Ω—ñ –∑–∞—Ä–∞–∑
            if (stats.freeParcels > 0) {
                categories.push({
                    id: 'free',
                    label: '–í—ñ–ª—å–Ω—ñ',
                    icon: 'üü¢',
                    count: stats.freeParcels,
                    area: stats.freeArea,
                    color: '#10B981',
                    colorVar: 'var(--mono-green)'
                });
            }
            
            // 2. –ù–æ–≤—ñ –≤–ª–∞—Å–Ω–∏–∫–∏ –±–µ–∑ –æ—Ä–µ–Ω–¥–∏
            let newOwnersCount = 0, newOwnersArea = 0;
            const newOwnersYears = Object.keys(stats.newOwnersFree).sort((a, b) => b - a);
            newOwnersYears.forEach(year => {
                newOwnersCount += stats.newOwnersFree[year].count;
                newOwnersArea += stats.newOwnersFree[year].area;
            });
            
            if (newOwnersCount > 0) {
                categories.push({
                    id: 'newOwners',
                    label: '–ù–æ–≤—ñ –≤–ª–∞—Å.',
                    icon: 'üî•',
                    count: newOwnersCount,
                    area: newOwnersArea,
                    color: '#F97316',
                    colorVar: 'var(--mono-orange)'
                });
            }
            
            // 3. –ü—Ä–æ—Å—Ç—Ä–æ—á–µ–Ω—ñ
            let expiredCount = 0, expiredArea = 0;
            Object.entries(stats.expiryYears).forEach(([year, data]) => {
                if (parseInt(year) < currentYear) {
                    expiredCount += data.count;
                    expiredArea += data.area;
                }
            });
            
            if (expiredCount > 0) {
                categories.push({
                    id: 'expired',
                    label: '–ü—Ä–æ—Å—Ç—Ä–æ—á.',
                    icon: 'üî¥',
                    count: expiredCount,
                    area: expiredArea,
                    color: '#EF4444',
                    colorVar: 'var(--mono-red)'
                });
            }
            
            // 4-6. –†–æ–∫–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è
            for (let year = currentYear; year <= currentYear + 2; year++) {
                const yearData = stats.expiryYears[year] || { count: 0, area: 0 };
                if (yearData.count > 0) {
                    const isCurrent = year === currentYear;
                    categories.push({
                        id: `year${year}`,
                        label: isCurrent ? `${year}` : `${year}`,
                        icon: isCurrent ? 'üü°' : 'üìÖ',
                        count: yearData.count,
                        area: yearData.area,
                        color: isCurrent ? '#F59E0B' : '#6B7280',
                        colorVar: isCurrent ? 'var(--mono-yellow)' : 'var(--mono-text-secondary)'
                    });
                }
            }
            
            // –ü—ñ–¥—Ä–∞—Ö—É–Ω–æ–∫ –∑–∞–≥–∞–ª—å–Ω–æ–≥–æ –ø–æ—Ç–µ–Ω—Ü—ñ–∞–ª—É
            let totalCount = 0, totalArea = 0;
            categories.forEach(cat => {
                totalCount += cat.count;
                totalArea += cat.area;
            });
            
            const percentOfTotal = stats.totalArea > 0 ? (totalArea / stats.totalArea * 100).toFixed(1) : 0;
            
            // –ó–∞–ø–æ–≤–Ω—é—î–º–æ summary
            summary.innerHTML = `
                <div style="text-align: right;">
                    <span style="font-size: 24px; font-weight: 700; color: var(--mono-green);">${totalCount}</span>
                    <span style="font-size: 14px; color: var(--mono-text-secondary);"> –¥—ñ–ª.</span>
                    <span style="font-size: 18px; font-weight: 600; color: var(--mono-text); margin-left: 8px;">${totalArea.toFixed(1)}</span>
                    <span style="font-size: 12px; color: var(--mono-text-secondary);"> –≥–∞</span>
                    <span style="background: var(--mono-green-bg); color: var(--mono-green); padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600; margin-left: 12px;">${percentOfTotal}%</span>
                </div>
            `;
            
            // –ì–µ–Ω–µ—Ä—É—î–º–æ –∫–∞—Ä—Ç–∫–∏
            let cardsHtml = '';
            categories.forEach(cat => {
                cardsHtml += `
                    <div style="background: var(--mono-surface-2); border-radius: 8px; padding: 10px 14px; border-left: 3px solid ${cat.color}; min-width: 100px; flex: 1;">
                        <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;">
                            <span style="font-size: 14px;">${cat.icon}</span>
                            <span style="font-size: 11px; color: var(--mono-text-secondary); text-transform: uppercase; letter-spacing: 0.3px;">${cat.label}</span>
                        </div>
                        <div style="display: flex; align-items: baseline; gap: 8px;">
                            <span style="font-size: 20px; font-weight: 700; color: ${cat.colorVar};">${cat.count}</span>
                            <span style="font-size: 12px; color: var(--mono-text-secondary);">${cat.area.toFixed(1)} –≥–∞</span>
                        </div>
                    </div>
                `;
            });
            cardsContainer.innerHTML = cardsHtml;
            
            // –ì–µ–Ω–µ—Ä—É—î–º–æ –ø—Ä–æ–≥—Ä–µ—Å-–±–∞—Ä
            let progressHtml = '';
            categories.forEach(cat => {
                const widthPercent = totalArea > 0 ? (cat.area / stats.totalArea * 100) : 0;
                if (widthPercent > 0) {
                    progressHtml += `<div style="width: ${widthPercent}%; background: ${cat.color}; height: 100%;" title="${cat.label}: ${cat.count} –¥—ñ–ª., ${cat.area.toFixed(1)} –≥–∞"></div>`;
                }
            });
            progressBar.innerHTML = progressHtml;
            progressText.textContent = `${percentOfTotal}% –≤—ñ–¥ –∑–∞–≥–∞–ª—å–Ω–æ—ó –ø–ª–æ—â—ñ`;
            
            // –°–ø–∏—Å–æ–∫ –Ω–æ–≤–∏—Ö –≤–ª–∞—Å–Ω–∏–∫—ñ–≤
            if (newOwnersCount > 0) {
                newOwnersDetails.style.display = 'block';
                
                let allOwners = [];
                newOwnersYears.forEach(year => {
                    stats.newOwnersFree[year].owners.forEach(o => {
                        o.year = year;
                        allOwners.push(o);
                    });
                });
                
                allOwners.sort((a, b) => b.area - a.area);
                const top10 = allOwners.slice(0, 10);
                
                let listHtml = `<div style="display: flex; flex-direction: column; gap: 6px;">`;
                top10.forEach((owner, index) => {
                    const yearColor = parseInt(owner.year) === currentYear ? 'var(--mono-orange)' : 'var(--mono-yellow)';
                    listHtml += `
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px 10px; background: var(--mono-surface-2); border-radius: 6px; border-left: 2px solid ${yearColor};">
                            <div style="display: flex; align-items: center; gap: 8px; flex: 1; min-width: 0;">
                                <span style="color: var(--mono-text-secondary); font-size: 11px; min-width: 16px;">${index + 1}</span>
                                <span style="font-size: 13px; color: var(--mono-text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${owner.name}</span>
                            </div>
                            <span style="font-size: 12px; font-weight: 600; color: var(--mono-orange); white-space: nowrap; margin-left: 8px;">${owner.area.toFixed(2)} –≥–∞</span>
                        </div>
                    `;
                });
                listHtml += `</div>`;
                newOwnersList.innerHTML = listHtml;
            } else {
                newOwnersDetails.style.display = 'none';
            }
        }
        
        // –°—Ç–∞—Ä—ñ —Ñ—É–Ω–∫—Ü—ñ—ó (–¥–ª—è —Å—É–º—ñ—Å–Ω–æ—Å—Ç—ñ)
        function updatePotentialCard(stats) {
            // –ó–∞–º—ñ–Ω–µ–Ω–æ –Ω–∞ updatePotentialSection
        }
        
        function updateNewOwnersSection(stats) {
            // –ó–∞–º—ñ–Ω–µ–Ω–æ –Ω–∞ updatePotentialSection
        }

        function updateConcentration(stats) {
            // –ù–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è
        }

        // Timeline Cards –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –¥–æ–≥–æ–≤–æ—Ä—ñ–≤
        function updateExpiryTimeline(stats) {
            const timeline = document.getElementById('expiryTimeline');
            const progressBar = document.getElementById('expiryProgressBar');
            const summary = document.getElementById('expirySummary');
            const detailsContainer = document.getElementById('expiryDetails');
            
            // –ó–±–∏—Ä–∞—î–º–æ –¥–∞–Ω—ñ –ø–æ —Ä–æ–∫–∞—Ö
            const yearData = [];
            
            // –ü—Ä–æ—Å—Ç—Ä–æ—á–µ–Ω—ñ
            let expiredCount = 0, expiredArea = 0, expiredTenants = {};
            Object.entries(stats.expiryYears).forEach(([year, data]) => {
                if (parseInt(year) < currentYear) {
                    expiredCount += data.count;
                    expiredArea += data.area;
                    Object.entries(data.tenants || {}).forEach(([tenant, tData]) => {
                        if (!expiredTenants[tenant]) expiredTenants[tenant] = { count: 0, area: 0 };
                        expiredTenants[tenant].count += tData.count;
                        expiredTenants[tenant].area += tData.area;
                    });
                }
            });
            
            if (expiredCount > 0) {
                yearData.push({
                    id: 'expired',
                    label: '–ü—Ä–æ—Å—Ç—Ä–æ—á–µ–Ω–æ',
                    icon: 'üî¥',
                    count: expiredCount,
                    area: expiredArea,
                    color: '#EF4444',
                    tenants: expiredTenants
                });
            }
            
            // –†–æ–∫–∏ –≤—ñ–¥ –ø–æ—Ç–æ—á–Ω–æ–≥–æ –¥–æ +4
            for (let year = currentYear; year <= currentYear + 4; year++) {
                const data = stats.expiryYears[year] || { count: 0, area: 0, tenants: {} };
                if (data.count > 0) {
                    const isCurrent = year === currentYear;
                    yearData.push({
                        id: `year${year}`,
                        label: `${year}`,
                        icon: isCurrent ? 'üü°' : 'üìÖ',
                        count: data.count,
                        area: data.area,
                        color: isCurrent ? '#F59E0B' : '#6B7280',
                        tenants: data.tenants || {}
                    });
                }
            }
            
            // –ü—ñ–¥—Ä–∞—Ö—É–Ω–æ–∫ –∑–∞–≥–∞–ª—å–Ω–æ–≥–æ
            let totalCount = 0, totalArea = 0;
            yearData.forEach(d => {
                totalCount += d.count;
                totalArea += d.area;
            });
            
            // Summary
            summary.innerHTML = `
                <span style="font-size: 20px; font-weight: 700; color: var(--mono-text);">${totalCount}</span>
                <span style="font-size: 12px; color: var(--mono-text-secondary);">–¥—ñ–ª.</span>
                <span style="font-size: 16px; font-weight: 600; color: var(--mono-text); margin-left: 4px;">${totalArea.toFixed(1)}</span>
                <span style="font-size: 12px; color: var(--mono-text-secondary);">–≥–∞</span>
            `;
            
            // Timeline Cards
            let timelineHtml = '';
            yearData.forEach((d, index) => {
                const isFirst = index === 0;
                const borderColor = d.color;
                
                timelineHtml += `
                    <div class="timeline-card" data-year="${d.id}" style="
                        min-width: 120px;
                        flex: 1;
                        background: var(--mono-surface-2);
                        border-radius: 12px;
                        padding: 16px;
                        border-top: 3px solid ${borderColor};
                        cursor: pointer;
                        transition: transform 0.2s, box-shadow 0.2s;
                        position: relative;
                    " onclick="toggleYearDetails('${d.id}')">
                        <div style="font-size: 12px; color: var(--mono-text-secondary); margin-bottom: 8px; display: flex; align-items: center; gap: 4px;">
                            <span>${d.icon}</span>
                            <span>${d.label}</span>
                        </div>
                        <div style="font-size: 28px; font-weight: 700; color: ${d.color};">${d.count}</div>
                        <div style="font-size: 13px; color: var(--mono-text-secondary);">${d.area.toFixed(1)} –≥–∞</div>
                        <div style="position: absolute; bottom: 8px; right: 12px; font-size: 10px; color: var(--mono-text-secondary);">
                            <i class="bi bi-chevron-down"></i>
                        </div>
                    </div>
                `;
            });
            timeline.innerHTML = timelineHtml;
            
            // Progress bar
            let progressHtml = '';
            yearData.forEach(d => {
                const widthPercent = stats.rentedArea > 0 ? (d.area / stats.rentedArea * 100) : 0;
                if (widthPercent > 0) {
                    progressHtml += `<div style="width: ${widthPercent}%; background: ${d.color}; height: 100%;" title="${d.label}: ${d.count} –¥—ñ–ª."></div>`;
                }
            });
            progressBar.innerHTML = progressHtml;
            
            // Details (–∞–∫–æ—Ä–¥–µ–æ–Ω)
            let detailsHtml = '';
            yearData.forEach(d => {
                const tenantsList = Object.entries(d.tenants)
                    .sort((a, b) => b[1].area - a[1].area)
                    .slice(0, 5);
                
                const othersCount = Object.keys(d.tenants).length - 5;
                
                let tenantsHtml = '';
                tenantsList.forEach(([tenantKey, tData]) => {
                    const displayName = getTenantDisplayName(tenantKey);
                    const color = getColor(tenantKey);
                    const percent = d.area > 0 ? (tData.area / d.area * 100).toFixed(0) : 0;
                    
                    tenantsHtml += `
                        <div style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: var(--mono-surface); border-radius: 6px;">
                            <span style="width: 8px; height: 8px; background: ${color}; border-radius: 50%;"></span>
                            <span style="flex: 1; font-size: 13px; color: var(--mono-text); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${displayName}</span>
                            <span style="font-size: 12px; color: var(--mono-text-secondary);">${tData.count} –¥—ñ–ª.</span>
                            <span style="font-size: 12px; font-weight: 600; color: ${d.color};">${tData.area.toFixed(1)} –≥–∞</span>
                            <div style="width: 50px; height: 4px; background: var(--mono-surface-3); border-radius: 2px; overflow: hidden;">
                                <div style="width: ${percent}%; height: 100%; background: ${color};"></div>
                            </div>
                        </div>
                    `;
                });
                
                if (othersCount > 0) {
                    tenantsHtml += `
                        <div style="text-align: center; padding: 8px; color: var(--mono-text-secondary); font-size: 12px;">
                            ... —â–µ ${othersCount} –æ—Ä–µ–Ω–¥–∞—Ä—ñ–≤
                        </div>
                    `;
                }
                
                detailsHtml += `
                    <div id="details-${d.id}" style="display: none; margin-top: 12px; padding: 12px; background: var(--mono-surface-2); border-radius: 8px; border-left: 3px solid ${d.color};">
                        <div style="font-size: 14px; font-weight: 600; color: var(--mono-text); margin-bottom: 10px;">
                            ${d.icon} ${d.label} ‚Äî ${d.count} –¥–æ–≥–æ–≤–æ—Ä—ñ–≤ (${d.area.toFixed(1)} –≥–∞)
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 6px;">
                            ${tenantsHtml || '<div style="color: var(--mono-text-secondary); font-size: 13px;">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –ø—Ä–æ –æ—Ä–µ–Ω–¥–∞—Ä—ñ–≤</div>'}
                        </div>
                    </div>
                `;
            });
            detailsContainer.innerHTML = detailsHtml;
            
            // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –¥–∞–Ω—ñ –¥–ª—è –¥–æ—Å—Ç—É–ø—É
            window.expiryYearData = yearData;
        }
        
        // –ü–µ—Ä–µ–º–∏–∫–∞—á –¥–µ—Ç–∞–ª–µ–π –ø–æ —Ä–æ–∫—É
        function toggleYearDetails(yearId) {
            const detailsEl = document.getElementById(`details-${yearId}`);
            const allDetails = document.querySelectorAll('[id^="details-"]');
            
            // –ó–∞–∫—Ä–∏–≤–∞—î–º–æ –≤—Å—ñ —ñ–Ω—à—ñ
            allDetails.forEach(el => {
                if (el.id !== `details-${yearId}`) {
                    el.style.display = 'none';
                }
            });
            
            // –ü–µ—Ä–µ–º–∏–∫–∞—î–º–æ –ø–æ—Ç–æ—á–Ω–∏–π
            if (detailsEl) {
                detailsEl.style.display = detailsEl.style.display === 'none' ? 'block' : 'none';
            }
        }
        
        // –°—Ç–∞—Ä–∞ —Ñ—É–Ω–∫—Ü—ñ—è –¥–ª—è —Å—É–º—ñ—Å–Ω–æ—Å—Ç—ñ
        function updateForecastTable(stats) {
            updateExpiryTimeline(stats);
        }
        
        function updateMatrixTable(expiryYears, tenants) {
            const years = Object.keys(expiryYears).sort((a, b) => a - b).filter(y => parseInt(y) >= currentYear - 2);
            const header = document.getElementById('matrixHeader');
            const tbody = document.getElementById('matrixTableBody');
            
            if (!header || !tbody) return;
            
            // –ó–Ω–∞—Ö–æ–¥–∏–º–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è –¥–ª—è heatmap
            let maxArea = 0;
            Object.values(expiryYears).forEach(yearData => {
                Object.values(yearData.tenants || {}).forEach(t => {
                    if (t.area > maxArea) maxArea = t.area;
                });
            });
            
            // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –∫–æ–ª—å–æ—Ä—É heatmap
            function getHeatmapStyle(area, isCurrentYear) {
                if (area <= 0) return '';
                const intensity = Math.min(area / maxArea, 1);
                const baseColor = isCurrentYear ? '239, 68, 68' : '16, 185, 129'; // —á–µ—Ä–≤–æ–Ω–∏–π –¥–ª—è –ø–æ—Ç–æ—á–Ω–æ–≥–æ, –∑–µ–ª–µ–Ω–∏–π –¥–ª—è —ñ–Ω—à–∏—Ö
                const alpha = 0.2 + intensity * 0.5; // –≤—ñ–¥ 0.2 –¥–æ 0.7
                return `background-color: rgba(${baseColor}, ${alpha}) !important;`;
            }
            
            // Header
            let headerHtml = '<th class="sticky-col">–û—Ä–µ–Ω–¥–∞—Ä</th>';
            years.forEach(year => {
                const isCurrent = parseInt(year) === currentYear;
                const yearClass = parseInt(year) < currentYear ? 'year-expired' : (isCurrent ? 'year-current' : 'year-future');
                // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ box-shadow –¥–ª—è —Ä–∞–º–∫–∏ (–ø—Ä–∞—Ü—é—î –∑ border-collapse)
                const currentYearStyle = isCurrent ? 
                    'box-shadow: inset 0 0 0 2px #EF4444; background-color: rgba(239, 68, 68, 0.15) !important; color: #EF4444; font-weight: 700;' : '';
                headerHtml += `<th class="text-end ${yearClass}" style="${currentYearStyle}">${year}</th>`;
            });
            headerHtml += '<th class="text-end">–í—Å—å–æ–≥–æ</th>';
            header.innerHTML = headerHtml;
            
            let html = '';
            const yearTotals = {};
            years.forEach(y => yearTotals[y] = 0);
            
            Object.entries(tenants)
                .sort((a, b) => b[1].area - a[1].area)
                .forEach(([tenantKey, data]) => {
                    const color = getColor(tenantKey);
                    const displayName = getTenantDisplayName(tenantKey);
                    let rowTotal = 0;
                    
                    html += `<tr><td class="sticky-col"><span class="tenant-indicator" style="background-color: ${color};"></span><span style="color: ${color};">${displayName}</span></td>`;
                    
                    years.forEach(year => {
                        const areaForYear = expiryYears[year]?.tenants?.[tenantKey]?.area || 0;
                        yearTotals[year] += areaForYear;
                        rowTotal += areaForYear;
                        
                        const isCurrent = parseInt(year) === currentYear;
                        const heatmapStyle = getHeatmapStyle(areaForYear, isCurrent);
                        // box-shadow –¥–ª—è —Ä–∞–º–∫–∏ –ø–æ—Ç–æ—á–Ω–æ–≥–æ —Ä–æ–∫—É
                        const currentYearStyle = isCurrent ? 
                            'box-shadow: inset 2px 0 0 #EF4444, inset -2px 0 0 #EF4444;' : '';
                        
                        html += `<td class="text-end" style="${heatmapStyle}${currentYearStyle}">${areaForYear > 0 ? areaForYear.toFixed(1) : '-'}</td>`;
                    });
                    
                    html += `<td class="text-end" style="font-weight: 600;">${rowTotal > 0 ? rowTotal.toFixed(1) : '-'}</td></tr>`;
                });
            
            tbody.innerHTML = html;
            
            // Sticky footer - —Ä—è–¥–æ–∫ "–í—Å—å–æ–≥–æ" (sticky –∑–Ω–∏–∑—É)
            const footer = document.getElementById('matrixFooter');
            if (footer) {
                let grandTotal = 0;
                let footerHtml = '<tr style="background-color: #1C1C1E;"><td class="sticky-col" style="position: sticky; left: 0; background-color: #1C1C1E; font-weight: 700;">–í—Å—å–æ–≥–æ</td>';
                years.forEach(year => {
                    grandTotal += yearTotals[year];
                    const isCurrent = parseInt(year) === currentYear;
                    const currentYearStyle = isCurrent ? 
                        'box-shadow: inset 2px 0 0 #EF4444, inset -2px 0 0 #EF4444, inset 0 -2px 0 #EF4444; background-color: rgba(239, 68, 68, 0.25) !important; color: #EF4444;' : 
                        'background-color: #1C1C1E;';
                    footerHtml += `<td class="text-end" style="${currentYearStyle} font-weight: 700;">${yearTotals[year] > 0 ? yearTotals[year].toFixed(1) : '-'}</td>`;
                });
                footerHtml += `<td class="text-end" style="font-weight: 700; background-color: #1C1C1E;">${grandTotal.toFixed(1)}</td></tr>`;
                footer.innerHTML = footerHtml;
            }
        }

        function updateRegistrationTable(registrationYears) {
            // –ù–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è
        }

        function updateTenantsTable(stats) {
            const tbody = document.getElementById('tenantsTableBody');
            const sorted = Object.entries(stats.tenants).sort((a, b) => b[1].area - a[1].area);
            
            let html = '';
            sorted.forEach(([tenantKey, data]) => {
                const percent = (data.area / stats.totalArea * 100).toFixed(1);
                const avgArea = (data.area / data.count).toFixed(2);
                const color = getColor(tenantKey);
                // –û—Ç—Ä–∏–º—É—î–º–æ –∫–∞–Ω–æ–Ω—ñ—á–Ω—É –Ω–∞–∑–≤—É –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è
                const displayName = getTenantDisplayName(tenantKey);
                
                html += `
                    <tr>
                        <td>
                            <span class="tenant-indicator" style="background-color: ${color};"></span>
                            <span style="color: ${color}; font-weight: 500;">${displayName}</span>
                        </td>
                        <td class="text-end">${data.count}</td>
                        <td class="text-end">${data.area.toFixed(2)}</td>
                        <td class="text-end">${percent}%</td>
                        <td class="text-end">${avgArea}</td>
                        <td class="text-end">${formatNumber(data.ngo)}</td>
                    </tr>`;
            });
            
            tbody.innerHTML = html || '<tr><td colspan="6" style="text-align: center; color: var(--mono-text-secondary);">–ù–µ–º–∞—î –æ—Ä–µ–Ω–¥–∞—Ä—ñ–≤</td></tr>';
        }

        function updateOwnersTable() {
            if (!globalStats) return;
            
            const minParcels = parseInt(document.getElementById('minParcelsFilter').value) || 3;
            const tbody = document.getElementById('ownersTableBody');
            const sorted = Object.entries(globalStats.owners)
                .filter(([_, data]) => data.count >= minParcels)
                .sort((a, b) => b[1].area - a[1].area);
            
            let html = '';
            sorted.forEach(([name, data]) => {
                const avgArea = (data.area / data.count).toFixed(2);
                html += `
                    <tr>
                        <td>${name}</td>
                        <td class="text-end">${data.count}</td>
                        <td class="text-end">${data.area.toFixed(2)}</td>
                        <td class="text-end">${avgArea}</td>
                    </tr>`;
            });
            
            tbody.innerHTML = html || '<tr><td colspan="4" style="text-align: center; color: var(--mono-text-secondary);">–ù–µ–º–∞—î –≤–ª–∞—Å–Ω–∏–∫—ñ–≤ –∑ —Ç–∞–∫–æ—é –∫—ñ–ª—å–∫—ñ—Å—Ç—é –¥—ñ–ª—è–Ω–æ–∫</td></tr>';
        }

        // ========== –ù–û–í–Ü –§–£–ù–ö–¶–Ü–á ==========
        
        // –ì—Ä–∞—Ñ—ñ–∫ –¥–∏–Ω–∞–º—ñ–∫–∏ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó
        let registrationChartInstance = null;
        let tenantsChartInstance = null;
        
        function updateRegistrationChart(registrationYears) {
            const ctx = document.getElementById('registrationChart');
            if (!ctx) return;
            
            const years = Object.keys(registrationYears).sort((a, b) => a - b);
            const activeData = years.map(y => registrationYears[y].active || 0);
            const inactiveData = years.map(y => registrationYears[y].inactive || 0);
            
            if (registrationChartInstance) {
                registrationChartInstance.destroy();
            }
            
            registrationChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: years,
                    datasets: [
                        {
                            label: '–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –≤–ª–∞—Å–Ω–æ—Å—Ç—ñ',
                            data: years.map(y => registrationYears[y].total || 0),
                            backgroundColor: 'rgba(16, 185, 129, 0.7)',
                            borderColor: '#10B981',
                            borderWidth: 1,
                            borderRadius: 4
                        },
                        {
                            label: '–£–∫–ª–∞–¥–µ–Ω–æ –¥–æ–≥–æ–≤–æ—Ä—ñ–≤ –æ—Ä–µ–Ω–¥–∏',
                            data: years.map(y => registrationYears[y].active || 0),
                            backgroundColor: 'rgba(59, 130, 246, 0.7)',
                            borderColor: '#3B82F6',
                            borderWidth: 1,
                            borderRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false // –õ–µ–≥–µ–Ω–¥–∞ –≤ –∑–∞–≥–æ–ª–æ–≤–∫—É —Å–µ–∫—Ü—ñ—ó
                        },
                        tooltip: {
                            backgroundColor: '#2C2C2E',
                            titleColor: '#FFFFFF',
                            bodyColor: '#ABABAB',
                            borderColor: 'rgba(255,255,255,0.1)',
                            borderWidth: 1,
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.raw} –¥—ñ–ª—è–Ω–æ–∫`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { color: '#8E8E93', font: { size: 11 } }
                        },
                        y: {
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { color: '#8E8E93', font: { size: 11 } },
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // –°–ø–æ–≤—ñ—â–µ–Ω–Ω—è –ø—Ä–æ –¥–æ–≥–æ–≤–æ—Ä–∏ (–ø—Ä–∏–±—Ä–∞–Ω–æ, –∞–ª–µ –∑–∞–ª–∏—à–∞—î–º–æ –ø–æ—Ä–æ–∂–Ω—é —Ñ—É–Ω–∫—Ü—ñ—é)
        function updateAlerts(stats, features) {
            // –ù–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è
        }
        
        // –ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü—ñ—è –æ—Ä–µ–Ω–¥–∞—Ä—ñ–≤ (–ø—Ä–∏–±—Ä–∞–Ω–æ)
        function updateConcentration(stats) {
            // –ù–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è
        }
        
        // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó (–æ–±'—î–¥–Ω–∞–Ω–æ –∑ –≥—Ä–∞—Ñ—ñ–∫–æ–º)
        function updateRegistrationTable(registrationYears) {
            // –ù–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è
        }
        
        // –ì—Ä–∞—Ñ—ñ–∫ –æ—Ä–µ–Ω–¥–∞—Ä—ñ–≤ (–ø—Ä–∏–±—Ä–∞–Ω–æ)
        function updateTenantsChart(tenants, totalArea) {
            // –ù–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è
        }

        // –ï–∫—Å–ø–æ—Ä—Ç –≤ Excel
        function exportToExcel() {
            if (!globalStats) {
                alert('–î–∞–Ω—ñ —â–µ –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ');
                return;
            }
            
            const wb = XLSX.utils.book_new();
            
            // –õ–∏—Å—Ç 1: –ó–∞–≥–∞–ª—å–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            const summaryData = [
                ['–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ä–∞–¥—ñ:', councilName],
                ['–î–∞—Ç–∞ –∑–≤—ñ—Ç—É:', new Date().toLocaleDateString('uk-UA')],
                [''],
                ['–ü–æ–∫–∞–∑–Ω–∏–∫', '–ó–Ω–∞—á–µ–Ω–Ω—è'],
                ['–ó–∞–≥–∞–ª—å–Ω–∞ –ø–ª–æ—â–∞ (–≥–∞)', globalStats.totalArea.toFixed(2)],
                ['–ö—ñ–ª—å–∫—ñ—Å—Ç—å –¥—ñ–ª—è–Ω–æ–∫', globalStats.totalParcels],
                ['–í—ñ–ª—å–Ω—ñ –≤—ñ–¥ –æ—Ä–µ–Ω–¥–∏ (–≥–∞)', globalStats.freeArea.toFixed(2)],
                ['–ö—ñ–ª—å–∫—ñ—Å—Ç—å –≤—ñ–ª—å–Ω–∏—Ö –¥—ñ–ª—è–Ω–æ–∫', globalStats.freeParcels],
                ['–ö—ñ–ª—å–∫—ñ—Å—Ç—å –æ—Ä–µ–Ω–¥–∞—Ä—ñ–≤', Object.keys(globalStats.tenants).length],
                ['–ù–ì–û (–≥—Ä–Ω)', globalStats.totalNGO.toFixed(0)]
            ];
            const ws1 = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, ws1, '–ó–∞–≥–∞–ª—å–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞');
            
            // –õ–∏—Å—Ç 2: –û—Ä–µ–Ω–¥–∞—Ä—ñ
            const tenantsData = [['–û—Ä–µ–Ω–¥–∞—Ä', '–ö—ñ–ª—å–∫—ñ—Å—Ç—å –¥—ñ–ª—è–Ω–æ–∫', '–ü–ª–æ—â–∞ (–≥–∞)', '% –ø–ª–æ—â—ñ', '–°–µ—Ä–µ–¥–Ω—è –ø–ª–æ—â–∞', '–ù–ì–û (–≥—Ä–Ω)']];
            Object.entries(globalStats.tenants)
                .sort((a, b) => b[1].area - a[1].area)
                .forEach(([tenantKey, data]) => {
                    const displayName = getTenantDisplayName(tenantKey);
                    tenantsData.push([
                        displayName,
                        data.count,
                        data.area.toFixed(2),
                        (data.area / globalStats.totalArea * 100).toFixed(1) + '%',
                        (data.area / data.count).toFixed(2),
                        data.ngo.toFixed(0)
                    ]);
                });
            const ws2 = XLSX.utils.aoa_to_sheet(tenantsData);
            XLSX.utils.book_append_sheet(wb, ws2, '–û—Ä–µ–Ω–¥–∞—Ä—ñ');
            
            // –õ–∏—Å—Ç 3: –ü—Ä–æ–≥–Ω–æ–∑ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è
            const forecastData = [['–†—ñ–∫', '–ö—ñ–ª—å–∫—ñ—Å—Ç—å –¥–æ–≥–æ–≤–æ—Ä—ñ–≤', '–ü–ª–æ—â–∞ (–≥–∞)', '% –≤—ñ–¥ –æ—Ä–µ–Ω–¥–æ–≤–∞–Ω–æ—ó']];
            
            // –ü—Ä–æ—Å—Ç—Ä–æ—á–µ–Ω—ñ
            let expiredCount = 0, expiredArea = 0;
            Object.entries(globalStats.expiryYears).forEach(([year, data]) => {
                if (parseInt(year) < currentYear) {
                    expiredCount += data.count;
                    expiredArea += data.area;
                }
            });
            if (expiredCount > 0) {
                forecastData.push(['–ü—Ä–æ—Å—Ç—Ä–æ—á–µ–Ω—ñ', expiredCount, expiredArea.toFixed(2), 
                    (expiredArea / globalStats.rentedArea * 100).toFixed(1) + '%']);
            }
            
            for (let year = currentYear; year <= currentYear + 5; year++) {
                const yearData = globalStats.expiryYears[year] || { count: 0, area: 0 };
                forecastData.push([
                    year,
                    yearData.count,
                    yearData.area.toFixed(2),
                    globalStats.rentedArea > 0 ? (yearData.area / globalStats.rentedArea * 100).toFixed(1) + '%' : '0%'
                ]);
            }
            const ws3 = XLSX.utils.aoa_to_sheet(forecastData);
            XLSX.utils.book_append_sheet(wb, ws3, '–ü—Ä–æ–≥–Ω–æ–∑ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è');
            
            // –õ–∏—Å—Ç 4: –ú–∞—Ç—Ä–∏—Ü—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è
            const years = Object.keys(globalStats.expiryYears).sort((a, b) => a - b).filter(y => parseInt(y) >= currentYear - 2);
            const matrixData = [['–û—Ä–µ–Ω–¥–∞—Ä', ...years, '–í—Å—å–æ–≥–æ']];
            
            Object.entries(globalStats.tenants)
                .sort((a, b) => b[1].area - a[1].area)
                .forEach(([tenantKey, data]) => {
                    const displayName = getTenantDisplayName(tenantKey);
                    const row = [displayName];
                    let rowTotal = 0;
                    years.forEach(year => {
                        const areaForYear = globalStats.expiryYears[year]?.tenants?.[tenantKey]?.area || 0;
                        row.push(areaForYear > 0 ? areaForYear.toFixed(1) : '-');
                        rowTotal += areaForYear;
                    });
                    row.push(rowTotal > 0 ? rowTotal.toFixed(1) : '-');
                    matrixData.push(row);
                });
            const ws4 = XLSX.utils.aoa_to_sheet(matrixData);
            XLSX.utils.book_append_sheet(wb, ws4, '–ú–∞—Ç—Ä–∏—Ü—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è');
            
            // –õ–∏—Å—Ç 5: –í–ª–∞—Å–Ω–∏–∫–∏
            const ownersData = [['–í–ª–∞—Å–Ω–∏–∫', '–ö—ñ–ª—å–∫—ñ—Å—Ç—å –¥—ñ–ª—è–Ω–æ–∫', '–ü–ª–æ—â–∞ (–≥–∞)', '–°–µ—Ä–µ–¥–Ω—è –ø–ª–æ—â–∞']];
            Object.entries(globalStats.owners)
                .sort((a, b) => b[1].area - a[1].area)
                .forEach(([name, data]) => {
                    ownersData.push([
                        name,
                        data.count,
                        data.area.toFixed(2),
                        (data.area / data.count).toFixed(2)
                    ]);
                });
            const ws5 = XLSX.utils.aoa_to_sheet(ownersData);
            XLSX.utils.book_append_sheet(wb, ws5, '–í–ª–∞—Å–Ω–∏–∫–∏');
            
            // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Ñ–∞–π–ª
            XLSX.writeFile(wb, `–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞_${councilName}.xlsx`);
        }

        function goBack() {
            let returnUrl = 'index.html';
            if (id) returnUrl += `?id=${id}`;
            if (selectedFile) {
                returnUrl += id ? '&' : '?';
                returnUrl += `return_file=${encodeURIComponent(selectedFile)}`;
            }
            window.location.href = returnUrl;
        }

        document.addEventListener('DOMContentLoaded', loadAndProcessData);
    </script>
</body>
</html>
