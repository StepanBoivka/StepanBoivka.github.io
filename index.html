<!doctype html>
<html lang="uk">
<head>
    <meta charset="utf-8">
    <!-- –Ñ–¥–∏–Ω–∏–π –æ–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω–∏–π viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>–ê–ì–†–û-–ü–†–û–°–¢–Ü–†</title>
    
    <!-- PWA Meta Tags -->
    <meta name="application-name" content="–ê–ì–†–û-–ü–†–û–°–¢–Ü–†">
    <meta name="apple-mobile-web-app-title" content="–ê–ì–†–û-–ü–†–û–°–¢–Ü–†">
    <meta name="description" content="–Ü–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è –∞–≥—Ä–∞—Ä–Ω–æ–≥–æ —Å–µ–∫—Ç–æ—Ä—É –£–∫—Ä–∞—ó–Ω–∏">
    <meta name="theme-color" content="#198754">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="format-detection" content="telephone=no">
    <meta name="msapplication-tap-highlight" content="no">
    <meta name="msapplication-TileColor" content="#198754">
    <meta name="msapplication-config" content="browserconfig.xml">
    
    <!-- Additional mobile optimization -->
    <meta name="HandheldFriendly" content="true">
    <meta name="MobileOptimized" content="width">
    <meta name="apple-touch-fullscreen" content="yes">
    <meta name="apple-mobile-web-app-orientations" content="portrait">
    <meta name="screen-orientation" content="portrait">
    <meta name="x5-orientation" content="portrait">
    <meta name="full-screen" content="yes">
    <meta name="x5-fullscreen" content="true">
    <meta name="browsermode" content="application">
    <meta name="x5-page-mode" content="app">
    
    <!-- PWA display mode -->
    <meta name="display-mode" content="standalone">
    <link rel="manifest" crossorigin="use-credentials" id="manifestLink" href="manifest.json">
    
    <!-- JavaScript –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –¥–∏–Ω–∞–º—ñ—á–Ω–æ–≥–æ –º–∞–Ω—ñ—Ñ–µ—Å—Ç–∞ -->
    <script src="js/manifest-generator.js"></script>
    
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <!-- –í–µ—Ä—Å—ñ—è –¥–ª—è –æ—á–∏—â–µ–Ω–Ω—è –∫–µ—à—É -->
    <meta name="cache-version" content="2025-07-16-enhanced-install-button">
    
    <!-- –î–æ–¥–∞—Ç–∫–æ–≤–∏–π –ø—Ä–∏–º—É—Å–æ–≤–∏–π —á–∞—Å –¥–ª—è –∫–µ—à—É -->
    <meta name="cache-bust" content="1721088800">
    
    <!-- PWA Manifest -->
    <!-- Manifest link moved up to PWA Meta Tags section -->
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDE4MCAxODAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxODAiIGhlaWdodD0iMTgwIiByeD0iMjIiIGZpbGw9IiMxOTg3NTQiLz4KPHN2ZyB4PSI0NSIgeT0iNDUiIHdpZHRoPSI5MCIgaGVpZ2h0PSI5MCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJ3aGl0ZSI+CjxwYXRoIGQ9Ik0xMiAyQzguMTMgMiA1IDUuMTMgNSA5YzAgNS4yNSA3IDEzIDcgMTNzNy03Ljc1IDctMTNjMC0zLjg3LTMuMTMtNy03LTd6bTAgOS41Yy0xLjM4IDAtMi41LTEuMTItMi41LTIuNXMxLjEyLTIuNSAyLjUtMi41IDIuNSAxLjEyIDIuNSAyLjUtMS4xMiAyLjUtMi41IDIuNXoiLz4KPC9zdmc+Cjwvc3ZnPgo=">
    <link rel="apple-touch-icon" sizes="152x152" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUyIiBoZWlnaHQ9IjE1MiIgdmlld0JveD0iMCAwIDE1MiAxNTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxNTIiIGhlaWdodD0iMTUyIiByeD0iMTkiIGZpbGw9IiMxOTg3NTQiLz4KPHN2ZyB4PSIzOCIgeT0iMzgiIHdpZHRoPSI3NiIgaGVpZ2h0PSI3NiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJ3aGl0ZSI+CjxwYXRoIGQ9Ik0xMiAyQzguMTMgMiA1IDUuMTMgNSA5YzAgNS4yNSA3IDEzIDcgMTNzNy03Ljc1IDctMTNjMC0zLjg3LTMuMTMtNy03LTd6bTAgOS41Yy0xLjM4IDAtMi41LTEuMTItMi41LTIuNXMxLjEyLTIuNSAyLjUtMi41IDIuNSAxLjEyIDIuNSAyLjUtMS4xMiAyLjUtMi41IDIuNXoiLz4KPC9zdmc+Cjwvc3ZnPgo=">
    <link rel="apple-touch-icon" sizes="144x144" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTQ0IiBoZWlnaHQ9IjE0NCIgdmlld0JveD0iMCAwIDE0NCAxNDQiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxNDQiIGhlaWdodD0iMTQ0IiByeD0iMTgiIGZpbGw9IiMxOTg3NTQiLz4KPHN2ZyB4PSIzNiIgeT0iMzYiIHdpZHRoPSI3MiIgaGVpZ2h0PSI3MiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJ3aGl0ZSI+CjxwYXRoIGQ9Ik0xMiAyQzguMTMgMiA1IDUuMTMgNSA5YzAgNS4yNSA3IDEzIDcgMTNzNy03Ljc1IDctMTNjMC0zLjg3LTMuMTMtNy03LTd6bTAgOS41Yy0xLjM4IDAtMi41LTEuMTItMi41LTIuNXMxLjEyLTIuNSAyLjUtMi41IDIuNSAxLjEyIDIuNSAyLjUtMS4xMiAyLjUtMi41IDIuNXoiLz4KPC9zdmc+Cjwvc3ZnPgo=">
    <link rel="apple-touch-icon" sizes="120x120" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjEyMCIgdmlld0JveD0iMCAwIDEyMCAxMjAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMjAiIGhlaWdodD0iMTIwIiByeD0iMTUiIGZpbGw9IiMxOTg3NTQiLz4KPHN2ZyB4PSIzMCIgeT0iMzAiIHdpZHRoPSI2MCIgaGVpZ2h0PSI2MCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJ3aGl0ZSI+CjxwYXRoIGQ9Ik0xMiAyQzguMTMgMiA1IDUuMTMgNSA5YzAgNS4yNSA3IDEzIDcgMTNzNy03Ljc1IDctMTNjMC0zLjg3LTMuMTMtNy03LTd6bTAgOS41Yy0xLjM4IDAtMi41LTEuMTItMi41LTIuNXMxLjEyLTIuNSAyLjUtMi41IDIuNSAxLjEyIDIuNSAyLjUtMS4xMiAyLjUtMi41IDIuNXoiLz4KPC9zdmc+Cjwvc3ZnPgo=">
    <link rel="apple-touch-icon" sizes="114x114" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTE0IiBoZWlnaHQ9IjExNCIgdmlld0JveD0iMCAwIDExNCAxMTQiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMTQiIGhlaWdodD0iMTE0IiByeD0iMTQiIGZpbGw9IiMxOTg3NTQiLz4KPHN2ZyB4PSIyOCIgeT0iMjgiIHdpZHRoPSI1OCIgaGVpZ2h0PSI1OCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJ3aGl0ZSI+CjxwYXRoIGQ9Ik0xMiAyQzguMTMgMiA1IDUuMTMgNSA5YzAgNS4yNSA3IDEzIDcgMTNzNy03Ljc1IDctMTNjMC0zLjg3LTMuMTMtNy03LTd6bTAgOS41Yy0xLjM4IDAtMi41LTEuMTItMi41LTIuNXMxLjEyLTIuNSAyLjUtMi41IDIuNSAxLjEyIDIuNSAyLjUtMS4xMiAyLjUtMi41IDIuNXoiLz4KPC9zdmc+Cjwvc3ZnPgo=">
    <link rel="apple-touch-icon" sizes="76x76" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNzYiIGhlaWdodD0iNzYiIHZpZXdCb3g9IjAgMCA3NiA3NiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9Ijc2IiBoZWlnaHQ9Ijc2IiByeD0iMTAiIGZpbGw9IiMxOTg3NTQiLz4KPHN2ZyB4PSIxOSIgeT0iMTkiIHdpZHRoPSIzOCIgaGVpZ2h0PSIzOCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJ3aGl0ZSI+CjxwYXRoIGQ9Ik0xMiAyQzguMTMgMiA1IDUuMTMgNSA5YzAgNS4yNSA3IDEzIDcgMTNzNy03Ljc1IDctMTNjMC0zLjg3LTMuMTMtNy03LTd6bTAgOS41Yy0xLjM4IDAtMi41LTEuMTItMi41LTIuNXMxLjEyLTIuNSAyLjUtMi41IDIuNSAxLjEyIDIuNSAyLjUtMS4xMiAyLjUtMi41IDIuNXoiLz4KPC9zdmc+Cjwvc3ZnPgo=">
    <link rel="apple-touch-icon" sizes="72x72" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNzIiIGhlaWdodD0iNzIiIHZpZXdCb3g9IjAgMCA3MiA3MiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjcyIiBoZWlnaHQ9IjcyIiByeD0iOSIgZmlsbD0iIzE5ODc1NCIvPgo8c3ZnIHg9IjE4IiB5PSIxOCIgd2lkdGg9IjM2IiBoZWlnaHQ9IjM2IiB2aWV3Qm94PSIwIDAgMjQgMjQiIGZpbGw9IndoaXRlIj4KPHBhdGggZD0iTTEyIDJDOC4xMyAyIDUgNS4xMyA1IDljMCA1LjI1IDcgMTMgNyAxM3M3LTcuNzUgNy0xM2MwLTMuODctMy4xMy03LTctN3ptMCA5LjVjLTEuMzggMC0yLjUtMS4xMi0yLjUtMi41czEuMTItMi41IDIuNS0yLjUgMi41IDEuMTIgMi41IDIuNS0xLjEyIDIuNS0yLjUgMi41eiIvPgo8L3N2Zz4KPC9zdmc+Cg==">
    <link rel="apple-touch-icon" sizes="60x60" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjYwIiBoZWlnaHQ9IjYwIiByeD0iNyIgZmlsbD0iIzE5ODc1NCIvPgo8c3ZnIHg9IjE1IiB5PSIxNSIgd2lkdGg9IjMwIiBoZWlnaHQ9IjMwIiB2aWV3Qm94PSIwIDAgMjQgMjQiIGZpbGw9IndoaXRlIj4KPHBhdGggZD0iTTEyIDJDOC4xMyAyIDUgNS4xMyA1IDljMCA1LjI1IDcgMTMgNyAxM3M3LTcuNzUgNy0xM2MwLTMuODctMy4xMy03LTctN3ptMCA5LjVjLTEuMzggMC0yLjUtMS4xMi0yLjUtMi41czEuMTItMi41IDIuNS0yLjUgMi41IDEuMTIgMi41IDIuNS0xLjEyIDIuNS0yLjUgMi41eiIvPgo8L3N2Zz4KPC9zdmc+Cg==">
    <link rel="apple-touch-icon" sizes="57x57" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTciIGhlaWdodD0iNTciIHZpZXdCb3g9IjAgMCA1NyA1NyIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjU3IiBoZWlnaHQ9IjU3IiByeD0iNyIgZmlsbD0iIzE5ODc1NCIvPgo8c3ZnIHg9IjE0IiB5PSIxNCIgd2lkdGg9IjI5IiBoZWlnaHQ9IjI5IiB2aWV3Qm94PSIwIDAgMjQgMjQiIGZpbGw9IndoaXRlIj4KPHBhdGggZD0iTTEyIDJDOC4xMyAyIDUgNS4xMyA1IDljMCA1LjI1IDcgMTMgNyAxM3M3LTcuNzUgNy0xM2MwLTMuODctMy4xMy03LTctN3ptMCA5LjVjLTEuMzggMC0yLjUtMS4xMi0yLjUtMi41czEuMTItMi41IDIuNS0yLjUgMi41IDEuMTIgMi41IDIuNS0xLjEyIDIuNS0yLjUgMi41eiIvPgo8L3N2Zz4KPC9zdmc+Cg==">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiByeD0iMjQiIGZpbGw9IiMxOTg3NTQiLz4KPHN2ZyB4PSI0OCIgeT0iNDgiIHdpZHRoPSI5NiIgaGVpZ2h0PSI5NiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJ3aGl0ZSI+CjxwYXRoIGQ9Ik0xMiAyQzguMTMgMiA1IDUuMTMgNSA5YzAgNS4yNSA3IDEzIDcgMTNzNy03Ljc1IDctMTNjMC0zLjg3LTMuMTMtNy03LTd6bTAgOS41Yy0xLjM4IDAtMi41LTEuMTItMi41LTIuNXMxLjEyLTIuNSAyLjUtMi41IDIuNSAxLjEyIDIuNSAyLjUtMS4xMiAyLjUtMi41IDIuNXoiLz4KPC9zdmc+Cjwvc3ZnPgo=">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iNCIgZmlsbD0iIzE5ODc1NCIvPgo8c3ZnIHg9IjQiIHk9IjQiIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJ3aGl0ZSI+CjxwYXRoIGQ9Ik0xMiAyQzguMTMgMiA1IDUuMTMgNSA5YzAgNS4yNSA3IDEzIDcgMTNzNy03Ljc1IDctMTNjMC0zLjg3LTMuMTMtNy03LTd6bTAgOS41Yy0xLjM4IDAtMi41LTEuMTItMi41LTIuNXMxLjEyLTIuNSAyLjUtMi41IDIuNSAxLjEyIDIuNSAyLjUtMS4xMiAyLjUtMi41IDIuNXoiLz4KPC9zdmc+Cjwvc3ZnPgo=">
    
    <!-- CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <link rel="stylesheet" href="css/L.Control.Layers.Tree.css?v=1.6">
    <link rel="stylesheet" href="https://unpkg.com/leaflet-search@3.0.0/dist/leaflet-search.min.css">
    <link rel="stylesheet" href="css/area-tooltip.css">
    <link rel="stylesheet" href="css/leaflet.draw.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet-easybutton@2.4.0/src/easy-button.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol/dist/L.Control.Locate.min.css" />
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">

    <!-- –ü—Ä–∏–º—É—Å–æ–≤–µ –æ—á–∏—â–µ–Ω–Ω—è –∫–µ—à—É –±—Ä–∞—É–∑–µ—Ä–∞ -->
    <script>
        // –ü—Ä–∏–º—É—Å–æ–≤–µ –æ—á–∏—â–µ–Ω–Ω—è –∫–µ—à—É –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ
        if ('caches' in window) {
            caches.keys().then(function(names) {
                names.forEach(function(name) {
                    caches.delete(name);
                });
            });
        }
        
        // –ü—Ä–∏–º—É—Å–æ–≤–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è CSS —Ç–∞ JS
        const links = document.getElementsByTagName('link');
        for (let i = 0; i < links.length; i++) {
            const link = links[i];
            if (link.rel === 'stylesheet') {
                const href = link.href;
                link.href = href + (href.indexOf('?') >= 0 ? '&' : '?') + 'v=' + Date.now();
            }
        }
        
        // –†–∞–Ω–µ–Ω–Ω—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥–ª—è PWA - –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –∑ client ID
        function checkPWARedirect() {
            const isPWA = window.matchMedia('(display-mode: standalone)').matches || 
                         window.navigator.standalone === true;
            
            // –î–æ–¥–∞—Ç–∫–æ–≤–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥–ª—è iOS Safari PWA
            const isIOSSafari = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            const isIOSPWA = isIOSSafari && window.navigator.standalone === true;
            
            console.log('üîç PWA Detection:', {
                isPWA: isPWA,
                isIOSSafari: isIOSSafari,
                isIOSPWA: isIOSPWA,
                standalone: window.navigator.standalone,
                displayMode: window.matchMedia('(display-mode: standalone)').matches
            });
            
            if (isPWA || isIOSPWA) {
                console.log('üì± PWA detected, checking for stored client ID...');
                
                try {
                    const storedId = localStorage.getItem('client_id');
                    const currentParams = new URLSearchParams(window.location.search);
                    const currentId = currentParams.get('id');
                    
                    console.log('üíæ Stored ID:', storedId);
                    console.log('üîó Current ID:', currentId);
                    console.log('üåê Current URL:', window.location.href);
                    
                    // –Ø–∫—â–æ —î –∑–±–µ—Ä–µ–∂–µ–Ω–∏–π ID, –∞–ª–µ –Ω–µ–º–∞—î –≤ –ø–æ—Ç–æ—á–Ω–æ–º—É URL
                    if (storedId && !currentId) {
                        console.log('üîÑ Redirecting to stored client ID:', storedId);
                        
                        const newUrl = new URL(window.location);
                        newUrl.searchParams.set('id', storedId);
                        
                        console.log('‚û°Ô∏è Redirecting to:', newUrl.href);
                        
                        // –î–ª—è iOS –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ window.location.href –∑–∞–º—ñ—Å—Ç—å replace
                        if (isIOSPWA) {
                            window.location.href = newUrl.href;
                        } else {
                            window.location.replace(newUrl.href);
                        }
                        return; // –ó—É–ø–∏–Ω—è—î–º–æ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è
                    }
                } catch (e) {
                    console.error('‚ùå Error checking PWA redirect:', e);
                }
            }
        }
        
        // –í–∏–∫–ª–∏–∫–∞—î–º–æ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É —è–∫–æ–º–æ–≥–∞ —Ä–∞–Ω—ñ—à–µ
        checkPWARedirect();
        
        // –î–æ–¥–∞—Ç–∫–æ–≤–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥–ª—è iOS (–≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è –ø—ñ–∑–Ω—ñ—à–µ, –∫–æ–ª–∏ —Ñ—É–Ω–∫—Ü—ñ—è –±—É–¥–µ –≤–∏–∑–Ω–∞—á–µ–Ω–∞)
        // ensureIOSPWARedirect –±—É–¥–µ –≤–∏–∫–ª–∏–∫–∞–Ω–∞ –≤ DOMContentLoaded
        
        // –û–Ω–æ–≤–ª—é—î–º–æ manifest link –∑ client ID —è–∫—â–æ –≤—ñ–Ω —î
        function updateManifestLink() {
            console.log('üîÑ –û–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –º–∞–Ω—ñ—Ñ–µ—Å—Ç');
            
            // –û—Ç—Ä–∏–º—É—î–º–æ client ID –Ω–∞–ø—Ä—è–º—É –∑ URL
            const urlParams = new URLSearchParams(window.location.search);
            const clientId = urlParams.get('id');
            
            if (clientId) {
                console.log('üéØ Client ID –∑–Ω–∞–π–¥–µ–Ω–æ:', clientId);
                const manifestLink = document.getElementById('manifestLink');
                if (manifestLink) {
                    // –°–ø—Ä–æ–±—É—î–º–æ —Å–ø–æ—á–∞—Ç–∫—É PHP –≤–µ—Ä—Å—ñ—é (—è–∫—â–æ –¥–æ—Å—Ç—É–ø–Ω–∞)
                    const phpManifestUrl = `dynamic_manifest.php?id=${encodeURIComponent(clientId)}`;
                    
                    fetch(phpManifestUrl)
                        .then(response => {
                            if (response.ok && response.headers.get('content-type')?.includes('application/manifest+json')) {
                                manifestLink.href = phpManifestUrl;
                                console.log('‚úÖ –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ PHP –º–∞–Ω—ñ—Ñ–µ—Å—Ç:', phpManifestUrl);
                            } else {
                                throw new Error('PHP –º–∞–Ω—ñ—Ñ–µ—Å—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π –∞–±–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π —Ç–∏–ø');
                            }
                        })
                        .catch(error => {
                            console.warn('‚ö†Ô∏è PHP –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ JavaScript –≤–µ—Ä—Å—ñ—é:', error.message);
                                  // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ JavaScript –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –º–∞–Ω—ñ—Ñ–µ—Å—Ç–∞
                        if (typeof window.createManifestBlobUrl === 'function') {
                            const blobUrl = window.createManifestBlobUrl(clientId);
                            manifestLink.href = blobUrl;
                            console.log('‚úÖ –ú–∞–Ω—ñ—Ñ–µ—Å—Ç –æ–Ω–æ–≤–ª–µ–Ω–æ –∑ JavaScript –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞:', blobUrl);
                            
                            // –î–æ–¥–∞—Ç–∫–æ–≤–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è –¥–ª—è debug
                            if (typeof window.generateDynamicManifest === 'function') {
                                const manifest = window.generateDynamicManifest(clientId);
                                console.log('üìã –ó–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–∏–π –º–∞–Ω—ñ—Ñ–µ—Å—Ç:', {
                                    start_url: manifest.start_url,
                                    scope: manifest.scope,
                                    name: manifest.name
                                });
                            }
                        } else {
                            console.warn('‚ö†Ô∏è JavaScript –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —Å—Ç–∞—Ç–∏—á–Ω–∏–π –º–∞–Ω—ñ—Ñ–µ—Å—Ç');
                            manifestLink.href = 'manifest.json';
                        }
                        });
                }
            } else {
                console.log('üìÑ –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —Å—Ç–∞—Ç–∏—á–Ω–∏–π –º–∞–Ω—ñ—Ñ–µ—Å—Ç');
                const manifestLink = document.getElementById('manifestLink');
                if (manifestLink) {
                    manifestLink.href = 'manifest.json';
                }
            }
        }
        
        updateManifestLink();
        
        // –ü—Ä–∏–º—É—Å–æ–≤–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(function(registrations) {
                for(let registration of registrations) {
                    registration.unregister();
                }
            });
        }
    </script>

    <!-- –î–æ–¥–∞—Ç–∫–æ–≤–∏–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è iOS PWA –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—è -->
    <script>
        // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥–ª—è iOS PWA –ø—Ä–∏ –ø–æ–≤–Ω–æ–º—É –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ
        window.addEventListener('load', function() {
            const isIOSSafari = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            const isIOSPWA = isIOSSafari && window.navigator.standalone === true;
            
            if (isIOSPWA) {
                console.log('üçé iOS PWA detected on window load');
                
                setTimeout(function() {
                    const currentParams = new URLSearchParams(window.location.search);
                    const currentId = currentParams.get('id');
                    
                    if (!currentId) {
                        const storedId = localStorage.getItem('client_id');
                        if (storedId) {
                            console.log('üîÑ iOS PWA (window.load): Final redirect attempt to:', storedId);
                            window.location.href = `${window.location.origin}${window.location.pathname}?id=${encodeURIComponent(storedId)}`;
                        }
                    }
                }, 500); // –ë—ñ–ª—å—à–∞ –∑–∞—Ç—Ä–∏–º–∫–∞ –¥–ª—è –ø–æ–≤–Ω–æ—ó –≤–ø–µ–≤–Ω–µ–Ω–æ—Å—Ç—ñ
            }
        });
    </script>

    <style>
        /* ===== MONOBANK-STYLE DESIGN SYSTEM ===== */
        :root {
            /* –ö–æ–ª—å–æ—Ä–æ–≤–∞ –ø–∞–ª—ñ—Ç—Ä–∞ */
            --mono-bg: #000000;
            --mono-surface: #1C1C1E;
            --mono-surface-elevated: #2C2C2E;
            --mono-card: #1C1C1E;
            --mono-primary: #10B981;
            --mono-primary-soft: rgba(16, 185, 129, 0.15);
            --mono-accent: #34D399;
            --mono-text: #FFFFFF;
            --mono-text-secondary: #ABABAB;
            --mono-text-muted: #8E8E93;
            --mono-border: rgba(255, 255, 255, 0.12);
            --mono-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            --mono-shadow-soft: 0 4px 16px rgba(0, 0, 0, 0.3);
            --mono-radius: 16px;
            --mono-radius-sm: 12px;
            --mono-radius-lg: 24px;
            --mono-transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* PWA —Ç–∞ –º–æ–±—ñ–ª—å–Ω—ñ –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è */
        html, body {
    width: 100%;
    height: 100%;
    margin: 0;
    overflow: hidden;
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    -khtml-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
    overscroll-behavior: none;
    background: var(--mono-bg);
}

/* –ü—ñ–¥—Ç—Ä–∏–º–∫–∞ safe-area –¥–ª—è iPhone –∑ –≤–∏—Ä—ñ–∑–æ–º */
body {
    padding-top: env(safe-area-inset-top);
    padding-bottom: env(safe-area-inset-bottom);
}

#map {
    position: absolute;
    top: calc(56px + env(safe-area-inset-top));
    bottom: env(safe-area-inset-bottom);
    left: 0;
    right: 0;
    width: 100%;
    margin: 0;
    padding: 0;
    touch-action: pan-x pan-y;
}

.navbar {
    z-index: 1000;
    height: 56px;
    position: fixed;
    top: env(safe-area-inset-top);
    left: 0;
    right: 0;
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    background: rgba(28, 28, 30, 0.85) !important;
    border-bottom: 1px solid var(--mono-border);
}

/* –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è –¥–ª—è touch –≤–∑–∞—î–º–æ–¥—ñ—ó */
.btn, .leaflet-control-layers-toggle, .leaflet-control-locate a, .leaflet-bar a {
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
    min-height: 44px;
    min-width: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* –ú–æ–±—ñ–ª—å–Ω–∞ –Ω–∞–≤—ñ–≥–∞—Ü—ñ—è */
.navbar .btn {
    border-radius: var(--mono-radius-sm);
    transition: var(--mono-transition);
}

.navbar .btn:active {
    transform: scale(0.95);
    background-color: rgba(255, 255, 255, 0.2);
}

/* ===== MONOBANK-STYLE PWA INSTALL BUTTON ===== */
.pwa-install {
    position: fixed;
    bottom: calc(90px + env(safe-area-inset-bottom));
    right: 16px;
    z-index: 1001;
    background: var(--mono-primary);
    color: white;
    border: none;
    border-radius: var(--mono-radius);
    padding: 14px 24px;
    font-size: 15px;
    font-weight: 600;
    box-shadow: 0 8px 32px rgba(16, 185, 129, 0.4);
    display: none;
    align-items: center;
    gap: 10px;
    transition: var(--mono-transition);
    cursor: pointer;
}

.pwa-install:hover {
    background: var(--mono-accent);
    transform: translateY(-2px);
    box-shadow: 0 12px 40px rgba(16, 185, 129, 0.5);
}

.pwa-install:active {
    transform: scale(0.98);
}

.pwa-install.show {
    display: flex;
    animation: slideInRight 0.5s ease-out, pulseInstall 2s infinite 1s;
}

/* –ê–Ω—ñ–º–∞—Ü—ñ—ó –¥–ª—è –∫–Ω–æ–ø–∫–∏ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è */
@keyframes pulseInstall {
    0% {
        box-shadow: 0 8px 30px rgba(25, 135, 84, 0.6);
        transform: scale(1);
    }
    50% {
        box-shadow: 0 12px 40px rgba(25, 135, 84, 0.9);
        transform: scale(1.02);
    }
    100% {
        box-shadow: 0 8px 30px rgba(25, 135, 84, 0.6);
        transform: scale(1);
    }
}

@keyframes slideInRight {
    0% {
        opacity: 0;
        transform: translateX(100px);
    }
    100% {
        opacity: 1;
        transform: translateX(0);
    }
}

/* –î–æ–¥–∞—Ç–∫–æ–≤—ñ –µ—Ñ–µ–∫—Ç–∏ –¥–ª—è Desktop */
@media (min-width: 1024px) {
    .pwa-install {
        padding: 18px 30px;
        font-size: 18px;
        bottom: 30px;
        right: 30px;
        box-shadow: 0 10px 40px rgba(25, 135, 84, 0.7);
    }
    
    .pwa-install:hover {
        box-shadow: 0 15px 50px rgba(25, 135, 84, 0.9);
    }
    
    .pwa-install::before {
        content: '';
        position: absolute;
        top: -2px;
        left: -2px;
        right: -2px;
        bottom: -2px;
        background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4, #feca57);
        border-radius: 50px;
        z-index: -1;
        opacity: 0;
        transition: opacity 0.3s ease;
        animation: rainbow 3s linear infinite;
    }
    
    .pwa-install:hover::before {
        opacity: 0.7;
    }
}

@keyframes rainbow {
    0% { filter: hue-rotate(0deg); }
    100% { filter: hue-rotate(360deg); }
}

/* Tooltip –¥–ª—è –∫–Ω–æ–ø–∫–∏ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è */
.pwa-install .install-tooltip {
    position: absolute;
    top: -50px;
    right: 0;
    background: rgba(0, 0, 0, 0.9);
    color: white;
    padding: 8px 12px;
    border-radius: 8px;
    font-size: 12px;
    white-space: nowrap;
    opacity: 0;
    transform: translateY(10px);
    transition: all 0.3s ease;
    pointer-events: none;
    z-index: 1002;
}

.pwa-install .install-tooltip::after {
    content: '';
    position: absolute;
    top: 100%;
    right: 20px;
    border: 5px solid transparent;
    border-top-color: rgba(0, 0, 0, 0.9);
}

.pwa-install:hover .install-tooltip {
    opacity: 1;
    transform: translateY(0);
}

.pwa-install .install-text {
    display: inline;
}

/* –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è –¥–ª—è –º–∞–ª–∏—Ö –µ–∫—Ä–∞–Ω—ñ–≤ */
@media (max-width: 480px) {
    .pwa-install .install-text {
        display: none;
    }
    
    .pwa-install {
        padding: 12px !important;
        border-radius: 50% !important;
        width: 50px !important;
        height: 50px !important;
    }
    
    .pwa-install .install-tooltip {
        right: -10px;
        top: -45px;
    }
}

/* === –û–ü–¢–ò–ú–Ü–ó–ê–¶–Ü–Ø –ü–†–û–î–£–ö–¢–ò–í–ù–û–°–¢–Ü –î–õ–Ø –ú–û–ë–Ü–õ–¨–ù–ò–• === */
@media (max-width: 768px) {
    /* –í–∏–º–∏–∫–∞—î–º–æ –≤–∞–∂–∫—ñ –∞–Ω—ñ–º–∞—Ü—ñ—ó –Ω–∞ –º–æ–±—ñ–ª—å–Ω–∏—Ö */
    .pwa-install {
        animation: none !important;
        backdrop-filter: none !important;
        -webkit-backdrop-filter: none !important;
    }
    
    .pwa-install.show {
        animation: slideInRight 0.3s ease-out !important;
    }
    
    /* –ü—Ä–∏–±–∏—Ä–∞—î–º–æ blur –µ—Ñ–µ–∫—Ç–∏ –Ω–∞ –º–æ–±—ñ–ª—å–Ω–∏—Ö (–¥—É–∂–µ –≤–∞–∂–∫—ñ –¥–ª—è GPU) */
    .navbar {
        backdrop-filter: none !important;
        -webkit-backdrop-filter: none !important;
        background: rgba(33, 37, 41, 0.98) !important;
    }
    
    .mobile-bottom-menu {
        backdrop-filter: none !important;
        -webkit-backdrop-filter: none !important;
        background: rgba(255, 255, 255, 0.98) !important;
    }
    
    .mobile-layers-panel {
        backdrop-filter: none !important;
        -webkit-backdrop-filter: none !important;
        background: rgba(255, 255, 255, 0.98) !important;
    }
    
    /* –û–ø—Ç–∏–º—ñ–∑—É—î–º–æ –ø–µ—Ä–µ—Ö–æ–¥–∏ */
    * {
        transition-duration: 0.15s !important;
    }
    
    /* –í–∏–º–∏–∫–∞—î–º–æ —Å–∫–ª–∞–¥–Ω—ñ box-shadow –Ω–∞ –º–æ–±—ñ–ª—å–Ω–∏—Ö */
    .pwa-install {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
    }
}

/* –ó–º–µ–Ω—à—É—î–º–æ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –Ω–∞ —Å–ª–∞–±–∫–∏—Ö –ø—Ä–∏—Å—Ç—Ä–æ—è—Ö */
@media (prefers-reduced-motion: reduce) {
    * {
        animation: none !important;
        transition: none !important;
    }
}

/* Loading Splash Screen */
/* ===== MONOBANK-STYLE SPLASH SCREEN ===== */
.splash-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: var(--mono-bg);
    z-index: 9999;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: var(--mono-text);
    transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

.splash-screen.hidden {
    opacity: 0;
    pointer-events: none;
}

.splash-logo {
    width: 100px;
    height: 100px;
    background: linear-gradient(135deg, var(--mono-primary) 0%, var(--mono-accent) 100%);
    border-radius: var(--mono-radius-lg);
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 24px;
    box-shadow: 0 20px 60px rgba(16, 185, 129, 0.3);
}

.splash-logo i {
    font-size: 48px;
    color: white;
}

.splash-title {
    font-size: 28px;
    font-weight: 700;
    margin-bottom: 8px;
    letter-spacing: -0.5px;
}

.splash-subtitle {
    font-size: 15px;
    color: var(--mono-text-secondary);
    margin-bottom: 48px;
}

.loading-spinner {
    width: 32px;
    height: 32px;
    border: 3px solid var(--mono-surface-elevated);
    border-top: 3px solid var(--mono-primary);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –≤—Å—ñ —Å—Ç–∏–ª—ñ –∑ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–æ—ó –≤–µ—Ä—Å—ñ—ó */
.color-box {
    width: 12px;
    height: 12px;
    display: inline-block;
    margin-right: 5px;
}

.layer-name {
    color: black;
    font-size: 12px;
}

.leaflet-control-search {
    top: 5px !important;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω—ñ—Å—Ç—å –¥–ª—è —Å–º–∞—Ä—Ç—Ñ–æ–Ω—ñ–≤ */
@media (max-width: 576px) {
    #fileSelect {
        max-width: calc(100% - 100px);
        font-size: 14px;
    }
    
    .navbar {
        padding: 0.3rem;
    }
}
.select-custom {
    width: 200px; /* –ó–º–µ–Ω—à—É—î–º–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É —à–∏—Ä–∏–Ω—É */
}

.select-custom-small {
    width: 80px; /* –ó–º–µ–Ω—à—É—î–º–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É —à–∏—Ä–∏–Ω—É */
}

/* –°—Ç–∏–ª—ñ –¥–ª—è –≤—ñ–¥–∫—Ä–∏—Ç–æ–≥–æ —Å–ø–∏—Å–∫—É */
.select-custom option, 
.select-custom-small option {
    width: auto;
    min-width: 200px; /* –ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∞ —à–∏—Ä–∏–Ω–∞ –¥–ª—è –≤—ñ–¥–∫—Ä–∏—Ç–æ–≥–æ —Å–ø–∏—Å–∫—É */
    white-space: normal; /* –î–æ–∑–≤–æ–ª—è—î–º–æ –ø–µ—Ä–µ–Ω–æ—Å —Ç–µ–∫—Å—Ç—É */
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω—ñ—Å—Ç—å –¥–ª—è —Ä—ñ–∑–Ω–∏—Ö –µ–∫—Ä–∞–Ω—ñ–≤ */
@media (max-width: 992px) {
    .select-custom {
        width: 150px;
    }
    .select-custom-small {
        width: 70px;
    }
}

@media (max-width: 576px) {
    .select-custom {
        width: 120px;
        font-size: 12px; /* –ó–º–µ–Ω—à—É—î–º–æ —Ä–æ–∑–º—ñ—Ä —à—Ä–∏—Ñ—Ç—É */
    }
    .select-custom-small {
        width: 60px;
        font-size: 12px;
    }
}

@media (max-width: 400px) {
    .select-custom {
        width: 100px;
    }
    .select-custom-small {
        width: 50px;
    }
    /* –ó–º–µ–Ω—à—É—î–º–æ –≤—ñ–¥—Å—Ç—É–ø –º—ñ–∂ —Å–µ–ª–µ–∫—Ç–∞–º–∏ */
    .ms-2 {
        margin-left: 0.3rem !important;
    }
}

/* –î–æ–¥–∞—î–º–æ –µ–ª—ñ–ø—Å–∏—Å –¥–ª—è –¥–æ–≤–≥–æ–≥–æ —Ç–µ–∫—Å—Ç—É */
.select-custom, .select-custom-small {
    text-overflow: ellipsis;
    overflow: hidden;
}

/* –°—Ç–∏–ª—å –¥–ª—è —Ç–µ–∫—Å—Ç—É –≤ –∑–∞–∫—Ä–∏—Ç–æ–º—É —Å–µ–ª–µ–∫—Ç—ñ */
.select-custom option, .select-custom-small option {
    text-overflow: ellipsis;
}



/* –í–∏–¥–∞–ª—ñ—Ç—å —Å—Ç–∞—Ä—ñ —Å—Ç–∏–ª—ñ –¥–ª—è –≤–∫–ª–∞–¥–æ–∫ */
.popup-tabs,
.popup-tab {
    display: none;
}

.modal {
    display: none;
    position: fixed;
    z-index: 2000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.modal-content {
    background-color: #fefefe;
    margin: 15% auto;
    padding: 20px;
    border: 1px —Å–æ–ª—ñ–¥ #888;
    width: 80%;
    max-width: 500px;
    border-radius: 5px;
}

.close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

.close:hover,
.close:focus {
    color: black;
    text-decoration: none;
    cursor: pointer;
}

#cadastralList {
    width: 100%;
    height: 150px;
    margin: 10px 0;
    padding: 5px;
}
@keyframes pulse {
    0% {
        transform: scale(1);
        opacity: 1;
    }
    50% {
        transform: scale(1.2);
        opacity: 0.8;
    }
    100% {
        transform: scale(1);
        opacity: 1;
    }
}

.custom-div-icon {
    margin-left: -10px !important;
    margin-top: -10px !important;
}
.nav-tabs .nav-link {
    color: #495057;
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    margin-right: 5px;
}

.nav-tabs .nav-link.active {
    color: #495057;
    background-color: #fff;
    border-color: #dee2e6 #dee2e6 #fff;
}

.tab-content {
    padding: 15px;
    border: 1px —Å–æ–ª—ñ–¥ #dee2e6;
    border-top: none;
    border-radius: 0 0 4px 4px;
}

.select-custom-small {
    width: 100px; /* –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞ —à–∏—Ä–∏–Ω–∞ –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø—ñ–≤ */
}

@media (max-width: 992px) {
    .select-custom-small {
        width: 80px; /* –î–ª—è –ø–ª–∞–Ω—à–µ—Ç—ñ–≤ */
    }
}

@media (max-width: 576px) {
    .select-custom-small {
        width: 70px; /* –î–ª—è –º–æ–±—ñ–ª—å–Ω–∏—Ö */
    }
}

@media (max-width: 400px) {
    .select-custom-small {
        width: 60px; /* –î–ª—è –¥—É–∂–µ –º–∞–ª–∏—Ö –µ–∫—Ä–∞–Ω—ñ–≤ */
    }
}

.popup-link {
    text-align: center;
    margin-top: 5px;
    padding-top: 5px;
    border-top: 1px —Å–æ–ª—ñ–¥ #eee;
}

.popup-link a {
    display: inline-block;
    color: #198754; /* Bootstrap –∑–µ–ª–µ–Ω–∏–π –∫–æ–ª—ñ—Ä */
    text-decoration: none;
}

.popup-link i {
    font-size: 18px;
}

.popup-link a:hover {
    color: #157347; /* –¢–µ–º–Ω—ñ—à–∏–π –∑–µ–ª–µ–Ω–∏–π –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–Ω—ñ */
}

.popup-link .text-end {
    font-size: 0.9em;
    color: #666;
}
    .data-freshness-indicator {
        font-size: 0.8rem;
    }
    .data-freshness-indicator i {
        font-size: 1rem;
    }
    
    /* –ú–æ–±—ñ–ª—å–Ω—ñ —Å—Ç–∏–ª—ñ –¥–ª—è –∑–∞–ø–æ–±—ñ–≥–∞–Ω–Ω—è –ø–µ—Ä–µ–∫—Ä–∏—Ç—Ç—é –µ–ª–µ–º–µ–Ω—Ç—ñ–≤ */
    @media (max-width: 768px) {
        /* –ó–∞–±–µ–∑–ø–µ—á—É—î–º–æ –ø—Ä–∞–≤–∏–ª—å–Ω—É —Å—Ç—Ä—É–∫—Ç—É—Ä—É navbar –Ω–∞ –º–æ–±—ñ–ª—å–Ω–∏—Ö */
        .navbar-nav {
            flex-direction: row !important;
            align-items: center !important;
            flex-wrap: nowrap !important;
            width: 100% !important;
        }
        
        .navbar-nav .pulse-button {
            margin-right: 5px !important;
            padding: 0.25rem 0.5rem !important;
            font-size: 0.8rem !important;
        }
        
        .data-freshness-indicator {
            font-size: 0.7rem !important;
            margin-right: 0.5rem !important;
        }
        
        .data-freshness-indicator i {
            font-size: 0.8rem !important;
        }
        
        /* –ó–º–µ–Ω—à—É—î–º–æ –≤—ñ–¥—Å—Ç—É–ø–∏ –¥–ª—è –∫–æ–Ω—Ç–∞–∫—Ç–Ω–æ–≥–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É */
        .contact-phone .btn {
            padding: 0.25rem 0.5rem !important;
            font-size: 0.8rem !important;
        }
        
        /* –ó–∞–±–µ–∑–ø–µ—á—É—î–º–æ –¥–æ—Å—Ç–∞—Ç–Ω—å–æ –º—ñ—Å—Ü—è –º—ñ–∂ –µ–ª–µ–º–µ–Ω—Ç–∞–º–∏ */
        .navbar-nav .d-flex.align-items-center > div {
            margin-right: 0.25rem !important;
        }
        
        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ø—Ä–∞–≤–æ—ó —á–∞—Å—Ç–∏–Ω–∏ –º–∞—î –¥–æ—Å—Ç–∞—Ç–Ω—å–æ –º—ñ—Å—Ü—è */
        .navbar-nav .d-flex.align-items-center:last-child {
            min-width: auto !important;
            flex-shrink: 0 !important;
        }
    }
    
    @media (max-width: 576px) {
        /* –ù–∞ –¥—É–∂–µ –º–∞–ª–µ–Ω—å–∫–∏—Ö –µ–∫—Ä–∞–Ω–∞—Ö –ø—Ä–∏—Ö–æ–≤—É—î–º–æ —Ç–µ–∫—Å—Ç –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—ñ, –∑–∞–ª–∏—à–∞—î–º–æ —Ç—ñ–ª—å–∫–∏ —ñ–∫–æ–Ω–∫—É */
        .data-freshness-indicator small {
            display: none !important;
        }
        
        .data-freshness-indicator {
            margin-right: 0.25rem !important;
        }
        
        /* –©–µ –±—ñ–ª—å—à–µ –∑–º–µ–Ω—à—É—î–º–æ –∫–Ω–æ–ø–∫—É –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è */
        .navbar-nav .pulse-button {
            padding: 0.2rem 0.4rem !important;
            font-size: 0.75rem !important;
        }
        
        .pulse-button i {
            font-size: 0.7rem !important;
        }
    }
    .freshness-good {
        color: #28a745 !important;
    }
    .freshness-warning {
        color: #ffc107 !important;
    }
    @keyframes blink {
        0% { opacity: 1; }
        50% { opacity: 0.3; }
        100% { opacity: 1; }
    }

    .freshness-–±–∞–¥ {
        color: #dc3545 !important;
        animation: blink 2s ease-in-out infinite;
    }
    /* –°—Ç–∏–ª–∏ –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–Ω—ã—Ö —É—á–∞—Å—Ç–∫–æ–≤ */
    .selected-polygon {
        filter: brightness(1.3);
    }

    .selected-polygon path {
        stroke: #FFFF00 !important;
        stroke-width: 3 !important;
        stroke-dasharray: 10, 10 !important;
        animation: dash 20s linear infinite;
    }

    @keyframes dash {
        0% {
            stroke-dashoffset: 0;
        }
        100% {
            stroke-dashoffset: -1000;
        }
    }
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –∏–∑–º–µ—Ä–µ–Ω–∏—è */
    .leaflet-draw-tooltip {
        background: rgb(54, 54, 54);
        background: rgba(0, 0, 0, 0.5);
        border: 1px solid transparent;
        border-radius: 4px;
        color: #fff;
        font: 12px/18px "Helvetica Neue", Arial, Helvetica, sans-serif;
        margin-left: 20px;
        margin-top: -21px;
        padding: 4px 8px;
        position: absolute;
        visibility: hidden;
        white-space: nowrap;
        z-index: 6;
    }
    /* –î–æ–¥–∞—Ç–∏ –Ω–æ–≤—ñ —Å—Ç–∏–ª—ñ */
.offcanvas {
    --bs-offcanvas-width: 300px;
}

@media (max-width: 576px) {
    .offcanvas {
        --bs-offcanvas-width: 260px;
    }
}

/* ===== MONOBANK-STYLE BOTTOM SHEET ===== */
@media (max-width: 768px) {
    /* –ü–µ—Ä–µ—Ç–≤–æ—Ä—é—î–º–æ offcanvas –Ω–∞ bottom sheet */
    .offcanvas.offcanvas-start {
        top: auto !important;
        bottom: 0 !important;
        left: 0 !important;
        right: 0 !important;
        width: 100% !important;
        max-width: 100% !important;
        height: auto !important;
        max-height: 85vh !important;
        border-radius: var(--mono-radius-lg) var(--mono-radius-lg) 0 0 !important;
        background: var(--mono-surface) !important;
        border: none !important;
        border-top: 1px solid var(--mono-border) !important;
        transform: translateY(100%) !important;
        transition: transform 0.4s cubic-bezier(0.32, 0.72, 0, 1) !important;
    }
    
    .offcanvas.offcanvas-start.show {
        transform: translateY(0) !important;
    }
    
    /* Handle bar –Ω–∞ top */
    .offcanvas-header::before {
        content: '';
        position: absolute;
        top: 8px;
        left: 50%;
        transform: translateX(-50%);
        width: 36px;
        height: 5px;
        background: var(--mono-text-muted);
        border-radius: 3px;
    }
    
    .offcanvas-header {
        position: relative;
        padding-top: 24px !important;
        border-bottom: none !important;
    }
    
    .offcanvas-title {
        font-size: 1.5rem !important;
        font-weight: 700 !important;
        color: var(--mono-text) !important;
    }
    
    .offcanvas-body {
        padding: 0 20px 20px !important;
        overflow-y: auto !important;
        -webkit-overflow-scrolling: touch;
    }
    
    /* Mono-style —Å–µ–∫—Ü—ñ—ó */
    .offcanvas h6 {
        font-size: 0.75rem !important;
        font-weight: 600 !important;
        text-transform: uppercase !important;
        letter-spacing: 0.5px !important;
        color: var(--mono-text-secondary) !important;
        margin-bottom: 16px !important;
        padding-bottom: 0 !important;
        border: none !important;
    }
    
    /* Mono-style cards –¥–ª—è —Å–µ–∫—Ü—ñ–π */
    .offcanvas .mb-4 {
        background: var(--mono-surface-elevated) !important;
        border-radius: var(--mono-radius) !important;
        padding: 16px !important;
        margin-bottom: 16px !important;
    }
    
    /* Mono-style inputs */
    .offcanvas .form-select,
    .offcanvas .form-control {
        background: var(--mono-bg) !important;
        border: none !important;
        border-radius: var(--mono-radius-sm) !important;
        color: var(--mono-text) !important;
        padding: 14px 16px !important;
        font-size: 16px !important;
        font-weight: 500 !important;
        transition: var(--mono-transition) !important;
    }
    
    .offcanvas .form-select:focus,
    .offcanvas .form-control:focus {
        box-shadow: 0 0 0 2px var(--mono-primary) !important;
        outline: none !important;
    }
    
    .offcanvas .form-label {
        font-size: 0.85rem !important;
        font-weight: 500 !important;
        color: var(--mono-text-secondary) !important;
        margin-bottom: 8px !important;
    }
    
    /* Mono-style –∫–Ω–æ–ø–∫–∏ */
    .offcanvas .btn {
        border-radius: var(--mono-radius-sm) !important;
        padding: 14px 20px !important;
        font-size: 15px !important;
        font-weight: 600 !important;
        border: none !important;
        transition: var(--mono-transition) !important;
    }
    
    .offcanvas .btn-outline-light {
        background: var(--mono-surface-elevated) !important;
        color: var(--mono-text) !important;
    }
    
    .offcanvas .btn-outline-light:active {
        background: var(--mono-bg) !important;
        transform: scale(0.98);
    }
    
    .offcanvas .btn-outline-primary {
        background: var(--mono-primary-soft) !important;
        color: var(--mono-primary) !important;
    }
    
    .offcanvas .btn-outline-danger {
        background: rgba(239, 68, 68, 0.15) !important;
        color: #EF4444 !important;
    }
    
    /* –Ü–∫–æ–Ω–∫–∏ —É –∫–Ω–æ–ø–∫–∞—Ö */
    .offcanvas .btn i {
        font-size: 18px !important;
    }
    
    /* Mono-style grid –¥–ª—è –∫–Ω–æ–ø–æ–∫ */
    .offcanvas .d-grid.gap-2 {
        gap: 10px !important;
    }
}

/* ===== MONOBANK-STYLE BOTTOM NAVIGATION ===== */
@media (max-width: 768px) {
    .mobile-bottom-menu {
        position: fixed !important;
        bottom: 0 !important;
        left: 0 !important;
        right: 0 !important;
        background: var(--mono-surface) !important;
        backdrop-filter: blur(20px) !important;
        -webkit-backdrop-filter: blur(20px) !important;
        border-top: 1px solid var(--mono-border) !important;
        padding: 8px 0 calc(8px + env(safe-area-inset-bottom)) !important;
        z-index: 1000 !important;
        display: flex !important;
        justify-content: space-around !important;
        align-items: center !important;
    }
    
    .mobile-menu-item {
        display: flex !important;
        flex-direction: column !important;
        align-items: center !important;
        padding: 8px 16px !important;
        border-radius: var(--mono-radius-sm) !important;
        background: transparent !important;
        border: none !important;
        color: var(--mono-text-secondary) !important;
        font-size: 11px !important;
        font-weight: 500 !important;
        min-width: 64px !important;
        transition: var(--mono-transition) !important;
    }
    
    .mobile-menu-item i {
        font-size: 22px !important;
        margin-bottom: 4px !important;
    }
    
    .mobile-menu-item:active {
        background: var(--mono-surface-elevated) !important;
        transform: scale(0.95) !important;
    }
    
    .mobile-menu-item.active {
        color: var(--mono-primary) !important;
    }
    
    /* –ö–∞—Ä—Ç–∞ - –≤—ñ–¥—Å—Ç—É–ø –¥–ª—è bottom menu */
    #map {
        bottom: calc(70px + env(safe-area-inset-bottom)) !important;
    }
    
    /* –ú–æ–±—ñ–ª—å–Ω–∞ –ø–∞–Ω–µ–ª—å —à–∞—Ä—ñ–≤ - Monobank style */
    .mobile-layers-panel {
        position: fixed !important;
        bottom: calc(80px + env(safe-area-inset-bottom)) !important;
        left: 12px !important;
        right: 12px !important;
        background: var(--mono-surface) !important;
        border-radius: var(--mono-radius) !important;
        padding: 20px !important;
        box-shadow: var(--mono-shadow) !important;
        max-height: 50vh !important;
        overflow-y: auto !important;
        z-index: 1001 !important;
        border: 1px solid var(--mono-border) !important;
    }
    
    .mobile-layers-panel h6 {
        color: var(--mono-text) !important;
        font-size: 1.1rem !important;
        font-weight: 600 !important;
        margin-bottom: 16px !important;
    }
    
    .mobile-layer-item {
        display: flex !important;
        align-items: center !important;
        padding: 12px 0 !important;
        border-bottom: 1px solid var(--mono-border) !important;
    }
    
    .mobile-layer-item:last-child {
        border-bottom: none !important;
    }
    
    .mobile-layer-item label {
        color: var(--mono-text) !important;
        font-size: 15px !important;
        font-weight: 500 !important;
    }
    
    /* Custom checkbox —É —Å—Ç–∏–ª—ñ Monobank */
    .mobile-layer-item input[type="checkbox"] {
        width: 22px !important;
        height: 22px !important;
        margin-right: 14px !important;
        accent-color: var(--mono-primary) !important;
        border-radius: 6px !important;
    }
}

.offcanvas-title {
    font-size: 1.1rem;
}

.form-label {
    font-size: 0.9rem;
    margin-bottom: 0.3rem;
}

/* –û–Ω–æ–≤–ª–µ–Ω—ñ —Å—Ç–∏–ª—ñ –¥–ª—è —Å–µ–ª–µ–∫—Ç—ñ–≤ */
.offcanvas .form-select {
    width: 100%;
    max-width: 100%;
}

/* –°—Ç–∏–ª—å –¥–ª—è –∫–Ω–æ–ø–∫–∏ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è –º–µ–Ω—é */
.navbar .btn-outline-light:hover {
    background-color: rgba(255,255,255,0.1);
}

/* –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è —á–∏—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—ñ —Ç–µ–∫—Å—Ç—É –≤ —Ç–µ–º–Ω—ñ–π —Ç–µ–º—ñ */
.offcanvas.bg-dark {
    --bs-bg-opacity: 0.95;
}

.offcanvas .form-select option {
    background-color: var(--bs-dark);
    color: var(--bs-light);
}

/* –°—Ç–∏–ª—ñ –¥–ª—è –∫–æ–Ω—Ç–∞–∫—Ç–Ω–æ–≥–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É */
.contact-phone a {
    text-decoration: none;
    transition: var(--mono-transition);
}

.contact-phone a:hover {
    background-color: rgba(255,255,255,0.1);
    transform: scale(1.05);
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω—ñ—Å—Ç—å –¥–ª—è –∫–æ–Ω—Ç–∞–∫—Ç–Ω–æ–≥–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É –≤ navbar */
@media (max-width: 768px) {
    .contact-phone .btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }
    
    .contact-phone .phone-text {
        display: none;
    }
    
    /* –ü—Ä–∏—Ö–æ–≤—É—î–º–æ –∑–∞–π–≤—ñ –µ–ª–µ–º–µ–Ω—Ç–∏ –Ω–∞ –º–æ–±—ñ–ª—å–Ω–∏—Ö */
    .data-freshness-indicator {
        display: none !important;
    }
    
    /* Navbar —É —Å—Ç–∏–ª—ñ Monobank */
    .navbar {
        background: var(--mono-bg) !important;
        border-bottom: 1px solid var(--mono-border) !important;
    }
}

/* –°—Ç–∏–ª—ñ –¥–ª—è –∫–æ–Ω—Ç–∞–∫—Ç–Ω–æ—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –≤ –±–æ–∫–æ–≤–æ–º—É –º–µ–Ω—é */
.offcanvas-body {
    display: flex;
    flex-direction: column;
}

.offcanvas-body .mt-auto {
    margin-top: auto !important;
}
    /* –û–Ω–æ–≤–ª–µ–Ω–∏–π CSS –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤–∏—Ö –ø–æ–ª—ñ–≤ —É –º–æ–¥–∞–ª—å–Ω–æ–º—É –≤—ñ–∫–Ω—ñ */
.modal textarea {
    width: 100%;
    min-height: 120px;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    resize: vertical;
}

.modal textarea:focus {
    border-color: #80bdff;
    outline: 0;
    box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
}

.modal .tab-content {
    padding: 15px;
    background: #fff;
}
.tools-menu {
    background-color: white;
}

.tools-container {
    position: absolute;
    right: 35px;
    top: 0;
    background-color: white;
    padding: 5px;
    border-radius: 4px;
    box-shadow: 0 1px 5px rgba(0,0,0,0.4);
    z-index: 1000;
    width: auto;
    white-space: nowrap;
}

.tools-group-title {
    font-weight: bold;
    margin-top: 5px;
    margin-bottom: 5px;
}

.tools-group {
    margin-bottom: 10px;
}

.tool-button {
    display: block;
    margin: 5px 0;
    width: 30px;
    height: 30px;
    line-height: 30px;
    text-align: center;
    background-color: white;
    color: #666;
    border-radius: 4px;
}

.tool-title {
    margin-left: 5px;
    font-size: 14px;
    vertical-align: middle;
}
    #exchangeTable {
        width: 100%;
        margin-bottom: 1rem;
        font-size: 14px;
    }

    #exchangeTable th,
    #exchangeTable td {
        padding: 8px;
        vertical-align: top;
    }

    #exchangeModal .modal-content {
        width: 90%;
        max-width: 800px;
    }
    /* –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –æ–±–º–µ–Ω–∞ */
    #exchangeModal .modal-content {
        width: 95%;
        max-width: 1000px; /* –†–∞—Å—à–∏—Ä—è–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é —à–∏—Ä–∏–Ω—É */
        max-height: 90vh; /* –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –≤—ã—Å–æ—Ç—É –æ–∫–Ω–∞ */
        margin: 5vh auto; /* –£–º–µ–Ω—å—à–∞–µ–º –æ—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É */
    }
    
    #exchangeTableContainer {
        max-height: 70vh;
        overflow-y: auto;
    }
    
    #fieldTables {
        overflow-x: auto;
    }
    
    #fieldTables table {
        font-size: 13px; /* –£–º–µ–Ω—å—à–∞–µ–º —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ */
        width: 100%;
        white-space: nowrap;
    }
    
    #fieldTables th,
    #fieldTables td {
        padding: 4px 8px; /* –£–º–µ–Ω—å—à–∞–µ–º –æ—Ç—Å—Ç—É–ø—ã –≤ —è—á–µ–π–∫–∞—Ö */
    }
    
    #fieldTables .tenant-group {
        margin-bottom: 1.5rem;
    }
    
    /* –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ä–∞–∑–º–µ—Ä–æ–≤ —ç–∫—Ä–∞–Ω–∞ */
    @media (max-width: 992px) {
        #exchangeModal .modal-content {
            width: 98%;
            margin: 1vh auto;
            max-height: 98vh;
        }
        
        #fieldTables table {
            font-size: 11px;
        }
        
        #fieldTables th,
        #fieldTables td {
            padding: 3px 5px;
        }
    }

    /* –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è –∫–æ–ª–æ–Ω–∫–∏ "–§–∞–∫—Ç–∏—á–Ω–∏–π –æ—Ä–µ–Ω–¥–∞—Ä" */
    .factual-tenant-cell {
        font-size: 12px; /* –£–º–µ–Ω—å—à–∞–µ–º —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ */
        white-space: normal; /* –†–∞–∑—Ä–µ—à–∞–µ–º –ø–µ—Ä–µ–Ω–æ—Å —Ç–µ–∫—Å—Ç–∞ */
        word-break: break-word; /* –ü–µ—Ä–µ–Ω–æ—Å–∏–º –¥–ª–∏–Ω–Ω—ã–µ —Å–ª–æ–≤–∞ */
    }

    /* –î–æ–¥–∞—Ç–∫–æ–≤—ñ –º–æ–±—ñ–ª—å–Ω—ñ –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è */
    @media (max-width: 768px) {
        /* –ü–æ–∫—Ä–∞—â—É—î–º–æ leaflet –∫–æ–Ω—Ç—Ä–æ–ª–∏ –¥–ª—è –º–æ–±—ñ–ª—å–Ω–∏—Ö */
        .leaflet-control-layers {
            max-height: 60vh;
            overflow-y: auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            color: #333 !important;
        }

        .leaflet-control-layers label {
            color: #333 !important;
        }

        .leaflet-control-locate a {
            width: 44px;
            height: 44px;
            line-height: 42px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }

        .leaflet-bar {
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        .leaflet-bar a {
            min-width: 44px;
            min-height: 44px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }

        /* ===== MONOBANK-STYLE POPUP ===== */
        .leaflet-popup-content-wrapper {
            border-radius: var(--mono-radius) !important;
            max-width: calc(100vw - 32px) !important;
            min-width: 280px;
            background: var(--mono-surface) !important;
            box-shadow: var(--mono-shadow) !important;
            border: 1px solid var(--mono-border) !important;
        }
        
        .leaflet-popup-tip {
            background: var(--mono-surface) !important;
            border: 1px solid var(--mono-border) !important;
            box-shadow: none !important;
        }
        
        .leaflet-popup {
            margin-bottom: calc(90px + env(safe-area-inset-bottom)) !important;
        }
        
        .leaflet-popup-content {
            margin: 0 !important;
            max-height: 50vh;
            overflow-y: auto;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            /* –î–æ–∑–≤–æ–ª—è—î–º–æ –≤–∏–¥—ñ–ª–µ–Ω–Ω—è —Ç–∞ –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è —Ç–µ–∫—Å—Ç—É –≤ popup */
            -webkit-user-select: text !important;
            -moz-user-select: text !important;
            -ms-user-select: text !important;
            user-select: text !important;
            -webkit-touch-callout: default !important;
            cursor: text;
        }
        
        .leaflet-popup-content * {
            -webkit-user-select: text !important;
            -moz-user-select: text !important;
            -ms-user-select: text !important;
            user-select: text !important;
        }
        
        /* –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä–∏—Ç—Ç—è popup */
        .leaflet-popup-close-button {
            color: var(--mono-text-secondary) !important;
            font-size: 20px !important;
            padding: 8px !important;
        }
        
        .leaflet-popup-close-button:hover {
            color: var(--mono-text) !important;
        }
        
        /* –°—Ç–∏–ª—ñ –¥–ª—è –¥–æ–≤–≥–∏—Ö –Ω–∞–∑–≤ –ø–æ–ª—ñ–≤ */
        .popup-content .property-name {
            word-wrap: break-word;
            word-break: break-word;
            white-space: normal;
            hyphens: auto;
            color: var(--mono-text-secondary) !important;
        }
        
        .popup-content .property-value {
            color: var(--mono-text) !important;
        }
        
        /* –Ü–∫–æ–Ω–∫–∏ –∑ —Ç–µ–∫—Å—Ç–æ–º */
        .icon-text {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--mono-text-secondary);
            margin-left: 4px;
        }
        
        /* –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è –∫–Ω–æ–ø–∫–∏ –∑–∞–∫—Ä–∏—Ç—Ç—è popup */
        .leaflet-popup-close-button {
            color: #666 !important;
            font-size: 18px !important;
            font-weight: bold !important;
            width: 28px !important;
            height: 28px !important;
            border-radius: 50% !important;
            background: rgba(255, 255, 255, 0.9) !important;
            border: 1px solid rgba(0, 0, 0, 0.1) !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            top: 6px !important;
            right: 6px !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15) !important;
        }
        
        .leaflet-popup-close-button:hover {
            background: rgba(255, 255, 255, 1) !important;
            border-color: rgba(0, 0, 0, 0.2) !important;
            color: #333 !important;
        }
        
        /* –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è —Å—Ç—Ä—ñ–ª–∫–∏ popup */
        .leaflet-popup-tip {
            border-top-color: white !important;
            border-radius: 2px !important;
        }
        
        /* –ö–æ–º–ø–∞–∫—Ç–Ω—ñ –ø–æ—Å–∏–ª–∞–Ω–Ω—è —É popup */
        .popup-link {
            margin-top: 8px !important;
            padding-top: 8px !important;
            border-top: 1px solid #eee !important;
        }
        
        .popup-link a {
            display: inline-flex !important;
            align-items: center !important;
            padding: 8px 12px !important;
            background: linear-gradient(45deg, #198754, #157347) !important;
            color: white !important;
            text-decoration: none !important;
            border-radius: 8px !important;
            font-size: 12px !important;
            font-weight: 500 !important;
            transition: all 0.2s ease !important;
            min-height: 36px !important;
            justify-content: center !important;
            box-shadow: 0 2px 8px rgba(25, 135, 84, 0.3) !important;
        }
        
        .popup-link a:hover {
            transform: translateY(-1px) !important;
            box-shadow: 0 4px 12px rgba(25, 135, 84, 0.4) !important;
        }
        
        .popup-link a:active {
            transform: translateY(0) !important;
        }
        
        .popup-link a i {
            margin-right: 6px !important;
            font-size: 14px !important;
        }
        
        /* –ê–¥–∞–ø—Ç–∞—Ü—ñ—è –¥–ª—è –¥—É–∂–µ –º–∞–ª–µ–Ω—å–∫–∏—Ö –µ–∫—Ä–∞–Ω—ñ–≤ */
        @media (max-width: 380px) {
            .leaflet-popup-content-wrapper {
                max-width: calc(100vw - 20px) !important;
                min-width: 240px;
            }
        }
        
        /* Touch –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è –¥–ª—è popup */
        .leaflet-popup-content-wrapper {
            touch-action: pan-y;
        }
        
        /* –ê–Ω—ñ–º–∞—Ü—ñ—ó –¥–ª—è popup */
        .leaflet-popup {
            animation: popupSlideIn 0.3s ease-out;
        }
        
        @keyframes popupSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        /* –°–ø–µ—Ü—ñ–∞–ª—å–Ω—ñ —Å—Ç–∏–ª—ñ –¥–ª—è –º–æ–±—ñ–ª—å–Ω–æ–≥–æ popup */
        .mobile-popup {
            z-index: 10001 !important;
        }
        
        .mobile-popup .leaflet-popup-content-wrapper {
            backdrop-filter: blur(15px) !important;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4) !important;
            border-radius: 16px !important;
            margin: 0 8px !important;
            max-width: calc(100vw - 32px) !important;
            min-width: 280px !important;
        }
        
        .mobile-popup .leaflet-popup-content {
            margin: 0 !important;
            line-height: 1.3 !important;
            max-height: 60vh !important;
            overflow-y: auto !important;
            -webkit-overflow-scrolling: touch !important;
            /* –î–æ–∑–≤–æ–ª—è—î–º–æ –≤–∏–¥—ñ–ª–µ–Ω–Ω—è —Ç–µ–∫—Å—Ç—É –≤ –º–æ–±—ñ–ª—å–Ω–æ–º—É popup */
            -webkit-user-select: text !important;
            -moz-user-select: text !important;
            user-select: text !important;
            -webkit-touch-callout: default !important;
        }
        
        .mobile-popup .leaflet-popup-close-button {
            top: 8px !important;
            right: 8px !important;
            width: 28px !important;
            height: 28px !important;
            font-size: 18px !important;
            background: rgba(0,0,0,0.1) !important;
            border-radius: 50% !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            color: #666 !important;
        }
        
        /* –°—Ç–∏–ª—ñ –¥–ª—è –º–æ–±—ñ–ª—å–Ω–æ–≥–æ –∑–∞–≥–æ–ª–æ–≤–∫—É –ø–æ–ø–∞–ø—É */
        .mobile-header {
            background: linear-gradient(45deg, #198754, #157347) !important;
            color: white !important;
            padding: 12px 16px !important;
            margin: -13px -19px 12px -19px !important;
            border-radius: 8px 8px 0 0 !important;
            font-weight: 600 !important;
            font-size: 0.9rem !important;
            display: flex !important;
            align-items: center !important;
            gap: 12px !important;
            overflow: hidden !important;
        }
        
        .mobile-header i {
            font-size: 1.3em !important;
            opacity: 0.9 !important;
            flex-shrink: 0 !important;
        }
        
        /* –°—Ç–∏–ª—ñ –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–Ω–æ–≥–æ –∑–∞–≥–æ–ª–æ–≤–∫—É –ø–æ–ø–∞–ø—É */
        .desktop-header {
            background: linear-gradient(45deg, #198754, #157347) !important;
            color: white !important;
            padding: 14px 18px !important;
            margin: -13px -19px 16px -19px !important;
            border-radius: 8px 8px 0 0 !important;
            font-weight: 600 !important;
            font-size: 1rem !important;
            display: flex !important;
            align-items: center !important;
            gap: 14px !important;
            box-shadow: 0 2px 8px rgba(25, 135, 84, 0.2) !important;
            overflow: hidden !important;
        }
        
        .desktop-header i {
            font-size: 1.4em !important;
            opacity: 0.9 !important;
            flex-shrink: 0 !important;
        }
        
        .header-info {
            flex: 1 !important;
            min-width: 0 !important;
        }
        
        .plot-number {
            font-size: 1em !important;
            font-weight: 700 !important;
            margin-bottom: 2px !important;
        }
        
        .plot-details {
            font-size: 0.8em !important;
            opacity: 0.85 !important;
            font-weight: 400 !important;
            white-space: nowrap !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
        }
        
        /* –°—Ç–∏–ª—ñ –¥–ª—è —Ç–µ–∫—Å—Ç—É –±—ñ–ª—è —ñ–∫–æ–Ω–æ–∫ –Ω–∞ –º–æ–±—ñ–ª—å–Ω–∏—Ö */
        .icon-text {
            font-size: 0.7rem !important;
            font-weight: 500 !important;
            margin-left: 4px !important;
            color: #666 !important;
        }
        
        /* –°—Ç–∏–ª—ñ –¥–ª—è —ñ–∫–æ–Ω–æ–∫ —É –ø–æ–ø–∞–ø–∞—Ö */
        .popup-content .property-name i {
            margin-right: 8px;
            color: #0d6efd;
            font-size: 1em;
            width: 16px;
            text-align: center;
        }
        
        @media (max-width: 768px) {
            /* –ö–æ–º–ø–∞–∫—Ç–Ω–∞ —Ç–∞–±–ª–∏—Ü—è –¥–ª—è –º–æ–±—ñ–ª—å–Ω–∏—Ö */
            .popup-content table {
                width: 100%;
                border-spacing: 0;
                font-size: 0.8rem;
            }
            
            .popup-content tr {
                border-bottom: 1px solid rgba(0,0,0,0.08);
                transition: background-color 0.2s ease;
            }
            
            .popup-content tr:last-child {
                border-bottom: none;
            }
            
            .popup-content tr:hover {
                background-color: rgba(0,123,255,0.05);
            }
            
            /* –ö–æ–º–ø–∞–∫—Ç–Ω—ñ —Å—Ç–∏–ª—ñ –¥–ª—è –º–æ–±—ñ–ª—å–Ω–∏—Ö –ø–æ–ø–∞–ø—ñ–≤ */
            .popup-content table {
                border-radius: 0 0 8px 8px !important;
                overflow: hidden !important;
            }
            
            .popup-content .property-name {
                width: 35% !important;
                min-width: 80px !important;
                max-width: 120px !important;
                text-align: left;
                padding: 6px 4px;
                vertical-align: middle;
                background: rgba(25,135,84,0.05);
                border-right: 1px solid rgba(0,0,0,0.08);
                display: flex;
                align-items: center;
                gap: 2px;
                word-wrap: break-word;
                word-break: break-word;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                font-size: 10px !important;
                border-radius: 0 !important;
            }
            
            /* –ó–∞–æ–∫—Ä—É–≥–ª–µ–Ω—ñ –∫—É—Ç–∏ –¥–ª—è –º–æ–±—ñ–ª—å–Ω–∏—Ö - –ø–µ—Ä—à–∏–π —Ä—è–¥–æ–∫ (–ø—ñ—Å–ª—è header) */
            .popup-content table tr:first-child .property-name,
            .popup-content table tr:first-child td.property-name {
                border-top-left-radius: 0 !important;
            }
            
            .popup-content table tr:first-child .property-value,
            .popup-content table tr:first-child td.property-value {
                border-top-right-radius: 0 !important;
            }
            
            /* –ó–∞–æ–∫—Ä—É–≥–ª–µ–Ω—ñ –∫—É—Ç–∏ –¥–ª—è –º–æ–±—ñ–ª—å–Ω–∏—Ö - –æ—Å—Ç–∞–Ω–Ω—ñ–π —Ä—è–¥–æ–∫ */
            .popup-content table tr:last-child .property-name,
            .popup-content table tr:last-child td.property-name {
                border-bottom-left-radius: 8px !important;
            }
            
            .popup-content table tr:last-child .property-value,
            .popup-content table tr:last-child td.property-value {
                border-bottom-right-radius: 8px !important;
            }
            
            .popup-content .property-value {
                width: 65% !important;
                padding: 6px 4px;
                word-break: break-word;
                line-height: 1.2;
                color: #333;
                font-weight: 500;
                font-size: 10px !important;
                overflow: hidden;
                max-height: 2.4em;
                border-radius: 0 !important;
            }
            
            .popup-content .property-name i {
                margin: 0;
                font-size: 1.1em;
                width: 16px;
                color: #0d6efd;
                flex-shrink: 0;
            }
            
            .popup-content .icon-text {
                font-size: 0.7rem !important;
                font-weight: 600 !important;
                color: #495057 !important;
                margin: 0 !important;
                white-space: nowrap;
            }
            
            /* –°–ø–µ—Ü—ñ–∞–ª—å–Ω—ñ —Å—Ç–∏–ª—ñ –¥–ª—è —Ä—ñ–∑–Ω–∏—Ö —Ç–∏–ø—ñ–≤ –¥–∞–Ω–∏—Ö */
            .popup-content .property-value:empty::after {
                content: "‚Äî";
                color: #999;
                font-style: italic;
            }
            
            /* –í–∏–¥—ñ–ª–µ–Ω–Ω—è –¥–ª—è –ø–ª–æ—â */
            .popup-content tr:has(.property-name i.bi-bounding-box),
            .popup-content tr:has(.property-name i.bi-calculator),
            .popup-content tr:has(.property-name i.bi-square) {
                background-color: rgba(40,167,69,0.05);
            }
            
            /* –í–∏–¥—ñ–ª–µ–Ω–Ω—è –¥–ª—è –≤–ª–∞—Å–Ω–∏–∫—ñ–≤ —Ç–∞ –æ—Ä–µ–Ω–¥–∞—Ä—ñ–≤ */
            .popup-content tr:has(.property-name i.bi-person-check),
            .popup-content tr:has(.property-name i.bi-person-workspace) {
                background-color: rgba(255,193,7,0.05);
            }
        }
        
        /* –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è –¥–ª—è landscape –æ—Ä—ñ—î–Ω—Ç–∞—Ü—ñ—ó —Ç–∞ –º–∞–ª–∏—Ö –µ–∫—Ä–∞–Ω—ñ–≤ */
        @media (max-width: 768px) and (orientation: landscape) {
            .leaflet-popup {
                margin-bottom: calc(60px + env(safe-area-inset-bottom)) !important;
            }
            
            .mobile-popup .leaflet-popup-content-wrapper {
                max-height: 60vh !important;
                max-width: 45vw !important;
            }
            
            .popup-content {
                max-height: 50vh !important;
                overflow-y: auto !important;
                scrollbar-width: thin;
                scrollbar-color: rgba(0,0,0,0.3) transparent;
            }
            
            .popup-content::-webkit-scrollbar {
                width: 4px;
            }
            
            .popup-content::-webkit-scrollbar-track {
                background: transparent;
            }
            
            .popup-content::-webkit-scrollbar-thumb {
                background: rgba(0,0,0,0.3);
                border-radius: 2px;
            }
        }
        
        /* –î–ª—è –¥—É–∂–µ –º–∞–ª–µ–Ω—å–∫–∏—Ö –µ–∫—Ä–∞–Ω—ñ–≤ - –£–õ–¨–¢–†–ê –ö–û–ú–ü–ê–ö–¢–ù–û */
        @media (max-width: 400px) {
            .mobile-popup .leaflet-popup-content-wrapper {
                margin: 0 2px !important;
                max-width: calc(100vw - 8px) !important;
                min-width: 240px !important;
            }
            
            .popup-content {
                padding: 8px !important;
                max-height: 50vh !important;
                overflow: hidden !important;
            }
            
            .popup-content table {
                font-size: 9px !important;
                table-layout: fixed !important;
                border-radius: 0 0 8px 8px !important;
                overflow: hidden !important;
            }
            
            .popup-content .property-name,
            .popup-content td.property-name {
                width: 30% !important;
                min-width: 60px !important;
                padding: 4px 3px !important;
                font-size: 8px !important;
                gap: 1px !important;
                white-space: nowrap !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
                border-radius: 0 !important;
            }
            
            /* –ó–∞–æ–∫—Ä—É–≥–ª–µ–Ω—ñ –∫—É—Ç–∏ –¥–ª—è –¥—É–∂–µ –º–∞–ª–µ–Ω—å–∫–∏—Ö –µ–∫—Ä–∞–Ω—ñ–≤ - –ø–µ—Ä—à–∏–π —Ä—è–¥–æ–∫ (–ø—ñ—Å–ª—è header) */
            .popup-content table tr:first-child .property-name,
            .popup-content table tr:first-child td.property-name {
                border-top-left-radius: 0 !important;
            }
            
            .popup-content table tr:first-child .property-value,
            .popup-content table tr:first-child td.property-value {
                border-top-right-radius: 0 !important;
            }
            
            /* –ó–∞–æ–∫—Ä—É–≥–ª–µ–Ω—ñ –∫—É—Ç–∏ –¥–ª—è –¥—É–∂–µ –º–∞–ª–µ–Ω—å–∫–∏—Ö –µ–∫—Ä–∞–Ω—ñ–≤ - –æ—Å—Ç–∞–Ω–Ω—ñ–π —Ä—è–¥–æ–∫ */
            .popup-content table tr:last-child .property-name,
            .popup-content table tr:last-child td.property-name {
                border-bottom-left-radius: 8px !important;
            }
            
            .popup-content table tr:last-child .property-value,
            .popup-content table tr:last-child td.property-value {
                border-bottom-right-radius: 8px !important;
            }
            
            .popup-content .property-value,
            .popup-content td.property-value {
                width: 70% !important;
                padding: 4px 3px !important;
                font-size: 9px !important;
                line-height: 1.1 !important;
                max-height: 1.5em !important;
                overflow: hidden !important;
                border-radius: 0 !important;
            }
            
            .mobile-header {
                padding: 10px 12px !important;
                font-size: 0.85rem !important;
            }
        }
        
        /* –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è –¥–ª—è —Å–µ–Ω—Å–æ—Ä–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è */
        @media (max-width: 768px) {
            .leaflet-popup-close-button:active {
                transform: scale(0.95);
                background: rgba(0,0,0,0.2) !important;
            }
            
            .popup-content tr:active {
                background-color: rgba(0,123,255,0.1) !important;
            }
        }

        /* –ú–æ–±—ñ–ª—å–Ω–µ –º–µ–Ω—é –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è */
        .offcanvas {
            background: rgba(33, 37, 41, 0.98);
            backdrop-filter: blur(20px);
        }
        
        /* –î–æ–¥–∞—Ç–∫–æ–≤—ñ –º–æ–±—ñ–ª—å–Ω—ñ –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è –¥–ª—è offcanvas */
        .offcanvas-header {
            padding: 16px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .offcanvas-title {
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .offcanvas-body {
            padding: 20px;
            overflow-y: auto;
        }
        
        /* –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è –∫–Ω–æ–ø–æ–∫ —É –º–µ–Ω—é */
        .offcanvas .btn {
            border-radius: 8px;
            padding: 12px 16px;
            transition: all 0.2s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .offcanvas .btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }
        
        .offcanvas .btn:active {
            transform: translateY(0);
        }
        
        /* –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è —Å–µ–ª–µ–∫—Ç—ñ–≤ */
        .offcanvas .form-select {
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.05);
            padding: 10px 12px;
            font-size: 14px;
        }
        
        .offcanvas .form-select:focus {
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
        }
        
        /* –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è –∑–∞–≥–æ–ª–æ–≤–∫—ñ–≤ —Å–µ–∫—Ü—ñ–π */
        .offcanvas h6 {
            font-size: 0.95rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 12px;
        }
        
        .offcanvas .border-bottom {
            border-color: rgba(255, 255, 255, 0.15) !important;
        }
        
        /* –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è –∫–æ–Ω—Ç–∞–∫—Ç–Ω–æ—ó —Å–µ–∫—Ü—ñ—ó */
        .offcanvas .mt-auto {
            border-color: rgba(255, 255, 255, 0.15) !important;
            padding-top: 16px;
        }
        
        /* –ê–¥–∞–ø—Ç–∏–≤–Ω—ñ—Å—Ç—å –∫–Ω–æ–ø–∫–∏ –∑–∞–∫—Ä–∏—Ç—Ç—è */
        .btn-close {
            filter: brightness(0) invert(1);
            opacity: 0.8;
        }
        
        .btn-close:hover {
            opacity: 1;
        }
        
        /* –î–æ–¥–∞—Ç–∫–æ–≤—ñ –º–æ–±—ñ–ª—å–Ω—ñ –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è */
        @media (max-width: 768px) {
            .offcanvas {
                --bs-offcanvas-width: 85vw;
                max-width: 320px;
            }
            
            .offcanvas-body {
                padding: 16px;
            }
            
            .offcanvas .btn {
                padding: 14px 16px;
                font-size: 15px;
                min-height: 48px;
                display: flex;
                align-items: center;
                justify-content: flex-start;
            }
            
            .offcanvas .btn i {
                font-size: 16px;
                min-width: 20px;
            }
            
            /* –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è –¥–æ—Ç–∏–∫—É */
            .offcanvas .btn:active {
                background: rgba(255, 255, 255, 0.2);
                transform: scale(0.98);
            }
            
            /* –ó–±—ñ–ª—å—à—É—î–º–æ —Ä–æ–∑–º—ñ—Ä–∏ –¥–ª—è –∑—Ä—É—á–Ω–æ—Å—Ç—ñ –¥–æ—Ç–∏–∫—É */
            .offcanvas .form-select {
                min-height: 44px;
                font-size: 16px; /* –ó–∞–ø–æ–±—ñ–≥–∞—î zoom –Ω–∞ iOS */
            }
            
            .offcanvas .form-label {
                font-size: 14px;
                margin-bottom: 6px;
                font-weight: 500;
            }
            
            /* –ü–æ–∫—Ä–∞—â—É—î–º–æ –≤—ñ–¥—Å—Ç—É–ø–∏ –º—ñ–∂ —Å–µ–∫—Ü—ñ—è–º–∏ */
            .offcanvas .mb-4 {
                margin-bottom: 1.5rem !important;
            }
            
            .offcanvas .mb-3 {
                margin-bottom: 1rem !important;
            }
            
            /* –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è –∫–æ–Ω—Ç–∞–∫—Ç–Ω–æ—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó */
            .offcanvas .mt-auto .btn {
                font-size: 16px;
                font-weight: 500;
            }
        }
        
        /* –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è –¥–ª—è –ª–∞–Ω–¥—à–∞—Ñ—Ç–Ω–æ—ó –æ—Ä—ñ—î–Ω—Ç–∞—Ü—ñ—ó */
        @media (max-width: 768px) and (orientation: landscape) {
            .offcanvas {
                --bs-offcanvas-width: 60vw;
                max-width: 280px;
            }
            
            .offcanvas-body {
                padding: 12px 16px;
            }
            
            .offcanvas .btn {
                padding: 10px 14px;
                min-height: 40px;
            }
        }

        /* –ü–æ–∫—Ä–∞—â—É—î–º–æ –∫–Ω–æ–ø–∫–∏ –≤ navbar –¥–ª—è –º–æ–±—ñ–ª—å–Ω–∏—Ö */
        .navbar .btn {
            min-width: 40px;
            min-height: 40px;
            border-radius: 10px;
        }
    }

    /* Landscape –æ—Ä—ñ—î–Ω—Ç–∞—Ü—ñ—è –¥–ª—è –º–æ–±—ñ–ª—å–Ω–∏—Ö */
    @media (max-width: 768px) and (orientation: landscape) {
        #map {
            top: calc(50px + env(safe-area-inset-top));
        }

        .navbar {
            height: 50px;
        }

        .pwa-install {
            bottom: calc(10px + env(safe-area-inset-bottom));
            right: 10px;
            padding: 8px 16px;
            font-size: 12px;
        }
    }

    /* –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è –¥–ª—è –≤–µ–ª–∏–∫–∏—Ö –º–æ–±—ñ–ª—å–Ω–∏—Ö –µ–∫—Ä–∞–Ω—ñ–≤ */
    @media (min-width: 390px) and (max-width: 768px) {
        .contact-phone .phone-text {
            display: inline !important;
            font-size: 12px;
        }
    }

    /* –ê–Ω—ñ–º–∞—Ü—ñ—ó –¥–ª—è –∫—Ä–∞—â–æ–≥–æ UX */
    .btn, .leaflet-bar a, .leaflet-control-layers-toggle {
        transition: all 0.2s ease;
    }

    .btn:active, .leaflet-bar a:active {
        transform: scale(0.95);
    }

    /* –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è —á–∏—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—ñ –¥–ª—è –ª–∏—Å—Ç—ñ–≤–∫—ñ–≤ –∫–æ–Ω—Ç—Ä–æ–ª—ñ–≤ */
    .leaflet-control-layers {
        background: rgba(255, 255, 255, 0.95) !important;
        color: #333 !important;
        border: 1px solid #ccc !important;
    }

    .leaflet-control-layers label {
        color: #333 !important;
        font-weight: 500 !important;
    }

    .leaflet-control-layers-list {
        color: #333 !important;
    }

    .leaflet-layerstree-header label {
        color: #333 !important;
    }

    .leaflet-layerstree-header-name {
        color: #333 !important;
    }

    .leaflet-control-layers input[type="checkbox"] {
        margin-right: 5px;
    }

    /* –ü–µ—Ä–µ–≤–∏–∑–Ω–∞—á–∞—î–º–æ –≤—Å—ñ –º–æ–∂–ª–∏–≤—ñ —Å–µ–ª–µ–∫—Ç–æ—Ä–∏ –¥–ª—è —Ç–µ–∫—Å—Ç—É –≤ layers control */
    .leaflet-control-layers * {
        color: #333 !important;
    }

    .leaflet-control-layers span {
        color: #333 !important;
    }

    .leaflet-control-layers div {
        color: #333 !important;
    }

    /* –ü—ñ–¥—Ç—Ä–∏–º–∫–∞ dark mode */
    @media (prefers-color-scheme: dark) {
        .leaflet-control-layers {
            background: rgba(33, 37, 41, 0.95);
            color: white;
        }

        .leaflet-control-layers label {
            color: white;
        }

        .leaflet-bar a {
            background: rgba(33, 37, 41, 0.95);
            color: white;
        }
    }
    
    /* –§–æ—Ä—Å—É—î–º–æ —Å–≤—ñ—Ç–ª–∏–π —Ç–µ–∫—Å—Ç –¥–ª—è layers control –Ω–µ–∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ —Ç–µ–º–∏ */
    .leaflet-control-layers {
        background: rgba(255, 255, 255, 0.95) !important;
        color: #333 !important;
    }
    
    .leaflet-control-layers label {
        color: #333 !important;
    }
    
    .leaflet-control-layers span:not(.color-box) {
        color: #333 !important;
    }
    
    .leaflet-layerstree-header-name {
        color: #333 !important;
    }
    
    .leaflet-layerstree-header label {
        color: #333 !important;
    }
    
    /* –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –∫–æ–ª—å–æ—Ä–æ–≤—ñ –∫–≤–∞–¥—Ä–∞—Ç–∏–∫–∏ */
    .leaflet-control-layers .color-box {
        color: transparent !important;
        width: 12px !important;
        height: 12px !important;
        display: inline-block !important;
        margin-right: 5px !important;
        border: 1px solid rgba(0,0,0,0.2) !important;
        /* –ù–ï –ø–µ—Ä–µ–≤–∏–∑–Ω–∞—á–∞—î–º–æ background-color - –∑–∞–ª–∏—à–∞—î–º–æ inline —Å—Ç–∏–ª—ñ */
    }
    
    /* –ó–±–µ—Ä—ñ–≥–∞—î–º–æ toggle —ñ–∫–æ–Ω–∫—É */
    .leaflet-control-layers-toggle {
        background-image: url("data:image/svg+xml,%3csvg width='26' height='26' viewBox='0 0 26 26' xmlns='http://www.w3.org/2000/svg'%3e%3cpath fill='%23333' fill-rule='evenodd' d='M6 4h14v2H6V4zm0 4h10v2H6V8zm0 4h14v2H6v-2zm0 4h10v2H6v-2z'/%3e%3c/svg%3e") !important;
        background-repeat: no-repeat !important;
        background-position: 50% 50% !important;
        background-size: 20px 20px !important;
        width: 36px !important;
        height: 36px !important;
    }
    
    /* –í–∏–¥–∞–ª—è—î–º–æ –¥–æ–¥–∞—Ç–∫–æ–≤–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç */
    .leaflet-control-layers-toggle:after {
        display: none !important;
    }
    
    /* –í—ñ–¥–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É —ñ–∫–æ–Ω–∫—É Leaflet layers control */
    .leaflet-control-layers-toggle {
        background-image: url("data:image/svg+xml,%3csvg width='26' height='26' viewBox='0 0 26 26' xmlns='http://www.w3.org/2000/svg'%3e%3cpath fill='%23333' d='M4 6h18v2H4zm0 4h12v2H4zm0 4h18v2H4zm0 4h12v2H4z'/%3e%3c/svg%3e") !important;
    }
    
    /* –ó–∞–±–µ–∑–ø–µ—á—É—î–º–æ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π –∫–æ–ª—ñ—Ä —Ç–µ–∫—Å—Ç—É –¥–ª—è layer names */
    .layer-name {
        color: #333 !important;
    }
    
    /* –î–æ–¥–∞—Ç–∫–æ–≤—ñ –º–æ–±—ñ–ª—å–Ω—ñ –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è –¥–ª—è layers control */
    @media (max-width: 768px) {
        /* –ü—Ä–∏—Ö–æ–≤—É—î–º–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–π layers control –Ω–∞ –º–æ–±—ñ–ª—å–Ω–∏—Ö */
        .leaflet-control-layers {
            display: none !important;
        }
        
        /* –ü—Ä–∏—Ö–æ–≤—É—î–º–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–π locate control –Ω–∞ –º–æ–±—ñ–ª—å–Ω–∏—Ö */
        .leaflet-control-locate {
            display: none !important;
        }
        
        /* –ü—Ä–∏—Ö–æ–≤—É—î–º–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–π search control –Ω–∞ –º–æ–±—ñ–ª—å–Ω–∏—Ö */
        .leaflet-control-search {
            display: none !important;
        }
        
        /* –°—Ç–≤–æ—Ä—é—î–º–æ –º–æ–±—ñ–ª—å–Ω–µ –º–µ–Ω—é –≤–Ω–∏–∑—É */
        .mobile-bottom-menu {
            position: fixed;
            bottom: env(safe-area-inset-bottom);
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            padding: 8px 16px calc(8px + env(safe-area-inset-bottom));
            z-index: 1000;
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 -2px 20px rgba(0, 0, 0, 0.1);
        }
        
        .mobile-menu-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px;
            border-radius: 12px;
            background: transparent;
            border: none;
            color: #333;
            font-size: 12px;
            min-width: 60px;
            transition: all 0.2s ease;
            touch-action: manipulation;
        }
        
        .mobile-menu-item:active {
            background: rgba(0, 0, 0, 0.1);
            transform: scale(0.95);
        }
        
        .mobile-menu-item i {
            font-size: 20px;
            margin-bottom: 4px;
        }
        
        .mobile-menu-item.active {
            background: rgba(25, 135, 84, 0.1);
            color: #198754;
        }
        
        .mobile-menu-item.locating {
            background: rgba(255, 193, 7, 0.1);
            color: #ffc107;
            animation: pulse 2s infinite;
        }
        
        .mobile-menu-item.located {
            background: rgba(25, 135, 84, 0.2);
            color: #198754;
        }
        
        /* –î–æ–¥–∞—î–º–æ –≤—ñ–¥—Å—Ç—É–ø –∑–Ω–∏–∑—É –¥–ª—è –∫–∞—Ä—Ç–∏ —â–æ–± –Ω–µ –ø–µ—Ä–µ–∫—Ä–∏–≤–∞–ª–∞ –º–µ–Ω—é */
        #map {
            bottom: calc(80px + env(safe-area-inset-bottom)) !important;
        }
        
        /* –ú–æ–±—ñ–ª—å–Ω–∞ –ø–∞–Ω–µ–ª—å —à–∞—Ä—ñ–≤ */
        .mobile-layers-panel {
            position: fixed;
            bottom: calc(80px + env(safe-area-inset-bottom));
            left: 16px;
            right: 16px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.2);
            max-height: 60vh;
            overflow-y: auto;
            display: none;
            z-index: 1001;
        }
        
        .mobile-layers-panel.show {
            display: block;
        }
        
        .mobile-layers-panel h6 {
            margin: 0 0 12px 0;
            color: #333;
            font-weight: 600;
        }
        
        .mobile-layer-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .mobile-layer-item:last-child {
            border-bottom: none;
        }
        
        .mobile-layer-item input[type="checkbox"] {
            margin-right: 12px;
            transform: scale(1.2);
        }
        
        .mobile-layer-item label {
            color: #333 !important;
            font-size: 14px;
            flex: 1;
            display: flex;
            align-items: center;
        }
        
        .mobile-layer-item .color-box {
            width: 14px;
            height: 14px;
            display: inline-block;
            margin-right: 8px;
            border-radius: 2px;
            vertical-align: middle;
            border: 1px solid rgba(255,255,255,0.3);
        }
        
        /* –°—Ç–∏–ª—ñ –¥–ª—è –º–æ–±—ñ–ª—å–Ω–æ–≥–æ –ø–æ—à—É–∫—É –≤ overlay */
        .mobile-search-overlay .leaflet-control-search {
            display: block !important;
            position: relative !important;
            background: white !important;
            border-radius: 12px !important;
            box-shadow: 0 8px 30px rgba(0,0,0,0.3) !important;
            margin: 0 !important;
            width: 100% !important;
            max-width: 400px !important;
            overflow: hidden !important;
        }
        
        .mobile-search-overlay .leaflet-control-search input {
            font-size: 16px !important;
            padding: 15px 20px !important;
            border: none !important;
            border-radius: 12px !important;
            width: 100% !important;
            box-sizing: border-box !important;
            background: white !important;
            color: #333 !important;
        }
        
        .mobile-search-overlay .leaflet-control-search input:focus {
            outline: none !important;
            box-shadow: 0 0 0 2px #198754 !important;
        }
        
        .mobile-search-overlay .leaflet-control-search .search-tooltip {
            background: white !important;
            border-radius: 0 0 12px 12px !important;
            box-shadow: none !important;
            max-height: 250px !important;
            overflow-y: auto !important;
            border-top: 1px solid #eee !important;
        }
        
        .mobile-search-overlay .leaflet-control-search .search-tip {
            padding: 12px 20px !important;
            border-bottom: 1px solid #f0f0f0 !important;
            font-size: 14px !important;
        }
        
        .mobile-search-overlay .leaflet-control-search .search-tip:hover {
            background-color: #f8f9fa !important;
        }
        
        .mobile-search-overlay .leaflet-control-search .search-tip:last-child {
            border-bottom: none !important;
        }
    }
    
    /* –°—Ç–∏–ª—ñ –¥–ª—è –º–æ–±—ñ–ª—å–Ω–æ–≥–æ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞ */
    @media (max-width: 768px) {
        /* –ü—Ä–∏—Ö–æ–≤—É—î–º–æ –ø–æ—Ä–æ–∂–Ω—ñ –ø–æ–ø–∞–ø–∏ –Ω–∞ –º–æ–±—ñ–ª—å–Ω–∏—Ö */
        .hidden-popup {
            display: none !important;
        }
        
        /* ===== MONOBANK-STYLE MOBILE MODAL ===== */
        #mobileModal .modal-dialog {
            margin: 0 !important;
            max-width: 100% !important;
            height: 100% !important;
        }
        
        #mobileModal .modal-content {
            background: var(--mono-bg) !important;
            border: none !important;
            border-radius: 0 !important;
            height: 100% !important;
        }
        
        #mobileModal .modal-header {
            background: var(--mono-surface) !important;
            border-bottom: 1px solid var(--mono-border) !important;
            padding: 16px 20px !important;
        }
        
        #mobileModal .modal-title {
            color: var(--mono-text) !important;
            font-size: 1.25rem !important;
            font-weight: 600 !important;
        }
        
        #mobileModal .btn-close {
            filter: invert(1) !important;
            opacity: 0.7 !important;
        }
        
        #mobileModal .modal-body {
            padding: 0;
            background: var(--mono-bg);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        #mobileModal .popup-content {
            padding: 16px;
            background: transparent;
            margin: 0;
        }
        
        #mobileModal .popup-content table {
            font-size: 15px !important;
            border-radius: var(--mono-radius) !important;
            overflow: hidden;
            background: var(--mono-surface) !important;
            border: 1px solid var(--mono-border) !important;
            width: 100% !important;
        }
        
        #mobileModal .property-name {
            font-size: 13px !important;
            padding: 14px 16px !important;
            background: var(--mono-surface-elevated) !important;
            color: var(--mono-text-secondary) !important;
            font-weight: 500 !important;
            border-bottom: 1px solid var(--mono-border) !important;
            border-right: 1px solid var(--mono-border) !important;
        }
        
        #mobileModal .property-value {
            font-size: 15px !important;
            padding: 14px 16px !important;
            color: var(--mono-text) !important;
            font-weight: 500 !important;
            background: var(--mono-surface) !important;
            border-bottom: 1px solid var(--mono-border) !important;
        }
        
        #mobileModal tr:last-child .property-name,
        #mobileModal tr:last-child .property-value {
            border-bottom: none !important;
        }
        
        #mobileModal .mobile-header {
            display: none;
        }
        
        #mobileModal .popup-link {
            margin: 16px;
            padding: 16px;
            background: var(--mono-surface);
            border-radius: var(--mono-radius-sm);
            border: 1px solid var(--mono-border);
        }
        
        #mobileModal .popup-link a {
            color: var(--mono-primary) !important;
        }
        
        #mobileModal .modal-footer {
            background: var(--mono-surface) !important;
            border-top: 1px solid var(--mono-border) !important;
            padding: 12px 20px calc(12px + env(safe-area-inset-bottom)) !important;
        }
        
        #mobileModal .modal-footer .btn {
            background: var(--mono-surface-elevated) !important;
            border: none !important;
            color: var(--mono-text) !important;
            border-radius: var(--mono-radius-sm) !important;
            padding: 12px 24px !important;
            font-weight: 600 !important;
        }
        
        /* –î–æ–¥–∞—Ç–∫–æ–≤—ñ –º–æ–±—ñ–ª—å–Ω—ñ –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó */
        .mobile-optimized {
            overflow-x: hidden;
        }
        
        /* –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è –¥–ª—è touch-–µ–∫—Ä–∞–Ω—ñ–≤ */
        .leaflet-control-layers-toggle {
            width: 44px !important;
            height: 44px !important;
        }
        
        .leaflet-control-zoom a {
            width: 44px !important;
            height: 44px !important;
            line-height: 44px !important;
        }
        
        /* –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è –¥–ª—è –º–∞–ª–∏—Ö –µ–∫—Ä–∞–Ω—ñ–≤ */
        @media (max-width: 480px) {
            .navbar-brand {
                font-size: 0.9rem;
            }
            
            .navbar-nav .nav-link {
                padding: 0.5rem 0.75rem;
            }
            
            .offcanvas {
                width: 90vw !important;
            }
        }
        
        /* –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è –¥–ª—è —Å–µ—Ä–µ–¥–Ω—ñ—Ö –º–æ–±—ñ–ª—å–Ω–∏—Ö –µ–∫—Ä–∞–Ω—ñ–≤ */
        @media (max-width: 576px) {
            #map {
                top: calc(50px + env(safe-area-inset-top));
            }
            
            .navbar {
                height: 50px;
            }
        }
        
        /* –í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –¥–ª—è tablet –µ–∫—Ä–∞–Ω—ñ–≤ (–≤–∫–ª—é—á–∞—é—á–∏ iPad –≤ portrait) */
        @media (min-width: 769px) and (max-width: 1024px) {
            #map {
                top: 56px !important;
                bottom: 0 !important;
                height: calc(100vh - 56px) !important;
            }
            
            .navbar {
                height: 56px !important;
                top: 0 !important;
            }
            
            /* –ó–∞–±–µ–∑–ø–µ—á—É—î–º–æ —â–æ –∫–∞—Ä—Ç–∞ –∑–∞–π–º–∞—î –≤–µ—Å—å –¥–æ—Å—Ç—É–ø–Ω–∏–π –ø—Ä–æ—Å—Ç—ñ—Ä */
            body, html {
                height: 100% !important;
                overflow: hidden !important;
            }
        }
        
        /* PWA –ø–æ–≤–Ω–æ–µ–∫—Ä–∞–Ω–Ω–∏–π —Ä–µ–∂–∏–º */
        @media (display-mode: standalone) {
            body {
                padding-top: env(safe-area-inset-top);
            }
            
            .navbar {
                top: env(safe-area-inset-top);
            }
            
            /* –í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –¥–ª—è iOS PWA popup –ø—Ä–æ–∫—Ä—É—á—É–≤–∞–Ω–Ω—è */
            .leaflet-popup-content-wrapper {
                max-height: 65vh !important;
                overflow: hidden !important;
            }
            
            .leaflet-popup-content {
                max-height: 60vh !important;
                overflow-y: auto !important;
                -webkit-overflow-scrolling: touch !important;
                scrollbar-width: thin !important;
                scrollbar-color: #198754 transparent !important;
                /* –î–æ–∑–≤–æ–ª—è—î–º–æ –≤–∏–¥—ñ–ª–µ–Ω–Ω—è —Ç–µ–∫—Å—Ç—É –≤ PWA —Ä–µ–∂–∏–º—ñ */
                -webkit-user-select: text !important;
                -moz-user-select: text !important;
                user-select: text !important;
                -webkit-touch-callout: default !important;
            }
            
            /* –ö–∞—Å—Ç–æ–º–Ω–∏–π —Å–∫—Ä–æ–ª–±–∞—Ä –¥–ª—è iOS */
            .leaflet-popup-content::-webkit-scrollbar {
                width: 4px !important;
            }
            
            .leaflet-popup-content::-webkit-scrollbar-track {
                background: transparent !important;
            }
            
            .leaflet-popup-content::-webkit-scrollbar-thumb {
                background: #198754 !important;
                border-radius: 2px !important;
            }
            
            .leaflet-popup-content::-webkit-scrollbar-thumb:hover {
                background: #157347 !important;
            }
        }
        
        /* –ü—Ä–∏—Ö–æ–≤—É–≤–∞–Ω–Ω—è –∞–¥—Ä–µ—Å–Ω–æ—ó —Å—Ç—Ä–æ–∫–∏ –Ω–∞ –º–æ–±—ñ–ª—å–Ω–∏—Ö */
        @media (max-height: 500px) and (orientation: landscape) {
            #map {
                top: calc(45px + env(safe-area-inset-top));
            }
            
            .navbar {
                height: 45px;
            }
        }
        
        /* –î–æ–¥–∞—Ç–∫–æ–≤—ñ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –¥–ª—è iOS Safari —Ç–∞ PWA */
        @media screen and (-webkit-min-device-pixel-ratio: 2) {
            .leaflet-popup-content {
                -webkit-overflow-scrolling: touch !important;
                transform: translateZ(0) !important;
                will-change: scroll-position !important;
                /* –î–æ–∑–≤–æ–ª—è—î–º–æ –≤–∏–¥—ñ–ª–µ–Ω–Ω—è —Ç–µ–∫—Å—Ç—É –Ω–∞ Retina –¥–∏—Å–ø–ª–µ—è—Ö */
                -webkit-user-select: text !important;
                user-select: text !important;
                -webkit-touch-callout: default !important;
            }
            
            /* –í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –¥–ª—è –º–æ–±—ñ–ª—å–Ω–æ–≥–æ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞ */
            #mobileModal .modal-body {
                max-height: 70vh !important;
                overflow-y: auto !important;
                -webkit-overflow-scrolling: touch !important;
                transform: translateZ(0) !important;
            }
        }
        
        /* –°–ø–µ—Ü—ñ–∞–ª—å–Ω—ñ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –¥–ª—è –≤—Å—ñ—Ö touch –ø—Ä–∏—Å—Ç—Ä–æ—ó–≤ */
        @media (any-hover: none) and (any-pointer: coarse) {
            .leaflet-popup {
                -webkit-transform: translateZ(0) !important;
                transform: translateZ(0) !important;
            }
            
            .leaflet-popup-content-wrapper {
                -webkit-transform: translateZ(0) !important;
                transform: translateZ(0) !important;
                position: relative !important;
            }
            
            .leaflet-popup-content {
                touch-action: pan-y !important;
                overscroll-behavior: contain !important;
                -webkit-overflow-scrolling: touch !important;
                position: relative !important;
                z-index: 1 !important;
                /* –î–æ–∑–≤–æ–ª—è—î–º–æ –≤–∏–¥—ñ–ª–µ–Ω–Ω—è —Ç–µ–∫—Å—Ç—É –Ω–∞ touch –ø—Ä–∏—Å—Ç—Ä–æ—è—Ö */
                -webkit-user-select: text !important;
                -moz-user-select: text !important;
                user-select: text !important;
                -webkit-touch-callout: default !important;
            }
        }
        
        /* –í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –¥–ª—è iPad - –≤—Å—ñ —Ä–æ–∑–º—ñ—Ä–∏ —Ç–∞ –æ—Ä—ñ—î–Ω—Ç–∞—Ü—ñ—ó */
        @media only screen 
        and (min-device-width: 768px) 
        and (max-device-width: 1024px) {
            #map {
                top: 56px !important;
                bottom: 0 !important;
                height: calc(100vh - 56px) !important;
            }
            
            .navbar {
                height: 56px !important;
                top: 0 !important;
            }
            
            /* –ü—Ä–∏—Ö–æ–≤—É—î–º–æ –∞–±–æ –∞–¥–∞–ø—Ç—É—î–º–æ PWA –∫–Ω–æ–ø–∫—É –¥–ª—è iPad */
            .pwa-install {
                bottom: calc(20px + env(safe-area-inset-bottom)) !important;
                right: 20px !important;
            }
        }
        
        /* –î–æ–¥–∞—Ç–∫–æ–≤—ñ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –¥–ª—è iPad Pro */
        @media only screen 
        and (min-device-width: 1024px) 
        and (max-device-width: 1366px) {
            #map {
                top: 56px !important;
                bottom: 0 !important;
                height: calc(100vh - 56px) !important;
            }
            
            .navbar {
                height: 56px !important;
                top: 0 !important;
            }
        }
        
        /* –í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –¥–ª—è iPad –≤ landscape —Ä–µ–∂–∏–º—ñ */
        @media only screen 
        and (min-device-width: 768px) 
        and (max-device-width: 1024px) 
        and (orientation: landscape) {
            #map {
                top: 56px !important;
                bottom: 0 !important;
                height: calc(100vh - 56px) !important;
                left: 0 !important;
                right: 0 !important;
                width: 100vw !important;
            }
            
            .navbar {
                height: 56px !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                width: 100vw !important;
            }
            
            /* –ó–∞–±–µ–∑–ø–µ—á—É—î–º–æ —â–æ –Ω–µ–º–∞—î –¥–æ–¥–∞—Ç–∫–æ–≤–∏—Ö –≤—ñ–¥—Å—Ç—É–ø—ñ–≤ */
            body {
                padding: 0 !important;
                margin: 0 !important;
                overflow: hidden !important;
            }
            
            html {
                padding: 0 !important;
                margin: 0 !important;
                overflow: hidden !important;
            }
        }
    }
    
    /* ========================================
       –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø: –î–æ–∑–≤–æ–ª—è—î–º–æ –≤–∏–¥—ñ–ª–µ–Ω–Ω—è —Ç–µ–∫—Å—Ç—É –≤ popup
       –¶–µ–π –±–ª–æ–∫ –º–∞—î –±—É—Ç–∏ –≤ –∫—ñ–Ω—Ü—ñ –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ—ó —Å–ø–µ—Ü–∏—Ñ—ñ—á–Ω–æ—Å—Ç—ñ
       ======================================== */
    .leaflet-popup-pane,
    .leaflet-popup,
    .leaflet-popup-content-wrapper,
    .leaflet-popup-content,
    .leaflet-popup-content *,
    .popup-content,
    .popup-content *,
    .popup-content table,
    .popup-content table *,
    .popup-content td,
    .popup-content tr,
    .property-name,
    .property-value,
    #mobileModal,
    #mobileModal *,
    .modal-body,
    .modal-body * {
        -webkit-user-select: text !important;
        -moz-user-select: text !important;
        -ms-user-select: text !important;
        user-select: text !important;
        -webkit-touch-callout: default !important;
    }
    
    .leaflet-popup-content,
    .popup-content {
        cursor: text !important;
    }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    <script src="https://unpkg.com/@mapbox/togeojson@0.16.0/togeojson.js"></script>
    <!-- –î–æ–±–∞–≤–ª—è–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É JSZip –¥–ª—è —Ä–∞—Å–ø–∞–∫–æ–≤–∫–∏ KMZ —Ñ–∞–π–ª–æ–≤ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body>
    <!-- Splash Screen –¥–ª—è PWA -->
    <div class="splash-screen" id="splashScreen">
        <div class="splash-logo">
            <i class="bi bi-geo-alt"></i>
        </div>
        <div class="splash-title">–ê–ì–†–û-–ü–†–û–°–¢–Ü–†</div>
        <div class="loading-spinner"></div>
    </div>

    <!-- PWA Install Button -->
    <button class="pwa-install" id="pwaInstall" title="–í—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å –¥–æ–¥–∞—Ç–æ–∫ –¥–ª—è —à–≤–∏–¥—à–æ–≥–æ –¥–æ—Å—Ç—É–ø—É">
        <i class="bi bi-download"></i>
        <span class="install-text">–í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –¥–æ–¥–∞—Ç–æ–∫</span>
        <div class="install-tooltip">
            <i class="bi bi-info-circle"></i>
            –®–≤–∏–¥—à–∏–π –¥–æ—Å—Ç—É–ø –±–µ–∑ –±—Ä–∞—É–∑–µ—Ä–∞!
        </div>
    </button>

    <!-- –û—Å—Ç–∞–≤–ª—è–µ–º —Ç—ñ–ª—å–∫–∏ –æ–¥–∏–Ω navbar -->
    <nav class="navbar navbar-dark fixed-top py-1" style="background: var(--mono-surface) !important; border-bottom: 1px solid var(--mono-border);">
        <div class="container-fluid px-3">
            <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è –±–æ–∫–æ–≤–æ–≥–æ –º–µ–Ω—é -->
            <button class="btn btn-sm" 
                    style="background: var(--mono-surface-elevated); border: none; color: var(--mono-text); border-radius: var(--mono-radius-sm); width: 40px; height: 40px;" 
                    type="button" 
                    data-bs-toggle="offcanvas" 
                    data-bs-target="#mainMenu"
                    aria-controls="mainMenu">
                <i class="bi bi-list" style="font-size: 18px;"></i>
            </button>

            <!-- –õ–æ–≥–æ—Ç–∏–ø –ø–æ —Ü–µ–Ω—Ç—Ä—É -->
            <div class="d-flex justify-content-center flex-grow-1">
                <span style="color: var(--mono-text); font-size: 17px; font-weight: 600; letter-spacing: -0.3px;">
                    <i class="bi bi-geo-alt-fill me-1" style="color: var(--mono-primary);"></i>–ê–ì–†–û-–ü–†–û–°–¢–Ü–†
                </span>
            </div>

            <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ø—Ä–∞–≤–æ—ó —á–∞—Å—Ç–∏–Ω–∏ navbar -->
            <div class="d-flex align-items-center gap-2">
                <!-- –ö–Ω–æ–ø–∫–∞ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è -->
                <a href="https://docs.google.com/forms/d/e/1FAIpQLSdGQcVSh5EnTCa6eJKT9KYX6HleJnXveBcyrCEgaKvlQgRInQ/viewform" 
                   class="btn btn-sm d-none d-md-flex" 
                   style="background: var(--mono-primary); border: none; color: white; border-radius: var(--mono-radius-sm); padding: 8px 16px; font-weight: 600;"
                   target="_blank"
                   title="–ó–∞–º–æ–≤–∏—Ç–∏ –¥–æ—Å—Ç—É–ø –±–µ–∑–∫–æ—à—Ç–æ–≤–Ω–æ">
                    <i class="bi bi-gift me-1"></i>–ó–∞–º–æ–≤–∏—Ç–∏
                </a>
                
                <!-- –ö–æ–Ω—Ç–∞–∫—Ç–Ω–∏–π —Ç–µ–ª–µ—Ñ–æ–Ω -->
                <a href="tel:+380638805745" 
                   class="btn btn-sm d-flex align-items-center" 
                   style="background: var(--mono-surface-elevated); border: none; color: var(--mono-text); border-radius: var(--mono-radius-sm); width: 40px; height: 40px;"
                   title="–ó–∞—Ç–µ–ª–µ—Ñ–æ–Ω—É–≤–∞—Ç–∏">
                    <i class="bi bi-telephone" style="font-size: 16px;"></i>
                </a>
            </div>
        </div>
    </nav>

    <!-- –ë–æ–∫–æ–≤–µ –º–µ–Ω—é -->
    <div class="offcanvas offcanvas-start text-light" tabindex="-1" id="mainMenu" style="background: var(--mono-surface) !important;">
        <div class="offcanvas-header" style="border-bottom: 1px solid var(--mono-border);">
            <h5 class="offcanvas-title" style="font-weight: 700; font-size: 1.4rem;">–ú–µ–Ω—é</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <!-- –°–µ–∫—Ü—ñ—è –≤–∏–±–æ—Ä—É –æ–±–ª–∞—Å—Ç—ñ –ø–µ—Ä–µ–≥–ª—è–¥—É -->
            <div class="mb-4" style="background: var(--mono-surface-elevated); border-radius: var(--mono-radius); padding: 16px;">
                <h6 style="color: var(--mono-text-secondary); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 16px;">–§—ñ–ª—å—Ç—Ä–∏</h6>
                <div class="mb-3">
                    <label for="fileSelect" class="form-label" style="color: var(--mono-text); font-weight: 500;">
                        <i class="bi bi-geo-alt me-1" style="color: var(--mono-primary);"></i>
                        –†–∞–¥–∞
                    </label>
                    <select class="form-select form-select-sm" id="fileSelect" style="background: var(--mono-bg); border: none; color: var(--mono-text); border-radius: var(--mono-radius-sm); padding: 12px 14px; width: 100%;">
                        <option>–í–∏–±–µ—Ä—ñ—Ç—å —Ä–∞–¥—É</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="fieldSelect" class="form-label" style="color: var(--mono-text); font-weight: 500;">
                        <i class="bi bi-grid-3x3-gap me-1" style="color: var(--mono-primary);"></i>
                        –ü–æ–ª–µ –æ–±—Ä–æ–±—ñ—Ç–∫—É
                    </label>
                    <select class="form-select form-select-sm" id="fieldSelect" style="background: var(--mono-bg); border: none; color: var(--mono-text); border-radius: var(--mono-radius-sm); padding: 12px 14px; width: 100%;">
                        <option value="">–í—Å—ñ –ø–æ–ª—è</option>
                    </select>
                </div>
                <!-- –î–æ–¥–∞—î–º–æ –Ω–æ–≤–∏–π select –¥–ª—è —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—ó –∑–∞ —Ä–æ–∫–æ–º -->
                <div class="mb-3">
                    <label for="expiryYearSelect" class="form-label" style="color: var(--mono-text); font-weight: 500;">
                        <i class="bi bi-calendar-x me-1" style="color: var(--mono-primary);"></i>
                        –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—è –æ—Ä–µ–Ω–¥–∏
                    </label>
                    <select class="form-select form-select-sm" id="expiryYearSelect" style="background: var(--mono-bg); border: none; color: var(--mono-text); border-radius: var(--mono-radius-sm); padding: 12px 14px;">
                        <option value="">–í—Å—ñ —Ä–æ–∫–∏</option>
                    </select>
                </div>
                <!-- –î–æ–¥–∞—î–º–æ –Ω–æ–≤–∏–π select –¥–ª—è —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—ó –∑–∞ –¥–∞—Ç–æ—é —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó -->
                <div class="mb-3">
                    <label for="registrationYearSelect" class="form-label" style="color: var(--mono-text); font-weight: 500;">
                        <i class="bi bi-calendar-check me-1" style="color: var(--mono-primary);"></i>
                        –î–∞—Ç–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –æ—Ä–µ–Ω–¥–∏
                    </label>
                    <select class="form-select form-select-sm" id="registrationYearSelect" style="background: var(--mono-bg); border: none; color: var(--mono-text); border-radius: var(--mono-radius-sm); padding: 12px 14px;">
                        <option value="">–í—Å—ñ —Ä–æ–∫–∏</option>
                    </select>
                </div>
                <!-- –§—ñ–ª—å—Ç—Ä –∑–∞ —Ü—ñ–ª—å–æ–≤–∏–º –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è–º -->
                <div class="mb-3">
                    <label for="landUseSelect" class="form-label" style="color: var(--mono-text); font-weight: 500;">
                        <i class="bi bi-signpost-split me-1" style="color: var(--mono-primary);"></i>
                        –¶—ñ–ª—å–æ–≤–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è
                    </label>
                    <select class="form-select form-select-sm" id="landUseSelect" style="background: var(--mono-bg); border: none; color: var(--mono-text); border-radius: var(--mono-radius-sm); padding: 12px 14px;">
                        <option value="">–í—Å—ñ —Ç–∏–ø–∏</option>
                    </select>
                </div>
                <!-- –§—ñ–ª—å—Ç—Ä –∑–∞ –ø–ª–æ—â–µ—é –∑–µ–º–µ–ª—å–Ω–æ—ó –¥—ñ–ª—è–Ω–∫–∏ -->
                <div class="mb-3">
                    <label class="form-label" style="color: var(--mono-text); font-weight: 500;">
                        <i class="bi bi-rulers me-1" style="color: var(--mono-primary);"></i>
                        –ü–ª–æ—â–∞ –î–ó–ö (–≥–∞)
                    </label>
                    <div class="row g-2">
                        <div class="col-6">
                            <input type="number" class="form-control form-control-sm" id="areaMinInput" placeholder="–í—ñ–¥" step="0.01" min="0" style="background: var(--mono-bg); border: none; color: var(--mono-text); border-radius: var(--mono-radius-sm); padding: 12px 14px;">
                        </div>
                        <div class="col-6">
                            <input type="number" class="form-control form-control-sm" id="areaMaxInput" placeholder="–î–æ" step="0.01" min="0" style="background: var(--mono-bg); border: none; color: var(--mono-text); border-radius: var(--mono-radius-sm); padding: 12px 14px;">
                        </div>
                    </div>
                    <button class="btn btn-sm w-100 mt-2" id="applyAreaFilterBtn" style="background: var(--mono-primary-soft); color: var(--mono-primary); border: none; border-radius: var(--mono-radius-sm); padding: 12px; font-weight: 600;">
                        <i class="bi bi-funnel me-1"></i>–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏
                    </button>
                </div>
                <!-- –ö–Ω–æ–ø–∫–∞ —Å–∫–∏–¥–∞–Ω–Ω—è –≤—Å—ñ—Ö —Ñ—ñ–ª—å—Ç—Ä—ñ–≤ -->
                <button class="btn btn-sm w-100" id="resetAllFiltersBtn" style="background: rgba(239, 68, 68, 0.15); color: #EF4444; border: none; border-radius: var(--mono-radius-sm); padding: 12px; font-weight: 600;">
                    <i class="bi bi-x-circle me-1"></i>–°–∫–∏–Ω—É—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä–∏
                </button>
            </div>
            <!-- –°–µ–∫—Ü—ñ—è —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ñ–≤ -->
            <div class="mb-4" style="background: var(--mono-surface-elevated); border-radius: var(--mono-radius); padding: 16px;">
                <h6 style="color: var(--mono-text-secondary); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 16px;">–Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏</h6>
                <div class="d-grid gap-2">
                    <button class="btn text-start" id="cadastralSearchButton" style="background: var(--mono-bg); color: var(--mono-text); border: none; border-radius: var(--mono-radius-sm); padding: 14px 16px; font-weight: 500;">
                        <i class="bi bi-search me-2" style="color: var(--mono-primary);"></i>
                        –ü–æ—à—É–∫ –∑–∞ —Å–ø–∏—Å–∫–æ–º –Ω–æ–º–µ—Ä—ñ–≤
                    </button>
                    <button class="btn text-start" id="statisticsButton" style="background: var(--mono-bg); color: var(--mono-text); border: none; border-radius: var(--mono-radius-sm); padding: 14px 16px; font-weight: 500;">
                        <i class="bi bi-pie-chart-fill me-2" style="color: var(--mono-primary);"></i>
                        –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                    </button>
                    <button class="btn text-start" id="exportButton" style="background: var(--mono-bg); color: var(--mono-text); border: none; border-radius: var(--mono-radius-sm); padding: 14px 16px; font-weight: 500;">
                        <i class="bi bi-table me-2" style="color: var(--mono-primary);"></i>
                        –ï–∫—Å–ø–æ—Ä—Ç –≤ Excel
                    </button>
                    <button class="btn text-start" id="freshnessButton" style="background: var(--mono-bg); color: var(--mono-text); border: none; border-radius: var(--mono-radius-sm); padding: 14px 16px; font-weight: 500;">
                        <i class="bi bi-building-fill me-2" style="color: var(--mono-primary);"></i>
                        –ú–æ—î –ø—ñ–¥–ø—Ä–∏—î–º—Å—Ç–≤–æ
                    </button>
                    <button class="btn text-start" id="exchangeButton" style="background: var(--mono-bg); color: var(--mono-text); border: none; border-radius: var(--mono-radius-sm); padding: 14px 16px; font-weight: 500;">
                        <i class="bi bi-arrow-left-right me-2" style="color: var(--mono-primary);"></i>
                        –ü—Ä–æ–ø–æ–∑–∏—Ü—ñ—è –æ–±–º—ñ–Ω—É
                    </button>
                    <button class="btn text-start" id="resetClientIdButton" style="display: none; background: rgba(245, 158, 11, 0.15); color: #F59E0B; border: none; border-radius: var(--mono-radius-sm); padding: 14px 16px; font-weight: 500;">
                        <i class="bi bi-arrow-clockwise me-2"></i>
                        –°–∫–∏–Ω—É—Ç–∏ –∫–ª—ñ—î–Ω—Ç—Å—å–∫–∏–π ID
                    </button>
                    <button class="btn text-start" id="debugButton" style="display: none; background: rgba(59, 130, 246, 0.15); color: #3B82F6; border: none; border-radius: var(--mono-radius-sm); padding: 14px 16px; font-weight: 500;">
                        <i class="bi bi-bug me-2"></i>
                        –ü–æ–∫–∞–∑–∞—Ç–∏ –¥–µ–±–∞–≥ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é
                    </button>
                    <div id="selectionTools" style="display: none;">
                        <button class="btn text-start w-100 mb-2" data-action="clear-selection" style="background: rgba(245, 158, 11, 0.15); color: #F59E0B; border: none; border-radius: var(--mono-radius-sm); padding: 14px 16px; font-weight: 500;">
                            <i class="bi bi-trash3 me-2"></i>
                            –û—á–∏—Å—Ç–∏—Ç–∏ –≤–∏–¥—ñ–ª–µ–Ω–Ω—è
                        </button>
                        <button class="btn text-start w-100" data-action="export-selected" style="background: var(--mono-primary-soft); color: var(--mono-primary); border: none; border-radius: var(--mono-radius-sm); padding: 14px 16px; font-weight: 500;">
                            <i class="bi bi-file-earmark-excel me-2"></i>
                            –ï–∫—Å–ø–æ—Ä—Ç—É–≤–∞—Ç–∏ –≤–∏–¥—ñ–ª–µ–Ω—ñ
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- –ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è -->
            <div class="mt-auto pt-3" style="border-top: 1px solid var(--mono-border);">
                <div class="text-center">
                    <small style="color: var(--mono-text-secondary); display: block; margin-bottom: 12px;">–ö–æ–Ω—Ç–∞–∫—Ç–∏</small>
                    <a href="tel:+380638805745" class="btn w-100" style="background: var(--mono-primary); color: white; border: none; border-radius: var(--mono-radius-sm); padding: 14px; font-weight: 600;">
                        <i class="bi bi-telephone me-2"></i>
                        +38 063 880 57 45
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- –ö–∞—Ä—Ç–∞ -->
    <div id="map"></div>
    
    <!-- –ú–æ–±—ñ–ª—å–Ω–µ –º–µ–Ω—é –≤–Ω–∏–∑—É (—Ç—ñ–ª—å–∫–∏ –¥–ª—è –º–æ–±—ñ–ª—å–Ω–∏—Ö –ø—Ä–∏—Å—Ç—Ä–æ—ó–≤) -->
    <div class="mobile-bottom-menu d-md-none">
        <button class="mobile-menu-item" id="mobileLayersBtn">
            <i class="bi bi-layers"></i>
            <span>–®–∞—Ä–∏</span>
        </button>
        <button class="mobile-menu-item" id="mobileSearchBtn">
            <i class="bi bi-search"></i>
            <span>–ü–æ—à—É–∫</span>
        </button>
        <button class="mobile-menu-item" id="mobileLocationBtn">
            <i class="bi bi-geo-alt"></i>
            <span>–õ–æ–∫–∞—Ü—ñ—è</span>
        </button>
        <button class="mobile-menu-item" id="mobileMenuBtn">
            <i class="bi bi-list"></i>
            <span>–ú–µ–Ω—é</span>
        </button>
    </div>
    
    <!-- –ú–æ–±—ñ–ª—å–Ω–∞ –ø–∞–Ω–µ–ª—å —à–∞—Ä—ñ–≤ -->
    <div class="mobile-layers-panel" id="mobileLayersPanel">
        <h6>
            <i class="bi bi-layers me-2"></i>
            –®–∞—Ä–∏ –∫–∞—Ä—Ç–∏
            <button class="btn btn-sm btn-outline-secondary float-end" id="closeMobileLayersBtn">
                <i class="bi bi-x"></i>
            </button>
        </h6>
        <div id="mobileLayersList">
            <!-- –¢—É—Ç –±—É–¥—É—Ç—å —à–∞—Ä–∏ -->
        </div>
    </div>
    <!-- Modal for cadastral numbers input -->
<div id="cadastralModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h5>–ü–æ—à—É–∫ –∑–∞ –∫–∞–¥–∞—Å—Ç—Ä–æ–≤–∏–º–∏ –Ω–æ–º–µ—Ä–∞–º–∏</h5>
        <ul class="nav nav-tabs" id="cadastralTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="own-tab" data-bs-toggle="tab" data-bs-target="#own" type="button">
                    –°–≤–æ—ó –¥—ñ–ª—è–Ω–∫–∏
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="others-tab" data-bs-toggle="tab" data-bs-target="#others" type="button">
                    –ß—É–∂—ñ –¥—ñ–ª—è–Ω–∫–∏
                </button>
            </li>
        </ul>
        <div class="tab-content" id="cadastralTabContent">
            <div class="tab-pane fade show active" id="own" role="tabpanel">
                <p class="text-muted mb-2">–í—Å—Ç–∞–≤—Ç–µ —Å–ø–∏—Å–æ–∫ —Å–≤–æ—ó—Ö –∫–∞–¥–∞—Å—Ç—Ä–æ–≤–∏—Ö –Ω–æ–º–µ—Ä—ñ–≤ (–∫–æ–∂–µ–Ω –∑ –Ω–æ–≤–æ–≥–æ —Ä—è–¥–∫–∞)</p>
                <textarea id="ownCadastralList" 
                          class="form-control" 
                          placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥:&#10;6821555100:05:006:0001&#10;6821555100:05:006:0002"></textarea>
            </div>
            <div class="tab-pane fade" id="others" role="tabpanel">
                <p class="text-muted mb-2">–í—Å—Ç–∞–≤—Ç–µ —Å–ø–∏—Å–æ–∫ —á—É–∂–∏—Ö –∫–∞–¥–∞—Å—Ç—Ä–æ–≤–∏—Ö –Ω–æ–º–µ—Ä—ñ–≤ (–∫–æ–∂–µ–Ω –∑ –Ω–æ–≤–æ–≥–æ —Ä—è–¥–∫–∞)</p>
                <textarea id="othersCadastralList" 
                          class="form-control" 
                          placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥:&#10;6821555100:05:006:0003&#10;6821555100:05:006:0004"></textarea>
            </div>
        </div>
        <div class="mt-3">
            <button type="button" class="btn btn-primary" id="searchCadastral">–ü–æ—à—É–∫</button>
            <button type="button" class="btn btn-secondary ms-2" onclick="clearCadastralLists()">–û—á–∏—Å—Ç–∏—Ç–∏</button>
        </div>
    </div>
</div>

<!-- Modal for GeoJSON export -->
<div id="exportModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h5>–ï–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–∏—Ö</h5>
        <div class="mb-3">
            <label for="exportFilename" class="form-label">–ù–∞–∑–≤–∞ —Ñ–∞–π–ª—É</label>
            <input type="text" class="form-control" id="exportFilename" placeholder="–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É —Ñ–∞–π–ª—É...">
        </div>
        <div class="mb-3">
            <label class="form-label">–§–æ—Ä–º–∞—Ç —Ñ–∞–π–ª—É</label>
            <select class="form-select" id="exportFormat">
                <option value="geojson">GeoJSON</option>
                <option value="kml">KML</option>
            </select>
        </div>
        <div class="mb-3">
            <label class="form-label">–ü–æ–ª—ñ–≥–æ–Ω–∏</label>
            <div id="polygonsList" class="list-group mb-2">
                <!-- –¢—É—Ç –±—É–¥—É—Ç—å –ø–æ–ª—ñ–≥–æ–Ω–∏ -->
            </div>
        </div>
        <button class="btn btn-primary" id="confirmExport">–ï–∫—Å–ø–æ—Ä—Ç—É–≤–∞—Ç–∏</button>
    </div>
</div>

<!-- –ó–Ω–∞–π–¥—ñ—Ç—å div –∑ id="exportModal" —ñ –¥–æ–¥–∞–π—Ç–µ –ø—ñ—Å–ª—è –Ω—å–æ–≥–æ –Ω–æ–≤–∏–π –º–æ–¥–∞–ª -->
<div id="loadModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h5>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø–æ–ª—ñ–≥–æ–Ω—ñ–≤</h5>
        <div class="mb-3">
            <label for="fileInput" class="form-label">–í–∏–±–µ—Ä—ñ—Ç—å GeoJSON, KML –∞–±–æ KMZ —Ñ–∞–π–ª</label>
            <input type="file" class="form-control" id="fileInput" accept=".geojson,.kml,.kmz">
        </div>
        <div class="mb-3">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="clearExisting">
                <label class="form-check-label" for="clearExisting">
                    –û—á–∏—Å—Ç–∏—Ç–∏ —ñ—Å–Ω—É—é—á—ñ –ø–æ–ª—ñ–≥–æ–Ω–∏ –ø–µ—Ä–µ–¥ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è–º
                </label>
            </div>
        </div>
        <button class="btn btn-primary" id="confirmLoad">–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏</button>
    </div>
</div>

<!-- Modal for exchange proposal -->
<div id="exchangeModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h5>–ü—Ä–æ–ø–æ–∑–∏—Ü—ñ—è –æ–±–º—ñ–Ω—É –∑–µ–º–µ–ª—å–Ω–∏–º–∏ –¥—ñ–ª—è–Ω–∫–∞–º–∏</h5>
        
        <div id="exchangeInputContainer">
            <div class="mb-2">
                <label for="selectedTenant" class="form-label">–í–∏–±–µ—Ä—ñ—Ç—å –æ—Ä–µ–Ω–¥–∞—Ä—è</label>
                <select class="form-select form-select-sm" id="selectedTenant">
                    <option value="">-- –í–∏–±–µ—Ä—ñ—Ç—å –æ—Ä–µ–Ω–¥–∞—Ä—è --</option>
                </select>
            </div>
            
            <div class="mb-2">
                <label for="exchangeList" class="form-label">–í–≤–µ–¥—ñ—Ç—å –∫–∞–¥–∞—Å—Ç—Ä–æ–≤—ñ –Ω–æ–º–µ—Ä–∏ –¥–ª—è –æ–±–º—ñ–Ω—É</label>
                <textarea id="exchangeList" class="form-control form-control-sm" rows="4" 
                         placeholder="–í–≤–µ–¥—ñ—Ç—å –∫–∞–¥–∞—Å—Ç—Ä–æ–≤—ñ –Ω–æ–º–µ—Ä–∏, –∫–æ–∂–µ–Ω –∑ –Ω–æ–≤–æ–≥–æ —Ä—è–¥–∫–∞"></textarea>
            </div>
            
            <div class="mb-2">
                <button type="button" class="btn btn-primary btn-sm" id="addTenantData">–î–æ–¥–∞—Ç–∏</button>
                <button type="button" class="btn btn-success btn-sm" id="generateExchange">–ê–Ω–∞–ª—ñ–∑—É–≤–∞—Ç–∏ –æ–±–º—ñ–Ω</button>
            </div>
            
            <div class="mb-2">
                <h6 class="border-bottom pb-2 mb-2">–í–∏–±—Ä–∞–Ω—ñ –æ—Ä–µ–Ω–¥–∞—Ä—ñ –¥–ª—è –æ–±–º—ñ–Ω—É:</h6>
                <div id="tenantSelections">
                    <!-- –ó–¥–µ—Å—å –±—É–¥—É—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä—ã -->
                </div>
            </div>
        </div>
        
        <div id="exchangeTableContainer" style="display: none;">
            <div id="exchangeSummary" class="mb-2">
                <!-- –ó–¥–µ—Å—å –±—É–¥–µ—Ç –∫—Ä–∞—Ç–∫–∞—è —Å–≤–æ–¥–∫–∞ –ø–æ –æ–±–º–µ–Ω—É -->
            </div>
            <div id="notFoundSummary" class="alert alert-warning mb-2" style="display: none;">
                <!-- –ó–¥–µ—Å—å –±—É–¥–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –Ω–µ–Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –Ω–æ–º–µ—Ä–∞—Ö -->
            </div>
            <div id="fieldTables" style="display: none;">
                <!-- –°—é–¥–∞ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è —Ç–∞–±–ª–∏—Ü—ã -->
            </div>
            <div id="exchangeAnalysisContainer" class="mt-3">
                <h6>–ê–ù–ê–õ–Ü–ó –†–Ü–í–ù–û–¶–Ü–ù–ù–û–°–¢–Ü –û–ë–ú–Ü–ù–£:</h6>
                <div id="exchangeAnalysis"></div>
            </div>
            <div class="mt-3 d-flex justify-content-between align-items-center flex-wrap">
                <div class="mb-2"><strong>–ó–∞–≥–∞–ª—å–Ω–∞ –ø–ª–æ—â–∞ –æ–±–º—ñ–Ω—É: </strong><span id="totalArea">0</span> –≥–∞</div>
                <button type="button" class="btn btn-success" id="exportPDF">
                    <i class="bi bi-file-pdf me-2"></i>–ï–∫—Å–ø–æ—Ä—Ç –≤ PDF
                </button>
            </div>
            <div class="mt-2">
                <button type="button" class="btn btn-secondary" id="backToExchangeInput">
                    <i class="bi bi-arrow-left me-2"></i>–ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –¥–æ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è
                </button>
            </div>
        </div>
    </div>
</div>

    <!-- –°–∫—Ä–∏–ø—Ç—ã -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="js/L.Control.Layers.Tree.min.js?v=1.2"></script>
    <script src="https://unpkg.com/leaflet-search@3.0.0/dist/leaflet-search.min.js"></script>
    <script src="https://unpkg.com/leaflet-geometryutil/src/leaflet.geometryutil.js"></script>
    <script src="js/leaflet.draw.js"></script>
    <script src="https://unpkg.com/leaflet-easybutton@2.4.0/src/easy-button.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-CMBXL0TQLR"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-CMBXL0TQLR');
    </script>
    <!-- –û—Å–Ω–æ–≤–Ω–æ–π —Å–∫—Ä–∏–ø—Ç -->
    <script>
        // –ë–µ–∑–ø–µ—á–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è –¥–ª—è —Ç–∞–∫—Ç–∏–ª—å–Ω–æ–≥–æ –≤—ñ–¥–≥—É–∫—É (–æ–≥–æ–ª–æ—à—É—î–º–æ –ø–µ—Ä—à–æ—é)
        let hasUserInteracted = false;
        
        // –í—ñ–¥—Å—Ç–µ–∂—É—î–º–æ –ø–µ—Ä—à—É –≤–∑–∞—î–º–æ–¥—ñ—é –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
        function trackUserInteraction() {
            hasUserInteracted = true;
            document.removeEventListener('touchstart', trackUserInteraction);
            document.removeEventListener('click', trackUserInteraction);
        }
        
        document.addEventListener('touchstart', trackUserInteraction, { once: true });
        document.addEventListener('click', trackUserInteraction, { once: true });
        
        function safeVibrate(duration = 50) {
            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –ø—ñ–¥—Ç—Ä–∏–º–∫—É API —Ç–∞ –≤–∑–∞—î–º–æ–¥—ñ—é –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
            if (navigator.vibrate && hasUserInteracted && window.innerWidth <= 768) {
                try {
                    navigator.vibrate(duration);
                } catch (e) {
                    console.log('Vibration failed:', e);
                }
            }
        }
        
        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –º–æ–±—ñ–ª—å–Ω–æ–≥–æ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞
        function showMobileModal(content) {
            // –°—Ç–≤–æ—Ä—é—î–º–æ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ —Ç—ñ–ª—å–∫–∏ –¥–ª—è –º–æ–±—ñ–ª—å–Ω–∏—Ö –ø—Ä–∏—Å—Ç—Ä–æ—ó–≤
            if (window.innerWidth <= 768) {
                const modal = document.createElement('div');
                modal.className = 'mobile-modal-overlay';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.8);
                    z-index: 10000;
                    display: flex;
                    align-items: flex-end;
                    justify-content: center;
                    animation: modalFadeIn 0.3s ease-out;
                `;
                
                const modalContent = document.createElement('div');
                modalContent.className = 'mobile-modal-content';
                modalContent.style.cssText = `
                    background: white;
                    width: 100%;
                    max-height: 85vh;
                    border-radius: 20px 20px 0 0;
                    box-shadow: 0 -8px 30px rgba(0, 0, 0, 0.3);
                    overflow: hidden;
                    transform: translateY(100%);
                    animation: modalSlideUp 0.3s ease-out forwards;
                    display: flex;
                    flex-direction: column;
                `;
                
                // –•–µ–¥–µ—Ä –∑ –∫–Ω–æ–ø–∫–æ—é –∑–∞–∫—Ä–∏—Ç—Ç—è
                const header = document.createElement('div');
                header.style.cssText = `
                    background: linear-gradient(135deg, #28a745, #1e7e34);
                    padding: 16px 20px;
                    border-bottom: 1px solid #dee2e6;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    min-height: 60px;
                    position: relative;
                `;
                
                const title = document.createElement('h5');
                title.textContent = '–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –¥—ñ–ª—è–Ω–∫—É';
                title.style.cssText = `
                    margin: 0;
                    font-size: 18px;
                    font-weight: 600;
                    color: white !important;
                `;
                
                // –Ü–Ω–¥–∏–∫–∞—Ç–æ—Ä –¥–ª—è –¥—Ä–∞–≥—É (—è–∫ —É –Ω–∞—Ç–∏–≤–Ω–∏—Ö –¥–æ–¥–∞—Ç–∫–∞—Ö)
                const dragIndicator = document.createElement('div');
                dragIndicator.style.cssText = `
                    width: 40px;
                    height: 4px;
                    background: rgba(255, 255, 255, 0.7);
                    border-radius: 2px;
                    position: absolute;
                    top: 8px;
                    left: 50%;
                    transform: translateX(-50%);
                `;
                
                const closeBtn = document.createElement('button');
                closeBtn.innerHTML = '‚úï';
                closeBtn.style.cssText = `
                    background: rgba(255, 255, 255, 0.2);
                    border: none;
                    font-size: 24px;
                    color: #ffffff;
                    cursor: pointer;
                    padding: 0;
                    width: 32px;
                    height: 32px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    border-radius: 50%;
                    transition: background-color 0.2s;
                `;
                
                closeBtn.addEventListener('mousedown', function() {
                    this.style.backgroundColor = 'rgba(255, 255, 255, 0.3)';
                });
                
                closeBtn.addEventListener('mouseup', function() {
                    this.style.backgroundColor = 'rgba(255, 255, 255, 0.2)';
                });
                
                // –ö–æ–Ω—Ç–µ–Ω—Ç
                const body = document.createElement('div');
                body.style.cssText = `
                    flex: 1;
                    overflow-y: auto;
                    padding: 20px;
                    background: white;
                    -webkit-overflow-scrolling: touch;
                    -webkit-user-select: text;
                    -moz-user-select: text;
                    -ms-user-select: text;
                    user-select: text;
                    -webkit-touch-callout: default;
                `;
                
                // –û–±—Ä–æ–±–ª—è—î–º–æ –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è –∫—Ä–∞—â–æ–≥–æ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è
                const processedContent = processModalContent(content);
                body.innerHTML = processedContent;
                
                // –ó–±–∏—Ä–∞—î–º–æ –≤—Å–µ —Ä–∞–∑–æ–º
                header.appendChild(dragIndicator);
                header.appendChild(title);
                header.appendChild(closeBtn);
                
                modalContent.appendChild(header);
                modalContent.appendChild(body);
                modal.appendChild(modalContent);
                
                // –î–æ–¥–∞—î–º–æ CSS –∞–Ω—ñ–º–∞—Ü—ñ—ó
                if (!document.getElementById('mobile-modal-styles')) {
                    const styles = document.createElement('style');
                    styles.id = 'mobile-modal-styles';
                    styles.textContent = `
                        @keyframes modalFadeIn {
                            from { opacity: 0; }
                            to { opacity: 1; }
                        }
                        
                        @keyframes modalSlideUp {
                            from { transform: translateY(100%); }
                            to { transform: translateY(0); }
                        }
                        
                        @keyframes modalSlideDown {
                            from { transform: translateY(0); }
                            to { transform: translateY(100%); }
                        }
                        
                        .mobile-modal-content h3,
                        .mobile-modal-content h4,
                        .mobile-modal-content h5 {
                            color: #212529 !important;
                            margin-bottom: 16px !important;
                            font-weight: 600 !important;
                        }
                        
                        .mobile-modal-content p,
                        .mobile-modal-content span,
                        .mobile-modal-content div {
                            color: #495057 !important;
                            line-height: 1.6 !important;
                        }
                        
                        .mobile-modal-content .info-row {
                            display: flex;
                            justify-content: space-between;
                            padding: 12px 0;
                            border-bottom: 1px solid #f1f3f4;
                        }
                        
                        .mobile-modal-content .info-row:last-child {
                            border-bottom: none;
                        }
                        
                        .mobile-modal-content .info-label {
                            font-weight: 500 !important;
                            color: #6c757d !important;
                            flex-shrink: 0;
                        }
                        
                        .mobile-modal-content .info-value {
                            font-weight: 400 !important;
                            color: #212529 !important;
                            text-align: right;
                            word-break: break-word;
                        }
                        
                        /* –î–æ–∑–≤–æ–ª—è—î–º–æ –≤–∏–¥—ñ–ª–µ–Ω–Ω—è —Ç–µ–∫—Å—Ç—É */
                        .mobile-modal-content,
                        .mobile-modal-content * {
                            -webkit-user-select: text !important;
                            -moz-user-select: text !important;
                            -ms-user-select: text !important;
                            user-select: text !important;
                            -webkit-touch-callout: default !important;
                        }
                    `;
                    document.head.appendChild(styles);
                }
                
                // –û–±—Ä–æ–±–Ω–∏–∫–∏ –ø–æ–¥—ñ–π
                const closeModal = () => {
                    modalContent.style.animation = 'modalSlideDown 0.3s ease-out forwards';
                    setTimeout(() => {
                        if (document.body.contains(modal)) {
                            document.body.removeChild(modal);
                        }
                    }, 300);
                };
                
                closeBtn.addEventListener('click', closeModal);
                
                // –ó–∞–∫—Ä–∏—Ç—Ç—è –ø–æ –∫–ª—ñ–∫—É –Ω–∞ —Ñ–æ–Ω
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closeModal();
                    }
                });
                
                // –ü—ñ–¥—Ç—Ä–∏–º–∫–∞ –∂–µ—Å—Ç—ñ–≤ (swipe down –¥–ª—è –∑–∞–∫—Ä–∏—Ç—Ç—è)
                let startY = 0;
                let currentY = 0;
                let isDragging = false;
                
                modalContent.addEventListener('touchstart', function(e) {
                    startY = e.touches[0].clientY;
                    isDragging = true;
                }, { passive: true });
                
                modalContent.addEventListener('touchmove', function(e) {
                    if (!isDragging) return;
                    
                    currentY = e.touches[0].clientY;
                    const deltaY = currentY - startY;
                    
                    if (deltaY > 0) { // –¢—ñ–ª—å–∫–∏ –≤–Ω–∏–∑
                        modalContent.style.transform = `translateY(${deltaY}px)`;
                    }
                }, { passive: true });
                
                modalContent.addEventListener('touchend', function(e) {
                    if (!isDragging) return;
                    isDragging = false;
                    
                    const deltaY = currentY - startY;
                    
                    if (deltaY > 100) { // –Ø–∫—â–æ –ø–æ—Ç—è–≥–Ω—É–ª–∏ –±—ñ–ª—å—à–µ –Ω—ñ–∂ –Ω–∞ 100px
                        closeModal();
                    } else {
                        // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –Ω–∞–∑–∞–¥
                        modalContent.style.transform = 'translateY(0)';
                    }
                }, { passive: true });
                
                // Haptic feedback –ø—Ä–∏ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—ñ
                safeVibrate(50);
                
                document.body.appendChild(modal);
                return modal;
            }
            return null;
        }
        
        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –æ–±—Ä–æ–±–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç—É –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞
        function processModalContent(content) {
            // –Ø–∫—â–æ –∫–æ–Ω—Ç–µ–Ω—Ç –≤–∂–µ —î HTML
            if (typeof content === 'string' && content.includes('<')) {
                // –ü–æ–∫—Ä–∞—â—É—î–º–æ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è –º–æ–±—ñ–ª—å–Ω–æ–≥–æ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è
                let processed = content;
                
                // –í–∏–¥–∞–ª—è—î–º–æ –∑–∞–π–≤—ñ –±–ª–æ–∫–∏ –∑ –∑–µ–ª–µ–Ω–∏–º —Ñ–æ–Ω–æ–º (div –∑ style, —â–æ –º—ñ—Å—Ç–∏—Ç—å background)
                processed = processed.replace(/<div[^>]*style="[^"]*background[^"]*"[^>]*>.*?<\/div>/gs, '');
                
                // –ó–∞–º—ñ–Ω—é—î–º–æ —Ç–∞–±–ª–∏—Ü—ñ –Ω–∞ –±—ñ–ª—å—à –º–æ–±—ñ–ª—å–Ω–æ-–¥—Ä—É–∂–Ω—ñ –±–ª–æ–∫–∏
                processed = processed.replace(/<table[^>]*>(.*?)<\/table>/gs, function(match, tableContent) {
                    // –í–∏—Ç—è–≥—É—î–º–æ —Ä—è–¥–∫–∏ –∑ —Ç–∞–±–ª–∏—Ü—ñ
                    const rows = tableContent.match(/<tr[^>]*>(.*?)<\/tr>/gs) || [];
                    
                    let mobileContent = '<div class="mobile-info-table">';
                    
                    rows.forEach(row => {
                        const cells = row.match(/<td[^>]*>(.*?)<\/td>/gs) || [];
                        if (cells.length >= 2) {
                            // –í–∏—Ç—è–≥—É—î–º–æ —Ç–∞ –æ—á–∏—â—É—î–º–æ –Ω–∞–∑–≤—É –ø–æ–ª—è —Ç–∞ –∑–Ω–∞—á–µ–Ω–Ω—è
                            let label = cells[0].replace(/<[^>]*>/g, '').trim();
                            let value = cells[1].replace(/<[^>]*>/g, '').trim();
                            
                            // –î–æ–¥–∞—î–º–æ –¥–≤–æ–∫—Ä–∞–ø–∫—É —è–∫—â–æ —ó—ó –Ω–µ–º–∞—î
                            if (!label.endsWith(':')) {
                                label = label + ':';
                            }
                            
                            if (label && value) {
                                mobileContent += `
                                    <div class="info-row">
                                        <div class="info-label">${label}</div>
                                        <div class="info-value">${value}</div>
                                    </div>
                                `;
                            }
                        }
                    });
                    
                    mobileContent += '</div>';
                    return mobileContent;
                });
                
                return processed;
            }
            
            // –Ø–∫—â–æ —Ü–µ –ø—Ä–æ—Å—Ç–∏–π —Ç–µ–∫—Å—Ç
            return `<div style="font-size: 16px; line-height: 1.6;">${content}</div>`;
        }

        // PWA Variables
        let deferredPrompt;
        let isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;

        // PWA Service Worker Registration –∑ –∞–≥—Ä–µ—Å–∏–≤–Ω–∏–º –æ—á–∏—â–µ–Ω–Ω—è–º –∫–µ—à—É
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    // –û—á–∏—â–∞—î–º–æ –≤—Å—ñ —Å—Ç–∞—Ä—ñ –∫–µ—à—ñ
                    const cacheNames = await caches.keys();
                    await Promise.all(
                        cacheNames.map(cacheName => caches.delete(cacheName))
                    );
                    
                    // –í–∏–º–∫–Ω–µ–º–æ Service Worker —Ç–∏–º—á–∞—Å–æ–≤–æ –¥–ª—è —à–≤–∏–¥–∫–æ–≥–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    await Promise.all(registrations.map(registration => registration.unregister()));
                    
                    console.log('All caches and service workers cleared');
                    
                    // –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —Å—Ç–æ—Ä—ñ–Ω–∫—É —è–∫—â–æ —Ü–µ –ø–µ—Ä—à–∏–π –∑–∞–ø—É—Å–∫ –ø—ñ—Å–ª—è –æ—á–∏—â–µ–Ω–Ω—è
                    if (!sessionStorage.getItem('cache-cleared-v1.4')) {
                        sessionStorage.setItem('cache-cleared-v1.4', 'true');
                        window.location.reload(true);
                        return;
                    }
                    
                } catch (error) {
                    console.log('Cache clearing failed: ', error);
                }
            });
        }

        // PWA Install Prompt
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            if (!isStandalone) {
                const installBtn = document.getElementById('pwaInstall');
                installBtn.classList.add('show');
                
                // –î–æ–¥–∞—Ç–∫–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –¥–ª—è Windows –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤
                if (navigator.userAgent.includes('Windows')) {
                    setTimeout(() => {
                        showInstallNotification();
                    }, 3000); // –ü–æ–∫–∞–∑—É—î–º–æ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥–∏
                }
            }
        });
        
        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –ø–æ–∫–∞–∑—É –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è
        function showInstallNotification() {
            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤–∂–µ –Ω–µ –ø–æ–∫–∞–∑—É–≤–∞–ª–æ—Å—å
            if (localStorage.getItem('installNotificationShown')) {
                return;
            }
            
            const notification = document.createElement('div');
            notification.id = 'installNotification';
            notification.innerHTML = `
                <div class="install-notification">
                    <div class="notification-content">
                        <i class="bi bi-download notification-icon"></i>
                        <div class="notification-text">
                            <strong>–í—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å –ê–ì–†–û-–ü–†–û–°–¢–Ü–† —è–∫ –¥–æ–¥–∞—Ç–æ–∫!</strong>
                            <p>–®–≤–∏–¥—à–∏–π –¥–æ—Å—Ç—É–ø, –ø—Ä–∞—Ü—é—î –æ—Ñ–ª–∞–π–Ω, –±–µ–∑ –±—Ä–∞—É–∑–µ—Ä–∞</p>
                        </div>
                        <button class="btn btn-light btn-sm install-now-btn">
                            <i class="bi bi-download"></i> –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏
                        </button>
                        <button class="btn btn-outline-light btn-sm close-notification">
                            <i class="bi bi-x"></i>
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // –î–æ–¥–∞—î–º–æ —Å—Ç–∏–ª—ñ –¥–ª—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
            const notificationStyles = document.createElement('style');
            notificationStyles.textContent = `
                .install-notification {
                    position: fixed;
                    top: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: linear-gradient(45deg, #198754, #20c997);
                    color: white;
                    padding: 15px 20px;
                    border-radius: 15px;
                    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                    z-index: 10000;
                    max-width: 90vw;
                    width: 450px;
                    animation: slideInDown 0.5s ease-out;
                }
                
                .notification-content {
                    display: flex;
                    align-items: center;
                    gap: 15px;
                }
                
                .notification-icon {
                    font-size: 24px;
                    animation: bounce 2s infinite;
                }
                
                .notification-text {
                    flex: 1;
                }
                
                .notification-text strong {
                    display: block;
                    margin-bottom: 5px;
                }
                
                .notification-text p {
                    margin: 0;
                    font-size: 14px;
                    opacity: 0.9;
                }
                
                .install-now-btn, .close-notification {
                    white-space: nowrap;
                }
                
                @keyframes slideInDown {
                    0% {
                        opacity: 0;
                        transform: translateX(-50%) translateY(-50px);
                    }
                    100% {
                        opacity: 1;
                        transform: translateX(-50%) translateY(0);
                    }
                }
                
                @keyframes bounce {
                    0%, 20%, 50%, 80%, 100% {
                        transform: translateY(0);
                    }
                    40% {
                        transform: translateY(-10px);
                    }
                    60% {
                        transform: translateY(-5px);
                    }
                }
                
                @media (max-width: 768px) {
                    .install-notification {
                        width: 95vw;
                        left: 2.5vw;
                        transform: none;
                    }
                    
                    .notification-content {
                        flex-direction: column;
                        text-align: center;
                        gap: 10px;
                    }
                }
            `;
            document.head.appendChild(notificationStyles);
            
            // –û–±—Ä–æ–±–Ω–∏–∫–∏ –ø–æ–¥—ñ–π
            notification.querySelector('.install-now-btn').addEventListener('click', () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                }
                closeNotification();
            });
            
            notification.querySelector('.close-notification').addEventListener('click', closeNotification);
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø—Ä–∏—Ö–æ–≤—É—î–º–æ —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥
            setTimeout(closeNotification, 10000);
            
            function closeNotification() {
                notification.style.animation = 'slideInDown 0.3s ease-out reverse';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                    if (notificationStyles.parentNode) {
                        notificationStyles.parentNode.removeChild(notificationStyles);
                    }
                }, 300);
                localStorage.setItem('installNotificationShown', 'true');
            }
        }

        // PWA Install Button Click
        document.getElementById('pwaInstall').addEventListener('click', async () => {
            if (deferredPrompt) {
                // –ü–µ—Ä–µ–¥ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è–º –ø–µ—Ä–µ–∫–æ–Ω—É—î–º–æ—Å—è, —â–æ client ID –∑–±–µ—Ä–µ–∂–µ–Ω–æ
                const currentId = new URLSearchParams(window.location.search).get('id');
                if (currentId) {
                    localStorage.setItem('client_id', currentId);
                    console.log('Client ID –∑–±–µ—Ä–µ–∂–µ–Ω–æ –ø–µ—Ä–µ–¥ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è–º PWA:', currentId);
                }
                
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    console.log('User accepted the install prompt');
                    document.getElementById('pwaInstall').classList.remove('show');
                    
                    // –ü–æ–∫–∞–∑—É—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ —É—Å–ø—ñ—à–Ω–µ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è client ID
                    if (currentId) {
                        setTimeout(() => {
                            alert('–î–æ–¥–∞—Ç–æ–∫ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ! –í–∞—à –∫–ª—ñ—î–Ω—Ç—Å—å–∫–∏–π —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä –∑–±–µ—Ä–µ–∂–µ–Ω–æ –¥–ª—è –º–∞–π–±—É—Ç–Ω—ñ—Ö –∑–∞–ø—É—Å–∫—ñ–≤.');
                        }, 1000);
                    }
                }
                deferredPrompt = null;
            }
        });

        // –ü—Ä–∏—Ö–æ–≤—É—î–º–æ –∫–Ω–æ–ø–∫—É PWA —è–∫—â–æ –¥–æ–¥–∞—Ç–æ–∫ –≤–∂–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–π
        window.addEventListener('appinstalled', () => {
            document.getElementById('pwaInstall').classList.remove('show');
        });

        // Splash Screen —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è
        function hideSplashScreen() {
            const splash = document.getElementById('splashScreen');
            splash.classList.add('hidden');
            setTimeout(() => {
                splash.style.display = 'none';
            }, 500);
        }

        // Mobile touch improvements
        function addMobileTouchSupport() {
            // –í—ñ–¥–∫–ª—é—á–∞—î–º–æ zoom –Ω–∞ double tap –¥–ª—è iOS
            let lastTouchEnd = 0;
            document.addEventListener('touchend', function (event) {
                const now = (new Date()).getTime();
                if (now - lastTouchEnd <= 300) {
                    event.preventDefault();
                }
                lastTouchEnd = now;
            }, false);

            // –ü–æ–∫—Ä–∞—â—É—î–º–æ touch scrolling
            document.addEventListener('touchmove', function(e) {
                e.preventDefault();
            }, { passive: false });

            // –î–æ–¥–∞—î–º–æ haptic feedback –¥–ª—è iOS
            function hapticFeedback(type = 'light') {
                safeVibrate(50);
                if (window.DeviceMotionEvent && typeof DeviceMotionEvent.requestPermission === 'function') {
                    // iOS haptic feedback
                    try {
                        safeVibrate(type === 'light' ? 25 : 50);
                    } catch (e) {
                        console.log('Haptic feedback not supported');
                    }
                }
            }

            // –î–æ–¥–∞—î–º–æ haptic feedback –¥–æ –∫–Ω–æ–ø–æ–∫
            document.querySelectorAll('.btn, .leaflet-bar a, .mobile-menu-item').forEach(button => {
                button.addEventListener('touchstart', () => hapticFeedback('light'), { passive: true });
            });
        }

        // –ì–ª–æ–±–∞–ª—å–Ω—ñ –∑–º—ñ–Ω–Ω—ñ
        let selectedFeatures = new Set();
        let isCtrlPressed = false;
        let map, layersControl, searchControl, fieldLayer;
        let overlays = {};
        let tenantColors = {};
        let tenantAreas = {};
        let freeLayer;
        let freeArea = 0;
        let originalGeoJsonData;
        let baseMaps = {};
        let cadastralModal;
        let ownMarkersLayer, othersMarkersLayer;
        let editableLayers;
        let selectedFile = ''; // –î–æ–¥–∞—î–º–æ –≥–ª–æ–±–∞–ª—å–Ω—É –∑–º—ñ–Ω–Ω—É –¥–ª—è –≤–∏–±—Ä–∞–Ω–æ–≥–æ —Ñ–∞–π–ª—É
        let locateControl; // –î–æ–¥–∞—î–º–æ –≥–ª–æ–±–∞–ª—å–Ω—É –∑–º—ñ–Ω–Ω—É –¥–ª—è locate control

        // –ü—Ä–µ–¥–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ —Ü–≤–µ—Ç–∞ –¥–ª—è –æ—Ä–µ–Ω–¥–∞—Ä—ñ–≤
        const predefinedColors = [
            "#E44754", "#1B9688", "#ff9947", "#FAC1FA", "#9BBFF8",
            "#95F1FA", "#C6F8BD", "#F7FAB2", "#FFD7A6", "#FDABAB",
            "#A569BD", "#FF5733", "#4A235A", "#7DCEA0", "#E74C3C",
            "#F5B041", "#2471A3", "#AF7AC5", "#58D68D", "#5DADE2"
        ];
        let colorIndex = 0;

        // –†–µ–∂–∏–º –Ω–∞–ª–∞–≥–æ–¥–∂–µ–Ω–Ω—è –¥–ª—è –º–æ–±—ñ–ª—å–Ω–∏—Ö —à–∞—Ä—ñ–≤
        const DEBUG_MOBILE_LAYERS = false; // –≤—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å –≤ true –¥–ª—è –Ω–∞–ª–∞–≥–æ–¥–∂–µ–Ω–Ω—è
        
        function debugLog(...args) {
            if (DEBUG_MOBILE_LAYERS) {
                console.log(...args);
            }
        }

        // –§—É–Ω–∫—Ü—ñ—ó –¥–ª—è —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—ó –¥–∞–Ω–∏—Ö –∑–∞ —Ä–æ–∫–∞–º–∏ (–≤–∏–∑–Ω–∞—á–∞—î–º–æ –≥–ª–æ–±–∞–ª—å–Ω–æ)
        function filterByExpiryYear(feature, selectedYear) {
            if (selectedYear === '') return true; // –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –∑–∞–ø–∏—Å–∏
            if (selectedYear === 'no_date') {
                // –ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–∏ –±–µ–∑ –¥–∞—Ç—ã
                return !feature.properties?.['–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è'];
            }
            if (feature.properties?.['–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è']) {
                const dateStr = feature.properties['–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è'];
                const year = dateStr.split('.')[2];
                return year === selectedYear;
            }
            return false;
        }
        
        function filterByRegistrationYear(feature, selectedYear) {
            if (selectedYear === '') return true; // –ü–æ–∫–∞–∑–∞—Ç–∏ –≤—Å—ñ –∑–∞–ø–∏—Å–∏
            if (selectedYear === 'no_date') {
                // –ü–æ–∫–∞–∑–∞—Ç–∏ —Ç—ñ–ª—å–∫–∏ –∑–∞–ø–∏—Å–∏ –±–µ–∑ –¥–∞—Ç–∏
                return !feature.properties?.['–î–∞—Ç–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –æ—Ä–µ–Ω–¥–∏'];
            }
            if (feature.properties?.['–î–∞—Ç–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –æ—Ä–µ–Ω–¥–∏']) {
                const dateStr = feature.properties['–î–∞—Ç–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –æ—Ä–µ–Ω–¥–∏'];
                const year = dateStr.split('.')[2];
                return year === selectedYear;
            }
            return false;
        }

        // –§—É–Ω–∫—Ü—ñ—ó –¥–ª—è —Å—Ç–∏–ª—ñ–∑–∞—Ü—ñ—ó —à–∞—Ä—ñ–≤
        function styleFeature(feature) {
            // –î–ª—è split –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ä–µ–Ω–¥–∞—Ä—è —á–∞—Å—Ç–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
            const tenant = feature.properties["–û—Ä–µ–Ω–¥–∞—Ä —á–∞—Å—Ç–∏–Ω–∏"] || feature.properties["–û—Ä–µ–Ω–¥–∞—Ä"];
            return {
                color: getColor(tenant),
                weight: 0.5,
                opacity: 1,
                fillOpacity: 0.4
            };
        }

        function getColor(tenant) {
            if (!tenant) return "#ffffff";
            if (!tenantColors[tenant]) {
                tenantColors[tenant] = predefinedColors[colorIndex % predefinedColors.length];
                colorIndex++;
                
                // –õ–æ–≥—É—î–º–æ –¥–ª—è –Ω–∞–ª–∞–≥–æ–¥–∂–µ–Ω–Ω—è
                debugLog('Assigned color', tenantColors[tenant], 'to tenant', tenant);
            }
            return tenantColors[tenant];
        }

        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –æ—á–∏—â–µ–Ω–Ω—è —à–∞—Ä—ñ–≤
        function clearOverlays() {
            // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –±–∞–∑–æ–≤—ñ —à–∞—Ä–∏ —Ç–∞ –ø–æ–ª—è
            const baseAndFieldLayers = {};
            
            // –ö–æ–ø—ñ—é—î–º–æ –±–∞–∑–æ–≤—ñ —à–∞—Ä–∏ —Ç–∞ –ø–æ–ª—è
            Object.entries(overlays).forEach(([key, layer]) => {
                if (key === "Google Maps" || 
                    key === "OpenStreetMap" || 
                    key === "–ê–∫—Ç—É–∞–ª—å–Ω—ñ —Ä–∞—Å—Ç—Ä–∏" || 
                    key === "kadastr.live" || 
                    key === "–ü–æ–ª—è –æ–±—Ä–æ–±—ñ—Ç–∫—É") {
                    baseAndFieldLayers[key] = layer;
                } else {
                    // –í–∏–¥–∞–ª—è—î–º–æ –∑ –∫–∞—Ä—Ç–∏ —Ç—ñ–ª—å–∫–∏ —à–∞—Ä–∏ –∑ –¥–∞–Ω–∏–º–∏
                    map.removeLayer(layer);
                }
            });
            
            // –û—á–∏—â—É—î–º–æ overlays —ñ –≤—ñ–¥–Ω–æ–≤–ª—é—î–º–æ –±–∞–∑–æ–≤—ñ —à–∞—Ä–∏ —Ç–∞ –ø–æ–ª—è
            overlays = {...baseAndFieldLayers};
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è –≥–æ–ª–æ–≤–Ω–æ–≥–æ –º–µ–Ω—é –ø—ñ—Å–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ç–æ—Ä—ñ–Ω–∫–∏
        document.addEventListener('DOMContentLoaded', function() {
            // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ PWA —Ñ—É–Ω–∫—Ü—ñ—ó
            addMobileTouchSupport();
            
            // –û–±—Ä–æ–±–Ω–∏–∫ –∑–º—ñ–Ω–∏ —Ä–æ–∑–º—ñ—Ä—É –≤—ñ–∫–Ω–∞
            window.addEventListener('resize', function() {
                if (window.innerWidth > 768) {
                    // –î–µ—Å–∫—Ç–æ–ø–Ω–∏–π —Ä–µ–∂–∏–º - –ø—Ä–∏—Ö–æ–≤—É—î–º–æ –º–æ–±—ñ–ª—å–Ω—ñ –µ–ª–µ–º–µ–Ω—Ç–∏
                    document.getElementById('mobileLayersPanel').classList.remove('show');
                } else {
                    // –ú–æ–±—ñ–ª—å–Ω–∏–π —Ä–µ–∂–∏–º - —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ
                    if (!document.getElementById('mobileLayersBtn').hasAttribute('data-initialized')) {
                        initializeMobileMenu();
                        document.getElementById('mobileLayersBtn').setAttribute('data-initialized', 'true');
                    }
                }
            });
            
            // –ü—Ä–∏—Ö–æ–≤—É—î–º–æ splash screen –ø—ñ—Å–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
            setTimeout(() => {
                hideSplashScreen();
            }, 1500);

            // –ù–µ–≤–µ–ª–∏–∫–∞ –∑–∞—Ç—Ä–∏–º–∫–∞, —â–æ–± –¥–∞—Ç–∏ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ –ø–æ–≤–Ω—ñ—Å—Ç—é –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏—Å—å
            setTimeout(function() {
                const mainMenu = document.getElementById('mainMenu');
                if (mainMenu) {
                    const offcanvasMenu = new bootstrap.Offcanvas(mainMenu);
                    offcanvasMenu.show();
                }
            }, 500);
        });

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –∫–∞—Ä—Ç—ã —Å –≤–∏–¥–∏–º—ã—Ö —Å–ª–æ–µ–≤
        function collectMapData() {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–µ—Ç –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
            const uniqueProperties = new Set();
            const data = [];
            
            // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –≤–∏–¥–∏–º—ã–µ —Å–ª–æ–∏ —Ç–∏–ø–∞ split
            Object.values(overlays).forEach(layerGroup => {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —ç—Ç–æ —Å–ª–æ–π
                if (!layerGroup || typeof layerGroup.eachLayer !== 'function') return;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∏–¥–∏–º –ª–∏ —Å–ª–æ–π
                if (map.hasLayer(layerGroup)) {
                    
                    layerGroup.eachLayer(layer => {
                        if (layer.feature && layer.feature.properties) {
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø –æ–±—ä–µ–∫—Ç–∞
                            if (layer.feature.properties.type === 'split') {
                                // –°–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –¥–ª—è —Å–≤–æ–π—Å—Ç–≤
                                const kadNum = layer.feature.properties["–ö–∞–¥–∞—Å—Ç—Ä–æ–≤–∏–π –Ω–æ–º–µ—Ä"];
                                const tenant = layer.feature.properties["–û—Ä–µ–Ω–¥–∞—Ä —á–∞—Å—Ç–∏–Ω–∏"] || 
                                            layer.feature.properties["–û—Ä–µ–Ω–¥–∞—Ä"] || "";
                                const status = layer.feature.properties["–°—Ç–∞—Ç—É—Å"] || "";
                                
                                const propId = `${kadNum}_${tenant}_${status}`;
                                
                                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –¥–æ–±–∞–≤–ª—è–ª–∏ –ª–∏ –º—ã —É–∂–µ —ç—Ç–æ—Ç –æ–±—ä–µ–∫—Ç
                                if (!uniqueProperties.has(propId)) {
                                    uniqueProperties.add(propId);
                                    data.push(layer.feature.properties);
                                }
                            }
                        }
                    });
                }
            });
            
            return data;
        }

        // –û—Ç—Ä–∏–º–∞–Ω–Ω—è –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤ –∑ URL —ñ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –¥–ª—è PWA
        function getClientId() {
            const urlParams = new URLSearchParams(window.location.search);
            let id = urlParams.get('id');
            
            console.log('getClientId - URL id:', id);
            console.log('getClientId - current URL:', window.location.href);
            
            // –Ø–∫—â–æ id —î –≤ URL, –∑–±–µ—Ä—ñ–≥–∞—î–º–æ –π–æ–≥–æ –≤ localStorage –¥–ª—è PWA
            if (id) {
                try {
                    localStorage.setItem('client_id', id);
                    console.log('Client ID –∑–±–µ—Ä–µ–∂–µ–Ω–æ:', id);
                } catch (e) {
                    console.error('–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –≤ localStorage:', e);
                }
            } else {
                // –Ø–∫—â–æ id –Ω–µ–º–∞—î –≤ URL (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –ø—Ä–∏ –∑–∞–ø—É—Å–∫—É PWA), —Å–ø—Ä–æ–±—É—î–º–æ –æ—Ç—Ä–∏–º–∞—Ç–∏ –∑ localStorage
                try {
                    const storedId = localStorage.getItem('client_id');
                    console.log('getClientId - stored id:', storedId);
                    if (storedId) {
                        id = storedId;
                        console.log('Client ID –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–æ –∑ localStorage:', id);
                        
                        // –û–Ω–æ–≤–ª—é—î–º–æ URL –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ç–æ—Ä—ñ–Ω–∫–∏
                        try {
                            const currentUrl = new URL(window.location);
                            currentUrl.searchParams.set('id', id);
                            window.history.replaceState({}, '', currentUrl);
                            console.log('URL –æ–Ω–æ–≤–ª–µ–Ω–æ:', currentUrl.href);
                        } catch (urlError) {
                            console.error('–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è URL:', urlError);
                        }
                    }
                } catch (e) {
                    console.error('–ü–æ–º–∏–ª–∫–∞ —á–∏—Ç–∞–Ω–Ω—è –∑ localStorage:', e);
                }
            }
            
            console.log('getClientId - final id:', id);
            return id;
        }

        // –°–ø–µ—Ü—ñ–∞–ª—å–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è –¥–ª—è iOS PWA –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—è
        function ensureIOSPWARedirect() {
            const isIOSSafari = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            const isIOSPWA = isIOSSafari && window.navigator.standalone === true;
            
            if (!isIOSPWA) return false;
            
            console.log('üçé iOS PWA detected - ensuring client ID redirect');
            
            const currentParams = new URLSearchParams(window.location.search);
            const currentId = currentParams.get('id');
            const storedId = localStorage.getItem('client_id');
            
            console.log('üîç iOS Check:', { currentId, storedId, currentURL: window.location.href });
            
            if (storedId && !currentId) {
                console.log('üîÑ iOS PWA: Performing redirect to:', storedId);
                
                // –î–ª—è iOS –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –Ω–∞–π–±—ñ–ª—å—à –Ω–∞–¥—ñ–π–Ω–∏–π –º–µ—Ç–æ–¥
                const targetUrl = `${window.location.origin}${window.location.pathname}?id=${encodeURIComponent(storedId)}`;
                console.log('‚û°Ô∏è iOS PWA: Redirecting to:', targetUrl);
                
                // –°–ø–æ—á–∞—Ç–∫—É –Ω–∞–º–∞–≥–∞—î–º–æ—Å—è –æ–Ω–æ–≤–∏—Ç–∏ localStorage –∑ –Ω–æ–≤–∏–º —á–∞—Å–æ–º
                try {
                    localStorage.setItem('client_id', storedId);
                    localStorage.setItem('last_ios_redirect', Date.now().toString());
                } catch (e) {
                    console.error('localStorage error:', e);
                }
                
                // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—è
                window.location.href = targetUrl;
                return true;
            }
            
            return false;
        }

        // –ü–æ–∫–∞–∑–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –∑–±–µ—Ä–µ–∂–µ–Ω–∏–π client ID –ø—Ä–∏ –∑–∞–ø—É—Å–∫—É PWA
        function showClientIdInfo() {
            const storedId = localStorage.getItem('client_id');
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const isPWA = window.matchMedia('(display-mode: standalone)').matches || 
                         window.navigator.standalone === true; // iOS specific
            
            console.log('showClientIdInfo - storedId:', storedId);
            console.log('showClientIdInfo - isIOS:', isIOS);
            console.log('showClientIdInfo - isPWA:', isPWA);
            
            if (storedId && isPWA) {
                // –ü–æ–∫–∞–∑—É—î–º–æ –∫–Ω–æ–ø–∫—É —Å–∫–∏–¥–∞–Ω–Ω—è client ID
                const resetButton = document.getElementById('resetClientIdButton');
                if (resetButton) {
                    resetButton.style.display = 'block';
                }
                
                // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –Ω–µ –ø–æ–∫–∞–∑—É–≤–∞–ª–∏ —Ü–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —Å—å–æ–≥–æ–¥–Ω—ñ
                const today = new Date().toDateString();
                const lastShown = localStorage.getItem('clientIdInfoShown');
                
                if (lastShown !== today) {
                    setTimeout(() => {
                        const toast = document.createElement('div');
                        toast.className = 'position-fixed top-0 start-50 translate-middle-x mt-3';
                        toast.style.zIndex = '9999';
                        toast.innerHTML = `
                            <div class="alert alert-success alert-dismissible fade show" role="alert">
                                <i class="bi bi-check-circle me-2"></i>
                                <strong>–ö–ª—ñ—î–Ω—Ç—Å—å–∫–∏–π ID –∞–∫—Ç–∏–≤–Ω–∏–π:</strong> ${storedId}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        `;
                        document.body.appendChild(toast);
                        
                        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø—Ä–∏—Ö–æ–≤–∞—Ç–∏ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
                        setTimeout(() => {
                            if (toast.parentNode) {
                                toast.remove();
                            }
                        }, 5000);
                        
                        try {
                            localStorage.setItem('clientIdInfoShown', today);
                        } catch (e) {
                            console.error('Error saving to localStorage:', e);
                        }
                    }, 2000);
                }
            }
        }

        // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —Ñ—É–Ω–∫—Ü—ñ—é –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è client ID
        const id = getClientId();
        const dataPath = id ? `data/${id}/` : 'data/';
        
        console.log('Final initialization - id:', id);
        console.log('Final initialization - dataPath:', dataPath);
        console.log('User agent:', navigator.userAgent);
        console.log('Is iOS:', /iPad|iPhone|iPod/.test(navigator.userAgent));
        console.log('Is PWA:', window.matchMedia('(display-mode: standalone)').matches);
        
        // –ü–æ–∫–∞–∑—É—î–º–æ –¥–µ–±–∞–≥ –∫–Ω–æ–ø–∫—É –¥–ª—è iOS –∞–±–æ PWA
        if (/iPad|iPhone|iPod/.test(navigator.userAgent) || window.matchMedia('(display-mode: standalone)').matches) {
            const debugButton = document.getElementById('debugButton');
            if (debugButton) {
                debugButton.style.display = 'block';
            }
        }
        
        // –ü–æ–∫–∞–∑—É—î–º–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ client ID —è–∫—â–æ PWA
        showClientIdInfo();
        // –ñ–¥–µ–º –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏ –≤—Å–µ—Ö —Å–∫—Ä–∏–ø—Ç–æ–≤
        document.addEventListener('DOMContentLoaded', function() {
            // –î–æ–¥–∞—Ç–∫–æ–≤–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥–ª—è iOS PWA –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ DOM
            setTimeout(function() {
                const isIOSSafari = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
                const isIOSPWA = isIOSSafari && window.navigator.standalone === true;
                
                if (isIOSPWA) {
                    console.log('üçé iOS PWA detected on DOM ready, checking redirect...');
                    
                    const currentParams = new URLSearchParams(window.location.search);
                    const currentId = currentParams.get('id');
                    const storedId = localStorage.getItem('client_id');
                    
                    if (storedId && !currentId) {
                        console.log('üîÑ iOS PWA: Redirecting to client ID:', storedId);
                        const newUrl = new URL(window.location);
                        newUrl.searchParams.set('id', storedId);
                        window.location.href = newUrl.href;
                        return;
                    }
                }
            }, 100); // –ù–µ–≤–µ–ª–∏–∫–∞ –∑–∞—Ç—Ä–∏–º–∫–∞ –¥–ª—è —É–ø–µ–≤–Ω–µ–Ω–æ—Å—Ç—ñ
            
            // –î–æ–¥–∞—Ç–∏ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –∫–ª–∞–≤—ñ—à —Ç—É—Ç, –Ω–∞ –≤–µ—Ä—Ö–Ω—å–æ–º—É —Ä—ñ–≤–Ω—ñ
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Control') {
                    isCtrlPressed = true;
                }
            });
            
            document.addEventListener('keyup', function(e) {
                if (e.key === 'Control') {
                    isCtrlPressed = false;
                }
            });

            initializeMap();
            initializeMobileMenu();
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
            cadastralModal = document.getElementById("cadastralModal");
            const closeBtn = document.getElementsByClassName("close")[0];
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ –º–µ–Ω—é
            document.getElementById('cadastralSearchButton').addEventListener('click', function() {
                // –ó–∞–∫—Ä–∏–≤–∞—î–º–æ –±–æ–∫–æ–≤—É –ø–∞–Ω–µ–ª—å
                var offcanvas = bootstrap.Offcanvas.getInstance(document.getElementById('mainMenu'));
                offcanvas.hide();
                // –ü—ñ—Å–ª—è –Ω–µ–≤–µ–ª–∏–∫–æ—ó –∑–∞—Ç—Ä–∏–º–∫–∏ –ø–æ–∫–∞–∑—É—î–º–æ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ
                setTimeout(() => {
                    clearCadastralLists();
                    cadastralModal.style.display = "block";
                }, 300); // –ó–∞—Ç—Ä–∏–º–∫–∞ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –∞–Ω—ñ–º–∞—Ü—ñ—ó –∑–∞–∫—Ä–∏—Ç—Ç—è –±–æ–∫–æ–≤–æ—ó –ø–∞–Ω–µ–ª—ñ
            });
                
            document.getElementById('statisticsButton').addEventListener('click', function() {
                var selectedFile = document.getElementById('fileSelect').value;
                if (selectedFile && selectedFile !== '–í–∏–±–µ—Ä—ñ—Ç—å —Ä–∞–¥—É') {
                    // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –≥–ª–æ–±–∞–ª—å–Ω—É –∑–º—ñ–Ω–Ω—É id, —è–∫–∞ –≤–∂–µ –≤—Ä–∞—Ö–æ–≤—É—î localStorage
                    const statisticsUrl = `statistics.html?file=${encodeURIComponent(selectedFile)}${id ? `&id=${id}` : ''}`;
                    window.location.href = statisticsUrl;
                } else {
                    alert('–ë—É–¥—å –ª–∞—Å–∫–∞, —Å–ø–æ—á–∞—Ç–∫—É –≤–∏–±–µ—Ä—ñ—Ç—å —Ñ–∞–π–ª –∑ –¥–∞–Ω–∏–º–∏.');
                }
            });
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
            closeBtn.onclick = function() {
                cadastralModal.style.display = "none";
                clearCadastralLists();
            }
            window.onclick = function(event) {
                if (event.target == cadastralModal) {
                    cadastralModal.style.display = "none";
                    clearCadastralLists();
                }
            }

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–∏—Å–∫–∞ –∫–∞–¥–∞—Å—Ç—Ä–æ–≤—ã—Ö –Ω–æ–º–µ—Ä–æ–≤
            document.getElementById('searchCadastral').addEventListener('click', searchCadastralNumbers);
            // –£–¥–∞–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –Ω–∞–≤–±–∞—Ä –ø–æ–∏—Å–∫–∞
            // document.getElementById('navbarCadastralSearchButton').addEventListener('click', function() {
            //     searchNavbarCadastralNumber();
            // });
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–∏—Å–∫–∞ –∫–∞–¥–∞—Å—Ç—Ä–æ–≤—ã—Ö –Ω–æ–º–µ—Ä–æ–≤
            // document.getElementById('navbarCombined
            //     .addEventListener('click', function() {
            //         searchNavbarCombined();
            //     });

            // –î–æ–±–∞–≤–ª—è–µ–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞ —Ä–∞–¥–∏
            const urlParams = new URLSearchParams(window.location.search);
            const returnFile = urlParams.get('return_file');
            if (returnFile) {
                // –î–æ–∂–∏–¥–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤ –∏ –≤—ã–±–∏—Ä–∞–µ–º –Ω—É–∂–Ω—ã–π
                const checkSelect = setInterval(() => {
                    const select = document.getElementById('fileSelect');
                    const option = Array.from(select.options).find(opt => opt.value === returnFile);
                    if (option) {
                        clearInterval(checkSelect);
                        select.value = returnFile;
                        select.dispatchEvent(new Event('change'));
                    }
                }, 100);
            }       

            // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞ –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ freshness
            document.getElementById('freshnessButton').addEventListener('click', function() {
                // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –≥–ª–æ–±–∞–ª—å–Ω—É –∑–º—ñ–Ω–Ω—É id, —è–∫–∞ –≤–∂–µ –≤—Ä–∞—Ö–æ–≤—É—î localStorage
                const selectedFile = document.getElementById('fileSelect').value;
                
                let freshnessUrl = `freshness.html`;
                if (id) freshnessUrl += `?id=${id}`;
                if (selectedFile && selectedFile !== '–í–∏–±–µ—Ä—ñ—Ç—å —Ä–∞–¥—É') {
                    freshnessUrl += id ? '&' : '?';
                    freshnessUrl += `file=${encodeURIComponent(selectedFile)}`;
                }
                window.location.href = freshnessUrl;
            });

            function searchCadastralNumbers() {
                var ownCadastralText = document.getElementById("ownCadastralList").value;
                var othersCadastralText = document.getElementById("othersCadastralList").value;
                
                if (!ownCadastralText && !othersCadastralText) {
                    alert('–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å —Ö–æ—á–∞ –± –æ–¥–∏–Ω –∫–∞–¥–∞—Å—Ç—Ä–æ–≤–∏–π –Ω–æ–º–µ—Ä');
                    return;
                }

                var ownNumbers = ownCadastralText.split('\n')
                    .map(num => num.trim())
                    .filter(num => num.length > 0);
                var othersNumbers = othersCadastralText.split('\n')
                    .map(num => num.trim())
                    .filter(num => num.length > 0);

                // –û—á–∏—â–∞—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ –º–∞—Ä–∫–µ—Ä–∏
                ownMarkersLayer.clearLayers();
                othersMarkersLayer.clearLayers();
                
                var foundFeatures = new Map();
                
                Object.values(overlays).forEach(layerGroup => {
                    if (layerGroup && typeof layerGroup.eachLayer === 'function') {
                        layerGroup.eachLayer(layer => {
                            if (layer.feature && layer.feature.properties) {
                                const kadNum = layer.feature.properties["–ö–∞–¥–∞—Å—Ç—Ä–æ–≤–∏–π –Ω–æ–º–µ—Ä"];
                                if (kadNum) {
                                    const isOwn = ownNumbers.includes(kadNum);
                                    const isOthers = othersNumbers.includes(kadNum);
                                    
                                    if (isOwn || isOthers) {
                                        foundFeatures.set(kadNum, layer);
                                        
                                        // –î–æ–¥–∞—î–º–æ –º–∞—Ä–∫–µ—Ä –¥–ª—è –∑–Ω–∞–π–¥–µ–Ω–æ—ó –¥—ñ–ª—è–Ω–∫–∏
                                        // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –¥–æ–ø–æ–º—ñ–∂–Ω—É —Ñ—É–Ω–∫—Ü—ñ—é –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Ü–µ–Ω—Ç—Ä–∞
                                        var center = getPolygonCenter(layer);
                                        var marker = createMarker(center, kadNum, isOwn);
                                        
                                        // –î–æ–¥–∞—î–º–æ –ø–æ–ø–∞–ø
                                        marker.bindPopup(`–ö–∞–¥–∞—Å—Ç—Ä–æ–≤–∏–π –Ω–æ–º–µ—Ä: ${kadNum}`, {
                                            offset: [0, -20]
                                        });
                                        
                                        marker.addTo(isOwn ? ownMarkersLayer : othersMarkersLayer);
                                    }
                                }
                            }
                        });
                    }                     
                });

                if (foundFeatures.size > 0) {
                // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ —î –º–∞—Ä–∫–µ—Ä–∏ –≤ —à–∞—Ä–∞—Ö –ø–µ—Ä–µ–¥ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è–º –≥—Ä—É–ø–∏ —ñ –≤–∏–∫–ª–∏–∫–æ–º getBounds()
                if (ownMarkersLayer.getLayers().length > 0 || othersMarkersLayer.getLayers().length > 0) {
                    var group = L.featureGroup([ownMarkersLayer, othersMarkersLayer]);
                    map.fitBounds(group.getBounds(), {
                        padding: [50, 50]
                    });
                }
                
                alert(`–ó–Ω–∞–π–¥–µ–Ω–æ ${foundFeatures.size} –¥—ñ–ª—è–Ω–æ–∫`);
                cadastralModal.style.display = "none";
                clearCadastralLists();
            } else {
                    alert('–î—ñ–ª—è–Ω–æ–∫ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');
                }     
            }
        });

        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –º–æ–±—ñ–ª—å–Ω–æ–≥–æ –º–µ–Ω—é
        function initializeMobileMenu() {
            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —Ü–µ –º–æ–±—ñ–ª—å–Ω–∏–π –ø—Ä–∏—Å—Ç—Ä—ñ–π
            if (window.innerWidth <= 768) {
                // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –ø–æ–¥—ñ–π –¥–ª—è –º–æ–±—ñ–ª—å–Ω–æ–≥–æ –º–µ–Ω—é
                
                // –ö–Ω–æ–ø–∫–∞ —à–∞—Ä—ñ–≤
                document.getElementById('mobileLayersBtn').addEventListener('click', function() {
                    toggleMobileLayersPanel();
                });
                
                // –ö–Ω–æ–ø–∫–∞ –ø–æ—à—É–∫—É  
                document.getElementById('mobileSearchBtn').addEventListener('click', function() {
                    // –ê–∫—Ç–∏–≤—É—î–º–æ –∫–∞—Ä—Ç–æ—á–Ω–∏–π –ø–æ—à—É–∫ –∑–∞–º—ñ—Å—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞
                    activateSearch();
                });
                
                // –ö–Ω–æ–ø–∫–∞ –ª–æ–∫–∞—Ü—ñ—ó
                document.getElementById('mobileLocationBtn').addEventListener('click', function() {
                    const btn = this;
                    
                    // –í—ñ–¥—Å—Ç–µ–∂—É—î–º–æ —á–∞—Å –∑–∞–ø–∏—Ç—É –¥–ª—è –ø–æ–∫–∞–∑—É –ø–æ–º–∏–ª–æ–∫
                    window.lastLocationRequestTime = Date.now();
                    
                    // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —Ç–æ–π —Å–∞–º–∏–π locate control —â–æ –π –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø—ñ
                    if (locateControl) {
                        // –Ø–∫—â–æ locate control –≤–∂–µ –∞–∫—Ç–∏–≤–Ω–∏–π, –∑—É–ø–∏–Ω—è—î–º–æ –π–æ–≥–æ
                        if (locateControl._active) {
                            locateControl.stop();
                            btn.classList.remove('locating', 'located');
                        } else {
                            // –Ü–Ω–∞–∫—à–µ –∑–∞–ø—É—Å–∫–∞—î–º–æ –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—é
                            btn.classList.add('locating');
                            btn.classList.remove('located');
                            locateControl.start();
                        }
                    } else if (map && map.locate) {
                        // Fallback –¥–æ –ø—Ä–æ—Å—Ç–æ—ó –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—ó —è–∫—â–æ locate control –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π
                        btn.classList.add('locating');
                        btn.classList.remove('located');
                        
                        map.locate({
                            setView: true, 
                            maxZoom: 20,
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 0
                        });
                        
                        // –û–±—Ä–æ–±–Ω–∏–∫–∏ –¥–ª—è –ø—Ä–æ—Å—Ç–æ—ó –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—ó
                        map.once('locationfound', function() {
                            btn.classList.remove('locating');
                            btn.classList.add('located');
                            setTimeout(() => {
                                btn.classList.remove('located');
                            }, 3000);
                        });
                        
                        map.once('locationerror', function() {
                            btn.classList.remove('locating', 'located');
                        });
                    }
                });
                
                // –ö–Ω–æ–ø–∫–∞ –º–µ–Ω—é
                document.getElementById('mobileMenuBtn').addEventListener('click', function() {
                    // Haptic feedback
                    safeVibrate(50);
                    
                    // –í—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ –±–æ–∫–æ–≤–µ –º–µ–Ω—é
                    const mainMenu = document.getElementById('mainMenu');
                    const offcanvasMenu = new bootstrap.Offcanvas(mainMenu);
                    offcanvasMenu.show();
                });
                
                // –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä–∏—Ç—Ç—è –ø–∞–Ω–µ–ª—ñ —à–∞—Ä—ñ–≤
                document.getElementById('closeMobileLayersBtn').addEventListener('click', function() {
                    document.getElementById('mobileLayersPanel').classList.remove('show');
                });
                
                // –ó–∞–∫—Ä–∏—Ç—Ç—è –ø–∞–Ω–µ–ª—ñ —à–∞—Ä—ñ–≤ –ø—Ä–∏ –∫–ª—ñ–∫—É –ø–æ–∑–∞ –Ω–µ—é
                document.addEventListener('click', function(e) {
                    const panel = document.getElementById('mobileLayersPanel');
                    const button = document.getElementById('mobileLayersBtn');
                    if (!panel.contains(e.target) && !button.contains(e.target)) {
                        panel.classList.remove('show');
                    }
                });
                
                // –û–Ω–æ–≤–ª—é—î–º–æ –º–æ–±—ñ–ª—å–Ω—ñ —à–∞—Ä–∏ –ø—Ä–∏ –∑–º—ñ–Ω—ñ layers control
                updateMobileLayers();
            }
        }
        
        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü—ñ—ó –ø–æ—à—É–∫—É
        function activateSearch() {
            if (searchControl && searchControl._layer) {
                // –ù–∞ –¥–µ—Å–∫—Ç–æ–ø—ñ –ø—Ä–æ—Å—Ç–æ —Ñ–æ–∫—É—Å—É—î–º–æ
                if (window.innerWidth > 768) {
                    if (searchControl._input) {
                        searchControl._input.focus();
                        if (searchControl._container && searchControl._container.classList) {
                            searchControl._container.classList.add('search-exp');
                        }
                    }
                    return;
                }
                
                // –ù–∞ –º–æ–±—ñ–ª—å–Ω–æ–º—É —Å—Ç–≤–æ—Ä—é—î–º–æ –≤–ª–∞—Å–Ω–∏–π —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                if (window.innerWidth <= 768) {
                    // –°—Ç–≤–æ—Ä—é—î–º–æ overlay –¥–ª—è –º–æ–±—ñ–ª—å–Ω–æ–≥–æ –ø–æ—à—É–∫—É
                    const overlay = document.createElement('div');
                    overlay.className = 'mobile-search-overlay';
                    overlay.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0,0,0,0.5);
                        z-index: 10000;
                        display: flex;
                        align-items: flex-start;
                        justify-content: center;
                        padding: 20px;
                        padding-top: calc(60px + env(safe-area-inset-top));
                    `;
                    
                    // –°—Ç–≤–æ—Ä—é—î–º–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ø–æ—à—É–∫—É
                    const searchContainer = document.createElement('div');
                    searchContainer.style.cssText = `
                        background: white;
                        border-radius: 12px;
                        box-shadow: 0 8px 30px rgba(0,0,0,0.3);
                        width: 100%;
                        max-width: 400px;
                        overflow: hidden;
                    `;
                    
                    // –°—Ç–≤–æ—Ä—é—î–º–æ –ø–æ–ª–µ –≤–≤–æ–¥—É
                    const searchInput = document.createElement('input');
                    searchInput.type = 'text';
                    searchInput.placeholder = '–ü–æ—à—É–∫ –∑–∞ –∫–∞–¥–∞—Å—Ç—Ä–æ–≤–∏–º –Ω–æ–º–µ—Ä–æ–º –∞–±–æ –≤–ª–∞—Å–Ω–∏–∫–æ–º';
                    searchInput.style.cssText = `
                        font-size: 16px;
                        padding: 15px 20px;
                        border: none;
                        border-radius: 12px;
                        width: 100%;
                        box-sizing: border-box;
                        background: white;
                        color: #333;
                        outline: none;
                    `;
                    
                    // –°—Ç–≤–æ—Ä—é—î–º–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤
                    const resultsContainer = document.createElement('div');
                    resultsContainer.style.cssText = `
                        max-height: 250px;
                        overflow-y: auto;
                        border-top: 1px solid #eee;
                        display: none;
                    `;
                    
                    searchContainer.appendChild(searchInput);
                    searchContainer.appendChild(resultsContainer);
                    overlay.appendChild(searchContainer);
                    
                    // –ó–∞–∫—Ä–∏—Ç—Ç—è –ø–æ –∫–ª—ñ–∫—É –Ω–∞ overlay
                    overlay.addEventListener('click', function(e) {
                        if (e.target === overlay) {
                            closeMobileSearch();
                        }
                    });
                    
                    // ESC –¥–ª—è –∑–∞–∫—Ä–∏—Ç—Ç—è
                    const escHandler = function(e) {
                        if (e.key === 'Escape') {
                            closeMobileSearch();
                            document.removeEventListener('keydown', escHandler);
                        }
                    };
                    document.addEventListener('keydown', escHandler);
                    
                    // –ü–æ—à—É–∫ –ø—Ä–∏ –≤–≤–µ–¥–µ–Ω–Ω—ñ —Ç–µ–∫—Å—Ç—É
                    let searchTimeout;
                    searchInput.addEventListener('input', function() {
                        clearTimeout(searchTimeout);
                        const query = this.value.trim();
                        
                        if (query.length < 2) {
                            resultsContainer.style.display = 'none';
                            return;
                        }
                        
                        searchTimeout = setTimeout(() => {
                            performMobileSearch(query, resultsContainer);
                        }, 300);
                    });
                    
                    // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –ø–æ—Å–∏–ª–∞–Ω–Ω—è
                    window.mobileSearchOverlay = overlay;
                    window.mobileSearchEscHandler = escHandler;
                    
                    // –î–æ–¥–∞—î–º–æ –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω–∫—É
                    document.body.appendChild(overlay);
                    
                    // –§–æ–∫—É—Å—É—î–º–æ –ø—ñ—Å–ª—è –∫–æ—Ä–æ—Ç–∫–æ—ó –∑–∞—Ç—Ä–∏–º–∫–∏
                    setTimeout(() => {
                        searchInput.focus();
                        // Haptic feedback
                        safeVibrate(50);
                    }, 100);
                }
            } else {
                // –Ø–∫—â–æ search control —â–µ –Ω–µ —Å—Ç–≤–æ—Ä–µ–Ω–∏–π, –ø–æ–∫–∞–∑—É—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
                alert('–ü–æ—à—É–∫ –±—É–¥–µ –¥–æ—Å—Ç—É–ø–Ω–∏–π –ø—ñ—Å–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö –∫–∞—Ä—Ç–∏');
            }
        }
        
        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –∑–∞–∫—Ä–∏—Ç—Ç—è –º–æ–±—ñ–ª—å–Ω–æ–≥–æ –ø–æ—à—É–∫—É
        function closeMobileSearch() {
            if (window.mobileSearchOverlay) {
                // –í–∏–¥–∞–ª—è—î–º–æ overlay
                document.body.removeChild(window.mobileSearchOverlay);
                window.mobileSearchOverlay = null;
                
                // –í–∏–¥–∞–ª—è—î–º–æ ESC handler
                if (window.mobileSearchEscHandler) {
                    document.removeEventListener('keydown', window.mobileSearchEscHandler);
                    window.mobileSearchEscHandler = null;
                }
            }
            
            // –ù–ï –≤–∏–¥–∞–ª—è—î–º–æ –ø—ñ–¥—Å–≤—ñ—á—É–≤–∞–Ω–Ω—è –ø–æ—à—É–∫—É —Ç—É—Ç - –≤–æ–Ω–æ –º–∞—î –∑–∞–ª–∏—à–∞—Ç–∏—Å—è —è–∫ —É –¥–µ—Å–∫—Ç–æ–ø–Ω—ñ–π –≤–µ—Ä—Å—ñ—ó
            // –ü—ñ–¥—Å–≤—ñ—á—É–≤–∞–Ω–Ω—è –±—É–¥–µ –≤–∏–¥–∞–ª–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —á–µ—Ä–µ–∑ —Ç–∞–π–º–µ—Ä –∞–±–æ –ø—Ä–∏ –Ω–æ–≤–æ–º—É –ø–æ—à—É–∫—É
        }
        
        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –ø–æ—à—É–∫—É –Ω–∞ –º–æ–±—ñ–ª—å–Ω–æ–º—É
        function performMobileSearch(query, resultsContainer) {
            resultsContainer.innerHTML = '';
            resultsContainer.style.display = 'none';
            
            if (!searchControl || !searchControl._layer) {
                return;
            }
            
            const results = [];
            
            // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –ª–æ–≥—ñ–∫—É –∑ searchControl
            searchControl._layer.eachLayer(function(layer) {
                if (layer.feature?.properties) {
                    const props = layer.feature.properties;
                    const kadastrovyNomer = props['–ö–∞–¥–∞—Å—Ç—Ä–æ–≤–∏–π –Ω–æ–º–µ—Ä'] || '';
                    const vlasnyk = props['–í–ª–∞—Å–Ω–∏–∫'] || '';
                    
                    const text = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                    const reg = new RegExp(text, 'i');
                    
                    if (reg.test(kadastrovyNomer) || reg.test(vlasnyk)) {
                        results.push({
                            layer: layer,
                            kadNum: kadastrovyNomer,
                            owner: vlasnyk
                        });
                    }
                }
            });
            
            if (results.length > 0) {
                results.slice(0, 10).forEach(result => { // –û–±–º–µ–∂—É—î–º–æ –¥–æ 10 —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤
                    const resultItem = document.createElement('div');
                    resultItem.style.cssText = `
                        padding: 12px 20px;
                        border-bottom: 1px solid #f0f0f0;
                        cursor: pointer;
                        font-size: 14px;
                    `;
                    
                    resultItem.innerHTML = `
                        <div style="font-weight: 500;">–ö–∞–¥–∞—Å—Ç—Ä–æ–≤–∏–π –Ω–æ–º–µ—Ä: ${result.kadNum}</div>
                        <div style="color: #666; font-size: 12px;">–í–ª–∞—Å–Ω–∏–∫: ${result.owner}</div>
                    `;
                    
                    resultItem.addEventListener('click', function() {
                        // –ü–µ—Ä–µ—Ö–æ–¥–∏–º–æ –¥–æ –¥—ñ–ª—è–Ω–∫–∏
                        if (result.layer.getBounds) {
                            map.fitBounds(result.layer.getBounds());
                        } else if (result.layer.getLatLng) {
                            map.setView(result.layer.getLatLng(), 15);
                        }
                        
                        // –°—Ç–≤–æ—Ä—é—î–º–æ —Ç–∏–º—á–∞—Å–æ–≤–µ –ø—ñ–¥—Å–≤—ñ—á—É–≤–∞–Ω–Ω—è –¥–ª—è –º–æ–±—ñ–ª—å–Ω–æ–≥–æ –ø–æ—à—É–∫—É
                        if (result.layer.getBounds) {
                            // –í–∏–¥–∞–ª—è—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—î –ø—ñ–¥—Å–≤—ñ—á—É–≤–∞–Ω–Ω—è —è–∫—â–æ —î
                            if (window.mobileSearchHighlight) {
                                map.removeLayer(window.mobileSearchHighlight);
                            }
                            
                            // –°—Ç–≤–æ—Ä—é—î–º–æ –∫—ñ–ª—å—Ü–µ –Ω–∞–≤–∫–æ–ª–æ –∑–Ω–∞–π–¥–µ–Ω–æ—ó –¥—ñ–ª—è–Ω–∫–∏ (—è–∫ —É –¥–µ—Å–∫—Ç–æ–ø–Ω—ñ–π –≤–µ—Ä—Å—ñ—ó)
                            const bounds = result.layer.getBounds();
                            const center = bounds.getCenter();
                            // –ó–º–µ–Ω—à—É—î–º–æ —Ä–∞–¥—ñ—É—Å —è–∫ —É —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–º—É Leaflet search
                            const radius = Math.max(
                                bounds.getNorthEast().distanceTo(bounds.getSouthWest()) / 8,
                                25 // –º—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π —Ä–∞–¥—ñ—É—Å
                            );
                            
                            window.mobileSearchHighlight = L.circle(center, {
                                radius: radius,
                                color: '#ff7800',
                                weight: 3,
                                opacity: 0.8,
                                fillColor: '#ff7800',
                                fillOpacity: 0.15,
                                className: 'mobile-search-highlight'
                            }).addTo(map);
                            
                            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤–∏–¥–∞–ª—è—î–º–æ –ø—ñ–¥—Å–≤—ñ—á—É–≤–∞–Ω–Ω—è —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥ (—è–∫ —É –¥–µ—Å–∫—Ç–æ–ø–Ω—ñ–π –≤–µ—Ä—Å—ñ—ó)
                            setTimeout(() => {
                                if (window.mobileSearchHighlight) {
                                    map.removeLayer(window.mobileSearchHighlight);
                                    window.mobileSearchHighlight = null;
                                }
                            }, 5000);
                        }
                        
                        // –í—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ popup
                        if (result.layer.openPopup) {
                            result.layer.openPopup();
                        }
                        
                        // –ó–∞–∫—Ä–∏–≤–∞—î–º–æ –ø–æ—à—É–∫
                        setTimeout(() => {
                            closeMobileSearch();
                        }, 500);
                        
                        // Haptic feedback
                        safeVibrate(100);
                    });
                    
                    resultItem.addEventListener('mouseenter', function() {
                        this.style.backgroundColor = '#f8f9fa';
                    });
                    
                    resultItem.addEventListener('mouseleave', function() {
                        this.style.backgroundColor = '';
                    });
                    
                    resultsContainer.appendChild(resultItem);
                });
                
                // –í–∏–¥–∞–ª—è—î–º–æ border –∑ –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ –µ–ª–µ–º–µ–Ω—Ç–∞
                const lastItem = resultsContainer.lastChild;
                if (lastItem) {
                    lastItem.style.borderBottom = 'none';
                }
                
                resultsContainer.style.display = 'block';
            }
        }
        function toggleMobileLayersPanel() {
            const panel = document.getElementById('mobileLayersPanel');
            const button = document.getElementById('mobileLayersBtn');
            
            if (panel.classList.contains('show')) {
                panel.classList.remove('show');
                button.classList.remove('active');
            } else {
                panel.classList.add('show');
                button.classList.add('active');
                updateMobileLayers();
            }
        }
        
        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å–ø–∏—Å–∫—É —à–∞—Ä—ñ–≤ —É –º–æ–±—ñ–ª—å–Ω—ñ–π –ø–∞–Ω–µ–ª—ñ
        function updateMobileLayers() {
            const mobileLayersList = document.getElementById('mobileLayersList');
            if (!mobileLayersList) return;
            
            mobileLayersList.innerHTML = '';
            
            // –°–ø–æ—á–∞—Ç–∫—É –¥–æ–¥–∞—î–º–æ —Å–∏—Å—Ç–µ–º–Ω—ñ —à–∞—Ä–∏ (–±–µ–∑ –∫–æ–ª—å–æ—Ä–æ–≤–∏—Ö –∫–≤–∞–¥—Ä–∞—Ç–∏–∫—ñ–≤)
            const systemLayers = ['Google Maps', 'OpenStreetMap', '–ê–∫—Ç—É–∞–ª—å–Ω—ñ —Ä–∞—Å—Ç—Ä–∏', 'kadastr.live'];
            systemLayers.forEach(name => {
                if (overlays[name]) {
                    const layer = overlays[name];
                    const isChecked = map.hasLayer(layer);
                    const layerItem = document.createElement('div');
                    layerItem.className = 'mobile-layer-item';
                    
                    layerItem.innerHTML = `
                        <input type="checkbox" id="mobile_${name.replace(/[^a-zA-Z0-9]/g, '_')}" ${isChecked ? 'checked' : ''}>
                        <label for="mobile_${name.replace(/[^a-zA-Z0-9]/g, '_')}">
                            ${name}
                        </label>
                    `;
                    
                    const checkbox = layerItem.querySelector('input');
                    checkbox.addEventListener('change', function() {
                        if (this.checked) {
                            map.addLayer(layer);
                        } else {
                            map.removeLayer(layer);
                        }
                    });
                    
                    mobileLayersList.appendChild(layerItem);
                }
            });
            
            // –î–æ–¥–∞—î–º–æ —à–∞—Ä–∏ –∑ –∫–æ–ª—å–æ—Ä–∞–º–∏ (–æ—Ä–µ–Ω–¥–∞—Ä—ñ —Ç–∞ —Å–ø–µ—Ü—ñ–∞–ª—å–Ω—ñ)
            Object.entries(overlays).forEach(([name, layer]) => {
                // –ü—Ä–æ–ø—É—Å–∫–∞—î–º–æ —Å–∏—Å—Ç–µ–º–Ω—ñ —à–∞—Ä–∏, —è–∫—ñ –≤–∂–µ –¥–æ–¥–∞–ª–∏
                if (systemLayers.includes(name)) return;
                
                const isChecked = map.hasLayer(layer);
                const layerItem = document.createElement('div');
                layerItem.className = 'mobile-layer-item';
                
                // –û—Ç—Ä–∏–º—É—î–º–æ –∫–æ–ª—ñ—Ä —Ç–∞ –Ω–∞–∑–≤—É –∑ layers control
                const layerColor = extractLayerColor(name);
                const layerDisplayName = extractLayerName(name);
                
                layerItem.innerHTML = `
                    <input type="checkbox" id="mobile_${name.replace(/[^a-zA-Z0-9]/g, '_')}" ${isChecked ? 'checked' : ''}>
                    <label for="mobile_${name.replace(/[^a-zA-Z0-9]/g, '_')}">
                        ${layerColor ? `<span class="color-box" style="background-color: ${layerColor}; ${layerColor === '#ffffff' ? 'border: 2px solid #ccc;' : ''}"></span>` : ''}
                        ${layerDisplayName}
                    </label>
                `;
                
                // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫ –ø–æ–¥—ñ—ó
                const checkbox = layerItem.querySelector('input');
                checkbox.addEventListener('change', function() {
                    if (this.checked) {
                        map.addLayer(layer);
                    } else {
                        map.removeLayer(layer);
                    }
                });
                
                mobileLayersList.appendChild(layerItem);
            });
        }
        
        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤–∏—Ç—è–≥—É–≤–∞–Ω–Ω—è –∫–æ–ª—å–æ—Ä—É –∑ layers control
        function extractLayerColor(layerName) {
            // –õ–æ–≥—É—î–º–æ –¥–ª—è –Ω–∞–ª–∞–≥–æ–¥–∂–µ–Ω–Ω—è
            debugLog('Extracting color for layer:', layerName);
            
            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –≤ tenantColors (–≥–ª–æ–±–∞–ª—å–Ω—ñ –∫–æ–ª—å–æ—Ä–∏ –æ—Ä–µ–Ω–¥–∞—Ä—ñ–≤)
            if (window.tenantColors && tenantColors[layerName]) {
                debugLog('Found in tenantColors:', tenantColors[layerName]);
                return tenantColors[layerName];
            }
            
            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —î —Ü–µ –æ—Ä–µ–Ω–¥–∞—Ä –∑ –∫–æ–ª—å–æ—Ä–æ–º —á–µ—Ä–µ–∑ getColor —Ñ—É–Ω–∫—Ü—ñ—é
            if (window.getColor && typeof getColor === 'function') {
                try {
                    const color = getColor(layerName);
                    if (color && color !== '#999999' && color !== '#999' && color !== '#ffffff') {
                        debugLog('Generated color via getColor:', color);
                        return color;
                    }
                } catch (e) {
                    debugLog('getColor error for', layerName, e);
                }
            }
            
            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –≤ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–æ–º—É layers control DOM –µ–ª–µ–º–µ–Ω—Ç—ñ
            try {
                const layersControl = document.querySelector('.leaflet-control-layers');
                if (layersControl) {
                    const labels = layersControl.querySelectorAll('label');
                    for (let label of labels) {
                        const labelText = label.textContent.trim();
                        if (labelText.includes(layerName) || labelText.startsWith(layerName)) {
                            const colorBox = label.querySelector('.color-box');
                            if (colorBox) {
                                const bgColor = colorBox.style.backgroundColor;
                                if (bgColor) {
                                    debugLog('Found in DOM:', bgColor);
                                    return bgColor;
                                }
                            }
                        }
                    }
                }
            } catch (e) {
                debugLog('DOM search error for', layerName, e);
            }
            
            // –ë–∞–∑–æ–≤—ñ –∫–æ–ª—å–æ—Ä–∏ –¥–ª—è —Å–∏—Å—Ç–µ–º–Ω–∏—Ö —à–∞—Ä—ñ–≤ (–±–µ–∑ –∫–æ–ª—å–æ—Ä—ñ–≤ –¥–ª—è –Ω–∏—Ö)
            const baseColors = {
                'Google Maps': null,
                'OpenStreetMap': null, 
                '–ê–∫—Ç—É–∞–ª—å–Ω—ñ —Ä–∞—Å—Ç—Ä–∏': null,
                'kadastr.live': null,
                '–ü–æ–ª—è –æ–±—Ä–æ–±—ñ—Ç–∫—É': '#95e1d3',
                '–≤—ñ–ª—å–Ω—ñ –≤—ñ–¥ –æ—Ä–µ–Ω–¥–∏': '#ffffff'
            };
            
            // –Ø–∫—â–æ —Ü–µ —Å–∏—Å—Ç–µ–º–Ω–∏–π —à–∞—Ä –±–µ–∑ –∫–æ–ª—å–æ—Ä—É, –ø–æ–≤–µ—Ä—Ç–∞—î–º–æ null
            if (baseColors.hasOwnProperty(layerName)) {
                debugLog('System layer, using base color:', baseColors[layerName]);
                return baseColors[layerName];
            }
            
            // –î–ª—è –Ω–µ–≤—ñ–¥–æ–º–∏—Ö –æ—Ä–µ–Ω–¥–∞—Ä—ñ–≤ –≥–µ–Ω–µ—Ä—É—î–º–æ –≤–∏–ø–∞–¥–∫–æ–≤–∏–π –∫–æ–ª—ñ—Ä
            const generatedColor = generateColorForTenant(layerName);
            debugLog('Generated fallback color:', generatedColor);
            return generatedColor;
        }
        
        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó –∫–æ–ª—å–æ—Ä—É –¥–ª—è –æ—Ä–µ–Ω–¥–∞—Ä—è
        function generateColorForTenant(tenantName) {
            // –°—Ç–≤–æ—Ä—é—î–º–æ —Ö–µ—à –∑ –Ω–∞–∑–≤–∏ –æ—Ä–µ–Ω–¥–∞—Ä—è
            let hash = 0;
            for (let i = 0; i < tenantName.length; i++) {
                hash = tenantName.charCodeAt(i) + ((hash << 5) - hash);
                hash = hash & hash; // –ö–æ–Ω–≤–µ—Ä—Ç—É—î–º–æ –≤ 32-–±—ñ—Ç–Ω–µ —á–∏—Å–ª–æ
            }
            
            // –ì–µ–Ω–µ—Ä—É—î–º–æ HSL –∫–æ–ª—ñ—Ä –∑ —Ö–µ—à—É
            const hue = Math.abs(hash % 360);
            const saturation = 60 + (Math.abs(hash) % 30); // 60-90%
            const lightness = 45 + (Math.abs(hash) % 20);  // 45-65%
            
            return `hsl(${hue}, ${saturation}%, ${lightness}%)`;
        }
        
        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤–∏—Ç—è–≥—É–≤–∞–Ω–Ω—è –Ω–∞–∑–≤–∏ —à–∞—Ä—É
        function extractLayerName(layerName) {
            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —î –ø–ª–æ—â–∞ –≤ –Ω–∞–∑–≤—ñ (–¥–ª—è –æ—Ä–µ–Ω–¥–∞—Ä—ñ–≤)
            if (window.tenantAreas && tenantAreas[layerName]) {
                return `${layerName} (${tenantAreas[layerName].toFixed(2)} –≥–∞)`;
            }
            
            // –î–ª—è –≤—ñ–ª—å–Ω–∏—Ö –≤—ñ–¥ –æ—Ä–µ–Ω–¥–∏
            if (layerName === '–≤—ñ–ª—å–Ω—ñ –≤—ñ–¥ –æ—Ä–µ–Ω–¥–∏' && window.freeArea) {
                return `–≤—ñ–ª—å–Ω—ñ –≤—ñ–¥ –æ—Ä–µ–Ω–¥–∏ (${freeArea.toFixed(2)} –≥–∞)`;
            }
            
            return layerName;
        }

        function initializeMap() {
    // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É –æ–¥–∏–Ω —Ä–∞–∑ –∑ –º–æ–±—ñ–ª—å–Ω–∏–º–∏ –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è–º–∏
    map = L.map('map', {
        zoomControl: false,
        tap: true,
        tapTolerance: 15,
        touchZoom: true,
        bounceAtZoomLimits: false,
        wheelPxPerZoomLevel: 60,
        zoomSnap: 0.5,
        zoomDelta: 0.5,
        maxBoundsViscosity: 0.5
    }).setView([48.3794, 31.1656], 6);
    
    // –ú–æ–±—ñ–ª—å–Ω—ñ –æ–±–º–µ–∂–µ–Ω–Ω—è –¥–ª—è –∫–∞—Ä—Ç–∏
    if (window.innerWidth <= 768) {
        map.options.zoomSnap = 1;
        map.options.zoomDelta = 1;
        map.setMaxZoom(18);
    }
    
    // –°–±—Ä–æ—Å –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
    isCtrlPressed = false;

    // –°–æ–∑–¥–∞–µ–º –±–∞–∑–æ–≤—ã–µ —Å–ª–æ–∏
    const googleLayer = L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
        maxZoom: 20,
        attribution: '&copy; <a href="https://www.google.com/maps">Google</a>'
    }).addTo(map);

    const openStreetMapLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    });

    const rasterLayer = L.tileLayer(dataPath + 'tiles/{z}/{x}/{y}.png', {
        maxZoom: 20,
        attribution: '–ê–∫—Ç—É–∞–ª—å–Ω—ñ —Ä–∞—Å—Ç—Ä–∏'
    });

    const kadastrLayer = L.tileLayer('https://cdn.kadastr.live/tiles/raster/styles/parcels/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="https://kadastr.live">kadastr.live</a>'
    });

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –±–∞–∑–æ–≤—ã—Ö —Å–ª–æ–µ–≤
    overlays = {
        "Google Maps": googleLayer,
        "OpenStreetMap": openStreetMapLayer,
        "–ê–∫—Ç—É–∞–ª—å–Ω—ñ —Ä–∞—Å—Ç—Ä–∏": rasterLayer,
        "kadastr.live": kadastrLayer
    };

    // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç—Ä–æ–ª—å –ª–æ–∫–∞—Ü–∏–∏
    locateControl = L.control.locate({
        position: 'bottomright',
        strings: {
            title: "–ü–æ–∫–∞–∑–∞—Ç–∏ –º–æ—î –º—ñ—Å—Ü–µ–∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è"
        },
        locateOptions: {
            enableHighAccuracy: true,
            maxZoom: 20,
            timeout: 10000,
            maximumAge: 0,
            watch: true
        },
        flyTo: true,
        returnToPrevBounds: true,
        showCompass: true,
        markerStyle: {
            color: '#136AEC',
            fillColor: '#2A93EE'
        },
        circleStyle: {
            color: '#136AEC',
            fillColor: '#19BCED',
            fillOpacity: 0.15
        },
        followCircleStyle: {
            color: '#FFA500',
            fillColor: '#FFB000',
            fillOpacity: 0.15
        },
        icon: 'fa fa-crosshairs',
        iconLoading: 'fa fa-spinner fa-spin'
    }).addTo(map);
    
    // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –ø–æ–¥—ñ–π –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó –∑ –º–æ–±—ñ–ª—å–Ω–æ—é –∫–Ω–æ–ø–∫–æ—é
    map.on('locateactivate', function() {
        // –ö–æ–ª–∏ locate control –∞–∫—Ç–∏–≤—É—î—Ç—å—Å—è
        const mobileBtn = document.getElementById('mobileLocationBtn');
        if (mobileBtn) {
            mobileBtn.classList.add('locating');
            mobileBtn.classList.remove('located');
        }
    });
    
    map.on('locatedeactivate', function() {
        // –ö–æ–ª–∏ locate control –¥–µ–∞–∫—Ç–∏–≤—É—î—Ç—å—Å—è
        const mobileBtn = document.getElementById('mobileLocationBtn');
        if (mobileBtn) {
            mobileBtn.classList.remove('locating', 'located');
        }
    });
    
    map.on('locationfound', function() {
        // –ö–æ–ª–∏ –∑–Ω–∞–π–¥–µ–Ω–æ –º—ñ—Å—Ü–µ–∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è
        const mobileBtn = document.getElementById('mobileLocationBtn');
        if (mobileBtn) {
            mobileBtn.classList.remove('locating');
            mobileBtn.classList.add('located');
        }
    });
    
    map.on('locationerror', function(e) {
        // –ü—Ä–∏ –ø–æ–º–∏–ª—Ü—ñ –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—ó
        const mobileBtn = document.getElementById('mobileLocationBtn');
        if (mobileBtn) {
            mobileBtn.classList.remove('locating', 'located');
        }
        
        // –ü–æ–∫–∞–∑—É—î–º–æ –∑—Ä–æ–∑—É–º—ñ–ª–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –ø–æ–º–∏–ª–∫—É
        let errorMessage = '–ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–∑–Ω–∞—á–∏—Ç–∏ –≤–∞—à–µ –º—ñ—Å—Ü–µ–∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è.';
        
        switch(e.code) {
            case e.PERMISSION_DENIED:
                errorMessage = '–î–æ—Å—Ç—É–ø –¥–æ –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—ó –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–æ. –ë—É–¥—å –ª–∞—Å–∫–∞, –¥–æ–∑–≤–æ–ª—å—Ç–µ –¥–æ—Å—Ç—É–ø –¥–æ –º—ñ—Å—Ü–µ–∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è –≤ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è—Ö –±—Ä–∞—É–∑–µ—Ä–∞.';
                break;
            case e.POSITION_UNAVAILABLE:
                errorMessage = '–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –º—ñ—Å—Ü–µ–∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.';
                break;
            case e.TIMEOUT:
                errorMessage = '–ß–∞—Å –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è –º—ñ—Å—Ü–µ–∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è –≤–∏—á–µ—Ä–ø–∞–Ω–æ.';
                break;
        }
        
        // –ü–æ–∫–∞–∑—É—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –∫–ª—ñ–∫–Ω—É–≤ –Ω–∞ –∫–Ω–æ–ø–∫—É
        if (window.lastLocationRequestTime && Date.now() - window.lastLocationRequestTime < 2000) {
            alert(errorMessage);
        }
    });

    freeLayer = L.layerGroup();

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–∞—Ä—Ç–µ
    map.on('click', function(e) {
        if (!isCtrlPressed && !e.originalEvent.target.closest('.leaflet-control-layers')) {
            clearSelection();
        }
    });

    // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç—Ä–æ–ª—å —Å–ª–æ–µ–≤
    layersControl = L.control.layers(baseMaps, overlays, {
        collapsed: true
    }).addTo(map);

    // –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è –º—ñ–∂ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–º layers control —Ç–∞ –º–æ–±—ñ–ª—å–Ω–æ—é –ø–∞–Ω–µ–ª–ª—é
    map.on('overlayadd overlayremove', function(e) {
        // –û–Ω–æ–≤–ª—é—î–º–æ –º–æ–±—ñ–ª—å–Ω—ñ —à–∞—Ä–∏ –ø—Ä–∏ –∑–º—ñ–Ω—ñ –≤ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–º—É –∫–æ–Ω—Ç—Ä–æ–ª—ñ
        if (window.innerWidth <= 768 && typeof updateMobileLayers === 'function') {
            setTimeout(updateMobileLayers, 100); // –Ω–µ–≤–µ–ª–∏–∫–∞ –∑–∞—Ç—Ä–∏–º–∫–∞ –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è
        }
    });

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –∏ –ø–æ–ª—è
    loadFileList();
    addFieldLayer();

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–ª–æ–∏ –¥–ª—è –º–∞—Ä–∫–µ—Ä–æ–≤ –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—Ä—Ç—ã
    ownMarkersLayer = L.layerGroup().addTo(map);
    othersMarkersLayer = L.layerGroup().addTo(map);

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –∏–∑–º–µ—Ä–µ–Ω–∏—è
    editableLayers = new L.FeatureGroup();
    map.addLayer(editableLayers);

    // –ó–º—ñ–Ω—é—î–º–æ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è L.Control.Draw - –£–î–ê–õ–Ø–ï–ú –î–£–ë–õ–ò–†–£–Æ–©–ò–ï –≠–õ–ï–ú–ï–ù–¢–´ –£–ü–†–ê–í–õ–ï–ù–ò–Ø
    // –ù–∞ –∫–∞—Ä—Ç–µ –Ω–µ –±—É–¥–µ–º –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è L.Control.Draw,
    // —Ç–∞–∫ –∫–∞–∫ –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—à–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–µ –º–µ–Ω—é –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
    var drawControl = new L.Control.Draw({
        position: 'topright',
        draw: false, // –û—Ç–∫–ª—é—á–∞–µ–º –ø–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ —Ä–∏—Å–æ–≤–∞–Ω–∏—è
        edit: false  // –û—Ç–∫–ª—é—á–∞–µ–º –ø–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    });
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª–∏–≥–æ–Ω–æ–≤
    map.on(L.Draw.Event.CREATED, function (e) {
        var layer = e.layer;
        
        // –†–∞—Ö—É—î–º–æ –ø–ª–æ—â—É –≤ –≥–µ–∫—Ç–∞—Ä–∞—Ö
        var area = L.GeometryUtil.geodesicArea(layer.getLatLngs()[0]);
        var areaInHectares = (area / 10000).toFixed(4);
        
        // –î–æ–¥–∞—î–º–æ –ø–æ–ø–∞–ø –∑ –ø–ª–æ—â–µ—é
        layer.bindPopup('–ü–ª–æ—â–∞: ' + areaInHectares + ' –≥–∞');
        
        // –î–æ–¥–∞—î–º–æ –ø–æ–ª—ñ–≥–æ–Ω –¥–æ —à–∞—Ä—É –¥–ª—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è
        editableLayers.addLayer(layer);
    });

    // –û–Ω–æ–≤–ª—é—î–º–æ –ø–æ–ø–∞–ø –∑ –ø–ª–æ—â–µ—é –ø—Ä–∏ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—ñ
    map.on(L.Draw.Event.EDITED, function (e) {
        e.layers.eachLayer(function (layer) {
            if (layer instanceof L.Polygon) {
                var area = L.GeometryUtil.geodesicArea(layer.getLatLngs()[0]);
                var areaInHectares = (area / 10000).toFixed(4);
                layer.setPopupContent('–ü–ª–æ—â–∞: ' + areaInHectares + ' –≥–∞');
            }
        });
    });

    // –î–æ–¥–∞—î–º–æ –≤–∏–ø–∞–¥–∞—é—á–µ –º–µ–Ω—é –∑ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏
var toolsButton = L.Control.extend({
    options: {
        position: 'topright'
    },
    onAdd: function (map) {
        var container = L.DomUtil.create('div', 'leaflet-bar leaflet-control tools-menu');

        // –ì–æ–ª–æ–≤–Ω–∞ –∫–Ω–æ–ø–∫–∞
        var mainButton = L.DomUtil.create('a', 'tools-main-button', container);
        mainButton.href = '#';
        mainButton.title = '–Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è';
        mainButton.innerHTML = '<i class="bi bi-tools"></i>';

        // –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–Ω–æ–ø–æ–∫ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ñ–≤
        var toolsContainer = L.DomUtil.create('div', 'tools-container', container);
        toolsContainer.style.display = 'none';

        // –ì—Ä—É–ø—É—î–º–æ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏ –∑–∞ –∫–∞—Ç–µ–≥–æ—Ä—ñ—è–º–∏
        const toolGroups = [
            {
                title: '–ú–∞–ª—é–≤–∞–Ω–Ω—è',
                tools: [
                    { icon: 'bi-pencil-square', title: '–ú–∞–ª—é–≤–∞—Ç–∏ –ø–æ–ª—ñ–≥–æ–Ω', action: function() { 
                        new L.Draw.Polygon(map).enable();
                    }},
                    { icon: 'bi-arrows-move', title: '–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –ø–æ–ª—ñ–≥–æ–Ω–∏', action: function() {
                        new L.EditToolbar.Edit(map, {featureGroup: editableLayers}).enable();
                    }},
                    { icon: 'bi-trash', title: '–í–∏–¥–∞–ª–∏—Ç–∏ –ø–æ–ª—ñ–≥–æ–Ω', action: function() {
                        new L.EditToolbar.Delete(map, {featureGroup: editableLayers}).enable(); 
                    }}
                ]
            },
            {
                title: '–§–∞–π–ª–∏',
                tools: [
                    { icon: 'bi-file-earmark-arrow-down', title: '–ï–∫—Å–ø–æ—Ä—Ç –≤ GeoJSON/KML', action: function() {
                        exportToGeoJSON();
                    }},
                    { icon: 'bi-folder2-open', title: '–Ü–º–ø–æ—Ä—Ç –∑ GeoJSON/KML', action: function() {
                        showLoadModal();
                    }}
                ]
            }
        ];

        // –°—Ç–≤–æ—Ä—é—î–º–æ –≥—Ä—É–ø–∏ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ñ–≤
        toolGroups.forEach(group => {
            if (group.title) {
                const groupTitle = L.DomUtil.create('div', 'tools-group-title', toolsContainer);
                groupTitle.textContent = group.title;
            }
            
            const groupContainer = L.DomUtil.create('div', 'tools-group', toolsContainer);
            group.tools.forEach(tool => {
                const button = L.DomUtil.create('a', 'tool-button', groupContainer);
                button.href = '#';
                button.title = tool.title;
                button.innerHTML = `<i class="bi ${tool.icon}"></i>`;
                L.DomEvent.on(button, 'click', function(e) {
                    L.DomEvent.stopPropagation(e);
                    L.DomEvent.preventDefault(e);
                    toolsContainer.style.display = 'none';
                    tool.action();
                });
            }); 
        });

        // –û–±—Ä–æ–±–Ω–∏–∫ –∫–ª—ñ–∫—É –Ω–∞ –≥–æ–ª–æ–≤–Ω—É –∫–Ω–æ–ø–∫—É
        L.DomEvent.on(mainButton, 'click', function(e) {
            L.DomEvent.stopPropagation(e);
            L.DomEvent.preventDefault(e);
            toolsContainer.style.display = toolsContainer.style.display === 'none' ? 'block' : 'none';
        });

        // –ó–∞–∫—Ä–∏–≤–∞—î–º–æ –º–µ–Ω—é –ø—Ä–∏ –∫–ª—ñ–∫—É –ø–æ–∑–∞ –Ω–∏–º
        L.DomEvent.on(document, 'click', function() {
            toolsContainer.style.display = 'none';
        });

        // –ó–∞–ø–æ–±—ñ–≥–∞—î–º–æ –∑–∞–∫—Ä–∏—Ç—Ç—é –ø—Ä–∏ –∫–ª—ñ–∫—É –Ω–∞ –º–µ–Ω—é
        L.DomEvent.on(container, 'click', function(e) {
            L.DomEvent.stopPropagation(e);
        });

        return container;
    }
});

// –î–æ–¥–∞—î–º–æ –º–µ–Ω—é –Ω–∞ –∫–∞—Ä—Ç—É
map.addControl(new toolsButton());

            let cutLine = null;
            let polygonToCut = null;
            let isInCutMode = false;
            let cutPoints = [];

            function startCutMode() {
    isInCutMode = true;
    map.dragging.disable();
    map.doubleClickZoom.disable();
    // –ó–º—ñ–Ω—é—î–º–æ –∫—É—Ä—Å–æ—Ä –¥–ª—è –ø–æ–∫–∞–∑—É, —â–æ —Ä–µ–∂–∏–º –∞–∫—Ç–∏–≤–Ω–∏–π
    map._container.style.cursor = 'crosshair';

    // –ü–æ–∫–∞–∑—É—î–º–æ –ø—ñ–¥–∫–∞–∑–∫—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É
    alert('–í–∏–±–µ—Ä—ñ—Ç—å –ø–æ–ª—ñ–≥–æ–Ω –¥–ª—è —Ä–æ–∑—Ä—ñ–∑–∞–Ω–Ω—è');

    editableLayers.eachLayer(function(layer) {
        if (layer instanceof L.Polygon) {
            // –î–æ–¥–∞—î–º–æ –ø—ñ–¥—Å–≤—ñ—á—É–≤–∞–Ω–Ω—è –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–Ω—ñ
            layer.on('mouseover', function() {
                if (!polygonToCut) {
                    this.setStyle({
                        color: '#ff0000',
                        weight: 3
                    });
                }
            });

            layer.on('mouseout', function() {
                if (!polygonToCut) {
                    this.setStyle({
                        color: '#3388ff',
                        weight: 2
                    });
                }
            });

            layer.on('click', selectPolygonToCut);
        }
    });
}

function selectPolygonToCut(e) {
    if (!isInCutMode) return;

    L.DomEvent.stopPropagation(e);

    if (polygonToCut) {
        // –Ø–∫—â–æ –ø–æ–ª—ñ–≥–æ–Ω –≤–∂–µ –≤–∏–±—Ä–∞–Ω–æ, —ñ–≥–Ω–æ—Ä—É—î–º–æ –ø–æ–≤—Ç–æ—Ä–Ω–∏–π –≤–∏–±—ñ—Ä
        return;
    }
    
    polygonToCut = e.target;
    
    // –ü—ñ–¥—Å–≤—ñ—á—É—î–º–æ –≤–∏–±—Ä–∞–Ω–∏–π –ø–æ–ª—ñ–≥–æ–Ω
    polygonToCut.setStyle({
        color: '#ff0000',
        weight: 3,
        fillOpacity: 0.3
    });
    
    // –ü–æ–∫–∞–∑—É—î–º–æ –ø—ñ–¥–∫–∞–∑–∫—É –¥–ª—è –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ –∫—Ä–æ–∫—É
    alert('–¢–µ–ø–µ—Ä –∫–ª–∞—Ü–Ω—ñ—Ç—å –ø–æ –∫–∞—Ä—Ç—ñ –≤ –¥–≤–æ—Ö –º—ñ—Å—Ü—è—Ö, —â–æ–± —Å—Ç–≤–æ—Ä–∏—Ç–∏ –ª—ñ–Ω—ñ—é —Ä–æ–∑—Ä—ñ–∑—É');

    // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫ –¥–ª—è –º–∞–ª—é–≤–∞–Ω–Ω—è –ª—ñ–Ω—ñ—ó
    map.on('click', onDrawCutLine);
}
    
function onDrawCutLine(e) {
    if (!polygonToCut) return;
    
    cutPoints.push(e.latlng);

    if (cutLine) {
        map.removeLayer(cutLine);
    }

    // –ü–æ–∫–∞–∑—É—î–º–æ –ª—ñ–Ω—ñ—é —Ä–æ–∑—Ä—ñ–∑—É
    cutLine = L.polyline(cutPoints, {
        color: '#ff0000',
        weight: 3,
        dashArray: '5, 10'
    }).addTo(map);
    
    if (cutPoints.length >= 2) {
        if (performCut()) {
            cancelCutMode();
            cutButton.state('cut-inactive');
        } else {
            // –Ø–∫—â–æ —Ä–æ–∑—Ä—ñ–∑–∞–Ω–Ω—è –Ω–µ –≤–¥–∞–ª–æ—Å—è, –æ—á–∏—â–∞—î–º–æ —Ç–æ—á–∫–∏ –∞–ª–µ –∑–∞–ª–∏—à–∞—î–º–æ—Å—è –≤ —Ä–µ–∂–∏–º—ñ —Ä–æ–∑—Ä—ñ–∑–∞–Ω–Ω—è
            cutPoints = [];
            if (cutLine) {
                map.removeLayer(cutLine);
                cutLine = null;
            }
        }
    }
}

function cancelCutMode() {
    isInCutMode = false;
    map.dragging.enable();
    map.doubleClickZoom.enable();
    // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–π –∫—É—Ä—Å–æ—Ä
    map._container.style.cursor = '';

    // –û—á–∏—â–∞—î–º–æ —Ç–æ—á–∫–∏ —Ä–æ–∑—Ä—ñ–∑—É
    cutPoints = [];

    // –ó–Ω—ñ–º–∞—î–º–æ –ø—ñ–¥—Å–≤—ñ—á—É–≤–∞–Ω–Ω—è –∑ –ø–æ–ª—ñ–≥–æ–Ω—É
    if (polygonToCut) {
        polygonToCut.setStyle({
            color: '#3388ff',
            weight: 2,
            fillOpacity: 0.2
        });
        polygonToCut = null;
    }

    // –í–∏–¥–∞–ª—è—î–º–æ –≤—Å—ñ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –ø–æ–¥—ñ–π
    editableLayers.eachLayer(function(layer) {
        if (layer instanceof L.Polygon) {
            layer.off('mouseover');
            layer.off('mouseout');
            layer.off('click', selectPolygonToCut);
        }
    });

    map.off('click', onDrawCutLine);
}

function performCut() {
    try {
        if (!polygonToCut || cutPoints.length < 2) {
            throw new Error('–ù–µ –≤–∏–±—Ä–∞–Ω–æ –ø–æ–ª—ñ–≥–æ–Ω –∞–±–æ –Ω–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ —Ç–æ—á–æ–∫ –¥–ª—è —Ä–æ–∑—Ä—ñ–∑–∞–Ω–Ω—è');
        }

        const polygonGeoJSON = polygonToCut.toGeoJSON();

        // –°—Ç–≤–æ—Ä—é—î–º–æ –ª—ñ–Ω—ñ—é –∑ —Ç–æ—á–æ–∫ –∫–ª—ñ–∫—É
        const line = turf.lineString(cutPoints.map(latlng => [latlng.lng, latlng.lat]));

        // –ó–Ω–∞—Ö–æ–¥–∏–º–æ –ø–µ—Ä–µ—Ç–∏–Ω –ª—ñ–Ω—ñ—ó –∑ –ø–æ–ª—ñ–≥–æ–Ω–æ–º
        const intersection = turf.lineIntersect(line, polygonGeoJSON);
        if (intersection.features.length < 2) {
            throw new Error('–õ—ñ–Ω—ñ—è —Ä–æ–∑—Ä—ñ–∑—É –ø–æ–≤–∏–Ω–Ω–∞ –ø–µ—Ä–µ—Ç–∏–Ω–∞—Ç–∏ –ø–æ–ª—ñ–≥–æ–Ω —É –¥–≤–æ—Ö —Ç–æ—á–∫–∞—Ö');
        }

        // –°—Ç–≤–æ—Ä—é—î–º–æ –ª—ñ–Ω—ñ—é —Ä–æ–∑—Ä—ñ–∑—É —á–µ—Ä–µ–∑ —Ç–æ—á–∫–∏ –ø–µ—Ä–µ—Ç–∏–Ω—É
        const cutLine = turf.lineString([
            intersection.features[0].geometry.coordinates,
            intersection.features[1].geometry.coordinates
        ]);

        // –°—Ç–≤–æ—Ä—é—î–º–æ –±—É—Ñ–µ—Ä –Ω–∞–≤–∫–æ–ª–æ –ª—ñ–Ω—ñ—ó —Ä–æ–∑—Ä—ñ–∑—É
        const bufferedLine = turf.buffer(cutLine, 0.0001);

        // –†–æ–∑—Ä—ñ–∑–∞—î–º–æ –ø–æ–ª—ñ–≥–æ–Ω
        const clipped = turf.difference(polygonGeoJSON, bufferedLine);
        if (!clipped) {
            throw new Error('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ —Ä–æ–∑—Ä—ñ–∑–∞–Ω–Ω—ñ. –°–ø—Ä–æ–±—É–π—Ç–µ —ñ–Ω—à–∏–π –∫—É—Ç —Ä–æ–∑—Ä—ñ–∑—É.');
        }

        // –Ø–∫—â–æ –æ—Ç—Ä–∏–º–∞–ª–∏ MultiPolygon, —Ä–æ–∑–¥—ñ–ª—è—î–º–æ –π–æ–≥–æ –Ω–∞ –æ–∫—Ä–µ–º—ñ –ø–æ–ª—ñ–≥–æ–Ω–∏
        if (clipped.geometry.type === 'MultiPolygon') {
            // –í–∏–¥–∞–ª—è—î–º–æ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏–π –ø–æ–ª—ñ–≥–æ–Ω
            editableLayers.removeLayer(polygonToCut);

            // –î–æ–¥–∞—î–º–æ –Ω–æ–≤—ñ –ø–æ–ª—ñ–≥–æ–Ω–∏
            clipped.geometry.coordinates.forEach(coords => {
                const newPolygon = turf.polygon(coords);
                // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ –ø–ª–æ—â–∞ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—ñ–≥–æ–Ω—É –Ω–µ –∑–∞–Ω–∞–¥—Ç–æ –º–∞–ª–∞
                const area = turf.area(newPolygon) / 10000; // –∫–æ–Ω–≤–µ—Ä—Ç—É—î–º–æ –≤ –≥–∞
                if (area > 0.001) { // —ñ–≥–Ω–æ—Ä—É—î–º–æ –¥—É–∂–µ –º–∞–ª—ñ —á–∞—Å—Ç–∏–Ω–∏
                    addPolygonToMap(newPolygon, polygonToCut.feature.properties);
                }
            });
                
            return true;
        } else if (clipped.geometry.type === 'Polygon') {
            // –í–∏–¥–∞–ª—è—î–º–æ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏–π –ø–æ–ª—ñ–≥–æ–Ω
            editableLayers.removeLayer(polygonToCut);

            // –î–æ–¥–∞—î–º–æ –Ω–æ–≤–∏–π –ø–æ–ª—ñ–≥–æ–Ω
            addPolygonToMap(clipped, polygonToCut.feature.properties);
            return true;
        }

        throw new Error('–ù–µ–≤–¥–∞–ª–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ä–æ–∑—Ä—ñ–∑–∞–Ω–Ω—è');
    } catch (error) {
        alert('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ —Ä–æ–∑—Ä—ñ–∑–∞–Ω–Ω—ñ –ø–æ–ª—ñ–≥–æ–Ω—É: ' + error.message);
        return false;
    }
}
        
// –î–æ–¥–∞–π—Ç–µ –¥–æ–ø–æ–º—ñ–∂–Ω—É —Ñ—É–Ω–∫—Ü—ñ—é –¥–ª—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è –ø–æ–ª—ñ–≥–æ–Ω—É –Ω–∞ –∫–∞—Ä—Ç—É:
function addPolygonToMap(geoJSON, originalProperties) {
    const area = turf.area(geoJSON) / 10000; // –∫–æ–Ω–≤–µ—Ä—Ç—É—î–º–æ –≤ –≥–∞
    geoJSON.properties = {
        ...originalProperties,
        "–ü–ª–æ—â–∞ —Ä–æ–∑—Ä–∞—Ö–æ–≤–∞–Ω–∞": area.toFixed(4)
    };

    L.geoJSON(geoJSON, {
        style: {
            color: '#3388ff',
            weight: 2,
            fillOpacity: 0.2
        }
    }).eachLayer(layer => {
        layer.feature = {
            type: 'Feature',
            properties: geoJSON.properties,
            geometry: geoJSON.geometry
        };
        const popupContent = '–ü–ª–æ—â–∞: ' + area.toFixed(4) + ' –≥–∞';
        layer.bindPopup(popupContent);
        editableLayers.addLayer(layer);
    });
}

            function mergeSelectedPolygons() {
                if (selectedFeatures.size < 2) {
                    alert('–í–∏–±–µ—Ä—ñ—Ç—å –ø—Ä–∏–Ω–∞–π–º–Ω—ñ 2 –ø–æ–ª—ñ–≥–æ–Ω–∏ –¥–ª—è –æ–±\'—î–¥–Ω–∞–Ω–Ω—è');
                    return;
                }

                try {
                    let polygons = [];
                    selectedFeatures.forEach(featureId => {
                        editableLayers.eachLayer(layer => {
                            if (L.stamp(layer) === featureId) {
                                polygons.push(layer);
                            }
                        });
                    });

                    // –ö–æ–Ω–≤–µ—Ä—Ç—É—î–º–æ –ø–æ–ª—ñ–≥–æ–Ω–∏ –≤ —Ñ–æ—Ä–º–∞—Ç turf.js
                    const features = polygons.map(p => p.toGeoJSON());

                    // –û–±'—î–¥–Ω—É—î–º–æ –ø–æ–ª—ñ–≥–æ–Ω–∏
                    let union = features[0];
                    for (let i = 1; i < features.length; i++) {
                        union = turf.union(union, features[i]);
                    }

                    // –í–∏–¥–∞–ª—è—î–º–æ —Å—Ç–∞—Ä—ñ –ø–æ–ª—ñ–≥–æ–Ω–∏
                    polygons.forEach(p => editableLayers.removeLayer(p));

                    // –†–∞—Ö—É—î–º–æ –ø–ª–æ—â—É –Ω–æ–≤–æ–≥–æ –ø–æ–ª—ñ–≥–æ–Ω—É
                    const area = turf.area(union) / 10000; // –∫–æ–Ω–≤–µ—Ä—Ç—É—î–º–æ –≤ –≥–∞
                    union.properties = {
                        "–ü–ª–æ—â–∞ —Ä–æ–∑—Ä–∞—Ö–æ–≤–∞–Ω–∞": area.toFixed(4)
                    };

                    // –î–æ–¥–∞—î–º–æ –Ω–æ–≤–∏–π –ø–æ–ª—ñ–≥–æ–Ω
                    L.geoJSON(union, {
                        style: {
                            color: '#3388ff',
                            weight: 2,
                            fillOpacity: 0.2
                        }
                    }).eachLayer(layer => {
                        layer.feature = union;
                        const popupContent = '–ü–ª–æ—â–∞: ' + area.toFixed(4) + ' –≥–∞';
                        layer.bindPopup(popupContent);
                        editableLayers.addLayer(layer);
                    });

                    clearSelection();
                } catch (error) {
                    alert('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ–±\'—î–¥–Ω–∞–Ω–Ω—ñ –ø–æ–ª—ñ–≥–æ–Ω—ñ–≤: ' + error.message);
                }
            }
                    
        // –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤—ã–¥–µ–ª–µ–Ω–∏—è
        function toggleFeatureSelection(layer, e) {
    if (e) { // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —ñ—Å–Ω—É—î e
        L.DomEvent.stopPropagation(e);
    }

    const featureId = L.stamp(layer);

    if (selectedFeatures.has(featureId)) {
        // –ó–Ω—ñ–º–∞—î–º–æ –≤–∏–¥—ñ–ª–µ–Ω–Ω—è
        selectedFeatures.delete(featureId);
        layer.setStyle({
            fillOpacity: 0.4,
            weight: 0.5,
            color: getColor(layer.feature.properties["–û—Ä–µ–Ω–¥–∞—Ä"])
        });
    } else {
        // –î–æ–¥–∞—î–º–æ –≤–∏–¥—ñ–ª–µ–Ω–Ω—è
        if (!isCtrlPressed) {
            // –Ø–∫—â–æ Ctrl –Ω–µ –Ω–∞—Ç–∏—Å–Ω—É—Ç–æ - –æ—á–∏—â–∞—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ –≤–∏–¥—ñ–ª–µ–Ω–Ω—è
            clearSelection();
        }
        selectedFeatures.add(featureId);
        layer.setStyle({
            fillOpacity: 0.6,
            weight: 2,
            color: '#FFFF00'
        });
    }

    updateSelectionInfo();
}

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≤—ã–¥–µ–ª–µ–Ω–∏–∏
        function updateSelectionInfo() {
            
            // –ú–Ω–æ–∂–µ—Å—Ç–≤–æ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –∫–æ–º–±–∏–Ω–∞—Ü–∏–π
            const processedParts = new Set();
            // –ö–∞–¥–∞—Å—Ç—Ä–æ–≤—ã–µ –Ω–æ–º–µ—Ä–∞ –∏ –æ–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
            const uniqueFeatures = new Map();
            // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ –∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞–º
            const tenantAreas = new Map();
            // –ü–ª–æ—â–∞–¥–∏ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º
            const statusAreas = new Map();
            
            // –ü–µ—Ä–µ–±–∏—Ä–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã
            selectedFeatures.forEach(featureId => {
                Object.values(overlays).forEach(layerGroup => {
                    if (!layerGroup || typeof layerGroup.eachLayer !== 'function') return;
                    
                    layerGroup.eachLayer(layer => {
                        if (L.stamp(layer) !== featureId || !layer.feature || !layer.feature.properties) return;
                        
                        const props = layer.feature.properties;
                        if (props.type !== 'split') {
                            return;
                        }
                        
                        const kadNum = props["–ö–∞–¥–∞—Å—Ç—Ä–æ–≤–∏–π –Ω–æ–º–µ—Ä"];
                        const partArea = parseFloat(props["–ü–ª–æ—â–∞ —á–∞—Å—Ç–∏–Ω–∏"]) || 0;
                        const totalArea = parseFloat(props["–ü–ª–æ—â–∞ —Ä–æ–∑—Ä–∞—Ö–æ–≤–∞–Ω–∞"]) || 0;
                        const tenant = props["–û—Ä–µ–Ω–¥–∞—Ä —á–∞—Å—Ç–∏–Ω–∏"] || props["–û—Ä–µ–Ω–¥–∞—Ä"] || "–ë–µ–∑ –æ—Ä–µ–Ω–¥–∞—Ä—è";
                        const status = props["–°—Ç–∞—Ç—É—Å"] || "–ù–µ –≤–∫–∞–∑–∞–Ω–æ";
                        
                        // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏
                        const partId = `${kadNum}_${tenant}_${status}`;
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –¥–æ–±–∞–≤–ª—è–ª–∏ –ª–∏ –º—ã —É–∂–µ —ç—Ç–æ—Ç –æ–±—ä–µ–∫—Ç
                        if (processedParts.has(partId) || !kadNum || isNaN(partArea) || partArea <= 0) {
                            return; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –∏–ª–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                        }
                        
                        processedParts.add(partId);
                        
                        // –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ –∫–∞–¥–∞—Å—Ç—Ä–æ–≤–æ–º—É –Ω–æ–º–µ—Ä—É
                        if (!uniqueFeatures.has(kadNum)) {
                            uniqueFeatures.set(kadNum, {
                                totalArea: totalArea,
                                tenant: tenant,
                                tenantCounted: false
                            });
                        }
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞ –µ—Å–ª–∏ –µ—â–µ –Ω–µ —É—á—Ç–µ–Ω –¥–ª—è —ç—Ç–æ–≥–æ —É—á–∞—Å—Ç–∫–∞
                        if (!tenantAreas.has(tenant)) {
                            tenantAreas.set(tenant, 0);
                        }
                        
                        const featInfo = uniqueFeatures.get(kadNum);
                        if (!featInfo.tenantCounted) {
                            tenantAreas.set(tenant, tenantAreas.get(tenant) + totalArea);
                            featInfo.tenantCounted = true;
                        }
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –ø–ª–æ—â–∞–¥—å –ø–æ —Å—Ç–∞—Ç—É—Å—É
                        if (!statusAreas.has(status)) {
                            statusAreas.set(status, 0);
                        }
                        statusAreas.set(status, statusAreas.get(status) + partArea);
                    });
                });
            });

            // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–±—â—É—é –ø–ª–æ—â–∞–¥—å —É—á–∞—Å—Ç–∫–æ–≤
            const totalSelectedArea = Array.from(uniqueFeatures.values())
                .reduce((sum, info) => sum + info.totalArea, 0);
            
            // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–±—â—É—é –ø–ª–æ—â–∞–¥—å —á–∞—Å—Ç–µ–π –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º
            const totalPartsArea = Array.from(statusAreas.values())
                .reduce((sum, area) => sum + area, 0);

            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            updateSelectionInfoUI(uniqueFeatures, tenantAreas, statusAreas, totalSelectedArea, totalPartsArea);
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI —Å –∏–Ω—Ñ–æ–±–æ–∫—Å–æ–º –æ –≤—ã–¥–µ–ª–µ–Ω–Ω—ã—Ö —É—á–∞—Å—Ç–∫–∞—Ö
        function updateSelectionInfoUI(uniqueFeatures, tenantAreas, statusAreas, totalSelectedArea, totalPartsArea) {
            const infoElement = document.getElementById('selectionInfo');
            const selectionTools = document.getElementById('selectionTools');
            
            if (uniqueFeatures.size === 0) {
                if (infoElement) infoElement.remove();
                if (selectionTools) selectionTools.style.display = 'none';
                return;
            }
            
            // –°–æ–∑–¥–∞–µ–º –∏–Ω—Ñ–æ–±–æ–∫—Å –µ—Å–ª–∏ –µ–≥–æ –µ—â–µ –Ω–µ—Ç
            if (!infoElement) {
                const info = L.control({position: 'bottomleft'});
                info.onAdd = function() {
                    const div = L.DomUtil.create('div', 'selection-info');
                    div.id = 'selectionInfo';
                    div.style.background = 'white';
                    div.style.color = 'black';
                    div.style.padding = '6px';
                    div.style.border = '2px —Å–æ–ª—ñ–¥ #666';
                    div.style.borderRadius = '4px';
                    div.style.maxWidth = '300px';
                    return div;
                };
                info.addTo(map);
            }
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º HTML –¥–ª—è –∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–æ–≤
            let tenantsInfo = '';
            tenantAreas.forEach((area, tenant) => {
                const color = tenant === "–ë–µ–∑ –æ—Ä–µ–Ω–¥–∞—Ä—è" ? "#ffffff" : getColor(tenant);
                tenantsInfo += `
                    <div style="display: flex; align-items: center; margin-top: 3px;">
                        <span style="
                            display: inline-block;
                            width: 12px;
                            height: 12px;
                            margin-right: 5px;
                            background-color: ${color};
                            border: 1px solid #666;
                            border-radius: 2px;
                        "></span>
                        <span>${tenant}: ${area.toFixed(4)} –≥–∞</span>
                    </div>`;
            });
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º HTML –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤
            let statusInfo = '';
            statusAreas.forEach((area, status) => {
                const statusText = status.toLowerCase();
                const color = statusText === '–æ–±—Ä–æ–±–ª—è—î—Ç—å—Å—è' ? '#198754' : 
                            statusText === '–Ω–µ –æ–±—Ä–æ–±–ª—è—î—Ç—å—Å—è' ? '#dc3545' : 
                            '#666666';
                statusInfo += `
                    <div style="display: flex; align-items: center; margin-top: 3px;">
                        <span style="
                            display: inline-block;
                            width: 12px; 
                            height: 12px;
                            margin-right: 5px;
                            background-color: ${color};
                            border: 1px solid #666;
                            border-radius: 2px;
                        "></span>
                        <span>${status}: ${area.toFixed(4)} –≥–∞</span>
                    </div>`;
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∏–Ω—Ñ–æ–±–æ–∫—Å–∞
            document.getElementById('selectionInfo').innerHTML = `
                <div style="max-height: 300px; overflow-y: auto;">
                    <div>
                        <b>–í–∏–¥—ñ–ª–µ–Ω–æ –¥—ñ–ª—è–Ω–æ–∫:</b> ${uniqueFeatures.size}<br>
                        <div style="margin-top: 3px;">
                            <b>–ó–∞–≥–∞–ª—å–Ω–∞ –ø–ª–æ—â–∞:</b> ${totalSelectedArea.toFixed(4)} –≥–∞
                        </div>
                    </div>
                    <hr style="margin: 4px 0">
                    <div>
                        <strong>–†–æ–∑–ø–æ–¥—ñ–ª –ø–æ –æ—Ä–µ–Ω–¥–∞—Ä—è—Ö:</strong>
                        ${tenantsInfo}
                    </div>
                    <hr style="margin: 4px 0">
                    <div>
                        <strong>–†–æ–∑–ø–æ–¥—ñ–ª –∑–∞ —Å—Ç–∞—Ç—É—Å–∞–º–∏:</strong>
                        ${statusInfo}
                    </div>
                    <div style="margin-top: 3px; font-size: 0.9em; color: #666; text-align: right;">
                        –ü–ª–æ—â–∞ —á–∞—Å—Ç–∏–Ω: ${totalPartsArea.toFixed(4)} –≥–∞
                    </div>
                </div>`;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –≤—ã–¥–µ–ª–µ–Ω–∏—è
            if (selectionTools) {
                selectionTools.style.display = 'block';
            }
        }

        // –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é initMap
        function initMap() {
            // –î–æ–±–∞–≤–ª—è–µ–º –±–∞–∑–æ–≤—ã–µ —Å–ª–æ–∏
            const googleLayer = L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
                maxZoom: 20,
                attribution: '&copy; <a href="https://www.google.com/maps">Google</a>'
            }).addTo(map);

            const openStreetMapLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            });

            const rasterLayer = L.tileLayer(dataPath + 'tiles/{z}/{x}/{y}.png', {
                maxZoom: 20,
                attribution: '–ê–∫—Ç—É–∞–ª—å–Ω—ñ —Ä–∞—Å—Ç—Ä–∏'
            });

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –±–∞–∑–æ–≤—ã–µ —Å–ª–æ–∏ –≥–ª–æ–±–∞–ª—å–Ω–æ
            baseMaps = {
                "Google Maps": googleLayer,
                "OpenStreetMap": openStreetMapLayer,
                "–ê–∫—Ç—É–∞–ª—å–Ω—ñ —Ä–∞—Å—Ç—Ä–∏": rasterLayer
            };

            // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç—Ä–æ–ª—å –ª–æ–∫–∞—Ü–∏–∏
            L.control.locate({
                position: 'bottomright',
                strings: {
                    title: "–ü–æ–∫–∞–∑–∞—Ç–∏ –º–æ—î –º—ñ—Å—Ü–µ–∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è"
                },
                locateOptions: {
                    enableHighAccuracy: true,
                    maxZoom: 20,
                    timeout: 10000,
                    maximumAge: 0,
                    watch: true
                },
            }).addTo(map);

            var baseMaps = {
                "Google Maps": googleLayer,
                "OpenStreetMap": openStreetMapLayer,
                "–ê–∫—Ç—É–∞–ª—å–Ω—ñ —Ä–∞—Å—Ç—Ä–∏": rasterLayer
            };

            freeLayer = L.layerGroup();

            // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç—Ä–æ–ª—å —Å–ª–æ–µ–≤
            layersControl = L.control.layers(baseMaps, overlays, {
                collapsed: true
            }).addTo(map);

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
            loadFileList();
            addFieldLayer();

            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∞–≤–∏—à
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Control') {
                    isCtrlPressed = true;
                }
            });
            
            document.addEventListener('keyup', function(e) {
                if (e.key === 'Control') {
                    isCtrlPressed = false;
                }
            });

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–∞—Ä—Ç–µ
            map.on('click', function(e) {
                if (!isCtrlPressed && !e.originalEvent.target.closest('.leaflet-control-layers')) {
                    clearSelection();
                }
            });
        }

        function loadFileList() {
            console.log('Loading file list from:', dataPath + 'file_list.json');
            console.log('Current dataPath:', dataPath);
            console.log('Current id:', id);
            
            fetch(dataPath + 'file_list.json')
                .then(response => {
                    console.log('Response status:', response.status);
                    console.log('Response ok:', response.ok);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('File list data:', data);
                    var select = document.getElementById('fileSelect');
                    select.innerHTML = '<option>–í–∏–±–µ—Ä—ñ—Ç—å —Ä–∞–¥—É</option>';
                    data.files.forEach(file => {
                        var option = document.createElement('option');
                        option.value = file;
                        option.textContent = file.replace('.geojson', '');
                        select.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error loading file list:', error);
                    console.error('Attempted URL:', dataPath + 'file_list.json');
                    
                    // –Ø–∫—â–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑ client-specific –ø–∞–ø–∫–∏ –Ω–µ –≤–¥–∞–ª–æ—Å—è, —Å–ø—Ä–æ–±—É—î–º–æ –∑–∞–≥–∞–ª—å–Ω—É –ø–∞–ø–∫—É
                    if (dataPath !== 'data/') {
                        console.log('Fallback to general data folder');
                        fetch('data/file_list.json')
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error(`HTTP error! status: ${response.status}`);
                                }
                                return response.json();
                            })
                            .then(data => {
                                console.log('Fallback file list data:', data);
                                var select = document.getElementById('fileSelect');
                                select.innerHTML = '<option>–í–∏–±–µ—Ä—ñ—Ç—å —Ä–∞–¥—É</option>';
                                data.files.forEach(file => {
                                    var option = document.createElement('option');
                                    option.value = file;
                                    option.textContent = file.replace('.geojson', '');
                                    select.appendChild(option);
                                });
                            })
                            .catch(fallbackError => {
                                console.error('Fallback also failed:', fallbackError);
                                console.log('Trying PHP fallback...');
                                // –û—Å—Ç–∞–Ω–Ω—ñ–π –≤–∞—Ä—ñ–∞–Ω—Ç - —Å–ø—Ä–æ–±—É—î–º–æ PHP —Å–∫—Ä–∏–ø—Ç
                                tryPhpFallback();
                            });
                    } else {
                        console.log('Trying PHP fallback...');
                        tryPhpFallback();
                    }
                });
        }
        
        function tryPhpFallback() {
            // –°–ø—Ä–æ–±—É—î–º–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —á–µ—Ä–µ–∑ PHP —Å–∫—Ä–∏–ø—Ç —è–∫ –æ—Å—Ç–∞–Ω–Ω—ñ–π –≤–∞—Ä—ñ–∞–Ω—Ç
            fetch('list_files.php' + (id ? `?id=${id}` : ''))
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`PHP script error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('PHP fallback successful:', data);
                    var select = document.getElementById('fileSelect');
                    select.innerHTML = '<option>–í–∏–±–µ—Ä—ñ—Ç—å —Ä–∞–¥—É</option>';
                    data.files.forEach(file => {
                        var option = document.createElement('option');
                        option.value = file;
                        option.textContent = file.replace('.geojson', '');
                        select.appendChild(option);
                    });
                })
                .catch(phpError => {
                    console.error('PHP fallback also failed:', phpError);
                    // –Ø–∫ –æ—Å—Ç–∞–Ω–Ω—è –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å - —Å—Ç–≤–æ—Ä—é—î–º–æ —Å–ø–∏—Å–æ–∫ –∑ –Ω–∞—è–≤–Ω–∏—Ö —Ñ–∞–π–ª—ñ–≤
                    createManualFileList();
                });
        }
        
        function createManualFileList() {
            console.log('Creating manual file list');
            // –°—Ç–≤–æ—Ä—é—î–º–æ –±–∞–∑–æ–≤–∏–π —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª—ñ–≤ –¥–ª—è –£–∫—Ä–∞—ó–Ω–∏
            const defaultFiles = [
                '–ë–∞–±–∏–Ω—Å—å–∫–∞.geojson', '–ì–Ω—ñ–ª—å—á–µ–Ω—Å—å–∫–∞.geojson', '–ö–∞–ª—å–Ω–µ–Ω—Å—å–∫–∞.geojson',
                '–õ–æ—à–Ω—ñ–≤—Å—å–∫–∞.geojson', '–õ—è–¥—Å—å–∫–∞.geojson', '–ú–∞–π–¥–∞–Ω–µ—Ü—å–∫–∞.geojson',
                '–ü–æ–ª—è–Ω—Å—å–∫–∞.geojson', '–†–µ–∫—à–∏–Ω—Å—å–∫–∞.geojson', '–†–µ–º–µ–∑—ñ–≤—Ü—ñ–≤—Å—å–∫–∞.geojson',
                '–°–∞–¥—ñ–≤—Å—å–∫–∞.geojson', '–°–Ω–æ–≤–∏—Ü—å–∫–∞.geojson', '–°—É—â–∏–Ω—Å—å–∫–∞.geojson',
                '–¢—Ä–æ—Å—Ç—è–Ω–µ—Ü—å–∫–∞.geojson', '–£—Å—Ç—î-–ó–µ–ª–µ–Ω—Å—å–∫–∞.geojson', '–®–ø–∏–∫–æ–ª–æ—Å—å–∫–∞.geojson',
                '–Ø—Å–µ–Ω–æ–≤–µ—Ü—å–∫–∞.geojson'
            ];
            
            var select = document.getElementById('fileSelect');
            select.innerHTML = '<option>–í–∏–±–µ—Ä—ñ—Ç—å —Ä–∞–¥—É</option>';
            defaultFiles.forEach(file => {
                var option = document.createElement('option');
                option.value = file;
                option.textContent = file.replace('.geojson', '');
                select.appendChild(option);
            });
            
            console.log('Manual file list created');
        }

        function addFieldLayer() {
            // –°–ø–æ—á–∞—Ç–∫—É —Å–ø—Ä–æ–±—É—î–º–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∑ –ø–∞–ø–∫–∏ ID (—è–∫—â–æ —î), –ø–æ—Ç—ñ–º –∑ –∑–∞–≥–∞–ª—å–Ω–æ—ó –ø–∞–ø–∫–∏
            fetch(dataPath + 'field.geojson')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    fieldLayer = L.geoJSON(data, {
                        style: styleFieldFeature,
                        onEachFeature: function (feature, layer) {
                            if (feature.properties) {
                                var area = feature.properties.area || '';
                                var name = feature.properties.name || '';
                                var tooltipText = name + '\n' + area.toString() + ' –≥–∞';
                                layer.bindTooltip(tooltipText, {
                                    permanent: true,
                                    direction: 'center',
                                    className: 'area-tooltip',
                                    opacity: 0
                                });
                            }   
                        }
                    }).addTo(map);

                    updateLabelsVisibility();

                    map.on('zoomend', function() {
                        updateLabelsVisibility();
                    });

                    overlays["–ü–æ–ª—è –æ–±—Ä–æ–±—ñ—Ç–∫—É"] = fieldLayer;
                    var colorBox = '<span class="color-box" style="background-color:transparent; border: 2px solid yellow"></span>';
                    layersControl.addOverlay(fieldLayer, colorBox + '<span class="layer-name">–ü–æ–ª—è –æ–±—Ä–æ–±—ñ—Ç–∫—É</span>');
                })
                .catch(error => {
                    console.log('Field GeoJSON not found in specific folder, trying general data folder:', error);
                    // –Ø–∫—â–æ –Ω–µ –∑–Ω–∞–π—à–ª–∏ –≤ –ø–∞–ø—Ü—ñ ID, —Å–ø—Ä–æ–±—É—î–º–æ –≤ –∑–∞–≥–∞–ª—å–Ω—ñ–π –ø–∞–ø—Ü—ñ data/
                    if (dataPath !== 'data/') {
                        fetch('data/field.geojson')
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error(`HTTP error! status: ${response.status}`);
                                }
                                return response.json();
                            })
                            .then(data => {
                                fieldLayer = L.geoJSON(data, {
                                    style: styleFieldFeature,
                                    onEachFeature: function (feature, layer) {
                                        if (feature.properties) {
                                            var area = feature.properties.area || '';
                                            var name = feature.properties.name || '';
                                            var tooltipText = name + '\n' + area.toString() + ' –≥–∞';
                                            layer.bindTooltip(tooltipText, {
                                                permanent: true,
                                                direction: 'center',
                                                className: 'area-tooltip',
                                                opacity: 0
                                            });
                                        }   
                                    }
                                }).addTo(map);

                                updateLabelsVisibility();

                                map.on('zoomend', function() {
                                    updateLabelsVisibility();
                                });

                                overlays["–ü–æ–ª—è –æ–±—Ä–æ–±—ñ—Ç–∫—É"] = fieldLayer;
                                var colorBox = '<span class="color-box" style="background-color:transparent; border: 2px solid yellow"></span>';
                                layersControl.addOverlay(fieldLayer, colorBox + '<span class="layer-name">–ü–æ–ª—è –æ–±—Ä–æ–±—ñ—Ç–∫—É</span>');
                            })
                            .catch(error => console.error('Error loading Field GeoJSON data from general folder:', error));
                    } else {
                        console.error('Error loading Field GeoJSON data:', error);
                    }
                });
        }
                    
        function styleFieldFeature(feature) {
            return {
                color: 'yellow',
                weight: 3,
                opacity: 1,
                fillOpacity: 0
            };
        }

        function updateLabelsVisibility() {
            var currentZoom = map.getZoom();
            if (fieldLayer) {
                fieldLayer.eachLayer(function (layer) {
                    const tooltip = layer.getTooltip();
                    if (tooltip) {
                        if (currentZoom >= 15 && currentZoom <= 18) {
                            tooltip.setOpacity(1);
                        } else {
                            tooltip.setOpacity(0);
                        }
                    }
                });
            }
        }

        function clearSelection() {
    selectedFeatures.forEach(featureId => {
        Object.values(overlays).forEach(layerGroup => {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å–ª–æ–π –∫–∞—Ä—Ç—ã
            if (layerGroup && typeof layerGroup.eachLayer === 'function') {
                layerGroup.eachLayer(layer => {
                    if (L.stamp(layer) === featureId && layer.feature) {
                        layer.setStyle({
                            fillOpacity: 0.4,
                            weight: 0.5,
                            color: getColor(layer.feature.properties["–û—Ä–µ–Ω–¥–∞—Ä"])
                        });
                    }
                });
            }
        });
    });

    selectedFeatures.clear();

    const infoElement = document.getElementById('selectionInfo');
    const selectionTools = document.getElementById('selectionTools');

    if (infoElement) {
        infoElement.remove();
    }
    if (selectionTools) {
        selectionTools.style.display = 'none';
    }
}

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞
        document.getElementById('fileSelect').addEventListener('change', function() {
            var selectedFile = this.value;
            if (selectedFile && selectedFile !== '–í–∏–±–µ—Ä—ñ—Ç—å —Ä–∞–¥—É') {
                this.disabled = true;
                var loadingOption = document.createElement('option');
                loadingOption.text = '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...';
                this.add(loadingOption, 0);
                this.value = '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...';
                addGeoJsonLayer(dataPath + selectedFile, selectedFile)
                    .then(() => {
                        this.remove(0);
                        this.disabled = false;
                        this.value = selectedFile;
                    })
                    .catch(error => {
                        console.error('Error loading GeoJSON:', error);
                        alert('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö');
                        this.remove(0);
                        this.disabled = false;
                        this.value = '–í–∏–±–µ—Ä—ñ—Ç—å —Ä–∞–¥—É';
                    });
            }
        });

        async function addGeoJsonLayer(url, layerName) {
    // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –ø–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞–Ω –±–∞–∑–æ–≤–∏—Ö —à–∞—Ä—ñ–≤
    const baseLayersState = {
        "Google Maps": map.hasLayer(overlays["Google Maps"]),
        "OpenStreetMap": map.hasLayer(overlays["OpenStreetMap"]),
        "–ê–∫—Ç—É–∞–ª—å–Ω—ñ —Ä–∞—Å—Ç—Ä–∏": map.hasLayer(overlays["–ê–∫—Ç—É–∞–ª—å–Ω—ñ —Ä–∞—Å—Ç—Ä–∏"]),
        "kadastr.live": map.hasLayer(overlays["kadastr.live"])
    };
    
    clearOverlays();
    tenantAreas = {};
    freeArea = 0;
    selectedFeatures.clear(); // –û—á–∏—â–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã
    
    try {
        const response = await fetch(url);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –∏—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        const data = await response.json();
        originalGeoJsonData = data;
        
        // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ split-—á–∞—Å—Ç–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞ –∫–∞—Ä—Ç–µ
        const splitFeatures = data.features.filter(feature => 
            feature.properties && feature.properties.type === "split"
        );

        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç FeatureCollection —Ç–æ–ª—å–∫–æ —Å split-—á–∞—Å—Ç—è–º–∏
        const filteredData = {
            type: "FeatureCollection",
            features: splitFeatures
        };

        // –°—Ç—Ä–æ–∏–º —Å–ª–æ–π GeoJSON –∏–∑ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        var geoJsonLayer = L.geoJSON(filteredData, {
            style: styleFeature,
            onEachFeature: onEachFeature
        });

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–∫–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
        updateFieldSelect(data);
        updateExpiryYearSelect(data);
        updateRegistrationYearSelect(data); // –î–æ–¥–∞—î–º–æ –≤–∏–∫–ª–∏–∫ —Ñ—É–Ω–∫—Ü—ñ—ó –¥–ª—è –∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è —Å–ø–∏—Å–∫—É –¥–∞—Ç–∞–º–∏ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó
        updateLandUseSelect(data); // –ó–∞–ø–æ–≤–Ω—é—î–º–æ —Å–ø–∏—Å–æ–∫ —Ü—ñ–ª—å–æ–≤–æ–≥–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è
        
        // –°–∫–∏–¥–∞—î–º–æ —Ñ—ñ–ª—å—Ç—Ä–∏ –ø–ª–æ—â—ñ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ –Ω–æ–≤–∏—Ö –¥–∞–Ω–∏—Ö
        document.getElementById('areaMinInput').value = '';
        document.getElementById('areaMaxInput').value = '';

        // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª–æ–π –Ω–∞ –∫–∞—Ä—Ç—É
        map.fitBounds(geoJsonLayer.getBounds());
        overlays[layerName] = geoJsonLayer;
        geoJsonLayer.addTo(map);
        
        // –í—ñ–¥–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞–Ω –±–∞–∑–æ–≤–∏—Ö —à–∞—Ä—ñ–≤
        Object.entries(baseLayersState).forEach(([name, wasVisible]) => {
            if (wasVisible && overlays[name]) {
                overlays[name].addTo(map);
            }
        });
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
        updateLayersControl();
        addSearchControl(geoJsonLayer);
        updateDataFreshnessIndicator(filteredData);
        
        return true;
    } catch (error) {
        console.error('Error loading GeoJSON:', error);
        throw error;
    }
}

        function onEachFeature(feature, layer) {
    if (feature.properties) {
        // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —Ç–∏–ø –æ–±'—î–∫—Ç–∞
        if (feature.properties.type !== 'split') {
            return;
        }
        
        // –û–±—Ä–æ–±–ª—è—î–º–æ –ø–ª–æ—â—É —Ç–∞ –æ—Ä–µ–Ω–¥–∞—Ä—è
        processAreaAndTenant(feature, layer);
        
        // –°—Ç–≤–æ—Ä—é—î–º–æ popup –æ–¥—Ä–∞–∑—É (–ø–æ—Ç—Ä—ñ–±–Ω–æ –¥–ª—è –∫–æ—Ä–µ–∫—Ç–Ω–æ—ó —Ä–æ–±–æ—Ç–∏)
        createPopupContent(feature, layer);
        
        // –û–±—Ä–æ–±–Ω–∏–∫ –∫–ª—ñ–∫—É –¥–ª—è –≤–∏–¥—ñ–ª–µ–Ω–Ω—è
        layer.on('click', function(e) {
            if (!e.originalEvent.target.closest('.leaflet-popup')) {
                toggleFeatureSelection(layer, e);
            }
        });
    }
}

        function createPopupContent(feature, layer) {
            let popupContent = '<div class="popup-content">';
            
            popupContent += '<table style="width: 100%; border-collapse: separate; border-spacing: 0; margin: 0; background: transparent; border: none; border-radius: 0; overflow: visible;">';
            
            // –ü–æ–∫–∞–∑—É—î–º–æ –≤—Å—ñ –ø–æ–ª—è —ñ –Ω–∞ –º–æ–±—ñ–ª—å–Ω–∏—Ö —ñ –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–∞—Ö - —Ç—ñ–ª—å–∫–∏ –∑–º—ñ–Ω—é—î–º–æ –≤–∏–≥–ª—è–¥
            const orderedKeys = [
                "–ö–∞–¥–∞—Å—Ç—Ä–æ–≤–∏–π –Ω–æ–º–µ—Ä",
                "–ù–æ–º–µ—Ä –∑–µ–º–µ–ª—å–Ω–æ—ó –¥—ñ–ª—è–Ω–∫–∏", 
                "–ü–ª–æ—â–∞ –∑–µ–º–µ–ª—å–Ω–æ—ó –¥—ñ–ª—è–Ω–∫–∏",
                "–ü–ª–æ—â–∞ —Ä–æ–∑—Ä–∞—Ö–æ–≤–∞–Ω–∞",
                "–ü–ª–æ—â–∞ —á–∞—Å—Ç–∏–Ω–∏",
                "–¶—ñ–ª—å–æ–≤–µ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è",
                "–§–æ—Ä–º–∞ –≤–ª–∞—Å–Ω–æ—Å—Ç—ñ",
                "–í–ª–∞—Å–Ω–∏–∫",
                "–û—Ä–µ–Ω–¥–∞—Ä",
                "–û—Ä–µ–Ω–¥–∞—Ä —á–∞—Å—Ç–∏–Ω–∏", 
                "–î–∞—Ç–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –æ—Ä–µ–Ω–¥–∏",
                "–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è",
                "–í–∏–¥ –æ–±–º–µ–∂–µ–Ω–Ω—è",
                "–°—Ç–∞—Ç—É—Å",
                "–ù–∞–∑–≤–∞ –ø–æ–ª—è"
            ];
            
            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥–æ–µ –ø–æ–ª–µ –∏ –¥–æ–±–∞–≤–ª—è–µ–º –≤ —Ç–∞–±–ª–∏—Ü—É
            const tableRows = [];
            orderedKeys.forEach(key => {
                if (feature.properties.hasOwnProperty(key)) {
                    let value = feature.properties[key] || '';
                    
                    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —á–∏—Å–ª–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–ª–æ—â–∞–¥–µ–π —Å —Ç–æ—á–Ω–æ—Å—Ç—å—é –¥–æ 4 –∑–Ω–∞–∫–æ–≤
                    if ((key === "–ü–ª–æ—â–∞ —Ä–æ–∑—Ä–∞—Ö–æ–≤–∞–Ω–∞" || key === "–ü–ª–æ—â–∞ —á–∞—Å—Ç–∏–Ω–∏") && !isNaN(parseFloat(value))) {
                        value = parseFloat(value).toFixed(4) + " –≥–∞";
                    }
                    
                    // –ü–æ–∫—Ä–∞—â—É—î–º–æ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –¥–∞—Ç –¥–ª—è –º–æ–±—ñ–ª—å–Ω–∏—Ö
                    if ((key === "–î–∞—Ç–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –æ—Ä–µ–Ω–¥–∏" || key === "–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è") && value) {
                        // –§–æ—Ä–º–∞—Ç—É—î–º–æ –¥–∞—Ç—É —è–∫—â–æ —Ü–µ –º–æ–∂–ª–∏–≤–æ
                        try {
                            const date = new Date(value);
                            if (!isNaN(date.getTime())) {
                                value = date.toLocaleDateString('uk-UA');
                            }
                        } catch (e) {
                            // –ó–∞–ª–∏—à–∞—î–º–æ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è —è–∫—â–æ –Ω–µ –≤–¥–∞–ª–æ—Å—è —Ñ–æ—Ä–º–∞—Ç—É–≤–∞—Ç–∏
                        }
                    }
                    
                    // –°–∫–æ—Ä–æ—á—É—î–º–æ –¥–æ–≤–≥—ñ –∑–Ω–∞—á–µ–Ω–Ω—è –¥–ª—è –º–æ–±—ñ–ª—å–Ω–∏—Ö
                    if (window.innerWidth <= 768 && typeof value === 'string' && value.length > 50) {
                        value = `<span title="${value}">${value.substring(0, 47)}...</span>`;
                    }
                    
                    // –î–æ–¥–∞—î–º–æ —ñ–∫–æ–Ω–∫–∏ —Ç–∞ –∫–æ—Ä–æ—Ç–∫—ñ –ø–æ—è—Å–Ω–µ–Ω–Ω—è –¥–ª—è –≤—Å—ñ—Ö –ø–æ–ª—ñ–≤
                    let displayKey = key;
                    if (window.innerWidth <= 768) {
                        // –î–ª—è –º–æ–±—ñ–ª—å–Ω–∏—Ö –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –ø–æ–≤–Ω—ñ –Ω–∞–∑–≤–∏ –±–µ–∑ —Å–∫–æ—Ä–æ—á–µ–Ω—å
                        displayKey = key;
                    } else {
                        // –ü–æ–≤–Ω—ñ –Ω–∞–∑–≤–∏ –∑ —ñ–∫–æ–Ω–∫–∞–º–∏ –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø—É
                        const iconNames = {
                            "–ö–∞–¥–∞—Å—Ç—Ä–æ–≤–∏–π –Ω–æ–º–µ—Ä": '<i class="bi bi-hash"></i> –ö–∞–¥–∞—Å—Ç—Ä–æ–≤–∏–π',
                            "–ù–æ–º–µ—Ä –∑–µ–º–µ–ª—å–Ω–æ—ó –¥—ñ–ª—è–Ω–∫–∏": '<i class="bi bi-123"></i> –ù–æ–º–µ—Ä –∑–µ–º–µ–ª—å–Ω–æ—ó –¥—ñ–ª—è–Ω–∫–∏',
                            "–ü–ª–æ—â–∞ –∑–µ–º–µ–ª—å–Ω–æ—ó –¥—ñ–ª—è–Ω–∫–∏": '<i class="bi bi-square"></i> –ü–ª–æ—â–∞ –∑–µ–º–µ–ª—å–Ω–æ—ó –¥—ñ–ª—è–Ω–∫–∏',
                            "–ü–ª–æ—â–∞ —Ä–æ–∑—Ä–∞—Ö–æ–≤–∞–Ω–∞": '<i class="bi bi-calculator"></i> –ü–ª–æ—â–∞',
                            "–ü–ª–æ—â–∞ —á–∞—Å—Ç–∏–Ω–∏": '<i class="bi bi-bounding-box"></i> –ü–ª–æ—â–∞ —á–∞—Å—Ç–∏–Ω–∏',
                            "–¶—ñ–ª—å–æ–≤–µ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è": '<i class="bi bi-bullseye"></i> –¶—ñ–ª—å–æ–≤–µ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è',
                            "–§–æ—Ä–º–∞ –≤–ª–∞—Å–Ω–æ—Å—Ç—ñ": '<i class="bi bi-building"></i> –§–æ—Ä–º–∞ –≤–ª–∞—Å–Ω–æ—Å—Ç—ñ',
                            "–í–ª–∞—Å–Ω–∏–∫": '<i class="bi bi-person-check"></i> –í–ª–∞—Å–Ω–∏–∫',
                            "–û—Ä–µ–Ω–¥–∞—Ä": '<i class="bi bi-person-workspace"></i> –û—Ä–µ–Ω–¥–∞—Ä',
                            "–û—Ä–µ–Ω–¥–∞—Ä —á–∞—Å—Ç–∏–Ω–∏": '<i class="bi bi-person-workspace"></i> –û—Ä–µ–Ω–¥–∞—Ä —á–∞—Å—Ç–∏–Ω–∏',
                            "–î–∞—Ç–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –æ—Ä–µ–Ω–¥–∏": '<i class="bi bi-calendar-check"></i> –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è',
                            "–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è": '<i class="bi bi-calendar-x"></i> –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—è',
                            "–í–∏–¥ –æ–±–º–µ–∂–µ–Ω–Ω—è": '<i class="bi bi-shield-exclamation"></i> –û–±–º–µ–∂–µ–Ω–Ω—è',
                            "–°—Ç–∞—Ç—É—Å": '<i class="bi bi-info-circle"></i> –°—Ç–∞—Ç—É—Å',
                            "–ù–∞–∑–≤–∞ –ø–æ–ª—è": '<i class="bi bi-geo"></i> –ù–∞–∑–≤–∞ –ø–æ–ª—è'
                        };
                        displayKey = iconNames[key] || key;
                    }
                    
                    tableRows.push({ displayKey, value });
                }
            });
            
            // –°—Ç–≤–æ—Ä—é—î–º–æ —Ä—è–¥–∫–∏ —Ç–∞–±–ª–∏—Ü—ñ –∑ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–º–∏ –∑–∞–æ–∫—Ä—É–≥–ª–µ–Ω–∏–º–∏ –∫—É—Ç–∞–º–∏
            tableRows.forEach((row, index) => {
                const isFirst = index === 0;
                const isLast = index === tableRows.length - 1;
                
                // Monobank-style popup —Å—Ç–∏–ª—ñ
                let propertyNameStyle = "background: #2C2C2E !important; color: #ABABAB !important; border: none !important; border-right: 1px solid rgba(255,255,255,0.08) !important; padding: 10px 14px !important; font-weight: 500 !important; text-align: left !important; vertical-align: middle !important; margin: 0 !important; font-size: 13px !important;";
                let propertyValueStyle = "border: none !important; padding: 10px 14px !important; background: #1C1C1E !important; color: #FFFFFF !important; vertical-align: middle !important; margin: 0 !important; font-size: 14px !important; font-weight: 500 !important;";
                
                // –î–æ–¥–∞—î–º–æ –≤–µ—Ä—Ö–Ω—ñ –∑–∞–æ–∫—Ä—É–≥–ª–µ–Ω—ñ –∫—É—Ç–∏ –¥–æ –ø–µ—Ä—à–æ–≥–æ —Ä—è–¥–∫–∞ (—Ç–µ–ø–µ—Ä –Ω–µ–º–∞—î –∑–∞–≥–æ–ª–æ–≤–∫–∞)
                if (isFirst) {
                    propertyNameStyle += " border-top-left-radius: 12px !important;";
                    propertyValueStyle += " border-top-right-radius: 12px !important;";
                }
                
                if (isLast) {
                    propertyNameStyle += " border-bottom-left-radius: 12px !important;";
                    propertyValueStyle += " border-bottom-right-radius: 12px !important;";
                } else {
                    propertyValueStyle += " border-bottom: 1px solid rgba(255,255,255,0.08) !important;";
                    propertyNameStyle += " border-bottom: 1px solid rgba(255,255,255,0.08) !important;";
                }
                
                popupContent += `<tr>
                    <td class="property-name" style="${propertyNameStyle}">${row.displayKey}:</td>
                    <td class="property-value" style="${propertyValueStyle}">${row.value}</td>
                </tr>`;
            });
            
            popupContent += '</table>';
            
            // –û—Ç—Ä–∏–º—É—î–º–æ –∫–∞–¥–∞—Å—Ç—Ä–æ–≤–∏–π –Ω–æ–º–µ—Ä –¥–ª—è –ø–æ—Å–∏–ª–∞–Ω—å
            const cadastralNumber = feature.properties["–ö–∞–¥–∞—Å—Ç—Ä–æ–≤–∏–π –Ω–æ–º–µ—Ä"];
            if (cadastralNumber) {
                const publicUrl = 'https://e.land.gov.ua/back/cadaster/?cad_num=' + cadastralNumber;
                popupContent += createPopupLinks(publicUrl, feature.properties["–î–∞—Ç–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è"]);
            }
            
            popupContent += '</div>';
            
            // –ê–¥–∞–ø—Ç–∏–≤–Ω—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è popup
            if (window.innerWidth <= 768) {
                // –î–ª—è –º–æ–±—ñ–ª—å–Ω–∏—Ö - –ø–æ–∫–∞–∑—É—î–º–æ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –Ω–∞ –≤–µ—Å—å –µ–∫—Ä–∞–Ω
                layer.on('click', function(e) {
                    showMobileModal(popupContent, feature.properties);
                });
                
                // –ü—Ä–∏–≤'—è–∑—É—î–º–æ –ø–æ—Ä–æ–∂–Ω—ñ–π –ø–æ–ø–∞–ø —â–æ–± –Ω–µ –±—É–ª–æ –ø–æ–º–∏–ª–æ–∫
                layer.bindPopup('', { maxWidth: 1, className: 'hidden-popup' });
            } else {
                // –î–ª—è –¥–µ—Å–∫—Ç–æ–ø—É - –∑–≤–∏—á–∞–π–Ω–∏–π –ø–æ–ø–∞–ø
                const popupOptions = { maxWidth: 350 };
                layer.bindPopup(popupContent, popupOptions);
            }
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –ø–æ–¥—Å–∫–∞–∑–æ–∫ –≤ popup
        document.addEventListener('DOMContentLoaded', function() {
            // ...existing code...
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª—å –¥–ª—è –ø–æ—è—Å–Ω–µ–Ω–∏–π –≤ popup
            const style = document.createElement('style');
            style.textContent = `
                .popup-content .text-muted {
                    color: #6c757d;
                    font-size: 0.85em;
                    font-style: italic;
                }
                
                /* –£–ª—É—á—à–∞–µ–º –≤–Ω–µ—à–Ω–∏–π –≤–∏–¥ —Ç–∞–±–ª–∏—Ü—ã —Å –ø–ª–æ—â–∞–¥—è–º–∏ */
                .popup-content tr:has(.property-name:contains("–ü–ª–æ—â–∞")) {
                    background-color: rgba(0,0,0,0.03);
                }
                
                /* –í—ã–¥–µ–ª—è–µ–º —Å—Ç—Ä–æ–∫—É —Å –ø–ª–æ—â–∞–¥—å—é —á–∞—Å—Ç–∏, –µ—Å–ª–∏ –æ–Ω–∞ –º–∞–ª–∞ –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å –æ–±—â–µ–π */
                .popup-content tr.small-part {
                    background-color: rgba(255,243,205,0.5);
                }
            `;
            document.head.appendChild(style);
        });
        
        function processAreaAndTenant(feature, layer) {
            // –î–ª—è split –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ä–µ–Ω–¥–∞—Ä—è —á–∞—Å—Ç–∏
            const tenant = feature.properties["–û—Ä–µ–Ω–¥–∞—Ä —á–∞—Å—Ç–∏–Ω–∏"] || feature.properties["–û—Ä–µ–Ω–¥–∞—Ä"];
            const selectedField = document.getElementById('fieldSelect').value;
            
            // –î–ª—è split –∏—Å–ø–æ–ª—å–∑—É–µ–º –ü–ª–æ—â–∞ —á–∞—Å—Ç–∏–Ω–∏
            const area = parseFloat(feature.properties["–ü–ª–æ—â–∞ —á–∞—Å—Ç–∏–Ω–∏"]);
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω—É–∂–Ω–æ –ª–∏ —Å—á–∏—Ç–∞—Ç—å —ç—Ç—É —á–∞—Å—Ç—å
            let shouldCount = false;
            
            if (selectedField) {
                // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –ø–æ–ª–µ, —Å—á–∏—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ —á–∞—Å—Ç–∏ —Å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π –ù–∞–∑–≤–∞ –ø–æ–ª—è
                shouldCount = (feature.properties["–ù–∞–∑–≤–∞ –ø–æ–ª—è"] === selectedField);
            } else {
                // –ï—Å–ª–∏ –ø–æ–ª–µ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ, —Å—á–∏—Ç–∞–µ–º –≤—Å–µ split-—á–∞—Å—Ç–∏
                shouldCount = true;
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø–ª–æ—â–∞–¥—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ —Å—á–∏—Ç–∞—Ç—å —ç—Ç—É —á–∞—Å—Ç—å
            if (shouldCount && !isNaN(area)) {
                if (!tenant) {
                    freeLayer.addLayer(layer);
                    freeArea += area;
                } else {
                    if (!tenantAreas[tenant]) tenantAreas[tenant] = 0;
                    tenantAreas[tenant] += area;
                }
            }
        }

        function clearOverlays() {
    // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –±–∞–∑–æ–≤—ñ —à–∞—Ä–∏ —Ç–∞ –ø–æ–ª—è
    const baseAndFieldLayers = {};
    
    // –ö–æ–ø—ñ—é—î–º–æ –±–∞–∑–æ–≤—ñ —à–∞—Ä–∏ —Ç–∞ –ø–æ–ª—è
    Object.entries(overlays).forEach(([key, layer]) => {
        if (key === "Google Maps" || 
            key === "OpenStreetMap" || 
            key === "–ê–∫—Ç—É–∞–ª—å–Ω—ñ —Ä–∞—Å—Ç—Ä–∏" || 
            key === "kadastr.live" || 
            key === "–ü–æ–ª—è –æ–±—Ä–æ–±—ñ—Ç–∫—É") {
            baseAndFieldLayers[key] = layer;
        } else {
            // –í–∏–¥–∞–ª—è—î–º–æ –∑ –∫–∞—Ä—Ç–∏ —Ç—ñ–ª—å–∫–∏ —à–∞—Ä–∏ –∑ –¥–∞–Ω–∏–º–∏
            map.removeLayer(layer);
        }
    });
    
    // –û—á–∏—â—É—î–º–æ overlays —ñ –≤—ñ–¥–Ω–æ–≤–ª—é—î–º–æ –±–∞–∑–æ–≤—ñ —à–∞—Ä–∏ —Ç–∞ –ø–æ–ª—è
    overlays = {...baseAndFieldLayers};
}

        function updateLayersControl() {
    if (layersControl) {
        map.removeControl(layersControl);
    }
    const allLayers = {...baseMaps, ...overlays};
    layersControl = L.control.layers(null, allLayers, {
        collapsed: true
    }).addTo(map);
    addTenantLayers();
    addFreeLayer();
    
    // –û–Ω–æ–≤–ª—é—î–º–æ –º–æ–±—ñ–ª—å–Ω—ñ —à–∞—Ä–∏ –ø—ñ—Å–ª—è –ø–æ–≤–Ω–æ–≥–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è layers control
    if (window.innerWidth <= 768 && typeof updateMobileLayers === 'function') {
        setTimeout(updateMobileLayers, 200); // –Ω–µ–≤–µ–ª–∏–∫–∞ –∑–∞—Ç—Ä–∏–º–∫–∞ –¥–ª—è –ø–æ–≤–Ω–æ–≥–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è
    }
}

        function addTenantLayers() {
            var tenantLayers = {};
            var selectedField = document.getElementById('fieldSelect').value;
            
            // –°–ø–æ—á–∞—Ç–∫—É –æ—á–∏—â–∞—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ –¥–∞–Ω—ñ
            tenantAreas = {};
            Object.values(overlays).forEach(layerGroup => {
                if (layerGroup && typeof layerGroup.eachLayer === 'function') {
                    layerGroup.eachLayer(layer => {
                        if (!layer.feature || !layer.feature.properties) return;
                        
                        // –ò—Å–ø–æ–ª—å–∑—É–µ–º "–û—Ä–µ–Ω–¥–∞—Ä —á–∞—Å—Ç–∏–Ω–∏" –∏–ª–∏ "–û—Ä–µ–Ω–¥–∞—Ä"
                        const tenant = layer.feature.properties["–û—Ä–µ–Ω–¥–∞—Ä —á–∞—Å—Ç–∏–Ω–∏"] || 
                                     layer.feature.properties["–û—Ä–µ–Ω–¥–∞—Ä"];
                        
                        // –ò—Å–ø–æ–ª—å–∑—É–µ–º "–ü–ª–æ—â–∞ —á–∞—Å—Ç–∏–Ω–∏" –¥–ª—è split
                        const area = parseFloat(layer.feature.properties["–ü–ª–æ—â–∞ —á–∞—Å—Ç–∏–Ω–∏"]);
                        
                        let shouldCount = false;
                        if (selectedField) {
                            // –ï—Å–ª–∏ –ø–æ–ª–µ –≤—ã–±—Ä–∞–Ω–æ, —É—á–∏—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —á–∞—Å—Ç–∏ —Å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π –ù–∞–∑–≤–∞ –ø–æ–ª—è
                            shouldCount = (layer.feature.properties["–ù–∞–∑–≤–∞ –ø–æ–ª—è"] === selectedField);
                        } else {
                            // –ï—Å–ª–∏ –ø–æ–ª–µ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ, —É—á–∏—Ç—ã–≤–∞–µ–º –≤—Å–µ split-—á–∞—Å—Ç–∏
                            shouldCount = true;
                        }
                        
                        if (tenant && !isNaN(area) && shouldCount) {
                            if (!tenantLayers[tenant]) {
                                tenantLayers[tenant] = L.layerGroup();
                                tenantAreas[tenant] = 0;
                            }
                            tenantAreas[tenant] += area;
                            tenantLayers[tenant].addLayer(layer);
                        }
                    });
                }
            });

            // –°–æ—Ä—Ç—É—î–º–æ –æ—Ä–µ–Ω–¥–∞—Ä—ñ–≤ –∑–∞ –ø–ª–æ—â–µ—é
            var sortedTenants = Object.entries(tenantAreas)
                .sort(([,a], [,b]) => b - a)
                .map(([tenant]) => tenant);

            // –î–æ–¥–∞—î–º–æ —à–∞—Ä–∏ –≤ –ø–æ—Ç—Ä—ñ–±–Ω–æ–º—É –ø–æ—Ä—è–¥–∫—É
            sortedTenants.forEach(tenant => {
                overlays[tenant] = tenantLayers[tenant];
                var colorBox = `<span class="color-box" style="background-color:${getColor(tenant)}"></span>`;
                layersControl.addOverlay(tenantLayers[tenant], 
                    colorBox + `<span class="layer-name">${tenant} (${tenantAreas[tenant].toFixed(2)} –≥–∞)</span>`);
                tenantLayers[tenant].addTo(map);
            });
            
            // –û–Ω–æ–≤–ª—é—î–º–æ –º–æ–±—ñ–ª—å–Ω—ñ —à–∞—Ä–∏ –ø—ñ—Å–ª—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è –æ—Ä–µ–Ω–¥–∞—Ä—ñ–≤
            if (window.innerWidth <= 768 && typeof updateMobileLayers === 'function') {
                updateMobileLayers();
            }
        }

        function addFreeLayer() {
            if (freeLayer.getLayers().length > 0) {
                overlays["–≤—ñ–ª—å–Ω—ñ –≤—ñ–¥ –æ—Ä–µ–Ω–¥–∏"] = freeLayer;
                var colorBox = '<span class="color-box" style="background-color:#ffffff"></span>';
                layersControl.addOverlay(freeLayer, colorBox + `<span class="layer-name">–≤—ñ–ª—å–Ω—ñ –≤—ñ–¥ –æ—Ä–µ–Ω–¥–∏ (${freeArea.toFixed(2)} –≥–∞)</span>`);
                
                // –û–Ω–æ–≤–ª—é—î–º–æ –º–æ–±—ñ–ª—å–Ω—ñ —à–∞—Ä–∏ –ø—ñ—Å–ª—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è –≤—ñ–ª—å–Ω–∏—Ö –≤—ñ–¥ –æ—Ä–µ–Ω–¥–∏
                if (window.innerWidth <= 768 && typeof updateMobileLayers === 'function') {
                    updateMobileLayers();
                }
            }
        }

        function updateFieldSelect(data) {
            var fieldSelect = document.getElementById('fieldSelect');
            fieldSelect.innerHTML = '<option value="">–í—Å—ñ –ø–æ–ª—è</option>';
            var uniqueFields = new Set();
            data.features.forEach(feature => {
                // –°–æ–±–∏—Ä–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏—è –ø–æ–ª–µ–π —Ç–æ–ª—å–∫–æ –∏–∑ split-—á–∞—Å—Ç–µ–π
                if (feature.properties?.type === 'split' && feature.properties?.['–ù–∞–∑–≤–∞ –ø–æ–ª—è']) {
                    uniqueFields.add(feature.properties['–ù–∞–∑–≤–∞ –ø–æ–ª—è']);
                }
            });
            Array.from(uniqueFields).sort().forEach(fieldName => {
                var option = document.createElement('option');
                option.value = fieldName;
                option.textContent = fieldName;
                fieldSelect.appendChild(option);
            });
        }

        function createPopupLinks(publicUrl, updateDate) {
            let content = '<div class="popup-link d-flex justify-content-between align-items-center" style="padding: 12px 14px; background: #2C2C2E; border-radius: 12px; margin-top: 8px;">';
            content += `<a href="${publicUrl}" target="_blank" title="—ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –∑ —Å–µ—Ä–≤—ñ—Å—ñ–≤ –î–ó–ö" style="color: #10B981; font-size: 20px;">`;
            content += '<i class="bi bi-info-circle"></i></a>';
            content += '<div class="text-end" style="color: #ABABAB; font-size: 13px;">';
            if (updateDate) {
                const [day, month, year] = updateDate.split('.').map(Number);
                const updateDateTime = new Date(year, month - 1, day);
                const twoMonthsAgo = new Date();
                twoMonthsAgo.setMonth(twoMonthsAgo.getMonth() - 2);
                content += updateDate;
                if (updateDateTime < twoMonthsAgo) {
                    content += ' <i class="bi bi-exclamation-triangle-fill" style="color: #F59E0B;" ' +
                              'title="–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –º–æ–∂–µ –±—É—Ç–∏ –∑–∞—Å—Ç–∞—Ä—ñ–ª–æ—é"></i>';
                }
            }
            content += '</div></div>';
            return content;
        }

        function addSearchControl(layer) {
            if (searchControl) {
                map.removeControl(searchControl);
            }
            
            searchControl = new L.Control.Search({
                layer: layer,
                propertyName: '_searchField',
                initial: false,
                textPlaceholder: '–ü–æ—à—É–∫ –∑–∞ –∫–∞–¥–∞—Å—Ç—Ä–æ–≤–∏–º –Ω–æ–º–µ—Ä–æ–º –∞–±–æ –≤–ª–∞—Å–Ω–∏–∫–æ–º',
                filterData: function(text, records) {
                    var jsons = records;
                    var ret = {};
                    
                    text = text.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                    var reg = new RegExp(text, 'i');
                    
                    for (var i in jsons) {
                        try {
                            var props = jsons[i].layer.feature?.properties || {};
                            var kadastrovyNomer = props['–ö–∞–¥–∞—Å—Ç—Ä–æ–≤–∏–π –Ω–æ–º–µ—Ä'] || '';
                            var vlasnyk = props['–í–ª–∞—Å–Ω–∏–∫'] || '';
                            if (reg.test(kadastrovyNomer) || reg.test(vlasnyk)) {
                                ret[i] = jsons[i];
                            }   
                        } catch (error) {
                            console.error('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ–±—Ä–æ–±—Ü—ñ –æ–±\'—î–∫—Ç–∞:', error, jsons[i]);
                        }       
                    }
                    return ret;
                },
                buildTip: function(text, val) {
                    try {
                        var props = val.layer.feature?.properties || {};
                        var kadastrovyNomer = props['–ö–∞–¥–∞—Å—Ç—Ä–æ–≤–∏–π –Ω–æ–º–µ—Ä'] || '–ù–µ –≤–∫–∞–∑–∞–Ω–æ';
                        var vlasnyk = props['–í–ª–∞—Å–Ω–∏–∫'] || '–ù–µ –≤–∫–∞–∑–∞–Ω–æ';
                        return '<a href="#">–ö–∞–¥–∞—Å—Ç—Ä–æ–≤–∏–π –Ω–æ–º–µ—Ä: ' + kadastrovyNomer + '<br>–í–ª–∞—Å–Ω–∏–∫: ' + vlasnyk + '</a>';
                    } catch (error) {
                        console.error('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ –ø—ñ–¥–∫–∞–∑–∫–∏:', error);
                        return '<a href="#">–ü–æ–º–∏–ª–∫–∞: –Ω–µ–º–æ–∂–ª–∏–≤–æ –≤—ñ–¥–æ–±—Ä–∞–∑–∏—Ç–∏ –¥–∞–Ω—ñ</a>';
                    }
                },
                moveToLocation: function(latlng, title, map) {
                    if (latlng.layer && latlng.layer.getBounds) {
                        map.fitBounds(latlng.layer.getBounds());
                    } else {
                        map.setView(latlng, 15);
                    }
                }
            });
            
            // –î–æ–¥–∞—î–º–æ search control —Ç—ñ–ª—å–∫–∏ –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø—ñ
            if (window.innerWidth > 768) {
                searchControl.addTo(map);
            }
            // –ù–∞ –º–æ–±—ñ–ª—å–Ω–∏—Ö –∑–±–µ—Ä—ñ–≥–∞—î–º–æ searchControl –¥–ª—è –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –≤ –º–æ–±—ñ–ª—å–Ω–æ–º—É —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ñ

            // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫ –¥–ª—è –∑–∞–∫—Ä–∏—Ç—Ç—è –º–æ–±—ñ–ª—å–Ω–æ–≥–æ –ø–æ—à—É–∫—É –ø—Ä–∏ –∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—ñ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É
            searchControl.on('search:locationfound', function() {
                if (window.innerWidth <= 768) {
                    setTimeout(() => {
                        closeMobileSearch();
                    }, 1000); // –ó–∞—Ç—Ä–∏–º–∫–∞ –¥–ª—è —Ç–æ–≥–æ —â–æ–± –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –ø–æ–±–∞—á–∏–≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                }
            });

            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∏—Å–∫–æ–≤–æ–µ –ø–æ–ª–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞
            layer.eachLayer(function(layer) {
                if (layer.feature?.properties) {
                    const props = layer.feature.properties;
                    const searchField = `${props['–ö–∞–¥–∞—Å—Ç—Ä–æ–≤–∏–π –Ω–æ–º–µ—Ä'] || ''} ${props['–í–ª–∞—Å–Ω–∏–∫'] || ''}`;
                    layer.feature.properties._searchField = searchField;
                }
            });
        }

        function updateDataFreshnessIndicator(data) {
            const indicator = document.getElementById('dataFreshnessText');
            const icon = document.querySelector('.data-freshness-indicator i');
            const freshnessContainer = document.querySelector('.data-freshness-indicator');
            
            // –Ø–∫—â–æ –µ–ª–µ–º–µ–Ω—Ç—ñ–≤ –Ω–µ–º–∞—î (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –Ω–∞ –º–æ–±—ñ–ª—å–Ω–∏—Ö), –ø—Ä–æ—Å—Ç–æ –≤–∏—Ö–æ–¥–∏–º–æ
            if (!indicator || !icon || !freshnessContainer) {
                console.log('Data freshness indicator not found, skipping update');
                return;
            }
            
            const datesInfo = data.features.reduce((acc, f) => {
                const date = f.properties?.["–î–∞—Ç–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è"];
                if (!date) {
                    acc.noDate++;
                    return acc;
                }
                const [day, month, year] = date.split('.').map(Number);
                const dateObj = new Date(year, month - 1, day);
                acc.dates.push(dateObj);
                return acc;
            }, { dates: [], noDate: 0 });
            const totalRecords = data.features.length;
            const { dates, noDate } = datesInfo;
            if (dates.length === 0 && noDate === totalRecords) {
                freshnessContainer.classList.add('freshness-–±–∞–¥');
                icon.title = `–ó–∞–ø–∏—Å—ñ–≤ –±–µ–∑ –¥–∞—Ç–∏ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è: ${noDate}`;
                return;
            }
            if (dates.length === 0 && noDate === 0) {
                indicator.textContent = '–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö';
                icon.className = 'bi bi-clock-history text-light me-1';
                freshnessContainer.classList.remove('freshness-–±–∞–¥');
                return;
            }
            const now = new Date();
            const stats = dates.reduce((acc, date) => {
                const monthsOld = (now - date) / (1000 * 60 * 60 * 24 * 30);
                if (monthsOld < 1) acc.fresh++;
                else if (monthsOld < 2) acc.medium++;
                else acc.old++;
                return acc;
            }, { fresh: 0, medium: 0, old: 0 });
            const freshPercent = Math.round((stats.fresh / totalRecords) * 100);
            const mediumPercent = Math.round((stats.medium / totalRecords) * 100);
            const oldPercent = Math.round((stats.old / totalRecords) * 100);
            const noDatePercent = Math.round((noDate / totalRecords) * 100);
            let text, className;
            if (freshPercent >= 70) {
                text = `–ê–∫—Ç—É–∞–ª—å–Ω–æ ${freshPercent}%`;
                className = 'freshness-good';
            } else if (freshPercent + mediumPercent >= 70) {
                text = `–î–æ 2 –º—ñ—Å ${freshPercent + mediumPercent}%`;
                className = 'freshness-warning';
            } else {
                text = `–ó–∞—Å—Ç–∞—Ä—ñ–ª–æ ${oldPercent}%`;
                className = 'freshness-–±–∞–¥';
                freshnessContainer.classList.add('freshness-–±–∞–¥');
            }
            if (className !== 'freshness-–±–∞–¥') {
                freshnessContainer.classList.remove('freshness-–±–∞–¥');
            }
            const tooltip = `–ê–∫—Ç—É–∞–ª—å–Ω–æ (–¥–æ 1 –º—ñ—Å): ${freshPercent}%\n` +
                           `–î–æ 2 –º—ñ—Å: ${mediumPercent}%\n` +
                           `–ó–∞—Å—Ç–∞—Ä—ñ–ª–æ: ${oldPercent}%\n` +
                           `–ë–µ–∑ –¥–∞—Ç–∏ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è: ${noDatePercent}%`;
            indicator.textContent = text;
            indicator.title = tooltip;
            icon.className = `bi bi-clock-history me-1 ${className}`;
            icon.title = tooltip;
        }

        // –ü—Ä–∏–º–µ—Ä –∫–Ω–æ–ø–∫–∏ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Å–Ω—è—Ç–∏—è –≤—ã–¥–µ–ª–µ–Ω–∏—è (–º–æ–∂–Ω–æ —É–±—Ä–∞—Ç—å –ø—Ä–∏ –Ω–µ–Ω–∞–¥–æ–±–Ω–æ—Å—Ç–∏)
        // function addClearSelectionButton() {
        //     const clearBtn = L.control({position: 'topleft'});
        //     clearBtn.onAdd = function() {
        //         const btn = L.DomUtil.create('button', 'btn btn-light');
        //         btn.innerText = '–û—á–∏—Å—Ç–∏—Ç–∏ –≤–∏–¥—ñ–ª–µ–Ω–Ω—è';
        //         L.DomEvent.on(btn, 'click', () => clearSelection());
        //         return btn;
        //     };
        //     clearBtn.addTo(map);
        // }

        // ...rest of your existing code...

        function exportSelectedToExcel() {
    const rows = [
        // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è split-–¥–∞–Ω–Ω—ã—Ö
        ["–ö–∞–¥–∞—Å—Ç—Ä–æ–≤–∏–π –Ω–æ–º–µ—Ä", "–ü–ª–æ—â–∞ —á–∞—Å—Ç–∏–Ω–∏", "–í–ª–∞—Å–Ω–∏–∫", "–û—Ä–µ–Ω–¥–∞—Ä —á–∞—Å—Ç–∏–Ω–∏", "–û—Ä–µ–Ω–¥–∞—Ä", "–°—Ç–∞—Ç—É—Å"]
    ];
    const uniqueFeatures = new Map();
    selectedFeatures.forEach(featureId => {
        Object.values(overlays).forEach(layerGroup => {
            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —â–æ —Ü–µ —à–∞—Ä –∑ –º–µ—Ç–æ–¥–æ–º eachLayer
            if (layerGroup && typeof layerGroup.eachLayer === 'function') {
                layerGroup.eachLayer(layer => {
                    if (L.stamp(layer) === featureId && layer.feature) {
                        const props = layer.feature.properties;
                        const kadNum = props["–ö–∞–¥–∞—Å—Ç—Ä–æ–≤–∏–π –Ω–æ–º–µ—Ä"];
                        if (kadNum && !uniqueFeatures.has(kadNum)) {
                            uniqueFeatures.set(kadNum, [
                                kadNum,
                                props["–ü–ª–æ—â–∞ —á–∞—Å—Ç–∏–Ω–∏"] || "",
                                props["–í–ª–∞—Å–Ω–∏–∫"] || "",
                                props["–û—Ä–µ–Ω–¥–∞—Ä —á–∞—Å—Ç–∏–Ω–∏"] || "",
                                props["–û—Ä–µ–Ω–¥–∞—Ä"] || "",
                                props["–°—Ç–∞—Ç—É—Å"] || ""
                            ]);
                        }
                    }
                });
            }
        });
    });
    uniqueFeatures.forEach(row => rows.push(row));
    if (rows.length < 2) {
        alert("–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –µ–∫—Å–ø–æ—Ä—Ç—É");
        return;
    }
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(rows);
    XLSX.utils.book_append_sheet(wb, ws, "Selected");
    XLSX.writeFile(wb, "–≤–∏–¥—ñ–ª–µ–Ω—ñ –¥—ñ–ª—è–Ω–∫–∏.xlsx");
}

        // –ü–æ—Å–ª–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–æ–±–∞–≤–∏—Ç—å:
        cadastralModal = document.getElementById("cadastralModal");
        let closeBtn = document.getElementsByClassName("close")[0];

        // –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∫–Ω–æ–ø–æ–∫
        document.getElementById('cadastralSearchButton').addEventListener('click', function() {
            clearCadastralLists();
            cadastralModal.style.display = "block";
        });

        document.getElementById('exportButton').addEventListener('click', function() {
            var offcanvas = bootstrap.Offcanvas.getInstance(document.getElementById('mainMenu'));
            offcanvas.hide();
            setTimeout(() => {
                var data = collectMapData();
                var selectedFile = document.getElementById('fileSelect').value;
                if (data.length > 0) {
                    var filename = selectedFile.replace('.geojson', '');
                    exportToExcel(data, filename);
                } else {
                    alert('–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –µ–∫—Å–ø–æ—Ä—Ç—É. –ë—É–¥—å –ª–∞—Å–∫–∞, –≤–∏–±–µ—Ä—ñ—Ç—å —Ñ–∞–π–ª –∑ –¥–∞–Ω–∏–º–∏ —Å–ø–æ—á–∞—Ç–∫—É.');
                }
            }, 300);
        });

        document.getElementById('statisticsButton').addEventListener('click', function() {
            var selectedFile = document.getElementById('fileSelect').value;
            if (selectedFile && selectedFile !== '–í–∏–±–µ—Ä—ñ—Ç—å —Ä–∞–¥—É') {
                const urlParams = new URLSearchParams(window.location.search);
                const id = urlParams.get('id');
                const statisticsUrl = `statistics.html?file=${encodeURIComponent(selectedFile)}${id ? `&id=${id}` : ''}`;
                window.location.href = statisticsUrl;
            } else {
                alert('–ë—É–¥—å –ª–∞—Å–∫–∞, —Å–ø–æ—á–∞—Ç–∫—É –≤–∏–±–µ—Ä—ñ—Ç—å —Ñ–∞–π–ª –∑ –¥–∞–Ω–∏–º–∏.');
            }
        });

        // –î–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –º–æ–¥–∞–ª—å–Ω—ã–º –æ–∫–Ω–æ–º –∫–∞–¥–∞—Å—Ç—Ä–æ–≤—ã—Ö –Ω–æ–º–µ—Ä–æ–≤
        closeBtn.onclick = function() {
            cadastralModal.style.display = "none";
            clearCadastralLists();
        }
        window.onclick = function(event) {
            if (event.target == cadastralModal) {
                cadastralModal.style.display = "none";
                clearCadastralLists();
            }
        }

        function clearCadastralLists() {
            document.getElementById("ownCadastralList").value = '';
            document.getElementById("othersCadastralList").value = '';
        }

        // –î–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –∫–∞—Ä—Ç—ã
        function collectMapData() {
            var data = [];
            var selectedFile = document.getElementById('fileSelect').value;
            if (originalGeoJsonData && originalGeoJsonData.features) {
                // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω—ñ –¥–∞–Ω—ñ –∑–∞–º—ñ—Å—Ç—å overlays
                originalGeoJsonData.features.forEach(feature => {
                    if (feature.properties && 
                        (!feature.properties.type || feature.properties.type === 'original')) {
                        data.push(feature.properties);
                    }
                });
            }
            return data;
        }

        // –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–∏—Å–∫–∞ –∫–∞–¥–∞—Å—Ç—Ä–æ–≤—ã—Ö –Ω–æ–º–µ—Ä–æ–≤
        document.getElementById('searchCadastral').addEventListener('click', function() {
            var ownCadastralText = document.getElementById("ownCadastralList").value;
            var othersCadastralText = document.getElementById("othersCadastralList").value;
            if (!ownCadastralText && !othersCadastralText) {
                alert('–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å —Ö–æ—á–∞ –± –æ–¥–∏–Ω –∫–∞–¥–∞—Å—Ç—Ä–æ–≤–∏–π –Ω–æ–º–µ—Ä');
                return;
            }
            var ownNumbers = ownCadastralText.split('\n')
                .map(num => num.trim())
                .filter(num => num.length > 0);
            var othersNumbers = othersCadastralText.split('\n')
                .map(num => num.trim())
                .filter(num => num.length > 0);

            // –û—á–∏—â–∞—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ –º–∞—Ä–∫–µ—Ä–∏
            ownMarkersLayer.clearLayers();
            othersMarkersLayer.clearLayers();
            
            var foundFeatures = new Map();
            Object.values(overlays).forEach(layerGroup => {
                if (layerGroup && typeof layerGroup.eachLayer === 'function') {
                    layerGroup.eachLayer(layer => {
                        if (layer.feature && layer.feature.properties) {
                            var kadNum = layer.feature.properties['–ö–∞–¥–∞—Å—Ç—Ä–æ–≤–∏–π –Ω–æ–º–µ—Ä'];
                            if (kadNum && !foundFeatures.has(kadNum)) {
                                var isOwn = ownNumbers.includes(kadNum);
                                var isOther = othersNumbers.includes(kadNum);
                                if (isOwn || isOther) {
                                    foundFeatures.set(kadNum, layer);
                                    var center = getPolygonCenter(layer);
                                    var marker = createMarker(center, kadNum, isOwn);
                                    marker.bindPopup(`
                                        <div style="font-size: 14px; font-weight: bold;">
                                            ${kadNum}
                                            <br>
                                            <span style="color: ${isOwn ? '#28a745' : '#dc3545'}">
                                                ${isOwn ? '–°–≤–æ—è –¥—ñ–ª—è–Ω–∫–∞' : '–ß—É–∂–∞ –¥—ñ–ª—è–Ω–∫–∞'}
                                            </span>
                                        </div>
                                    `, {
                                        offset: [0, -20]
                                    });
                                    
                                    marker.addTo(isOwn ? ownMarkersLayer : othersMarkersLayer);
                                }
                            }         
                        }
                    });
                }                     
            });

            if (foundFeatures.size > 0) {
                var group = L.featureGroup([ownMarkersLayer, othersMarkersLayer]);
                map.fitBounds(group.getBounds(), {
                    padding: [50, 50]
                });
                
                alert(`–ó–Ω–∞–π–¥–µ–Ω–æ ${foundFeatures.size} –¥—ñ–ª—è–Ω–æ–∫`);
                cadastralModal.style.display = "none";
                clearCadastralLists();
            } else {
                alert('–î—ñ–ª—è–Ω–æ–∫ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');
            }     
        });

        function createMarker(center, kadNum, isOwn) {
            var color = isOwn ? '#28a745' : '#dc3545';
            return L.marker(center, {
                icon: L.divIcon({
                    className: 'custom-div-icon',
                    html: `
                        <div style="
                            background-color: ${color};
                            width: 20px;
                            height: 20px;
                            border-radius: 50%;
                            border: 3px —Å–æ–ª—ñ–¥ white;
                            box-shadow: 0 0 4px rgba(0,0,0,0.5);
                            animation: pulse 2s infinite;
                        "></div>
                    `,
                    iconSize: [10, 10],
                    iconAnchor: [5, 5]
                })
            });
        }

        // –î–æ–±–∞–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é exportToExcel
        function exportToExcel(data, filename) {
            // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç, –≤—ã–≤–æ–¥–∏–º –æ—à–∏–±–∫—É
            if (data.length === 0) {
                alert('–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –µ–∫—Å–ø–æ—Ä—Ç—É. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —â–æ –Ω–∞ –∫–∞—Ä—Ç—ñ —î –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω—ñ –æ–±\'—î–∫—Ç–∏.');
                return;
            }
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –∫–∞–¥–∞—Å—Ç—Ä–æ–≤–æ–º—É –Ω–æ–º–µ—Ä—É
            data.sort((a, b) => {
                const kadNumA = a["–ö–∞–¥–∞—Å—Ç—Ä–æ–≤–∏–π –Ω–æ–º–µ—Ä"] || "";
                const kadNumB = b["–ö–∞–¥–∞—Å—Ç—Ä–æ–≤–∏–π –Ω–æ–º–µ—Ä"] || "";
                return kadNumA.localeCompare(kadNumB);
            });
            
            // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ –ø–æ–ª—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –Ω–∞—á–∞–ª–µ
            const priorityKeys = [
                "–ö–∞–¥–∞—Å—Ç—Ä–æ–≤–∏–π –Ω–æ–º–µ—Ä",
                "–ü–ª–æ—â–∞ —Ä–æ–∑—Ä–∞—Ö–æ–≤–∞–Ω–∞",
                "–ü–ª–æ—â–∞ —á–∞—Å—Ç–∏–Ω–∏", 
                "–í–ª–∞—Å–Ω–∏–∫",
                "–û—Ä–µ–Ω–¥–∞—Ä —á–∞—Å—Ç–∏–Ω–∏",
                "–û—Ä–µ–Ω–¥–∞—Ä",
                "–î–∞—Ç–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –æ—Ä–µ–Ω–¥–∏",
                "–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è",
                "–ù–∞–∑–≤–∞ –ø–æ–ª—è",
                "–°—Ç–∞—Ç—É—Å"
            ];
            
            // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∫–ª—é—á–∏ –∏–∑ –¥–∞–Ω–Ω—ã—Ö
            const allKeys = new Set();
            data.forEach(item => {
                Object.keys(item).forEach(key => {
                    // –ò—Å–∫–ª—é—á–∞–µ–º —Å–ª—É–∂–µ–±–Ω–æ–µ –ø–æ–ª–µ type
                    if (key !== 'type') {
                        allKeys.add(key);
                    }
                });
            });
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ–∑–∞—Ü–∏–µ–π
            const headers = [];
            
            // –°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ –ø–æ–ª—è
            priorityKeys.forEach(key => {
                if (allKeys.has(key)) {
                    headers.push(key);
                    allKeys.delete(key);
                }
            });
            
            // –ó–∞—Ç–µ–º –¥–æ–±–∞–≤–ª—è–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É
            Array.from(allKeys).sort().forEach(key => {
                headers.push(key);
            });
            
            // –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä–æ–∫–∏ –¥–ª—è Excel
            const rows = [headers];
            data.forEach(item => {
                const row = headers.map(header => item[header] || "");
                rows.push(row);
            });
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(rows);
            XLSX.utils.book_append_sheet(wb, ws, "–î—ñ–ª—è–Ω–∫–∏");
            XLSX.writeFile(wb, filename + ".xlsx");
        }

        // –î–æ–±–∞–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é searchCadastralNumbers
        function searchCadastralNumbers() {
            var ownCadastralText = document.getElementById("ownCadastralList").value;
            var othersCadastralText = document.getElementById("othersCadastralList").value;
            
            if (!ownCadastralText && !othersCadastralText) {
                alert('–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å —Ö–æ—á–∞ –± –æ–¥–∏–Ω –∫–∞–¥–∞—Å—Ç—Ä–æ–≤–∏–π –Ω–æ–º–µ—Ä');
                return;
            }

            var ownNumbers = ownCadastralText.split('\n')
                .map(num => num.trim())
                .filter(num => num.length > 0);
            var othersNumbers = othersCadastralText.split('\n')
                .map(num => num.trim())
                .filter(num => num.length > 0);

            // –û—á–∏—â–∞—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ –º–∞—Ä–∫–µ—Ä–∏
            ownMarkersLayer.clearLayers();
            othersMarkersLayer.clearLayers();
            
            var foundFeatures = new Map();
            
            Object.values(overlays).forEach(layerGroup => {
                if (layerGroup && typeof layerGroup.eachLayer === 'function') {
                    layerGroup.eachLayer(layer => {
                        if (layer.feature && layer.feature.properties) {
                            const kadNum = layer.feature.properties["–ö–∞–¥–∞—Å—Ç—Ä–æ–≤–∏–π –Ω–æ–º–µ—Ä"];
                            if (kadNum) {
                                const isOwn = ownNumbers.includes(kadNum);
                                const isOthers = othersNumbers.includes(kadNum);
                                
                                if (isOwn || isOthers) {
                                    foundFeatures.set(kadNum, layer);
                                    
                                    // –î–æ–¥–∞—î–º–æ –º–∞—Ä–∫–µ—Ä –¥–ª—è –∑–Ω–∞–π–¥–µ–Ω–æ—ó –¥—ñ–ª—è–Ω–∫–∏
                                    // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –¥–æ–ø–æ–º—ñ–∂–Ω—É —Ñ—É–Ω–∫—Ü—ñ—é –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Ü–µ–Ω—Ç—Ä–∞
                                    var center = getPolygonCenter(layer);
                                    var marker = createMarker(center, kadNum, isOwn);
                                    
                                    // –î–æ–¥–∞—î–º–æ –ø–æ–ø–∞–ø
                                    marker.bindPopup(`–ö–∞–¥–∞—Å—Ç—Ä–æ–≤–∏–π –Ω–æ–º–µ—Ä: ${kadNum}`, {
                                        offset: [0, -20]
                                    });
                                    
                                    marker.addTo(isOwn ? ownMarkersLayer : othersMarkersLayer);
                                }
                            }
                        }
                    });
                }                     
            });

            if (foundFeatures.size > 0) {
                // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ —î –º–∞—Ä–∫–µ—Ä–∏ –≤ —à–∞—Ä–∞—Ö –ø–µ—Ä–µ–¥ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è–º –≥—Ä—É–ø–∏ —ñ –≤–∏–∫–ª–∏–∫–æ–º getBounds()
                if (ownMarkersLayer.getLayers().length > 0 || othersMarkersLayer.getLayers().length > 0) {
                    var group = L.featureGroup([ownMarkersLayer, othersMarkersLayer]);
                    map.fitBounds(group.getBounds(), {
                        padding: [50, 50]
                    });
                }
                
                alert(`–ó–Ω–∞–π–¥–µ–Ω–æ ${foundFeatures.size} –¥—ñ–ª—è–Ω–æ–∫`);
                cadastralModal.style.display = "none";
                clearCadastralLists();
            } else {
                alert('–î—ñ–ª—è–Ω–æ–∫ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');
            }     
        }

        function calculatePolygonArea(layer) {
            var area = L.GeometryUtil.geodesicArea(layer.getLatLngs()[0]);
            return (area / 10000).toFixed(4); // –ü–µ—Ä–µ–≤–æ–¥ –≤ –≥–µ–∫—Ç–∞—Ä—ã
        }

        function updateAreaPopup(layer) {
            var areaInHectares = calculatePolygonArea(layer);
            layer.setPopupContent('–ü–ª–æ—â–∞: ' + areaInHectares + ' –≥–∞');
        }

        function exportToGeoJSON() {
            var modal = document.getElementById('exportModal');
            var span = modal.getElementsByClassName("close")[0];
            var confirmBtn = document.getElementById('confirmExport');
            var filenameInput = document.getElementById('exportFilename');
            var formatSelect = document.getElementById('exportFormat');
            var polygonsList = document.getElementById('polygonsList');

            var defaultFilename = 'polygons_' + new Date().toISOString().slice(0,10);
            filenameInput.value = defaultFilename;
            polygonsList.innerHTML = '';
            var index = 1;
            editableLayers.eachLayer(function(layer) {
                if (layer instanceof L.Polygon) {
                    var area = calculatePolygonArea(layer);
                    var polygonItem = document.createElement('div');
                    polygonItem.className = 'list-group-item';
                    polygonItem.innerHTML = `
                        <div class="mb-2">
                            <strong>–ü–æ–ª—ñ–≥–æ–Ω ${index} (${area} –≥–∞)</strong>
                        </div>
                        <div class="form-group">
                            <textarea class="form-control polygon-note" 
                                     data-layer-id="${L.stamp(layer)}" 
                                     placeholder="–ü—Ä–∏–º—ñ—Ç–∫–∞ –¥–ª—è –ø–æ–ª—ñ–≥–æ–Ω—É ${index}..."
                                     rows="2"></textarea>
                        </div>
                    `;
                    polygonsList.appendChild(polygonItem);
                    index++;
                }
            });
            modal.style.display = "block";
            span.onclick = function() {
                modal.style.display = "none";
                filenameInput.value = '';
            }
            window.onclick = function(event) {
                if (event.target == modal) {
                    modal.style.display = "none";
                    filenameInput.value = '';
                }
            }
            confirmBtn.onclick = function() {
                var geojson = editableLayers.toGeoJSON();
                var notesMap = {};
                document.querySelectorAll('.polygon-note').forEach(function(textarea) {
                    notesMap[textarea.dataset.layerId] = textarea.value;
                });
                geojson.features.forEach(function(feature, index) {
                    if (!feature.properties) {
                        feature.properties = {};
                    }
                    var layer = editableLayers.getLayers()[index];
                    var layerId = L.stamp(layer);
                    if (feature.geometry && feature.geometry.type === 'Polygon') {
                        feature.properties.note = notesMap[layerId] || '';
                        feature.geometry.coordinates[0].forEach(function(coord) {
                            let lat, lng;
                            [lng, lat] = coord;
                            return [lat, lng];
                        });
                        var area = L.GeometryUtil.geodesicArea(feature.geometry.coordinates[0].map(coord => L.latLng(coord[1], coord[0])));
                        feature.properties.area = (area / 10000).toFixed(4);
                    }
                });
                var filename = filenameInput.value || defaultFilename;
                var format = formatSelect.value;
                if (format === 'kml') {
                    if (!filename.endsWith('.kml')) filename += '.kml';
                    var kml = convertToKML(geojson);
                    var dataStr = "data:text/xml;charset=utf-8," + encodeURIComponent(kml);
                } else {
                    if (!filename.endsWith('.geojson')) filename += '.geojson';
                    var dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(geojson));
                }
                var downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", filename);
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
                modal.style.display = "none";
                filenameInput.value = '';
            }
        }

        function convertToKML(geojson) {
            var kml = '<?xml version="1.0" encoding="UTF-8"?>\n<kml xmlns="http://www.opengis.net/kml/2.2">\n<Document>\n';
            geojson.features.forEach(function(feature, index) {
                kml += '  <Placemark>\n';
                kml += '    <name>–ü–æ–ª—ñ–≥–æ–Ω ' + (index + 1) + '</name>\n';
                kml += '    <description><![CDATA[';
                kml += '–ü–ª–æ—â–∞: ' + (feature.properties.area || '0') + ' –≥–∞<br>';
                kml += '–ü—Ä–∏–º—ñ—Ç–∫–∞: ' + (feature.properties.note || '');
                kml += ']]></description>\n';
                kml += '    <Style><LineStyle><color>ff000000</color><width>2</width></LineStyle>';
                kml += '<PolyStyle><color>4d0000ff</color></PolyStyle></Style>\n';
                if (feature.geometry && feature.geometry.type === 'Polygon') {
                    kml += '    <Polygon><outerBoundaryIs><LinearRing><coordinates>\n';
                    feature.geometry.coordinates[0].forEach(function(coord) {
                        kml += '      ' + coord[0] + ',' + coord[1] + ',0\n';
                    });
                    kml += '    </coordinates></LinearRing></outerBoundaryIs></Polygon>\n';
                }
                kml += '  </Placemark>\n';
            });
            kml += '</Document>\n</kml>';
            return kml;
        }

        // –î–æ–¥–∞–π—Ç–µ –Ω–æ–≤—ñ —Ñ—É–Ω–∫—Ü—ñ—ó –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–∞–π–ª—ñ–≤
        function showLoadModal() {
    var modal = document.getElementById('loadModal');
    modal.style.display = "block"; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    
    var fileInput = document.getElementById('fileInput');
    fileInput.value = ''; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
    
    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    var span = modal.getElementsByClassName("close")[0];
    span.onclick = function() {
        modal.style.display = "none"; // –ó–∞–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∫—Ä–µ—Å—Ç–∏–∫
    }
    
    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = "none"; // –ó–∞–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        }
    }
    
    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏
    var confirmBtn = document.getElementById('confirmLoad');
    confirmBtn.onclick = function() {
        var file = fileInput.files[0];
        var clearExisting = document.getElementById('clearExisting').checked;
        if (file) {
            var reader = new FileReader();
            
            if (file.name.toLowerCase().endsWith('.kmz')) {
                // –î–ª—è KMZ —Ñ–∞–π–ª–æ–≤ —á–∏—Ç–∞–µ–º –∫–∞–∫ ArrayBuffer
                reader.onload = function(e) {
                    loadPolygonsFromFile(e.target.result, file.name, clearExisting);
                };
                reader.readAsArrayBuffer(file);
            } else {
                // –î–ª—è KML –∏ GeoJSON —á–∏—Ç–∞–µ–º –∫–∞–∫ —Ç–µ–∫—Å—Ç
                reader.onload = function(e) {
                    loadPolygonsFromFile(e.target.result, file.name, clearExisting);
                };
                reader.readAsText(file);
            }
        } else {
            alert('–í–∏–±–µ—Ä—ñ—Ç—å —Ñ–∞–π–ª –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è');
        }
        modal.style.display = "none";
    }
}

        function loadPolygonsFromFile(content, filename, clearExisting) {       
    var data;
    try {
        if (filename.toLowerCase().endsWith('.kmz')) {
            // –î–ª—è KMZ —Ñ–∞–π–ª–æ–≤ —Å–Ω–∞—á–∞–ª–∞ —Ä–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º –∞—Ä—Ö–∏–≤
            JSZip.loadAsync(content) // content –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å ArrayBuffer –∏–ª–∏ Blob –¥–ª—è KMZ
                .then(function(zip) {
                    // –ò—â–µ–º —Ñ–∞–π–ª doc.kml –∏–ª–∏ –ø–µ—Ä–≤—ã–π .kml —Ñ–∞–π–ª –≤ –∞—Ä—Ö–∏–≤–µ
                    var kmlFile = zip.file('doc.kml');
                    if (!kmlFile) {
                        // –ï—Å–ª–∏ doc.kml –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—â–µ–º –ª—é–±–æ–π .kml —Ñ–∞–π–ª
                        Object.keys(zip.files).forEach(function(filename) {
                            if (filename.toLowerCase().endsWith('.kml') && !kmlFile) {
                                kmlFile = zip.file(filename);
                            }
                        });
                    }
                    
                    if (!kmlFile) {
                        throw new Error('KML —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω –≤–Ω—É—Ç—Ä–∏ KMZ –∞—Ä—Ö–∏–≤–∞');
                    }
                    
                    return kmlFile.async('text');
                })
                .then(function(kmlContent) {
                    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º KML —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
                    var parser = new DOMParser();
                    var kml = parser.parseFromString(kmlContent, 'text/xml');
                    var geoJsonData = toGeoJSON.kml(kml);
                    processGeoJsonData(geoJsonData, clearExisting);
                })
                .catch(function(error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ KMZ —Ñ–∞–π–ª–∞:', error);
                    alert('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ–±—Ä–æ–±—Ü—ñ KMZ —Ñ–∞–π–ª—É: ' + error.message);
                });
            return; // –í—ã—Ö–æ–¥–∏–º, —Ç.–∫. –æ–±—Ä–∞–±–æ—Ç–∫–∞ KMZ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è
        } else if (filename.toLowerCase().endsWith('.kml')) {
            var parser = new DOMParser();
            var kml = parser.parseFromString(content, 'text/xml');
            data = toGeoJSON.kml(kml);
        } else {
            // –î–ª—è GeoJSON
            data = JSON.parse(content);
        }

        processGeoJsonData(data, clearExisting);
        
    } catch (error) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–∞–π–ª—É:', error);
        alert('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–∞–π–ª—É. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª—É.');
    }
}

// –í—ã–¥–µ–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É GeoJSON –≤ –æ—Ç–¥–µ–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
function processGeoJsonData(data, clearExisting) {
    if (clearExisting) {
        editableLayers.clearLayers();
    }

    if (data.features && Array.isArray(data.features)) {
        let addedPolygons = 0;
        data.features.forEach(function(feature) {
            if (feature.geometry && 
                (feature.geometry.type === 'Polygon' || feature.geometry.type === 'MultiPolygon')) {
                try {
                    let polygonCoordinates = [];
                    if (feature.geometry.type === 'Polygon') {
                        polygonCoordinates = [feature.geometry.coordinates[0]];
                    } else if (feature.geometry.type === 'MultiPolygon') {
                        polygonCoordinates = feature.geometry.coordinates[0];
                    }
                    polygonCoordinates.forEach((coordinates) => {
                        let latLngs = coordinates.map(coord => {
                            return L.latLng(coord[1], coord[0]); // –ö–æ–Ω–≤–µ—Ä—Ç—É—î–º–æ –≤ latLng
                        });
                        
                        if (latLngs.length >= 3) {
                            const polygon = L.polygon(latLngs, {
                                color: '#3388ff',
                                weight: 2
                            });
                            
                            // –î–æ–¥–∞—î–º–æ –ø–ª–æ—â—É
                            const area = L.GeometryUtil.geodesicArea(latLngs);
                            const areaInHectares = (area / 10000).toFixed(4);
                            polygon.bindPopup('–ü–ª–æ—â–∞: ' + areaInHectares + ' –≥–∞');
                            
                            editableLayers.addLayer(polygon);
                            addedPolygons++;
                        }
                    });
                } catch (e) {
                    console.error('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ–±—Ä–æ–±—Ü—ñ –ø–æ–ª—ñ–≥–æ–Ω—É:', e);
                }
            }
        });

        if (addedPolygons > 0) {
            map.fitBounds(editableLayers.getBounds(), {
                padding: [50, 50]
            });
            alert(`–£—Å–ø—ñ—à–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ ${addedPolygons} –ø–æ–ª—ñ–≥–æ–Ω—ñ–≤`);
        } else {
            alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∂–æ–¥–Ω–æ–≥–æ –ø–æ–ª—ñ–≥–æ–Ω—É');
        }
    } else {
        alert('–§–∞–π–ª –º–∞—î –Ω–µ–≤—ñ—Ä–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç');
    }
}

        function updateExpiryYearSelect(data) {
            var expiryYearSelect = document.getElementById('expiryYearSelect');
            expiryYearSelect.innerHTML = '<option value="">–í—Å—ñ —Ä–æ–∫–∏</option>';
            expiryYearSelect.innerHTML += '<option value="no_date">–ë–µ–∑ –¥–∞—Ç–∏</option>'; // –î–æ–±–∞–≤–ª—è–µ–º –æ–ø—Ü–∏—é "–ë–µ–∑ –¥–∞—Ç–∏"
            var uniqueYears = new Set();
            data.features.forEach(feature => {
                // –°–æ–±–∏—Ä–∞–µ–º –≥–æ–¥—ã –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –∏–∑ split-—á–∞—Å—Ç–µ–π
                if (feature.properties?.type === 'split' && feature.properties?.['–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è']) {
                    const dateStr = feature.properties['–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è'];
                    const year = dateStr.split('.')[2];
                    if (year) {
                        uniqueYears.add(year);
                    }
                }
            });
            Array.from(uniqueYears).sort().forEach(year => {
                var option = document.createElement('option');
                option.value = year;
                option.textContent = year + ' —Ä—ñ–∫';
                expiryYearSelect.appendChild(option);
            });
        }

        // –î–æ–¥–∞—î–º–æ –Ω–æ–≤—É —Ñ—É–Ω–∫—Ü—ñ—é –¥–ª—è –∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è —Å–ø–∏—Å–∫—É —Ä–æ–∫–∞–º–∏ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –æ—Ä–µ–Ω–¥–∏
        function updateRegistrationYearSelect(data) {
            var registrationYearSelect = document.getElementById('registrationYearSelect');
            registrationYearSelect.innerHTML = '<option value="">–í—Å—ñ —Ä–æ–∫–∏</option>';
            registrationYearSelect.innerHTML += '<option value="no_date">–ë–µ–∑ –¥–∞—Ç–∏</option>'; 
            var uniqueYears = new Set();
            data.features.forEach(feature => {
                // –°–æ–±–∏—Ä–∞–µ–º –≥–æ–¥—ã —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Ç–æ–ª—å–∫–æ –∏–∑ split-—á–∞—Å—Ç–µ–π
                if (feature.properties?.type === 'split' && feature.properties?.['–î–∞—Ç–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –æ—Ä–µ–Ω–¥–∏']) {
                    const dateStr = feature.properties['–î–∞—Ç–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –æ—Ä–µ–Ω–¥–∏'];
                    const year = dateStr.split('.')[2];
                    if (year) {
                        uniqueYears.add(year);
                    }
                }
            });
            Array.from(uniqueYears).sort().forEach(year => {
                var option = document.createElement('option');
                option.value = year;
                option.textContent = year + ' —Ä—ñ–∫';
                registrationYearSelect.appendChild(option);
            });
        }

        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è —Å–ø–∏—Å–∫—É —Ü—ñ–ª—å–æ–≤–æ–≥–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è
        function updateLandUseSelect(data) {
            var landUseSelect = document.getElementById('landUseSelect');
            landUseSelect.innerHTML = '<option value="">–í—Å—ñ —Ç–∏–ø–∏</option>';
            landUseSelect.innerHTML += '<option value="no_data">–ë–µ–∑ –¥–∞–Ω–∏—Ö</option>';
            var uniqueUses = new Set();
            data.features.forEach(feature => {
                if (feature.properties?.type === 'split' && feature.properties?.['–¶—ñ–ª—å–æ–≤–µ']) {
                    uniqueUses.add(feature.properties['–¶—ñ–ª—å–æ–≤–µ']);
                }
            });
            Array.from(uniqueUses).sort().forEach(use => {
                var option = document.createElement('option');
                option.value = use;
                // –°–∫–æ—Ä–æ—á—É—î–º–æ –¥–æ–≤–≥—ñ –Ω–∞–∑–≤–∏ –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è
                option.textContent = use.length > 50 ? use.substring(0, 47) + '...' : use;
                option.title = use; // –ü–æ–≤–Ω–∞ –Ω–∞–∑–≤–∞ —É —Ç—É–ª—Ç–∏–ø—ñ
                landUseSelect.appendChild(option);
            });
        }

        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—ó –∑–∞ —Ü—ñ–ª—å–æ–≤–∏–º –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è–º
        function filterByLandUse(feature, selectedLandUse) {
            if (!selectedLandUse) return true;
            if (selectedLandUse === 'no_data') {
                // –ü–æ–∫–∞–∑–∞—Ç–∏ —Ç—ñ–ª—å–∫–∏ –∑–∞–ø–∏—Å–∏ –±–µ–∑ –¥–∞–Ω–∏—Ö —Ü—ñ–ª—å–æ–≤–æ–≥–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è
                return !feature.properties?.['–¶—ñ–ª—å–æ–≤–µ'];
            }
            return feature.properties?.['–¶—ñ–ª—å–æ–≤–µ'] === selectedLandUse;
        }

        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—ó –∑–∞ –¥—ñ–∞–ø–∞–∑–æ–Ω–æ–º –ø–ª–æ—â—ñ –î–ó–ö
        function filterByAreaRange(feature, minArea, maxArea) {
            const area = parseFloat(feature.properties?.['–ü–ª–æ—â–∞ –î–ó–ö']);
            if (isNaN(area)) return true; // –Ø–∫—â–æ –ø–ª–æ—â–∞ –Ω–µ –≤–∏–∑–Ω–∞—á–µ–Ω–∞, –ø–æ–∫–∞–∑—É—î–º–æ
            
            const min = parseFloat(minArea);
            const max = parseFloat(maxArea);
            
            if (!isNaN(min) && area < min) return false;
            if (!isNaN(max) && area > max) return false;
            
            return true;
        }

        // –£–Ω—ñ–≤–µ—Ä—Å–∞–ª—å–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è –¥–ª—è –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è –≤—Å—ñ—Ö —Ñ—ñ–ª—å—Ç—Ä—ñ–≤
        function applyAllFilters() {
            var selectedField = document.getElementById('fieldSelect').value;
            var selectedFile = document.getElementById('fileSelect').value;
            var selectedExpiryYear = document.getElementById('expiryYearSelect').value;
            var selectedRegistrationYear = document.getElementById('registrationYearSelect').value;
            var selectedLandUse = document.getElementById('landUseSelect').value;
            var areaMin = document.getElementById('areaMinInput').value;
            var areaMax = document.getElementById('areaMaxInput').value;
            
            if (selectedFile !== '–í–∏–±–µ—Ä—ñ—Ç—å —Ä–∞–¥—É' && originalGeoJsonData) {
                clearOverlays();
                tenantAreas = {};
                freeArea = 0;
                selectedFeatures.clear();
                
                const filteredFeatures = originalGeoJsonData.features.filter(feature => {
                    if (feature.properties?.type !== 'split') return false;
                    
                    const fieldMatch = !selectedField || feature.properties?.['–ù–∞–∑–≤–∞ –ø–æ–ª—è'] === selectedField;
                    const expiryYearMatch = filterByExpiryYear(feature, selectedExpiryYear);
                    const registrationYearMatch = filterByRegistrationYear(feature, selectedRegistrationYear);
                    const landUseMatch = filterByLandUse(feature, selectedLandUse);
                    const areaMatch = filterByAreaRange(feature, areaMin, areaMax);
                    
                    return fieldMatch && expiryYearMatch && registrationYearMatch && landUseMatch && areaMatch;
                });
                
                const filteredData = {
                    type: "FeatureCollection",
                    features: filteredFeatures
                };
                
                var geoJsonLayer = L.geoJSON(filteredData, {
                    style: styleFeature,
                    onEachFeature: onEachFeature
                });
                
                overlays[selectedFile] = geoJsonLayer;
                geoJsonLayer.addTo(map);
                
                if (geoJsonLayer.getBounds().isValid()) {
                    map.fitBounds(geoJsonLayer.getBounds());
                }
                
                updateLayersControl();
                addSearchControl(geoJsonLayer);
                updateDataFreshnessIndicator(filteredData);
            }
        }

        // –§—É–Ω–∫—Ü—ñ—è —Å–∫–∏–¥–∞–Ω–Ω—è –≤—Å—ñ—Ö —Ñ—ñ–ª—å—Ç—Ä—ñ–≤
        function resetAllFilters() {
            // –°–∫–∏–¥–∞—î–º–æ –≤—Å—ñ select-–∏ –Ω–∞ –ø–µ—Ä—à–µ –∑–Ω–∞—á–µ–Ω–Ω—è
            document.getElementById('fieldSelect').value = '';
            document.getElementById('expiryYearSelect').value = '';
            document.getElementById('registrationYearSelect').value = '';
            document.getElementById('landUseSelect').value = '';
            
            // –û—á–∏—â–∞—î–º–æ –ø–æ–ª—è –ø–ª–æ—â—ñ
            document.getElementById('areaMinInput').value = '';
            document.getElementById('areaMaxInput').value = '';
            
            // –ó–∞—Å—Ç–æ—Å–æ–≤—É—î–º–æ —Ñ—ñ–ª—å—Ç—Ä–∏ (–∑ –ø–æ—Ä–æ–∂–Ω—ñ–º–∏ –∑–Ω–∞—á–µ–Ω–Ω—è–º–∏ - –ø–æ–∫–∞–∂–µ –≤—Å–µ)
            applyAllFilters();
        }

        // –û–±—Ä–æ–±–Ω–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Å–∫–∏–¥–∞–Ω–Ω—è –≤—Å—ñ—Ö —Ñ—ñ–ª—å—Ç—Ä—ñ–≤
        document.getElementById('resetAllFiltersBtn').addEventListener('click', function() {
            resetAllFilters();
        });

        // –û–±—Ä–æ–±–Ω–∏–∫ –¥–ª—è —Ñ—ñ–ª—å—Ç—Ä–∞ —Ü—ñ–ª—å–æ–≤–æ–≥–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è
        document.getElementById('landUseSelect').addEventListener('change', function() {
            applyAllFilters();
        });

        // –û–±—Ä–æ–±–Ω–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è —Ñ—ñ–ª—å—Ç—Ä–∞ –ø–ª–æ—â—ñ
        document.getElementById('applyAreaFilterBtn').addEventListener('click', function() {
            applyAllFilters();
        });

        // –¢–∞–∫–æ–∂ –∑–∞—Å—Ç–æ—Å–æ–≤—É—î–º–æ —Ñ—ñ–ª—å—Ç—Ä –ø–ª–æ—â—ñ –ø—Ä–∏ –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—ñ Enter –≤ –ø–æ–ª—è—Ö –≤–≤–µ–¥–µ–Ω–Ω—è
        document.getElementById('areaMinInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                applyAllFilters();
            }
        });

        document.getElementById('areaMaxInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                applyAllFilters();
            }
        });

        document.getElementById('expiryYearSelect').addEventListener('change', function() {
            applyAllFilters();
        });

        // –û–±—Ä–æ–±–Ω–∏–∫ –¥–ª—è —Ñ—ñ–ª—å—Ç—Ä–∞ –¥–∞—Ç–∏ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –æ—Ä–µ–Ω–¥–∏
        document.getElementById('registrationYearSelect').addEventListener('change', function() {
            applyAllFilters();
        });

        // –ú–æ–¥–∏—Ñ—ñ–∫—É—î–º–æ —ñ—Å–Ω—É—é—á–∏–π –æ–±—Ä–æ–±–Ω–∏–∫ –∑–º—ñ–Ω–∏ fieldSelect
        document.getElementById('fieldSelect').addEventListener('change', function() {
            applyAllFilters();
        });

        // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –≤–∏–¥—ñ–ª–µ–Ω–Ω—è
        document.querySelector('[data-action="clear-selection"]')?.addEventListener('click', clearSelection);
        document.querySelector('[data-action="export-selected"]')?.addEventListener('click', exportSelectedToExcel);
    }; // –ó–∞–∫—Ä—ã–≤–∞—é—â–∞—è —Å–∫–æ–±–∫–∞ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ DOMContentLoaded

    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ - –¥–æ–±–∞–≤–∏—Ç—å –≤ –Ω–∞—á–∞–ª–æ —Å–∫—Ä–∏–ø—Ç–∞, —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
    function clearCadastralLists() {
        document.getElementById("ownCadastralList").value = '';
        document.getElementById("othersCadastralList").value = '';
    }

    function createMarker(center, kadNum, isOwn) {
        var color = isOwn ? '#28a745' : '#dc3545';
        return L.marker(center, {
            icon: L.divIcon({
                className: 'custom-div-icon',
                html: `
                    <div style="
                        background-color: ${color};
                        width: 20px;
                        height: 20px;
                        border-radius: 50%;
                        border: 3px solid white;
                        box-shadow: 0 0 4px rgba(0,0,0,0.5);
                        animation: pulse 2s infinite;
                    "></div>
                `,
                iconSize: [10, 10],
                iconAnchor: [5, 5]
            })
        });
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ü–µ–Ω—Ç—Ä–∞ –ø–æ–ª–∏–≥–æ–Ω–∞
    function getPolygonCenter(layer) {
        if (layer.getBounds) {
            return layer.getBounds().getCenter();
        }
        // –ï—Å–ª–∏ getBounds –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω, –≤—ã—á–∏—Å–ª—è–µ–º —Ü–µ–Ω—Ç—Ä –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º
        const latLngs = layer.getLatLngs()[0];
        const sumLat = latLngs.reduce((sum, point) => sum + point.lat, 0);
        const sumLng = latLngs.reduce((sum, point) => sum + point.lng, 0);
        return L.latLng(sumLat / latLngs.length, sumLng / latLngs.length);
    }

    // –í —Ñ—É–Ω–∫—Ü–∏–∏ searchCadastralNumbers –∑–∞–º–µ–Ω–∏—Ç—å layer.getBounds().getCenter() –Ω–∞:
    // var center = getPolygonCenter(layer);

    // ...rest of your existing code...

    function getBoundsFromLayers(layers) {
        let bounds = null;
        layers.forEach(layer => {
            if (layer.getBounds) {
                const layerBounds = layer.getBounds();
                if (bounds === null) {
                    bounds = layerBounds;
                } else {
                    bounds.extend(layerBounds);
                }
            }
        });
        return bounds;
    }

document.getElementById('exchangeButton').addEventListener('click', function() {
    var offcanvas = bootstrap.Offcanvas.getInstance(document.getElementById('mainMenu'));
    offcanvas.hide();
    setTimeout(() => {
        // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ
        document.getElementById('exchangeList').value = '';
        document.getElementById('tenantSelections').innerHTML = '';
        document.getElementById('exchangeTableContainer').style.display = 'none';
        document.getElementById('exchangeInputContainer').style.display = 'block';
        document.getElementById('notFoundSummary').style.display = 'none';
        selectedTenantsData = [];
        
        // –ó–∞–ø–æ–ª–Ω—è–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –æ—Ä–µ–Ω–¥–∞—Ä–µ–π
        populateTenantDropdown();
        
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        document.getElementById('exchangeModal').style.display = "block";
    }, 300);
});

// –û–±—Ä–æ–±–Ω–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –¥–µ–±–∞–≥—É
document.getElementById('debugButton').addEventListener('click', function() {
    const debugInfo = {
        userAgent: navigator.userAgent,
        isIOS: /iPad|iPhone|iPod/.test(navigator.userAgent),
        isPWA: window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true,
        currentURL: window.location.href,
        storedClientId: localStorage.getItem('client_id'),
        currentId: id,
        dataPath: dataPath,
        localStorageSupported: typeof(Storage) !== "undefined"
    };
    
    const debugText = JSON.stringify(debugInfo, null, 2);
    
    // –°—Ç–≤–æ—Ä—é—î–º–æ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –∑ –¥–µ–±–∞–≥ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—î—é
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0,0,0,0.5); z-index: 10000; display: flex; 
        align-items: center; justify-content: center; padding: 20px;
    `;
    modal.innerHTML = `
        <div style="background: white; padding: 20px; border-radius: 8px; max-width: 90%; max-height: 80%; overflow: auto;">
            <h5>–î–µ–±–∞–≥ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è</h5>
            <pre style="font-size: 12px; background: #f8f9fa; padding: 10px; border-radius: 4px;">${debugText}</pre>
            <button onclick="navigator.clipboard.writeText('${debugText.replace(/'/g, "\\'")}').then(()=>alert('–°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!')).catch(()=>{})" class="btn btn-sm btn-secondary me-2">–ö–æ–ø—ñ—é–≤–∞—Ç–∏</button>
            <button onclick="this.closest('div[style*=\"position: fixed\"]').remove()" class="btn btn-sm btn-primary">–ó–∞–∫—Ä–∏—Ç–∏</button>
        </div>
    `;
    document.body.appendChild(modal);
});

// –û–±—Ä–æ–±–Ω–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Å–∫–∏–¥–∞–Ω–Ω—è client ID
document.getElementById('resetClientIdButton').addEventListener('click', function() {
    if (confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ —Å–∫–∏–Ω—É—Ç–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–∏–π –∫–ª—ñ—î–Ω—Ç—Å—å–∫–∏–π ID? –ü—ñ—Å–ª—è —Ü—å–æ–≥–æ –≤–∞–º –∑–Ω–∞–¥–æ–±–∏—Ç—å—Å—è –∑–Ω–æ–≤—É –ø–µ—Ä–µ–π—Ç–∏ –∑–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–∏–º –ø–æ—Å–∏–ª–∞–Ω–Ω—è–º.')) {
        localStorage.removeItem('client_id');
        localStorage.removeItem('clientIdInfoShown');
        
        // –ü–æ–∫–∞–∑—É—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ —É—Å–ø—ñ—à–Ω–µ —Å–∫–∏–¥–∞–Ω–Ω—è
        alert('–ö–ª—ñ—î–Ω—Ç—Å—å–∫–∏–π ID —Å–∫–∏–Ω—É—Ç–æ. –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ —Å—Ç–æ—Ä—ñ–Ω–∫—É —Ç–∞ –ø–µ—Ä–µ–π–¥—ñ—Ç—å –∑–∞ –≤–∞—à–∏–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–∏–º –ø–æ—Å–∏–ª–∞–Ω–Ω—è–º.');
        
        // –ü—Ä–∏—Ö–æ–≤—É—î–º–æ –∫–Ω–æ–ø–∫—É
        document.getElementById('resetClientIdButton').style.display = 'none';
        
        // –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —Å—Ç–æ—Ä—ñ–Ω–∫—É
        setTimeout(() => {
            window.location.reload();
        }, 2000);
    }
});

// –ó–∞–∫—Ä–∏—Ç—Ç—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞
document.querySelector('#exchangeModal .close').addEventListener('click', function() {
    document.getElementById('exchangeModal').style.display = "none";
});

// –§–æ—Ä–º—É–≤–∞–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—ñ –æ–±–º—ñ–Ω—É
document.getElementById('generateExchange').addEventListener('click', function() {
    if (selectedTenantsData.length < 2) {
        alert('–î–æ–¥–∞–π—Ç–µ –ø—Ä–∏–Ω–∞–π–º–Ω—ñ –¥–≤–æ—Ö –æ—Ä–µ–Ω–¥–∞—Ä—ñ–≤ –¥–ª—è –∞–Ω–∞–ª—ñ–∑—É –æ–±–º—ñ–Ω—É');
        return;
    }
    
    analyzeExchange();
});

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ –æ—Ä–µ–Ω–¥–∞—Ä–µ–π –∏–∑ –¥–∞–Ω–Ω—ã—Ö –∫–∞—Ä—Ç—ã
function populateTenantDropdown() {
    const tenantSelect = document.getElementById('selectedTenant');
    tenantSelect.innerHTML = '<option value="">-- –í–∏–±–µ—Ä—ñ—Ç—å –æ—Ä–µ–Ω–¥–∞—Ä—è --</option>';
    
    if (!originalGeoJsonData) return;
    
    // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ—Ö —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –æ—Ä–µ–Ω–¥–∞—Ä–µ–π —Å –∫–∞—Ä—Ç—ã
    allTenants = [];
    const tenantSet = new Set();
    
    originalGeoJsonData.features.forEach(feature => {
        if (feature.properties && feature.properties.type === 'split') {
            const tenant = feature.properties['–û—Ä–µ–Ω–¥–∞—Ä —á–∞—Å—Ç–∏–Ω–∏'] || feature.properties['–û—Ä–µ–Ω–¥–∞—Ä'];
            if (tenant && !tenantSet.has(tenant)) {
                tenantSet.add(tenant);
                allTenants.push(tenant);
            }
        }
    });
    
    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –æ—Ä–µ–Ω–¥–∞—Ä–µ–π –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É
    allTenants.sort();
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ä–µ–Ω–¥–∞—Ä–µ–π –≤ –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫
    allTenants.forEach(tenant => {
        const option = document.createElement('option');
        option.value = tenant;
        option.textContent = tenant;
        tenantSelect.appendChild(option);
    });
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ—Ä–µ–Ω–¥–∞—Ä—è –∏ –µ–≥–æ –∫–∞–¥–∞—Å—Ç—Ä–æ–≤—ã—Ö –Ω–æ–º–µ—Ä–æ–≤
document.getElementById('addTenantData').addEventListener('click', function() {
    const tenantSelect = document.getElementById('selectedTenant');
    const exchangeList = document.getElementById('exchangeList');
    const tenantSelectionsContainer = document.getElementById('tenantSelections');
    
    const selectedTenant = tenantSelect.value;
    const cadastralNumbers = exchangeList.value.trim();
    
    if (!selectedTenant) {
        alert('–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–∏–±–µ—Ä—ñ—Ç—å –æ—Ä–µ–Ω–¥–∞—Ä—è');
        return;
    }
    
    if (!cadastralNumbers) {
        alert('–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –∫–∞–¥–∞—Å—Ç—Ä–æ–≤—ñ –Ω–æ–º–µ—Ä–∏');
        return;
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –º–∞—Å—Å–∏–≤
    const numbersList = cadastralNumbers.split('\n')
        .map(num => num.trim())
        .filter(num => num.length > 0);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –±—ã–ª –ª–∏ —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω —ç—Ç–æ—Ç –æ—Ä–µ–Ω–¥–∞—Ä—å
    const existingIndex = selectedTenantsData.findIndex(item => item.tenant === selectedTenant);
    if (existingIndex !== -1) {
        // –ï—Å–ª–∏ –æ—Ä–µ–Ω–¥–∞—Ä—å —É–∂–µ –±—ã–ª –¥–æ–±–∞–≤–ª–µ–Ω, —Å–ø—Ä–∞—à–∏–≤–∞–µ–º, —Ö–æ—á–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–º–µ–Ω–∏—Ç—å –µ–≥–æ –¥–∞–Ω–Ω—ã–µ
        if (confirm(`–û—Ä–µ–Ω–¥–∞—Ä "${selectedTenant}" –≤–∂–µ –¥–æ–¥–∞–Ω–æ. –ó–∞–º—ñ–Ω–∏—Ç–∏ –π–æ–≥–æ –∫–∞–¥–∞—Å—Ç—Ä–æ–≤—ñ –Ω–æ–º–µ—Ä–∏?`)) {
            selectedTenantsData[existingIndex].cadastralNumbers = numbersList;
            updateTenantSelectionsDisplay();
        }
    } else {
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–≥–æ –æ—Ä–µ–Ω–¥–∞—Ä—è
        selectedTenantsData.push({
            tenant: selectedTenant,
            cadastralNumbers: numbersList
        });
        updateTenantSelectionsDisplay();
    }
    
    // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞ –∫–∞–¥–∞—Å—Ç—Ä–æ–≤—ã—Ö –Ω–æ–º–µ—Ä–æ–≤
    exchangeList.value = '';
});

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –æ—Ä–µ–Ω–¥–∞—Ä–µ–π –∏ –∏—Ö –∫–∞–¥–∞—Å—Ç—Ä–æ–≤—ã—Ö –Ω–æ–º–µ—Ä–æ–≤
function updateTenantSelectionsDisplay() {
    const container = document.getElementById('tenantSelections');
    container.innerHTML = '';
    
    if (selectedTenantsData.length === 0) {
        container.innerHTML = '<p class="text-muted mb-0">–ù–µ–º–∞—î –≤–∏–±—Ä–∞–Ω–∏—Ö –æ—Ä–µ–Ω–¥–∞—Ä—ñ–≤</p>';
        return;
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ —Å –¥–∞–Ω–Ω—ã–º–∏ –æ—Ä–µ–Ω–¥–∞—Ä–µ–π –≤ –±–æ–ª–µ–µ –∫–æ–º–ø–∞–∫—Ç–Ω–æ–º –≤–∏–¥–µ
    selectedTenantsData.forEach((data, index) => {
        // –ù–∞—Ö–æ–¥–∏–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–ª–æ—â–∞–¥–∏ –∑–µ–º–µ–ª—å–Ω—ã—Ö —É—á–∞—Å—Ç–∫–æ–≤ –¥–ª—è —ç—Ç–æ–≥–æ –∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞
        let foundParcels = 0;
        const totalCadastre = data.cadastralNumbers.length;
        
        if (originalGeoJsonData) {
            data.cadastralNumbers.forEach(cadNum => {
                const features = originalGeoJsonData.features.filter(feature => 
                    feature.properties && feature.properties.type === 'split' && 
                    feature.properties['–ö–∞–¥–∞—Å—Ç—Ä–æ–≤–∏–π –Ω–æ–º–µ—Ä'] === cadNum
                );
                
                if (features.length > 0) {
                    foundParcels++;
                }
            });
        }
        
        const card = document.createElement('div');
        card.className = 'card tenant-card';
        
        const cardHeader = document.createElement('div');
        cardHeader.className = 'd-flex justify-content-between align-items-center card-header py-1 px-2';
        
        const tenantName = document.createElement('h6');
        tenantName.className = 'tenant-title';
        tenantName.textContent = data.tenant;
        tenantName.title = data.tenant; // –î–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ–ª–Ω–æ–≥–æ –Ω–∞–∑–≤–∞–Ω–∏—è –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
        
        const deleteButton = document.createElement('button');
        deleteButton.className = 'btn btn-sm btn-outline-danger py-0 px-1';
        deleteButton.innerHTML = '<i class="bi bi-trash"></i>';
        deleteButton.style.fontSize = '0.8rem';
        deleteButton.onclick = function() {
            selectedTenantsData.splice(index, 1);
            updateTenantSelectionsDisplay();
        };
        
        cardHeader.appendChild(tenantName);
        cardHeader.appendChild(deleteButton);
        
        const cardBody = document.createElement('div');
        cardBody.className = 'card-body py-1 px-2';
        
        const cadastreInfo = document.createElement('p');
        cadastreInfo.className = 'tenant-cadastre-summary';
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö/–Ω–µ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –∫–∞–¥–∞—Å—Ç—Ä–æ–≤—ã—Ö –Ω–æ–º–µ—Ä–∞—Ö
        let statusClass = 'text-success';
        let statusText = '–∑–Ω–∞–π–¥–µ–Ω–æ';
        
        if (foundParcels < totalCadastre) {
            statusClass = 'text-warning';
            statusText = `–∑–Ω–∞–π–¥–µ–Ω–æ ${foundParcels} –∑`;
        }
        
        cadastreInfo.innerHTML = `
            –ö–∞–¥–∞—Å—Ç—Ä–æ–≤—ñ –Ω–æ–º–µ—Ä–∏: <span class="${statusClass}">${statusText}</span> ${totalCadastre} —à—Ç.
        `;
        
        cardBody.appendChild(cadastreInfo);
        card.appendChild(cardHeader);
        card.appendChild(cardBody);
        container.appendChild(card);
    });
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –¥–æ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è"
document.getElementById('backToExchangeInput').addEventListener('click', function() {
    document.getElementById('exchangeTableContainer').style.display = 'none';
    document.getElementById('exchangeInputContainer').style.display = 'block';
});

// –§—É–Ω–∫—Ü–∏—è –∞–Ω–∞–ª–∏–∑–∞ –æ–±–º–µ–Ω–∞
function analyzeExchange() {
    const exchangeAnalysis = document.getElementById('exchangeAnalysis');
    const totalAreaElement = document.getElementById('totalArea');
    const exchangeTableContainer = document.getElementById('exchangeTableContainer');
    const fieldTablesContainer = document.getElementById('fieldTables');
    const notFoundSummary = document.getElementById('notFoundSummary');
    const exchangeSummary = document.getElementById('exchangeSummary');
    
    if (!originalGeoJsonData) {
        alert('–î–∞–Ω—ñ –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ. –°–ø–æ—á–∞—Ç–∫—É –≤–∏–±–µ—Ä—ñ—Ç—å —Ä–∞–¥—É.');
        return;
    }
    
    // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –∫–∞–¥–∞—Å—Ç—Ä–æ–≤—ã–µ –Ω–æ–º–µ—Ä–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞
    const allCadastralNumbers = selectedTenantsData.flatMap(data => data.cadastralNumbers);
    
    // –§–∏–ª—å—Ç—Ä—É–µ–º split-–∑–∞–ø–∏—Å–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
    const splitFeatures = originalGeoJsonData.features.filter(feature => 
        feature.properties && 
        allCadastralNumbers.includes(feature.properties['–ö–∞–¥–∞—Å—Ç—Ä–æ–≤–∏–π –Ω–æ–º–µ—Ä']) &&
        feature.properties.type === 'split'
    );
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –Ω–æ–º–µ—Ä–∞
    const foundNumbers = new Set(splitFeatures.map(f => f.properties['–ö–∞–¥–∞—Å—Ç—Ä–æ–≤–∏–π –Ω–æ–º–µ—Ä']));
    const notFoundNumbers = allCadastralNumbers.filter(num => !foundNumbers.has(num));
    
    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –Ω–µ–Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –Ω–æ–º–µ—Ä–∞—Ö
    if (notFoundNumbers.length > 0) {
        notFoundSummary.style.display = 'block';
        notFoundSummary.innerHTML = `
            <strong>–£–≤–∞–≥–∞!</strong> –ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ ${notFoundNumbers.length} –∫–∞–¥–∞—Å—Ç—Ä–æ–≤–∏—Ö –Ω–æ–º–µ—Ä—ñ–≤ –Ω–∞ –∫–∞—Ä—Ç—ñ: 
            <span class="small">${notFoundNumbers.slice(0, 5).join(', ')}${notFoundNumbers.length > 5 ? '...' : ''}</span>
        `;
    } else {
        notFoundSummary.style.display = 'none';
    }
    
    // –í—ã–≤–æ–¥–∏–º –æ–±—â—É—é —Å–≤–æ–¥–∫—É –ø–æ –æ–±–º–µ–Ω—É
    exchangeSummary.innerHTML = `
        <strong>–ó–∞–≥–∞–ª—å–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è:</strong> 
        ${selectedTenantsData.length} –æ—Ä–µ–Ω–¥–∞—Ä—ñ–≤, 
        ${allCadastralNumbers.length} –∫–∞–¥–∞—Å—Ç—Ä–æ–≤–∏—Ö –Ω–æ–º–µ—Ä—ñ–≤, 
        –∑–Ω–∞–π–¥–µ–Ω–æ –Ω–∞ –∫–∞—Ä—Ç—ñ: ${foundNumbers.size} —à—Ç.
    `;
    
    if (splitFeatures.length === 0) {
        exchangeTableContainer.style.display = 'block';
        exchangeAnalysis.innerHTML = '<div class="text-danger">–ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ –∂–æ–¥–Ω–æ—ó –¥—ñ–ª—è–Ω–∫–∏ –¥–ª—è –æ–±–º—ñ–Ω—É –Ω–∞ –∫–∞—Ä—Ç—ñ</div>';
        return;
    }
    
    // –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ –æ—Ä–µ–Ω–¥–∞—Ä—è–º –∏ –∏—Ö —É—á–∞—Å—Ç–∫–∞–º
    const exchangeData = new Map();
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —É—á–∞—Å—Ç–∫–æ–≤
    selectedTenantsData.forEach(selectedTenantData => {
        const chosenTenantName = selectedTenantData.tenant;
        
        // –ù–∞–π–¥–µ–º —É—á–∞—Å—Ç–∫–∏, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –∫–∞–¥–∞—Å—Ç—Ä–æ–≤—ã–º –Ω–æ–º–µ—Ä–∞–º —ç—Ç–æ–≥–æ –æ—Ä–µ–Ω–¥–∞—Ä—è
        const tenantFeatures = splitFeatures.filter(feature => 
            selectedTenantData.cadastralNumbers.includes(feature.properties['–ö–∞–¥–∞—Å—Ç—Ä–æ–≤–∏–π –Ω–æ–º–µ—Ä'])
        );
        
        // –°–æ–∑–¥–∞–µ–º –≥—Ä—É–ø–ø—ã –¥–∞–Ω–Ω—ã—Ö –ø–æ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–º –æ—Ä–µ–Ω–¥–∞—Ä—è–º –Ω–∞ –∫–∞—Ä—Ç–µ
        tenantFeatures.forEach(feature => {
            const props = feature.properties;
            const factualTenant = props['–û—Ä–µ–Ω–¥–∞—Ä —á–∞—Å—Ç–∏–Ω–∏'] || props['–û—Ä–µ–Ω–¥–∞—Ä'] || '–ë–µ–∑ –æ—Ä–µ–Ω–¥–∞—Ä—è';
            const cadastral = props['–ö–∞–¥–∞—Å—Ç—Ä–æ–≤–∏–π –Ω–æ–º–µ—Ä'];
            const splitArea = parseFloat(props['–ü–ª–æ—â–∞ —á–∞—Å—Ç–∏–Ω–∏']) || 0;
            const status = props['–°—Ç–∞—Ç—É—Å'] || '–ù–µ –≤–∏–∑–Ω–∞—á–µ–Ω–æ';
            
            if (!exchangeData.has(chosenTenantName)) {
                exchangeData.set(chosenTenantName, {
                    totalArea: 0,
                    factualTenants: new Map()
                });
            }
            
            const tenantData = exchangeData.get(chosenTenantName);
            
            if (!tenantData.factualTenants.has(factualTenant)) {
                tenantData.factualTenants.set(factualTenant, {
                    parcels: new Map(),
                    totalArea: 0,
                    areaByStatus: {}
                });
            }
            
            const factualTenantData = tenantData.factualTenants.get(factualTenant);
            
            if (!factualTenantData.parcels.has(cadastral)) {
                factualTenantData.parcels.set(cadastral, {
                    fullArea: parseFloat(props['–ü–ª–æ—â–∞ —Ä–æ–∑—Ä–∞—Ö–æ–≤–∞–Ω–∞']) || 0,
                    factualTenant: factualTenant, // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–≥–æ –∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —É—á–∞—Å—Ç–∫–∞
                    splits: [],
                    statusAreas: {}
                });
            }
            
            const parcelData = factualTenantData.parcels.get(cadastral);
            parcelData.splits.push({
                area: splitArea,
                status: status,
                expiry: props['–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è'] || '-'
            });
            
            parcelData.statusAreas[status] = (parcelData.statusAreas[status] || 0) + splitArea;
            factualTenantData.areaByStatus[status] = (factualTenantData.areaByStatus[status] || 0) + splitArea;
            factualTenantData.totalArea += splitArea;
            tenantData.totalArea += splitArea;
        });
    });
    
    // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –ø–µ—Ä–µ–¥ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ–º
    fieldTablesContainer.innerHTML = '';
    exchangeAnalysis.innerHTML = '';
    
    // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã
    const allStatuses = new Set();
    exchangeData.forEach(tenantData => {
        tenantData.factualTenants.forEach(factualTenantData => {
            Object.keys(factualTenantData.areaByStatus).forEach(status => allStatuses.add(status));
        });
    });
    const sortedStatuses = Array.from(allStatuses).sort();
    
    // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–±—â—É—é –ø–ª–æ—â–∞–¥—å –æ–±–º–µ–Ω–∞
    let totalArea = 0;
    
    // –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è –∫–∞–∂–¥–æ–π –≥—Ä—É–ø–ø—ã (–≤—ã–±—Ä–∞–Ω–Ω—ã–π –æ—Ä–µ–Ω–¥–∞—Ä—å + —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –æ—Ä–µ–Ω–¥–∞—Ä–∏)
    Array.from(exchangeData.keys()).sort().forEach(chosenTenant => {
        const tenantData = exchangeData.get(chosenTenant);
        totalArea += tenantData.totalArea;
        
        const tenantGroup = document.createElement('div');
        tenantGroup.className = 'tenant-group mb-4';
        
        // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –≥—Ä—É–ø–ø—ã —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º –æ—Ä–µ–Ω–¥–∞—Ä–µ–º
        const header = document.createElement('h5');
        header.textContent = `${chosenTenant} (${tenantData.totalArea.toFixed(4)} –≥–∞)`;
        tenantGroup.appendChild(header);
        
        // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ —É—á–∞—Å—Ç–∫–∏ –¥–ª—è —ç—Ç–æ–≥–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –æ—Ä–µ–Ω–¥–∞—Ä—è
        const allParcels = new Map();
        tenantData.factualTenants.forEach((factualTenantData, factualTenant) => {
            factualTenantData.parcels.forEach((parcelData, cadastral) => {
                allParcels.set(cadastral, {
                    ...parcelData,
                    factualTenant: factualTenant // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–≥–æ –∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞
                });
            });
        });
        
        // –°–æ–∑–¥–∞–µ–º –µ–¥–∏–Ω—É—é —Ç–∞–±–ª–∏—Ü—É –¥–ª—è –≤—Å–µ—Ö —É—á–∞—Å—Ç–∫–æ–≤ —ç—Ç–æ–≥–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –æ—Ä–µ–Ω–¥–∞—Ä—è
        const table = document.createElement('table');
        table.className = 'table table-sm';
        
        // –ó–∞–≥–æ–ª–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ã —Å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –∫–æ–ª–æ–Ω–∫–∏ "–§–∞–∫—Ç–∏—á–Ω–∏–π –æ—Ä–µ–Ω–¥–∞—Ä"
        const thead = document.createElement('thead');
        thead.innerHTML = `<tr>
            <th>–ö–∞–¥–∞—Å—Ç—Ä–æ–≤–∏–π –Ω–æ–º–µ—Ä</th>
            <th>–§–∞–∫—Ç–∏—á–Ω–∏–π –æ—Ä–µ–Ω–¥–∞—Ä</th>
            <th>–ü–ª–æ—â–∞ —Ä–æ–∑—Ä–∞—Ö–æ–≤–∞–Ω–∞</th>
            ${sortedStatuses.map(status => {
                const statusText = status.toLowerCase();
                const color = statusText === '–æ–±—Ä–æ–±–ª—è—î—Ç—å—Å—è' ? '#198754' : 
                            statusText === '–Ω–µ –æ–±—Ä–æ–±–ª—è—î—Ç—å—Å—è' ? '#dc3545' : 
                            '#000000';
                return `<th style="color: ${color}">${status}</th>`;
            }).join('')}
            <th>–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è</th>
        </tr>`;
        table.appendChild(thead);
        
        // –¢–µ–ª–æ —Ç–∞–±–ª–∏—Ü—ã
        const tbody = document.createElement('tbody');
        allParcels.forEach((parcelData, cadastral) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${cadastral}</td>
                <td class="factual-tenant-cell">${parcelData.factualTenant}</td>
                <td>${parcelData.fullArea.toFixed(4)}</td>
                ${sortedStatuses.map(status => 
                    `<td>${parcelData.statusAreas[status]?.toFixed(4) || '0.0000'}</td>`
                ).join('')}
                <td>${parcelData.splits[0]?.expiry || '-'}</td>
            `;
            tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        
        // –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–ª—è –≤—Å–µ—Ö —É—á–∞—Å—Ç–∫–æ–≤ —ç—Ç–æ–≥–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –æ—Ä–µ–Ω–¥–∞—Ä—è
        const tfoot = document.createElement('tfoot');
        const footerRow = document.createElement('tr');
        
        // –°–æ–±–∏—Ä–∞–µ–º –æ–±—â–∏–µ –ø–ª–æ—â–∞–¥–∏ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –æ—Ä–µ–Ω–¥–∞—Ä—è
        const totalStatusAreas = {};
        tenantData.factualTenants.forEach(factualTenantData => {
            Object.entries(factualTenantData.areaByStatus).forEach(([status, area]) => {
                totalStatusAreas[status] = (totalStatusAreas[status] || 0) + area;
            });
        });
        
        footerRow.innerHTML = `
            <td colspan="2"><strong>–í—Å—å–æ–≥–æ:</strong></td>
            <td><strong>${tenantData.totalArea.toFixed(4)}</strong></td>
            ${sortedStatuses.map(status => {
                const statusText = status.toLowerCase();
                const color = statusText === '–æ–±—Ä–æ–±–ª—è—î—Ç—å—Å—è' ? '#198754' : 
                            statusText === '–Ω–µ –æ–±—Ä–æ–±–ª—è—î—Ç—å—Å—è' ? '#dc3545' : 
                            '#000000';
                return `<td><strong style="color: ${color}">${totalStatusAreas[status]?.toFixed(4) || '0.0000'}</strong></td>`;
            }).join('')}
            <td></td>
        `;
        tfoot.appendChild(footerRow);
        table.appendChild(tfoot);
        
        tenantGroup.appendChild(table);
        fieldTablesContainer.appendChild(tenantGroup);
    });
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—â—É—é –ø–ª–æ—â–∞–¥—å
    totalAreaElement.textContent = totalArea.toFixed(4);
    
    // –ê–Ω–∞–ª–∏–∑ —Ä–∞–≤–Ω–æ—Ü–µ–Ω–Ω–æ—Å—Ç–∏ –æ–±–º–µ–Ω–∞ –º–µ–∂–¥—É –≤—ã–±—Ä–∞–Ω–Ω—ã–º–∏ –æ—Ä–µ–Ω–¥–∞—Ä—è–º–∏
    if (exchangeData.size > 1) {
        const chosenTenants = Array.from(exchangeData.entries());
        const maxDiffPercent = 5;
        
        for (let i = 0; i < chosenTenants.length; i++) {
            for (let j = i + 1; j < chosenTenants.length; j++) {
                const [tenant1, data1] = chosenTenants[i];
                const [tenant2, data2] = chosenTenants[j];
                
                const area1 = data1.totalArea;
                const area2 = data2.totalArea;
                const diff = Math.abs(area1 - area2);
                const avgArea = (area1 + area2) / 2;
                const diffPercent = (diff / avgArea) * 100;
                
                const analysisDiv = document.createElement('div');
                const comparison = `${tenant1} ‚Üî ${tenant2}:<br>` +
                    `${area1.toFixed(4)} –≥–∞ ‚Üî ${area2.toFixed(4)} –≥–∞<br>` +
                    `(—Ä—ñ–∑–Ω–∏—Ü—è: ${diff.toFixed(4)} –≥–∞, ${diffPercent.toFixed(1)}%)<br>`;
                
                if (diffPercent > maxDiffPercent) {
                    analysisDiv.className = 'text-danger';
                    analysisDiv.innerHTML = `‚ùå ${comparison}–û–±–º—ñ–Ω –ù–ï —Ä—ñ–≤–Ω–æ—Ü—ñ–Ω–Ω–∏–π`;
                } else {
                    analysisDiv.className = 'text-success';
                    analysisDiv.innerHTML = `‚úì ${comparison}–û–±–º—ñ–Ω —Ä—ñ–≤–Ω–æ—Ü—ñ–Ω–Ω–∏–π`;
                }
                
                exchangeAnalysis.appendChild(analysisDiv);
            }
        }
    } else {
        const warningDiv = document.createElement('div');
        warningDiv.className = 'text-danger';
        warningDiv.textContent = '–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –¥–∞–Ω–∏—Ö –¥–ª—è –∞–Ω–∞–ª—ñ–∑—É (–ø–æ—Ç—Ä—ñ–±–Ω–æ —è–∫ –º—ñ–Ω—ñ–º—É–º –¥–≤–∞ –æ—Ä–µ–Ω–¥–∞—Ä—è)';
        exchangeAnalysis.appendChild(warningDiv);
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏ –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –Ω–∞—á–∞–ª—É
    document.getElementById('exchangeInputContainer').style.display = 'none';
    fieldTablesContainer.style.display = 'block';
    exchangeTableContainer.style.display = 'block';
    
    setTimeout(() => {
        if (exchangeTableContainer) {
            exchangeTableContainer.scrollTop = 0;
        }
    }, 100);
}
    
    // ...existing scripts...
</script>

<script>
        // ...existing code...

        // –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è updateSelectionInfo –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –±–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
        function updateSelectionInfo() {
            
            // –ú–Ω–æ–∂–µ—Å—Ç–≤–æ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –∫–æ–º–±–∏–Ω–∞—Ü–∏–π
            const processedParts = new Set();
            // –ö–∞–¥–∞—Å—Ç—Ä–æ–≤—ã–µ –Ω–æ–º–µ—Ä–∞ –∏ –æ–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
            const uniqueFeatures = new Map();
            // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ –∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞–º
            const tenantAreas = new Map();
            // –ü–ª–æ—â–∞–¥–∏ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º
            const statusAreas = new Map();
            
            // –ü–µ—Ä–µ–±–∏—Ä–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã –∏ —Å–æ–±–∏—Ä–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —É—á–∞—Å—Ç–∫–∞
            selectedFeatures.forEach(featureId => {
                Object.values(overlays).forEach(layerGroup => {
                    layerGroup.eachLayer(layer => {
                        if (L.stamp(layer) === featureId && layer.feature) {
                            const props = layer.feature.properties;
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ split-—á–∞—Å—Ç—å
                            if (props.type !== 'split') {
                                return;
                            }
                            
                            const kadNum = props["–ö–∞–¥–∞—Å—Ç—Ä–æ–≤–∏–π –Ω–æ–º–µ—Ä"];
                            // –ò—Å–ø–æ–ª—å–∑—É–µ–º "–ü–ª–æ—â–∞ —á–∞—Å—Ç–∏–Ω–∏" –¥–ª—è —Ä–∞—Å—á–µ—Ç–æ–≤ –ø–æ —á–∞—Å—Ç—è–º
                            const partArea = parseFloat(props["–ü–ª–æ—â–∞ —á–∞—Å—Ç–∏–Ω–∏"]) || 0;
                            // –ò—Å–ø–æ–ª—å–∑—É–µ–º "–ü–ª–æ—â–∞ —Ä–æ–∑—Ä–∞—Ö–æ–≤–∞–Ω–∞" –¥–ª—è –æ–±—â–µ–π –ø–ª–æ—â–∞–¥–∏ —É—á–∞—Å—Ç–∫–∞
                            const totalArea = parseFloat(props["–ü–ª–æ—â–∞ —Ä–æ–∑—Ä–∞—Ö–æ–≤–∞–Ω–∞"]) || 0;
                            
                            const tenant = props["–û—Ä–µ–Ω–¥–∞—Ä —á–∞—Å—Ç–∏–Ω–∏"] || props["–û—Ä–µ–Ω–¥–∞—Ä"] || "–ë–µ–∑ –æ—Ä–µ–Ω–¥–∞—Ä—è";
                            const status = props["–°—Ç–∞—Ç—É—Å"] || "–ù–µ –≤–∫–∞–∑–∞–Ω–æ";
                            
                            // –°–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –¥–ª—è –∫–∞–∂–¥–æ–π —á–∞—Å—Ç–∏ —É—á–∞—Å—Ç–∫–∞
                            const partId = kadNum + '_' + tenant + '_' + status;

                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–∞ —á–∞—Å—Ç—å –µ—â–µ –Ω–µ –±—ã–ª–∞ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞
                            if (processedParts.has(partId)) {
                                return;
                            }
                            
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –ø–ª–æ—â–∞–¥–∏
                            if (!kadNum || isNaN(partArea) || partArea <= 0) {
                                return;
                            }

                            // –ü–æ–º–µ—á–∞–µ–º —á–∞—Å—Ç—å –∫–∞–∫ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—É—é
                            processedParts.add(partId);
                            
                            // –î–æ–±–∞–≤–ª—è–µ–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –∫–∞–¥–∞—Å—Ç—Ä–æ–≤–æ–≥–æ –Ω–æ–º–µ—Ä–∞
                            if (!uniqueFeatures.has(kadNum)) {
                                uniqueFeatures.set(kadNum, {
                                    totalArea: totalArea, // –û–±—â–∞—è –ø–ª–æ—â–∞–¥—å —É—á–∞—Å—Ç–∫–∞
                                    partAreas: {}, // –ü–ª–æ—â–∞–¥–∏ –ø–æ —á–∞—Å—Ç—è–º –∏ —Å—Ç–∞—Ç—É—Å–∞–º
                                    tenant: tenant // –û—Å–Ω–æ–≤–Ω–æ–π –∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä
                                });
                            }
                            
                            const featInfo = uniqueFeatures.get(kadNum);
                            // –î–æ–±–∞–≤–ª—è–µ–º –ø–ª–æ—â–∞–¥—å —á–∞—Å—Ç–∏ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —Å—Ç–∞—Ç—É—Å
                            featInfo.partAreas[status] = (featInfo.partAreas[status] || 0) + partArea;
                            
                            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–ª–æ—â–∞–¥—å –∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â—É—é –ø–ª–æ—â–∞–¥—å —É—á–∞—Å—Ç–∫–∞)
                            if (!tenantAreas.has(tenant)) {
                                tenantAreas.set(tenant, {
                                    totalArea: 0, // –û–±—â–∞—è –ø–ª–æ—â–∞–¥—å –≤—Å–µ—Ö —É—á–∞—Å—Ç–∫–æ–≤ –∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞
                                    partsArea: 0 // –°—É–º–º–∞ –ø–ª–æ—â–∞–¥–µ–π —á–∞—Å—Ç–µ–π
                                });
                            }
                            const tenantInfo = tenantAreas.get(tenant);
                            // –£—á–∏—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—ã–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–∞–¥–∞—Å—Ç—Ä–æ–≤—ã–π –Ω–æ–º–µ—Ä —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑ –¥–ª—è –æ–±—â–µ–π –ø–ª–æ—â–∞–¥–∏
                            if (!featInfo.tenantCounted) {
                                tenantInfo.totalArea += totalArea;
                                featInfo.tenantCounted = true;
                            }
                            // –í—Å–µ–≥–¥–∞ –¥–æ–±–∞–≤–ª—è–µ–º –ø–ª–æ—â–∞–¥—å —á–∞—Å—Ç–∏
                            tenantInfo.partsArea += partArea;
                            
                            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–ª–æ—â–∞–¥—å —Å—Ç–∞—Ç—É—Å–∞
                            const currentStatusArea = statusAreas.get(status) || 0;
                            statusAreas.set(status, currentStatusArea + partArea);
                            
                        }
                    });
                });
            });

            // –°–æ–∑–¥–∞–µ–º —Å–≤–æ–¥–∫–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            
            // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–±—â—É—é –ø–ª–æ—â–∞–¥—å –∫–∞–∫ —Å—É–º–º—É –æ–±—â–∏—Ö –ø–ª–æ—â–∞–¥–µ–π —É—á–∞—Å—Ç–∫–æ–≤
            const totalSelectedArea = Array.from(uniqueFeatures.values()).reduce((sum, info) => sum + info.totalArea, 0);
            const totalPartsArea = Array.from(statusAreas.values()).reduce((sum, area) => sum + area, 0);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å, –µ—Å–ª–∏ –µ—Å—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —É—á–∞—Å—Ç–∫–∏
            const infoElement = document.getElementById('selectionInfo');
            const selectionTools = document.getElementById('selectionTools');

            if (uniqueFeatures.size > 0) {
                if (!infoElement) {
                    // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
                    const info = L.control({position: 'bottomleft'});
                    info.onAdd = function() {
                        const div = L.DomUtil.create('div', 'selection-info');
                        div.id = 'selectionInfo';
                        div.style.background = 'white';
                        div.style.color = 'black';
                        div.style.padding = '6px';
                        div.style.border = '2px solid #666';
                        div.style.borderRadius = '4px';
                        div.style.maxWidth = '300px';
                        return div;
                    };
                    info.addTo(map);
                }

                // –§–æ—Ä–º–∏—Ä—É–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ –∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞–º (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—â—É—é –ø–ª–æ—â–∞–¥—å)
                let tenantsInfo = '';
                tenantAreas.forEach((data, tenant) => {
                    const color = tenant === "–ë–µ–∑ –æ—Ä–µ–Ω–¥–∞—Ä—è" ? "#ffffff" : getColor(tenant);
                    tenantsInfo += `
                        <div style="display: flex; align-items: center; margin-top: 3px;">
                            <span style="
                                display: inline-block;
                                width: 12px;
                                height: 12px;
                                margin-right: 5px;
                                background-color: ${color};
                                border: 1px solid #666;
                                border-radius: 2px;
                            "></span>
                            <span>${tenant}: ${data.totalArea.toFixed(4)} –≥–∞</span>
                        </div>`;
                });
                
                // –§–æ—Ä–º–∏—Ä—É–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—É–º–º—É –ø–ª–æ—â–∞–¥–µ–π —á–∞—Å—Ç–µ–π)
                let statusInfo = '';
                statusAreas.forEach((area, status) => {
                    const statusText = status.toLowerCase();
                    const color = statusText === '–æ–±—Ä–æ–±–ª—è—î—Ç—å—Å—è' ? '#198754' : 
                                 statusText === '–Ω–µ –æ–±—Ä–æ–±–ª—è—î—Ç—å—Å—è' ? '#dc3545' : 
                                 '#666666';
                    statusInfo += `
                        <div style="display: flex; align-items: center; margin-top: 3px;">
                            <span style="
                                display: inline-block;
                                width: 12px;
                                height: 12px;
                                margin-right: 5px;
                                background-color: ${color};
                                border: 1px solid #666;
                                border-radius: 2px;
                            "></span>
                            <span>${status}: ${area.toFixed(4)} –≥–∞</span>
                        </div>`;
                });

                // –û–±–Ω–æ–≤–ª—è–µ–º HTML —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
                document.getElementById('selectionInfo').innerHTML = `
                    <div style="max-height: 300px; overflow-y: auto;">
                        <div>
                            <b>–í–∏–¥—ñ–ª–µ–Ω–æ –¥—ñ–ª—è–Ω–æ–∫:</b> ${uniqueFeatures.size}<br>
                            <div style="margin-top: 3px;">
                                <b>–ó–∞–≥–∞–ª—å–Ω–∞ –ø–ª–æ—â–∞:</b> ${totalSelectedArea.toFixed(4)} –≥–∞
                            </div>
                        </div>
                        <hr style="margin: 4px 0">
                        <div>
                            ${tenantsInfo}
                        </div>
                        <hr style="margin: 4px 0">
                        <div>
                            <strong>–†–æ–∑–ø–æ–¥—ñ–ª –∑–∞ —Å—Ç–∞—Ç—É—Å–∞–º–∏:</strong>
                            ${statusInfo}
                        </div>
                        <div style="margin-top: 3px; font-size: 0.9em; color: #666; text-align: right;">
                            –ü–ª–æ—â–∞ —á–∞—Å—Ç–∏–Ω: ${totalPartsArea.toFixed(4)} –≥–∞
                        </div>
                    </div>`;

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –≤—ã–¥–µ–ª–µ–Ω–∏—è
                if (selectionTools) {
                    selectionTools.style.display = 'block';
                }
            } else {
                // –ï—Å–ª–∏ –Ω–µ—Ç –≤—ã–¥–µ–ª–µ–Ω–Ω—ã—Ö —É—á–∞—Å—Ç–∫–æ–≤, —É–¥–∞–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π –±–ª–æ–∫
                if (infoElement) {
                    infoElement.remove();
                }
                // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –≤—ã–¥–µ–ª–µ–Ω–∏—è
                if (selectionTools) {
                    selectionTools.style.display = 'none';
                }
            }
            
        }
        
        // ...existing code...
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–∏ exportSelectedToExcel –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è –æ–±—â–µ–π –ø–ª–æ—â–∞–¥–∏
        function exportSelectedToExcel() {
            const rows = [
                // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è –æ–±–æ–∏—Ö –≤–∏–¥–æ–≤ –ø–ª–æ—â–∞–¥–µ–π
                [
                    "–ö–∞–¥–∞—Å—Ç—Ä–æ–≤–∏–π –Ω–æ–º–µ—Ä", 
                    "–ü–ª–æ—â–∞ —Ä–æ–∑—Ä–∞—Ö–æ–≤–∞–Ω–∞", 
                    "–ü–ª–æ—â–∞ —á–∞—Å—Ç–∏–Ω–∏", 
                    "–í–ª–∞—Å–Ω–∏–∫", 
                    "–û—Ä–µ–Ω–¥–∞—Ä —á–∞—Å—Ç–∏–Ω–∏", 
                    "–û—Ä–µ–Ω–¥–∞—Ä", 
                    "–°—Ç–∞—Ç—É—Å"
                ]
            ];
            
            const uniqueFeatures = new Map();
            selectedFeatures.forEach(featureId => {
                Object.values(overlays).forEach(layerGroup => {
                    layerGroup.eachLayer(layer => {
                        if (L.stamp(layer) === featureId && layer.feature) {
                            const props = layer.feature.properties;
                            
                            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞–¥–∞—Å—Ç—Ä–æ–≤—ã–π –Ω–æ–º–µ—Ä + —Å—Ç–∞—Ç—É—Å –∫–∞–∫ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä
                            // —á—Ç–æ–±—ã –Ω–µ –ø–æ—Ç–µ—Ä—è—Ç—å —Ä–∞–∑–Ω—ã–µ —á–∞—Å—Ç–∏ –æ–¥–Ω–æ–≥–æ —É—á–∞—Å—Ç–∫–∞
                            const kadNum = props["–ö–∞–¥–∞—Å—Ç—Ä–æ–≤–∏–π –Ω–æ–º–µ—Ä"];
                            const status = props["–°—Ç–∞—Ç—É—Å"] || "";
                            const key = kadNum + "_" + status;
                            
                            if (kadNum && !uniqueFeatures.has(key)) {
                                uniqueFeatures.set(key, [
                                    kadNum,
                                    props["–ü–ª–æ—â–∞ —Ä–æ–∑—Ä–∞—Ö–æ–≤–∞–Ω–∞"] || "",
                                    props["–ü–ª–æ—â–∞ —á–∞—Å—Ç–∏–Ω–∏"] || "",
                                    props["–í–ª–∞—Å–Ω–∏–∫"] || "",
                                    props["–û—Ä–µ–Ω–¥–∞—Ä —á–∞—Å—Ç–∏–Ω–∏"] || "",
                                    props["–û—Ä–µ–Ω–¥–∞—Ä"] || "",
                                    status
                                ]);
                            }
                        }
                    });
                });
            });
            
            uniqueFeatures.forEach(row => rows.push(row));
            
            if (rows.length < 2) {
                alert("–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –µ–∫—Å–ø–æ—Ä—Ç—É");
                return;
            }
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(rows);
            XLSX.utils.book_append_sheet(wb, ws, "Selected");
            XLSX.writeFile(wb, "–≤–∏–¥—ñ–ª–µ–Ω—ñ –¥—ñ–ª—è–Ω–∫–∏.xlsx");
        }
        
        // ...existing code...
</script>
<script>
        // ...existing code...

        // –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –∫–∞—Ä—Ç—ã, —á—Ç–æ–±—ã –æ–Ω–∞ —Å–æ–±–∏—Ä–∞–ª–∞ —Å —Ç–µ–∫—É—â–µ–π –∫–∞—Ä—Ç—ã
        function collectMapData() {
            const data = [];
            
            // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å–æ –≤—Å–µ—Ö —Å–ª–æ–µ–≤, –∫–æ—Ç–æ—Ä—ã–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –Ω–∞ –∫–∞—Ä—Ç–µ
            Object.values(overlays).forEach(layerGroup => {
                if (!layerGroup || typeof layerGroup.eachLayer !== 'function') return;
                
                layerGroup.eachLayer(layer => {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —É —Å–ª–æ—è –µ—Å—Ç—å —Å–≤–æ–π—Å—Ç–≤–∞
                    if (layer.feature && layer.feature.properties) {
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ split-—á–∞—Å—Ç—å
                        if (layer.feature.properties.type === 'split') {
                            data.push(layer.feature.properties);
                        }
                    }
                });
            });
            
            return data;
        }

        // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è exportToExcel
        function exportToExcel(data, filename) {
            // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç, –≤—ã–≤–æ–¥–∏–º –æ—à–∏–±–∫—É
            if (data.length === 0) {
                alert('–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –µ–∫—Å–ø–æ—Ä—Ç—É. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —â–æ –Ω–∞ –∫–∞—Ä—Ç—ñ —î –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω—ñ –æ–±\'—î–∫—Ç–∏.');
                return;
            }
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –∫–∞–¥–∞—Å—Ç—Ä–æ–≤–æ–º—É –Ω–æ–º–µ—Ä—É
            data.sort((a, b) => {
                const kadNumA = a["–ö–∞–¥–∞—Å—Ç—Ä–æ–≤–∏–π –Ω–æ–º–µ—Ä"] || "";
                const kadNumB = b["–ö–∞–¥–∞—Å—Ç—Ä–æ–≤–∏–π –Ω–æ–º–µ—Ä"] || "";
                return kadNumA.localeCompare(kadNumB);
            });
            
            // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ –ø–æ–ª—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –Ω–∞—á–∞–ª–µ
            const priorityKeys = [
                "–ö–∞–¥–∞—Å—Ç—Ä–æ–≤–∏–π –Ω–æ–º–µ—Ä",
                "–ü–ª–æ—â–∞ —Ä–æ–∑—Ä–∞—Ö–æ–≤–∞–Ω–∞",
                "–ü–ª–æ—â–∞ —á–∞—Å—Ç–∏–Ω–∏", 
                "–í–ª–∞—Å–Ω–∏–∫",
                "–û—Ä–µ–Ω–¥–∞—Ä —á–∞—Å—Ç–∏–Ω–∏",
                "–û—Ä–µ–Ω–¥–∞—Ä",
                "–î–∞—Ç–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –æ—Ä–µ–Ω–¥–∏",
                "–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è",
                "–ù–∞–∑–≤–∞ –ø–æ–ª—è",
                "–°—Ç–∞—Ç—É—Å"
            ];
            
            // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∫–ª—é—á–∏ –∏–∑ –¥–∞–Ω–Ω—ã—Ö
            const allKeys = new Set();
            data.forEach(item => {
                Object.keys(item).forEach(key => {
                    if (key !== 'type') { // –ò—Å–∫–ª—é—á–∞–µ–º —Å–ª—É–∂–µ–±–Ω–æ–µ –ø–æ–ª–µ
                        allKeys.add(key);
                    }
                });
            });
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ–∑–∞—Ü–∏–µ–π
            const headers = [];
            
            // –°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ –ø–æ–ª—è
            priorityKeys.forEach(key => {
                if (allKeys.has(key)) {
                    headers.push(key);
                    allKeys.delete(key);
                }
            });
            
            // –ó–∞—Ç–µ–º –¥–æ–±–∞–≤–ª—è–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É
            Array.from(allKeys).sort().forEach(key => {
                headers.push(key);
            });
            
            // –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä–æ–∫–∏ –¥–ª—è Excel
            const rows = [headers];
            data.forEach(item => {
                const row = headers.map(header => item[header] || "");
                rows.push(row);
            });
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(rows);
            XLSX.utils.book_append_sheet(wb, ws, "–î—ñ–ª—è–Ω–∫–∏");
            XLSX.writeFile(wb, filename + ".xlsx");
        }
        
        // ...existing code...

    // –ï–¥–∏–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞
    function exportToExcel() {
        
        // –ü–æ–ª—É—á–∞–µ–º –∏–º—è —Ñ–∞–π–ª–∞
        const selectedFile = document.getElementById('fileSelect').value;
        const filename = selectedFile.replace('.geojson', '') || '–µ–∫—Å–ø–æ—Ä—Ç_–¥–∞–Ω–∏—Ö';
        
        // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ç–æ–ª—å–∫–æ —Å –≤–∏–¥–∏–º—ã—Ö —Å–ª–æ–µ–≤
        const data = [];
        const processedIds = new Set(); // –î–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
        
        Object.values(overlays).forEach(layerGroup => {
            if (!layerGroup || typeof layerGroup.eachLayer !== 'function') return;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å —Å–ª–æ—è
            if (map.hasLayer(layerGroup)) {
                layerGroup.eachLayer(layer => {
                    if (layer.feature?.properties?.type === 'split') {
                        const props = layer.feature.properties;
                        const id = `${props["–ö–∞–¥–∞—Å—Ç—Ä–æ–≤–∏–π –Ω–æ–º–µ—Ä"]}_${props["–û—Ä–µ–Ω–¥–∞—Ä —á–∞—Å—Ç–∏–Ω–∏"] || props["–û—Ä–µ–Ω–¥–∞—Ä"] || ""}_${props["–°—Ç–∞—Ç—É—Å"] || ""}`;
                        
                        if (!processedIds.has(id)) {
                            processedIds.add(id);
                            data.push(props);
                        }
                    }
                });
            }
        });

        
        if (data.length === 0) {
            alert('–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –µ–∫—Å–ø–æ—Ä—Ç—É. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —â–æ –Ω–∞ –∫–∞—Ä—Ç—ñ —î –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω—ñ –æ–±\'—î–∫—Ç–∏.');
            return;
        }

        try {
            // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∏ —ç–∫—Å–ø–æ—Ä—Ç
            data.sort((a, b) => (a["–ö–∞–¥–∞—Å—Ç—Ä–æ–≤–∏–π –Ω–æ–º–µ—Ä"] || "").localeCompare(b["–ö–∞–¥–∞—Å—Ç—Ä–æ–≤–∏–π –Ω–æ–º–µ—Ä"] || ""));
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet([
                // –ó–∞–≥–æ–ª–æ–≤–∫–∏
                ["–ö–∞–¥–∞—Å—Ç—Ä–æ–≤–∏–π –Ω–æ–º–µ—Ä", "–ü–ª–æ—â–∞ —Ä–æ–∑—Ä–∞—Ö–æ–≤–∞–Ω–∞", "–ü–ª–æ—â–∞ —á–∞—Å—Ç–∏–Ω–∏", "–í–ª–∞—Å–Ω–∏–∫", 
                 "–û—Ä–µ–Ω–¥–∞—Ä —á–∞—Å—Ç–∏–Ω–∏", "–û—Ä–µ–Ω–¥–∞—Ä", "–î–∞—Ç–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –æ—Ä–µ–Ω–¥–∏", "–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è", 
                 "–ù–∞–∑–≤–∞ –ø–æ–ª—è", "–°—Ç–∞—Ç—É—Å"],
                // –î–∞–Ω–Ω—ã–µ
                ...data.map(item => [
                    item["–ö–∞–¥–∞—Å—Ç—Ä–æ–≤–∏–π –Ω–æ–º–µ—Ä"] || "",
                    item["–ü–ª–æ—â–∞ —Ä–æ–∑—Ä–∞—Ö–æ–≤–∞–Ω–∞"] || "",
                    item["–ü–ª–æ—â–∞ —á–∞—Å—Ç–∏–Ω–∏"] || "",
                    item["–í–ª–∞—Å–Ω–∏–∫"] || "",
                    item["–û—Ä–µ–Ω–¥–∞—Ä —á–∞—Å—Ç–∏–Ω–∏"] || "",
                    item["–û—Ä–µ–Ω–¥–∞—Ä"] || "",
                    item["–î–∞—Ç–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –æ—Ä–µ–Ω–¥–∏"] || "",
                    item["–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è"] || "",
                    item["–ù–∞–∑–≤–∞ –ø–æ–ª—è"] || "",
                    item["–°—Ç–∞—Ç—É—Å"] || ""
                ])
            ]);
            
            XLSX.utils.book_append_sheet(wb, ws, "–î—ñ–ª—è–Ω–∫–∏");
            XLSX.writeFile(wb, `${filename}.xlsx`);
            
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ:', error);
            alert('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –µ–∫—Å–ø–æ—Ä—Ç—ñ: ' + error.message);
        }
    }

    // ...existing code...

    // –£–î–ê–õ–ò–¢–¨ –í–°–ï –°–¢–ê–†–´–ï –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ò –§–£–ù–ö–¶–ò–ò –≠–ö–°–ü–û–†–¢–ê
    // function exportToExcel(data, filename) { ... } - –£–î–ê–õ–ò–¢–¨
    // function collectMapData() { ... } - –£–î–ê–õ–ò–¢–¨

    // –ï–¥–∏–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞
    document.addEventListener('DOMContentLoaded', function() {
        // Haptic feedback –¥–ª—è –∫–Ω–æ–ø–æ–∫ —É offcanvas –º–µ–Ω—é
        const offcanvasButtons = document.querySelectorAll('.offcanvas .btn');
        offcanvasButtons.forEach(button => {
            button.addEventListener('click', function() {
                safeVibrate(30); // –ö–æ—Ä–æ—Ç–∫–∏–π —Ç–∞–∫—Ç–∏–ª—å–Ω–∏–π –≤—ñ–¥–≥—É–∫
            });
        });
        
        // Haptic feedback –¥–ª—è —Å–µ–ª–µ–∫—Ç—ñ–≤ —É offcanvas –º–µ–Ω—é
        const offcanvasSelects = document.querySelectorAll('.offcanvas .form-select');
        offcanvasSelects.forEach(select => {
            select.addEventListener('change', function() {
                safeVibrate(20); // –î—É–∂–µ –∫–æ—Ä–æ—Ç–∫–∏–π –≤—ñ–¥–≥—É–∫ –¥–ª—è –∑–º—ñ–Ω–∏ –≤–∏–±–æ—Ä—É
            });
        });
        
        // –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è –¥–ª—è –º–æ–±—ñ–ª—å–Ω–æ–≥–æ offcanvas
        const offcanvasElement = document.getElementById('mainMenu');
        if (offcanvasElement) {
            offcanvasElement.addEventListener('shown.bs.offcanvas', function() {
                // Haptic feedback –ø—Ä–∏ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—ñ –º–µ–Ω—é
                safeVibrate(50);
            });
            
            offcanvasElement.addEventListener('hidden.bs.offcanvas', function() {
                // –õ–µ–∫–≥–∏–π haptic feedback –ø—Ä–∏ –∑–∞–∫—Ä–∏—Ç—Ç—ñ –º–µ–Ω—é
                safeVibrate(25);
            });
        }
        
        const exportBtn = document.getElementById('exportButton');
        if (exportBtn) {
            // –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
            const newBtn = exportBtn.cloneNode(true);
            exportBtn.parentNode.replaceChild(newBtn, exportBtn);
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
            newBtn.addEventListener('click', function() {
                const offcanvas = bootstrap.Offcanvas.getInstance(document.getElementById('mainMenu'));
                if (offcanvas) {
                    offcanvas.hide();
                    setTimeout(exportToExcel, 300);
                } else {
                    exportToExcel();
                }
            });
        }
    });

    // ...existing code...
</script>

<script>
        // ...existing code...

function exportToExcel() {
    
    
    const selectedFile = document.getElementById('fileSelect').value;
    const filename = selectedFile.replace('.geojson', '') || '–µ–∫—Å–ø–æ—Ä—Ç_–¥–∞–Ω–∏—Ö';
    
    const data = [];
    const processedIds = new Set();
    
    Object.values(overlays).forEach(layerGroup => {
        if (!layerGroup || typeof layerGroup.eachLayer !== 'function') return;
        
        if (map.hasLayer(layerGroup)) {
            layerGroup.eachLayer(layer => {
                if (layer.feature?.properties?.type === 'split') {
                    const props = layer.feature.properties;
                    const id = `${props["–ö–∞–¥–∞—Å—Ç—Ä–æ–≤–∏–π –Ω–æ–º–µ—Ä"]}_${props["–û—Ä–µ–Ω–¥–∞—Ä —á–∞—Å—Ç–∏–Ω–∏"] || props["–û—Ä–µ–Ω–¥–∞—Ä"] || ""}_${props["–°—Ç–∞—Ç—É—Å"] || ""}`;
                    
                    if (!processedIds.has(id)) {
                        processedIds.add(id);
                        data.push(props);
                    }
                }
            });
        }
    });

    if (data.length === 0) {
        alert('–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –µ–∫—Å–ø–æ—Ä—Ç—É. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —â–æ –Ω–∞ –∫–∞—Ä—Ç—ñ —î –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω—ñ –æ–±\'—î–∫—Ç–∏.');
        return;
    }

    try {
        // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        data.sort((a, b) => (a["–ö–∞–¥–∞—Å—Ç—Ä–æ–≤–∏–π –Ω–æ–º–µ—Ä"] || "").localeCompare(b["–ö–∞–¥–∞—Å—Ç—Ä–æ–≤–∏–π –Ω–æ–º–µ—Ä"] || ""));
        
        // –ó–∞–≥–æ–ª–æ–≤–∫–∏ –∫–æ–ª–æ–Ω–æ–∫
        const headers = [
            "–ö–∞–¥–∞—Å—Ç—Ä–æ–≤–∏–π –Ω–æ–º–µ—Ä", 
            "–ü–ª–æ—â–∞ —Ä–æ–∑—Ä–∞—Ö–æ–≤–∞–Ω–∞", 
            "–ü–ª–æ—â–∞ —á–∞—Å—Ç–∏–Ω–∏", 
            "–í–ª–∞—Å–Ω–∏–∫", 
            "–û—Ä–µ–Ω–¥–∞—Ä —á–∞—Å—Ç–∏–Ω–∏", 
            "–û—Ä–µ–Ω–¥–∞—Ä", 
            "–î–∞—Ç–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –æ—Ä–µ–Ω–¥–∏", 
            "–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è", 
            "–ù–∞–∑–≤–∞ –ø–æ–ª—è", 
            "–°—Ç–∞—Ç—É—Å"
        ];
        
        // –°–æ–∑–¥–∞–µ–º –∫–Ω–∏–≥—É –∏ –ª–∏—Å—Ç
        const wb = XLSX.utils.book_new();
        
        // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ª–∏—Å—Ç–∞
        const wsData = [
            headers,
            ...data.map(item => headers.map(header => item[header] || ""))
        ];
        
        // –°–æ–∑–¥–∞–µ–º –ª–∏—Å—Ç
        const ws = XLSX.utils.aoa_to_sheet(wsData);
        
        // –ü–æ–ª—É—á–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –¥–ª–∏–Ω—É –¥–ª—è –∫–∞–∂–¥–æ–π –∫–æ–ª–æ–Ω–∫–∏
        const colWidths = headers.map((_, colIndex) => {
            return Math.max(
                // –î–ª–∏–Ω–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∞
                headers[colIndex].length,
                // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ –¥–∞–Ω–Ω—ã—Ö –≤ –∫–æ–ª–æ–Ω–∫–µ
                ...wsData.slice(1).map(row => 
                    String(row[colIndex] || "").length
                )
            );
        });
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —à–∏—Ä–∏–Ω—É –∫–æ–ª–æ–Ω–æ–∫
        ws['!cols'] = colWidths.map(width => ({
            // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Å–∏–º–≤–æ–ª—ã –≤ —É—Å–ª–æ–≤–Ω—ã–µ –µ–¥–∏–Ω–∏—Ü—ã Excel 
            // (–ø—Ä–∏–º–µ—Ä–Ω–æ 1.2 –µ–¥–∏–Ω–∏—Ü—ã –Ω–∞ —Å–∏–º–≤–æ–ª)
            width: Math.min(width * 1.2, 50) // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é —à–∏—Ä–∏–Ω—É
        }));
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
        const headerRange = XLSX.utils.decode_range(ws['!ref']);
        for (let C = headerRange.s.c; C <= headerRange.e.c; ++C) {
            const headerCell = XLSX.utils.encode_cell({ r: 0, c: C });
            if (!ws[headerCell]) continue;
            
            ws[headerCell].s = {
                font: { bold: true },
                fill: { fgColor: { rgb: "CCCCCC" } },
                alignment: { horizontal: "center" }
            };
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –ª–∏—Å—Ç –≤ –∫–Ω–∏–≥—É –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º
        XLSX.utils.book_append_sheet(wb, ws, "–î—ñ–ª—è–Ω–∫–∏");
        XLSX.writeFile(wb, `${filename}.xlsx`);
        
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ:', error);
        alert('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –µ–∫—Å–ø–æ—Ä—Ç—ñ: ' + error.message);
    }
}

// ...existing code...
</script>

<script src="js/pdfExport.js"></script>
<!-- –ú–æ–±—ñ–ª—å–Ω–µ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó -->
<div class="modal fade" id="mobileModal" tabindex="-1" aria-labelledby="mobileModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title d-flex align-items-center" id="mobileModalTitle">
                    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –±—É–¥–µ –∑–∞–ø–æ–≤–Ω–µ–Ω–æ JavaScript -->
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä–∏—Ç–∏"></button>
            </div>
            <div class="modal-body" id="mobileModalBody">
                <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –±—É–¥–µ –∑–∞–ø–æ–≤–Ω–µ–Ω–æ JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-lg me-1"></i>–ó–∞–∫—Ä–∏—Ç–∏
                </button>
            </div>
        </div>
    </div>
</div>

<!-- –§—ñ–Ω–∞–ª—å–Ω–µ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è: –¥–æ–∑–≤–æ–ª—è—î–º–æ –≤–∏–¥—ñ–ª–µ–Ω–Ω—è —Ç–µ–∫—Å—Ç—É –≤ popup -->
<style>
    .leaflet-popup-pane *,
    .leaflet-popup *,
    .leaflet-popup-content-wrapper *,
    .leaflet-popup-content,
    .leaflet-popup-content *,
    .popup-content,
    .popup-content *,
    #mobileModal *,
    .modal-body * {
        -webkit-user-select: text !important;
        -moz-user-select: text !important;
        -ms-user-select: text !important;
        user-select: text !important;
        -webkit-touch-callout: default !important;
        cursor: auto !important;
    }
</style>

</body>
</html>