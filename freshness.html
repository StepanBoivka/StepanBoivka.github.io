<!doctype html>
<html lang="uk">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Актуальність даних</title>    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .freshness-good { color: #28a745 !important; }
        .freshness-warning { color: #ffc107 !important; }
        .freshness-bad { color: #dc3545 !important; }
        
        .council-card {
            transition: all 0.3s ease;
            margin-bottom: 1rem;
        }
        .council-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .stats-box {
            font-size: 0.9rem;
            padding: 0.5rem;
            border-radius: 4px;
            background-color: rgba(0,0,0,0.03);
        }
        .progress {
            height: 25px;
            font-size: 0.9rem;
            font-weight: bold;
        }
        .progress-bar {
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 2em;
        }
        .view-switcher {
            position: absolute;
            right: 1rem;
            top: 1rem;
        }
        .table-view .progress {
            width: 400px;
        }
        @media (max-width: 768px) {
            .table-view .progress {
                width: 200px;
            }
        }
        .daily-updates-chart {
            height: 150px;
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#" onclick="goBack(); return false;">
                <i class="bi bi-arrow-left me-2"></i>Повернутися на карту
            </a>
            <div class="view-switcher">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-light" data-view="cards">
                        <i class="bi bi-grid"></i>
                    </button>
                    <button type="button" class="btn btn-outline-light active" data-view="table">
                        <i class="bi bi-table"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>    <div class="container py-4">        <h1 class="mb-4" id="pageTitle">
            Моє підприємство
            <small class="text-muted fs-5 ms-3" id="pageSubtitle">
                завантаження...
            </small>
        </h1><!-- Контейнер для інформації про підприємство -->
        <div id="enterpriseInfo" class="card border-primary mb-4" style="display: none;">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="bi bi-building-fill me-2"></i>Інформація про підприємство</h4>
            </div>
            <div class="card-body">
                <!-- Контент буде додано динамічно -->
            </div>
        </div>
        
        <!-- Контейнер для карток -->
        <div id="cardsView" class="row" style="display: none">
            <!-- Картки будуть тут -->
        </div>

        <!-- Контейнер для таблиці -->
        <div id="tableView" class="table-view">            <table class="table">                <thead>
                    <tr>
                        <th>Рада</th>
                        <th>КОАТУУ</th>                        <th>Статус</th>
                        <th>Ділянок</th>
                        <th>Актуальність даних</th>
                        <th>Останнє оновлення</th>
                        <th class="badge-column">Відсутні в ДЗК</th>
                        <th class="badge-column">Відсутні в РРП</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <!-- Рядки таблиці будуть тут -->
                </tbody>
            </table>
        </div>
    </div>    <script>        // Глобальні змінні для зберігання даних про розбіжності по радах
        let councilMissingInDzk = new Map(); // Відсутні в ДЗК (є в РРП, немає в ДЗК)
        let councilMissingInRrp = new Map(); // Відсутні в РРП (є в ДЗК, немає в РРП)
          document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get('id');
            const dataPath = id ? `data/${id}/` : 'data/';

            // Спочатку шукаємо txt файли для підприємства
            loadEnterpriseData(dataPath, id);
            
            // Потім завантажуємо дані рад
            loadAndAnalyzeData(dataPath, !!id);
        });async function loadEnterpriseData(dataPath, enterpriseId) {
            if (!enterpriseId) {
                // Якщо немає ID підприємства, ховаємо блок
                return;
            }

            try {
                // Шукаємо txt файли з GUID підприємства
                const txtFiles = await findTxtFiles(dataPath, enterpriseId);
                
                if (txtFiles.length > 0) {
                    document.getElementById('enterpriseInfo').style.display = 'block';
                    
                    // Завантажуємо та парсимо вміст файлів
                    let allEnterpriseData = [];
                    for (const fileName of txtFiles) {
                        try {
                            const response = await fetch('data/' + fileName);
                            const content = await response.text();
                            const parsedData = parseEnterpriseFile(content, fileName);
                            allEnterpriseData.push(parsedData);
                        } catch (error) {
                            console.error(`Помилка завантаження файлу ${fileName}:`, error);
                        }
                    }
                    
                    // Відображаємо інформацію про підприємства
                    displayEnterpriseInfo(allEnterpriseData);
                }
            } catch (error) {
                console.error('Помилка пошуку txt файлів:', error);
            }
        }async function findTxtFiles(dataPath, enterpriseId) {
            const txtFiles = [];
            
            // Список відомих txt файлів
            const knownFiles = [
                '32578784-1b993bed-913d-4b67-a425-eaabc687a569.txt',
                '40733935-b2a43d30-e687-470c-a1f1-6a336d1c112c.txt'
            ];

            // Шукаємо тільки файли, які містять переданий enterpriseId у своїй назві
            for (const fileName of knownFiles) {
                if (fileName.includes(enterpriseId)) {
                    try {
                        const response = await fetch('data/' + fileName);
                        if (response.ok) {
                            txtFiles.push(fileName);
                        }
                    } catch (error) {
                        console.log(`Файл data/${fileName} не знайдено`);
                    }
                }
            }            return txtFiles;
        }

        function parseEnterpriseFile(content, fileName) {
            const lines = content.trim().split('\n');
            const data = {
                fileName: fileName,
                edrpou: '',
                enterpriseName: '',
                actualityDate: '',
                cadastralNumbers: []
            };

            for (const line of lines) {
                const trimmedLine = line.trim();
                
                if (trimmedLine.startsWith('ЄДРПОУ:')) {
                    data.edrpou = trimmedLine.replace('ЄДРПОУ:', '').trim();
                } else if (trimmedLine.startsWith('Назва підприємства:')) {
                    data.enterpriseName = trimmedLine.replace('Назва підприємства:', '').trim();
                } else if (trimmedLine.startsWith('Дата актуальності:')) {
                    data.actualityDate = trimmedLine.replace('Дата актуальності:', '').trim();
                } else if (trimmedLine.includes(':')) {
                    // Це кадастровий номер
                    data.cadastralNumbers.push(trimmedLine);
                }
            }

            return data;
        }        async function displayEnterpriseInfo(enterpriseDataArray) {
            const infoContainer = document.getElementById('enterpriseInfo');
            
            if (enterpriseDataArray.length === 0) {
                infoContainer.querySelector('.card-body').innerHTML = `
                    <div class="text-center text-muted">
                        <i class="bi bi-exclamation-triangle fs-1"></i>
                        <p class="mt-2">Дані про підприємство не знайдено</p>
                    </div>
                `;
                return;
            }

            // Беремо дані з першого файлу
            const data = enterpriseDataArray[0];
            const totalCadastralNumbers = enterpriseDataArray.reduce((sum, item) => sum + item.cadastralNumbers.length, 0);

            // Збираємо всі кадастрові номери з txt файлів
            const txtCadastralNumbers = new Set();
            enterpriseDataArray.forEach(item => {
                item.cadastralNumbers.forEach(number => {
                    txtCadastralNumbers.add(number);
                });
            });            // Порівнюємо з geojson файлами
            const comparison = await compareWithGeojson(data.edrpou, txtCadastralNumbers);
            const exactMatchPercent = totalCadastralNumbers > 0 ? (comparison.foundInGeojson / totalCadastralNumbers) * 100 : 0;
            const matchPercent = Math.round(exactMatchPercent);            infoContainer.querySelector('.card-body').innerHTML = `
                <!-- Компактна інформація про підприємство -->
                <div class="row align-items-center mb-2">
                    <div class="col">
                        <div class="d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center">
                                <div class="bg-primary bg-opacity-10 p-2 rounded me-2" style="width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">
                                    <i class="bi bi-building-fill text-primary" style="font-size: 14px;"></i>
                                </div>
                                <div>
                                    <h6 class="mb-0 text-truncate" style="max-width: 300px;">${data.enterpriseName}</h6>
                                    <div class="d-flex align-items-center gap-2 mt-1">
                                        <span class="badge bg-primary" style="font-size: 10px;">${data.edrpou}</span>
                                        <small class="text-muted">
                                            <i class="bi bi-calendar-check me-1"></i>${data.actualityDate}
                                        </small>
                                    </div>
                                </div>
                            </div>
                            <div class="text-end">
                                <div class="h6 mb-0 text-${comparison.missingInGeojson === 0 ? 'success' : 'warning'}">
                                    ${exactMatchPercent === 100 ? '100' : exactMatchPercent.toFixed(1)}%
                                </div>
                                <small class="text-muted">відповідність</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Компактна статистика -->
                <div class="row g-1 mb-2">
                    <div class="col-4">
                        <div class="bg-info bg-opacity-10 px-2 py-1 rounded text-center">
                            <div class="fw-semibold text-info mb-0">${totalCadastralNumbers}</div>
                            <small class="text-muted" style="font-size: 10px;">договорів РРП</small>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="bg-success bg-opacity-10 px-2 py-1 rounded text-center">
                            <div class="fw-semibold text-success mb-0">${comparison.foundInGeojson}</div>
                            <small class="text-muted" style="font-size: 10px;">знайдено в ДЗК</small>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="bg-secondary bg-opacity-10 px-2 py-1 rounded text-center">
                            <div class="fw-semibold text-secondary mb-0">${comparison.totalCouncilsChecked}</div>
                            <small class="text-muted" style="font-size: 10px;">рад перевірено</small>
                        </div>
                    </div>
                </div>

                <!-- Міні прогрес-бар -->
                <div class="mb-2">
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar bg-success" style="width: ${exactMatchPercent}%" 
                             title="Співпадіння: ${exactMatchPercent.toFixed(1)}%">
                        </div>
                    </div>
                    <div class="d-flex justify-content-between mt-1">
                        <small class="text-muted" style="font-size: 10px;">
                            <i class="bi bi-arrow-left-right me-1"></i>Співставлення реєстрів
                        </small>
                        <small class="text-muted" style="font-size: 10px;">
                            ${exactMatchPercent.toFixed(1)}% відповідність
                        </small>
                    </div>
                </div>                ${comparison.missingInGeojson > 0 || comparison.missingInRrp > 0 ? `
                    <!-- Блок з проблемними ділянками -->
                    <div class="card border-warning">
                        <div class="card-header bg-warning bg-opacity-10">
                            <h6 class="mb-0 text-warning">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                Виявлені невідповідності реєстрів
                            </h6>
                        </div>
                        <div class="card-body">
                            ${comparison.missingInGeojson > 0 ? `
                                <div class="d-flex align-items-center justify-content-between mb-3">
                                    <div>
                                        <p class="mb-1">
                                            <strong>${comparison.missingInGeojson} з ${totalCadastralNumbers}</strong> кадастрових номерів 
                                            мають зареєстровані договори оренди в РРП, але відсутні межі ділянок в ДЗК
                                            <span class="text-danger fw-semibold">(${((comparison.missingInGeojson / totalCadastralNumbers) * 100).toFixed(1)}%)</span>
                                        </p>
                                        <small class="text-muted">
                                            Необхідність актуалізації меж ділянок або технічні проблеми синхронізації реєстрів
                                        </small>
                                    </div>
                                    <div class="text-end">
                                        <button class="btn btn-outline-danger btn-sm" type="button" 
                                                data-bs-toggle="collapse" data-bs-target="#missingInDzk" 
                                                aria-expanded="false">
                                            <i class="bi bi-list me-1"></i>
                                            Відсутні в ДЗК
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="collapse" id="missingInDzk">
                                    <div class="border-top pt-3 mb-3">
                                        <h6 class="text-muted mb-2">
                                            <i class="bi bi-file-earmark-x me-1"></i>
                                            Кадастрові номери без меж в ДЗК:
                                        </h6>
                                        <div style="max-height: 200px; overflow-y: auto;">
                                            ${Array.from(comparison.missingNumbers).map(num => 
                                                `<span class="badge bg-light text-dark border me-1 mb-1 font-monospace">${num}</span>`
                                            ).join('')}
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                              ${comparison.missingInRrp > 0 ? `
                                <div class="d-flex align-items-center justify-content-between mb-3">
                                    <div>                                        <p class="mb-1">
                                            <strong>${comparison.missingInRrp}</strong> кадастрових номерів 
                                            мають зареєстровану оренду в ДЗК за цим підприємством, але відсутні в РРП
                                        </p>
                                        <small class="text-muted">
                                            Можливо завершені договори оренди або розбіжності між реєстрами
                                        </small>
                                    </div>
                                    <div class="text-end">
                                        <button class="btn btn-outline-info btn-sm" type="button" 
                                                data-bs-toggle="collapse" data-bs-target="#missingInRrp" 
                                                aria-expanded="false">
                                            <i class="bi bi-list me-1"></i>
                                            Відсутні в РРП
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="collapse" id="missingInRrp">
                                    <div class="border-top pt-3">                                        <h6 class="text-muted mb-2">
                                            <i class="bi bi-file-earmark-plus me-1"></i>
                                            Кадастрові номери з орендою в ДЗК, що відсутні в РРП:
                                        </h6>
                                        <div style="max-height: 200px; overflow-y: auto;">
                                            ${Array.from(comparison.extraNumbers).map(num => 
                                                `<span class="badge bg-light text-dark border me-1 mb-1 font-monospace">${num}</span>`
                                            ).join('')}
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                ` : `
                    <!-- Блок успішного співпадіння -->
                    <div class="card border-success">
                        <div class="card-body text-center">
                            <div class="text-success mb-2">
                                <i class="bi bi-check-circle-fill fs-1"></i>
                            </div>
                            <h6 class="text-success">Повна відповідність реєстрів</h6>
                            <p class="text-muted mb-0">
                                Всі договори оренди з РРП мають відповідні межі ділянок в ДЗК
                            </p>
                        </div>
                    </div>
                `}

                <!-- Додаткова інформація -->                <div class="text-center mt-4 pt-3 border-top">
                    <small class="text-muted">
                        <i class="bi bi-info-circle me-1"></i>
                        Дані актуальні станом на ${data.actualityDate} • 
                        Перевірено ${comparison.totalCouncilsChecked} рад(и) • 
                        Файлів завантажено: ${enterpriseDataArray.length}
                    </small>
                </div>
            `;
            
            // Показуємо колонки з бейджами тепер, коли є дані підприємства
            const badgeHeaders = document.querySelectorAll('.badge-column');
            badgeHeaders.forEach(header => {
                header.style.display = 'table-cell';
            });
            
            // Оновлюємо існуючі рядки таблиці з новими даними бейджів
            const tableRows = document.querySelectorAll('#tableBody tr');
            tableRows.forEach(row => {
                const councilName = row.cells[0].textContent.trim().replace(/^\s*[^\s]+\s+/, ''); // Видаляємо іконку
                const missingInDzkCount = councilMissingInDzk.get(councilName) || 0;
                const missingInRrpCount = councilMissingInRrp.get(councilName) || 0;
                
                // Оновлюємо останні дві комірки (бейджі)
                if (row.cells.length >= 8) {
                    row.cells[6].innerHTML = `
                        <span class="badge ${missingInDzkCount > 0 ? 'bg-warning text-dark' : 'bg-success'}" title="${missingInDzkCount > 0 ? missingInDzkCount + ' відсутніх в ДЗК' : 'Всі знайдені в ДЗК'}">
                            ${missingInDzkCount}
                        </span>
                    `;
                    row.cells[6].style.display = 'table-cell';
                    
                    row.cells[7].innerHTML = `
                        <span class="badge ${missingInRrpCount > 0 ? 'bg-warning text-dark' : 'bg-success'}" title="${missingInRrpCount > 0 ? missingInRrpCount + ' відсутніх в РРП' : 'Всі знайдені в РРП'}">
                            ${missingInRrpCount}
                        </span>
                    `;
                    row.cells[7].style.display = 'table-cell';
                }
            });
        }async function compareWithGeojson(edrpou, txtCadastralNumbers) {
            const comparison = {
                foundInGeojson: 0,
                missingInGeojson: 0, // Є в РРП, немає в ДЗК
                missingInRrp: 0,     // Є в ДЗК, немає в РРП
                totalCouncilsChecked: 0,
                missingNumbers: new Set(),      // Номери відсутні в ДЗК
                extraNumbers: new Set()         // Номери відсутні в РРП
            };

            // Очищаємо попередні дані
            councilMissingInDzk.clear();
            councilMissingInRrp.clear();

            try {
                // Отримуємо список файлів рад
                const urlParams = new URLSearchParams(window.location.search);
                const id = urlParams.get('id');
                const dataPath = id ? `data/${id}/` : 'data/';
                
                const response = await fetch(dataPath + 'file_list.json');
                const data = await response.json();
                
                // Обробляємо кожну раду окремо
                for (const file of data.files) {
                    const councilName = file.replace('.geojson', '');
                    const councilCadastralNumbers = new Set();
                    let councilMissingInDzkCount = 0;
                    let councilMissingInRrpCount = 0;
                    
                    try {
                        const geojsonResponse = await fetch(dataPath + file);
                        const geojsonData = await geojsonResponse.json();
                        comparison.totalCouncilsChecked++;
                        
                        // Збираємо кадастрові номери цієї ради для нашого ЄДРПОУ
                        geojsonData.features.forEach(feature => {
                            const props = feature.properties;
                            if (props && props['ЄДРПОУ орендаря ділянки'] === edrpou) {
                                const cadastralNumber = props['Кадастровий номер'];
                                if (cadastralNumber) {
                                    councilCadastralNumbers.add(cadastralNumber);
                                }
                            }
                        });
                        
                        // Визначаємо КОАТУУ цієї ради
                        let councilKoatuu = null;
                        const firstFeature = geojsonData.features.find(f => f.properties?.['Кадастровий номер']);
                        if (firstFeature) {
                            councilKoatuu = firstFeature.properties['Кадастровий номер'].substring(0, 10);
                        }
                        
                        // 1. Перевіряємо номери з РРП - чи є вони в ДЗК
                        txtCadastralNumbers.forEach(txtNumber => {
                            if (councilCadastralNumbers.has(txtNumber)) {
                                comparison.foundInGeojson++;
                            } else {
                                // Перевіряємо чи цей номер належить до цієї ради (за КОАТУУ)
                                if (txtNumber.length >= 10 && councilKoatuu) {
                                    const txtKoatuu = txtNumber.substring(0, 10);
                                    if (txtKoatuu === councilKoatuu) {
                                        councilMissingInDzkCount++;
                                        comparison.missingInGeojson++;
                                        comparison.missingNumbers.add(txtNumber);
                                    }
                                }
                            }
                        });
                        
                        // 2. Перевіряємо номери з ДЗК - чи є вони в РРП
                        councilCadastralNumbers.forEach(geojsonNumber => {
                            if (!txtCadastralNumbers.has(geojsonNumber)) {
                                councilMissingInRrpCount++;
                                comparison.missingInRrp++;
                                comparison.extraNumbers.add(geojsonNumber);
                            }
                        });
                        
                    } catch (error) {
                        console.warn(`Помилка завантаження файлу ${file}:`, error);
                    }
                    
                    // Зберігаємо дані про розбіжності для цієї ради
                    councilMissingInDzk.set(councilName, councilMissingInDzkCount);
                    councilMissingInRrp.set(councilName, councilMissingInRrpCount);
                }

            } catch (error) {
                console.error('Помилка порівняння з geojson файлами:', error);
            }

            return comparison;
        }        async function loadAndAnalyzeData(dataPath, hasEnterpriseData = false) {
            try {
                const response = await fetch(dataPath + 'file_list.json');
                const data = await response.json();
                const grid = document.getElementById('cardsView');
                
                // Сховати/показати колонки з бейджами в залежності від наявності даних підприємства
                const badgeHeaders = document.querySelectorAll('.badge-column');
                badgeHeaders.forEach(header => {
                    header.style.display = hasEnterpriseData ? 'table-cell' : 'none';
                });
                
                let totalPlots = 0;
                const totalCouncils = data.files.length;
                
                for (const file of data.files) {
                    const councilData = await analyzeCouncilData(dataPath + file);
                    const card = createCouncilCard(file.replace('.geojson', ''), councilData, hasEnterpriseData);
                    grid.appendChild(card);
                    totalPlots += councilData.totalRecords;
                }                // Обновляем заголовок сторінки
                document.getElementById('pageSubtitle').textContent = `${totalCouncils} рад, ${totalPlots.toLocaleString('uk-UA')} ділянок`;
            } catch (error) {
                console.error('Помилка завантаження даних:', error);
                alert('Помилка завантаження списку файлів');
            }
        }

        async function analyzeCouncilData(filePath) {
            const response = await fetch(filePath);
            const data = await response.json();
            const now = new Date();
            
            // Фільтруємо тільки original записи
            const originalFeatures = data.features.filter(feature => feature.properties?.type === 'original');
            
            let stats = {
                totalRecords: originalFeatures.length,
                fresh: 0,
                medium: 0,
                old: 0,
                noDate: 0,
                latestUpdate: null,
                oldestUpdate: null,
                dailyUpdates: {},
                koatuu: ''
            };

            // Отримуємо КОАТУУ з першої ділянки
            if (originalFeatures.length > 0) {
                const firstFeature = originalFeatures[0];
                const cadastralNumber = firstFeature.properties?.["Кадастровий номер"];
                if (cadastralNumber) {
                    stats.koatuu = cadastralNumber.substring(0, 10);
                }
            }

            // Збираємо дані оновлень
            originalFeatures.forEach(feature => {
                const date = feature.properties?.["Дата оновлення"];
                if (!date) {
                    stats.noDate++;
                    return;
                }

                const [day, month, year] = date.split('.').map(Number);
                const updateDate = new Date(year, month - 1, day);
                const monthsOld = (now - updateDate) / (1000 * 60 * 60 * 24 * 30);

                const dateKey = updateDate.toISOString().split('T')[0];
                stats.dailyUpdates[dateKey] = (stats.dailyUpdates[dateKey] || 0) + 1;

                if (!stats.latestUpdate || updateDate > stats.latestUpdate) {
                    stats.latestUpdate = updateDate;
                }
                if (!stats.oldestUpdate || updateDate < stats.oldestUpdate) {
                    stats.oldestUpdate = updateDate;
                }

                if (monthsOld < 1) stats.fresh++;
                else if (monthsOld < 2) stats.medium++;
                else stats.old++;
            });

            // Додаємо всі дні між найстарішою і найновішою датою
            if (stats.oldestUpdate && stats.latestUpdate) {
                const currentDate = new Date(stats.oldestUpdate);
                while (currentDate <= stats.latestUpdate) {
                    const dateKey = currentDate.toISOString().split('T')[0];
                    if (!stats.dailyUpdates[dateKey]) {
                        stats.dailyUpdates[dateKey] = 0;
                    }
                    currentDate.setDate(currentDate.getDate() + 1);
                }
            }

            return stats;
        }        function createCouncilCard(name, stats, hasEnterpriseData = false) {
            const div = document.createElement('div');
            div.className = 'col-12';
            
            const freshPercent = Math.round((stats.fresh / stats.totalRecords) * 100);
            const mediumPercent = Math.round((stats.medium / stats.totalRecords) * 100);
            const oldPercent = Math.round((stats.old / stats.totalRecords) * 100);
            const noDatePercent = Math.round((stats.noDate / stats.totalRecords) * 100);

            let statusClass, statusText;
            if (freshPercent >= 70) {
                statusClass = 'freshness-good';
                statusText = 'Актуально';
            } else if (freshPercent + mediumPercent >= 70) {
                statusClass = 'freshness-warning';
                statusText = 'Частково актуально';
            } else {
                statusClass = 'freshness-bad';
                statusText = 'Застаріло';
            }            const latestDate = stats.latestUpdate ? stats.latestUpdate.toLocaleDateString('uk-UA') : 'немає даних';
            const oldestDate = stats.oldestUpdate ? stats.oldestUpdate.toLocaleDateString('uk-UA') : 'немає даних';            // Отримуємо кількості розбіжностей для цієї ради тільки якщо є дані підприємства
            const missingInDzkCount = hasEnterpriseData ? (councilMissingInDzk.get(name) || 0) : 0;
            const missingInRrpCount = hasEnterpriseData ? (councilMissingInRrp.get(name) || 0) : 0;

            // Додаємо дані в обидва представлення
            addTableRow(name, statusClass, statusText, stats, freshPercent, mediumPercent, oldPercent, noDatePercent, latestDate, missingInDzkCount, missingInRrpCount, hasEnterpriseData);

            div.innerHTML = `
                <div class="card council-card">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-3">
                                <h5 class="card-title d-flex align-items-center mb-0">
                                    <i class="bi bi-geo-alt-fill me-2 ${statusClass}"></i>
                                    ${name}
                                </h5>
                            </div>
                            <div class="col-md-2">
                                <div class="text-muted">Статус: <span class="${statusClass}">${statusText}</span></div>
                                <div class="small">Ділянок: ${stats.totalRecords}</div>
                            </div>
                            <div class="col-md-5">
                                <div class="progress">
                                    <div class="progress-bar bg-success" style="width: ${freshPercent}%" title="До 1 місяця: ${freshPercent}%">
                                        ${freshPercent}%
                                    </div>
                                    <div class="progress-bar bg-warning" style="width: ${mediumPercent}%" title="1-2 місяці: ${mediumPercent}%">
                                        ${mediumPercent}%
                                    </div>
                                    <div class="progress-bar bg-danger" style="width: ${oldPercent}%" title="Понад 2 місяці: ${oldPercent}%">
                                        ${oldPercent}%
                                    </div>
                                    <div class="progress-bar bg-secondary" style="width: ${noDatePercent}%" title="Без дати: ${noDatePercent}%">
                                        ${noDatePercent}%
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="small">Оновлено: ${latestDate}</div>
                            </div>
                        </div>
                        <div class="daily-updates-chart">
                            <canvas id="chart-${name}"></canvas>
                        </div>
                    </div>
                </div>
            `;

            // Додаємо створення графіка після рендерингу картки
            setTimeout(() => {
                const dates = Object.keys(stats.dailyUpdates).sort();
                const updates = dates.map(date => stats.dailyUpdates[date]);
                
                new Chart(document.getElementById(`chart-${name}`), {
                    type: 'bar',
                    data: {
                        labels: dates.map(date => {
                            const [y, m, d] = date.split('-');
                            return `${d}.${m}`;
                        }),
                        datasets: [{
                            label: 'Кількість оновлень',
                            data: updates,
                            backgroundColor: updates.map(value => 
                                value === 0 ? 'rgba(200,200,200,0.2)' : 'rgba(54, 162, 235, 0.5)'
                            ),
                            borderColor: updates.map(value => 
                                value === 0 ? 'rgba(200,200,200,0.5)' : 'rgba(54, 162, 235, 1)'
                            ),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const value = context.raw;
                                        return value === 0 ? 'Немає оновлень' : `Оновлено: ${value} ділянок`;
                                    }
                                }
                            }
                        }
                    }
                });
            }, 100);

            return div;
        }        function addTableRow(name, statusClass, statusText, stats, freshPercent, mediumPercent, oldPercent, noDatePercent, latestDate, missingInDzkCount = 0, missingInRrpCount = 0, hasEnterpriseData = false) {
            const tbody = document.getElementById('tableBody');
            const row = document.createElement('tr');
            
            const badgeCells = hasEnterpriseData ? `
                <td class="badge-column">
                    <span class="badge ${missingInDzkCount > 0 ? 'bg-warning text-dark' : 'bg-success'}" title="${missingInDzkCount > 0 ? missingInDzkCount + ' відсутніх в ДЗК' : 'Всі знайдені в ДЗК'}">
                        ${missingInDzkCount}
                    </span>
                </td>
                <td class="badge-column">
                    <span class="badge ${missingInRrpCount > 0 ? 'bg-warning text-dark' : 'bg-success'}" title="${missingInRrpCount > 0 ? missingInRrpCount + ' відсутніх в РРП' : 'Всі знайдені в РРП'}">
                        ${missingInRrpCount}
                    </span>
                </td>
            ` : `
                <td class="badge-column" style="display: none;"></td>
                <td class="badge-column" style="display: none;"></td>
            `;
            
            row.innerHTML = `
                <td>
                    <i class="bi bi-geo-alt-fill me-2 ${statusClass}"></i>
                    ${name}
                </td>
                <td>${stats.koatuu || 'Н/Д'}</td>
                <td><span class="${statusClass}">${statusText}</span></td>
                <td>${stats.totalRecords}</td>
                <td>
                    <div class="progress">
                        <div class="progress-bar bg-success" style="width: ${freshPercent}%" title="До 1 місяця: ${freshPercent}%">
                            ${freshPercent}%
                        </div>
                        <div class="progress-bar bg-warning" style="width: ${mediumPercent}%" title="1-2 місяці: ${mediumPercent}%">
                            ${mediumPercent}%
                        </div>
                        <div class="progress-bar bg-danger" style="width: ${oldPercent}%" title="Понад 2 місяці: ${oldPercent}%">
                            ${oldPercent}%
                        </div>
                        <div class="progress-bar bg-secondary" style="width: ${noDatePercent}%" title="Без дати: ${noDatePercent}%">
                            ${noDatePercent}%
                        </div>
                    </div>
                </td>
                <td>${latestDate}</td>
                ${badgeCells}
            `;
            
            tbody.appendChild(row);
        }

        // Додаємо перемикач видів
        document.addEventListener('DOMContentLoaded', function() {
            const viewButtons = document.querySelectorAll('[data-view]');
            viewButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const view = this.dataset.view;
                    document.getElementById('cardsView').style.display = view === 'cards' ? 'flex' : 'none';
                    document.getElementById('tableView').style.display = view === 'table' ? 'block' : 'none';
                    
                    // Оновлюємо активну кнопку
                    viewButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                });
            });
        });

        // Добавляем функцию для возврата
        function goBack() {
            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get('id');
            const selectedFile = urlParams.get('file');
            
            let returnUrl = 'index.html';
            if (id) returnUrl += `?id=${id}`;
            if (selectedFile) {
                returnUrl += id ? '&' : '?';
                returnUrl += `return_file=${encodeURIComponent(selectedFile)}`;
            }
            
            window.location.href = returnUrl;
        }

        // Додаємо нову функцію для копіювання КОАТУУ
        function copyKoatuuList() {
            const tableRows = document.querySelectorAll('#tableBody tr');
            const koatuuList = Array.from(tableRows)
                .map(row => row.children[1].textContent.trim())
                .filter(koatuu => koatuu !== 'Н/Д')
                .map(koatuu => `'${koatuu}'`)
                .join(',\n');

            navigator.clipboard.writeText(koatuuList).then(() => {
                // Показуємо тимчасове повідомлення про успіх
                const btn = document.querySelector('button[onclick="copyKoatuuList()"]');
                const originalHtml = btn.innerHTML;
                btn.innerHTML = '<i class="bi bi-check"></i> Скопійовано';
                setTimeout(() => {
                    btn.innerHTML = originalHtml;
                }, 2000);
            });
        }
    </script>
</body>
</html>
